<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recent Chats ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Tailwind CDN doesn‚Äôt include the line-clamp plugin by default */
    .line-clamp-2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-900">
  <div class="max-w-5xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-4">üí¨ Recent Chats</h1>
    <a href="/admin/dashboard" class="text-sm text-blue-600 hover:underline">‚Üê Back to Admin Dashboard</a>

    <!-- Analytics strip -->
    <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2">
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-xs text-gray-500">Pre-booking</div>
        <div class="text-xl font-bold">{{ analytics.pre_booking }}</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-xs text-gray-500">Active</div>
        <div class="text-xl font-bold">{{ analytics.active }}</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-xs text-gray-500">Post-stay</div>
        <div class="text-xl font-bold">{{ analytics.post_stay }}</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-xs text-gray-500">Urgent sessions</div>
        <div class="text-xl font-bold">{{ analytics.urgent_sessions }}</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-xs text-gray-500">Unhappy sessions</div>
        <div class="text-xl font-bold">{{ analytics.unhappy_sessions }}</div>
      </div>
    </div>

    <!-- Action Queue shortcuts -->
    <div class="mt-3 flex flex-wrap gap-2">
      <a
        href="/admin/chats?status=active&priority=urgent"
        class="text-xs bg-red-100 text-red-800 px-3 py-1 rounded-full font-semibold hover:bg-red-200"
      >
        üî• Active + Urgent
      </a>

      <a
        href="/admin/chats?status=active&priority=unhappy"
        class="text-xs bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-semibold hover:bg-yellow-200"
      >
        üòü Active + Unhappy
      </a>

      <a
        href="/admin/chats?status=active"
        class="text-xs bg-green-100 text-green-800 px-3 py-1 rounded-full font-semibold hover:bg-green-200"
      >
        üèñ Active stays
      </a>

      <a
        href="/admin/chats"
        class="text-xs bg-slate-100 text-slate-700 px-3 py-1 rounded-full font-semibold hover:bg-slate-200"
      >
        ‚Ü© Reset
      </a>
    </div>

    <!-- Filters -->
    <form class="mt-4 bg-white rounded-lg shadow p-3 flex flex-wrap gap-2 items-center" method="get">
      <select name="pmc_id" class="border rounded px-2 py-1 text-sm">
        <option value="">All PMCs</option>
        {% for p in pmcs %}
          <option value="{{ p.id }}" {% if (filters.pmc_id|string) == (p.id|string) %}selected{% endif %}>
            {{ p.pmc_name }}
          </option>
        {% endfor %}
      </select>

      <select name="property_id" class="border rounded px-2 py-1 text-sm">
        <option value="">All Properties</option>
        {% for pr in properties %}
          <option value="{{ pr.id }}" {% if (filters.property_id|string) == (pr.id|string) %}selected{% endif %}>
            {{ pr.property_name }}
          </option>
        {% endfor %}
      </select>

      <select name="status" class="border rounded px-2 py-1 text-sm">
        <option value="">All statuses</option>
        <option value="pre_booking" {% if filters.status=="pre_booking" %}selected{% endif %}>Pre-booking</option>
        <option value="active" {% if filters.status=="active" %}selected{% endif %}>Active</option>
        <option value="post_stay" {% if filters.status=="post_stay" %}selected{% endif %}>Post-stay</option>
      </select>

      <select name="priority" class="border rounded px-2 py-1 text-sm">
        <option value="">All priorities</option>
        <option value="urgent" {% if filters.priority=="urgent" %}selected{% endif %}>üî• Urgent only</option>
        <option value="unhappy" {% if filters.priority=="unhappy" %}selected{% endif %}>üòü Unhappy only</option>
      </select>

      <!-- Mine + assigned -->
      <label class="flex items-center gap-2 text-sm text-gray-700">
        <input type="checkbox" name="mine" value="1" {% if filters.mine %}checked{% endif %} />
        Mine
      </label>

      <input
        name="assigned_to"
        value="{{ filters.assigned_to or '' }}"
        class="border rounded px-2 py-1 text-sm w-[180px]"
        placeholder="Assigned to‚Ä¶"
      />

      <input
        name="q"
        value="{{ filters.q or '' }}"
        class="border rounded px-2 py-1 text-sm flex-1 min-w-[220px]"
        placeholder="Search guest, property, snippet..."
      />

      <button class="bg-slate-900 text-white rounded px-3 py-1 text-sm">Filter</button>
      <a href="/admin/chats" class="text-sm text-slate-600 hover:underline ml-auto">Reset</a>
    </form>

    {% if sessions %}
      <div class="mt-4 bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left">Property</th>
              <th class="px-4 py-2 text-left">Guest</th>
              <th class="px-4 py-2 text-left">Assigned</th>

              <th class="px-4 py-2 text-left">
                <span class="relative inline-flex items-center gap-1 group cursor-help">
                  Stage
                  <span class="text-[11px] text-slate-500">‚ìò</span>
                  <span
                    class="pointer-events-none absolute left-0 top-full mt-2 w-72 z-50
                           rounded-lg bg-slate-900 text-white text-xs p-3 shadow-lg
                           opacity-0 group-hover:opacity-100 transition whitespace-normal"
                  >
                    Stage represents the guest‚Äôs booking status at the time of the conversation.
                  </span>
                </span>
              </th>

              <th class="px-4 py-2 text-left">
                <span class="relative inline-flex items-center gap-1 group cursor-help">
                  Signals
                  <span class="text-[11px] text-slate-500">‚ìò</span>
                  <span
                    class="pointer-events-none absolute left-0 top-full mt-2 w-72 z-50
                           rounded-lg bg-slate-900 text-white text-xs p-3 shadow-lg
                           opacity-0 group-hover:opacity-100 transition whitespace-normal"
                  >
                    Signals reflect how the guest seems to be feeling (derived from urgency, sentiment, and patterns).
                  </span>
                </span>
              </th>

              <th class="px-4 py-2 text-left">
                <span class="relative inline-flex items-center gap-1 group cursor-help">
                  Priority
                  <span class="text-[11px] text-slate-500">‚ìò</span>
                  <span
                    class="pointer-events-none absolute left-0 top-full mt-2 w-72 z-50
                           rounded-lg bg-slate-900 text-white text-xs p-3 shadow-lg
                           opacity-0 group-hover:opacity-100 transition whitespace-normal"
                  >
                    Priority shows how urgently a conversation needs attention right now, based on signals, activity, and recency.
                  </span>
                </span>
              </th>

              <th class="px-4 py-2 text-left">Last activity</th>
              <th class="px-4 py-2 text-left">Snippet</th>
              <th class="px-4 py-2 text-left"></th>
            </tr>
          </thead>

          <tbody>
            {% for s in sessions %}
              {# Defensive: allow s.signals to be missing/null #}
              {% set sig = (s.signals or []) | map('lower') | list %}

              <tr class="border-t hover:bg-gray-50 {% if s.needs_attention %}bg-red-50{% endif %}">

                <!-- Property -->
                <td class="px-4 py-2">
                  <div class="font-semibold text-gray-900">
                    {{ s.property_name or "Unknown property" }}
                  </div>

                  <div class="text-xs text-gray-500">
                    Property ID: {{ s.property_id }}
                  </div>

                  {% if s.assigned_to %}
                    <div class="mt-1 text-[11px] text-gray-500">
                      Assigned: <span class="font-semibold text-gray-700">{{ s.assigned_to }}</span>
                    </div>
                  {% endif %}

                  {% if s.escalation_level %}
                    <div class="mt-1">
                      {% if s.escalation_level == "high" %}
                        <span class="inline-block px-2 py-0.5 rounded-full bg-red-200 text-red-900 font-semibold text-[11px]">
                          üî¥ Escalation
                        </span>
                      {% elif s.escalation_level == "medium" %}
                        <span class="inline-block px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 font-semibold text-[11px]">
                          üü° Escalation
                        </span>
                      {% elif s.escalation_level == "low" %}
                        <span class="inline-block px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 font-semibold text-[11px]">
                          üü¢ Escalation
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if s.is_resolved %}
                    <div class="mt-1">
                      <span class="inline-block px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-semibold text-[11px]">
                        ‚úÖ Resolved
                      </span>
                    </div>
                  {% endif %}
                </td>

                <!-- Guest -->
                <td class="px-4 py-2">
                  <div class="font-medium">{{ s.guest_name or "‚Äî" }}</div>
                </td>

                <!-- Assigned -->
                <td class="px-4 py-2 text-xs">
                  {% if s.assigned_to %}
                    <span class="inline-block px-2 py-1 rounded bg-slate-100 text-slate-800 font-semibold">
                      {{ s.assigned_to }}
                    </span>
                  {% else %}
                    <span class="text-gray-400">‚Äî</span>
                  {% endif %}
                </td>

                <!-- Stage -->
                <td class="px-4 py-2 text-xs">
                  {% if s.reservation_status == "active" %}
                    <span class="inline-block px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold">üèñ Active</span>
                  {% elif s.reservation_status == "pre_booking" %}
                    <span class="inline-block px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold">üí¨ Pre-booking</span>
                  {% elif s.reservation_status == "post_stay" %}
                    <span class="inline-block px-2 py-1 rounded-full bg-gray-200 text-gray-700 font-semibold">üì¨ Post-stay</span>
                  {% else %}
                    <span class="text-gray-400">Unknown</span>
                  {% endif %}
                </td>

                <!-- Signals (customer emotion words) -->
                <td class="px-4 py-2 text-xs">
                  {% if "panicked" in sig %}
                    <span class="inline-block px-2 py-1 rounded-full bg-red-100 text-red-700 font-semibold mr-1">üò∞ Panicked</span>
                  {% endif %}

                  {% if "angry" in sig %}
                    <span class="inline-block px-2 py-1 rounded-full bg-red-200 text-red-900 font-semibold mr-1">üò° Angry</span>
                  {% endif %}

                  {% if "upset" in sig %}
                    <span class="inline-block px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 font-semibold mr-1">üòü Upset</span>
                  {% endif %}

                  {% if "confused" in sig %}
                    <span class="inline-block px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold mr-1">üòï Confused</span>
                  {% endif %}

                  {% if "worried" in sig %}
                    <span class="inline-block px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 font-semibold mr-1">ü•∫ Worried</span>
                  {% endif %}

                  {% if sig|length == 0 or (sig|length == 1 and "calm" in sig) %}
                    <span class="inline-block px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold">üôÇ Calm</span>
                  {% endif %}
                </td>

                <!-- Priority (was Pulse/heat) -->
                <td class="px-4 py-2 text-xs"
                    title="Priority details:
                    Base score: {{ s.heat_raw }}
                    Adjusted score: {{ s.heat_boosted }}
                    Recent activity (24h): {{ s.msg_24h }} messages
                    Recent activity (7d): {{ s.msg_7d }} messages
                    Urgent flag: {{ 'yes' if s.has_urgent else 'no' }}">
                  {% if s.heat >= 85 %}
                    <span class="inline-block px-2 py-1 rounded-full bg-red-200 text-red-900 font-semibold cursor-help">üî• Critical</span>
                  {% elif s.heat >= 60 %}
                    <span class="inline-block px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 font-semibold cursor-help">‚ö†Ô∏è Elevated</span>
                  {% elif s.heat >= 35 %}
                    <span class="inline-block px-2 py-1 rounded-full bg-slate-100 text-slate-700 font-semibold cursor-help">üòå Calm</span>
                  {% else %}
                    <span class="text-gray-400">Calm</span>
                  {% endif %}
                </td>

                <!-- Last Activity -->
                <td class="px-4 py-2 text-xs text-gray-700">
                  {% if s.last_activity_at %}
                    <span
                      class="js-rel-time cursor-help"
                      data-ts="{{ s.last_activity_at.isoformat() }}"
                      title="{{ s.last_activity_at.strftime('%A, %B %d, %Y ¬∑ %I:%M:%S %p') }}"
                    >
                      {{ s.last_activity_at.strftime("%b %d ¬∑ %I:%M %p") }}
                    </span>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <!-- Snippet -->
                <td class="px-4 py-2 text-xs text-gray-600">
                  {% set snip = (s.last_snippet or "") %}
                  <div class="line-clamp-2" title="{{ snip }}">
                    {{ snip[:140] }}{% if snip|length > 140 %}‚Ä¶{% endif %}
                  </div>

                  {% if s.next_action %}
                    <div class="mt-1 text-[11px] text-slate-700">
                      <span class="text-blue-600">
                        <span class="font-semibold">Recommendation:</span>
                        {{ s.next_action }}
                      </span>
                    </div>
                  {% endif %}
                </td>

                <!-- View -->
                <td class="px-4 py-2 text-right">
                  <a href="/admin/chats/{{ s.id }}" class="text-blue-600 hover:underline text-xs font-semibold">
                    View ‚Üí
                  </a>
                </td>

              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mt-4 text-gray-600">No chat sessions yet.</p>
    {% endif %}
  </div>

  <script>
    function parseTimestamp(ts) {
      if (!ts) return null;
      const normalized = ts.includes("T") ? ts : ts.replace(" ", "T");
      const d = new Date(normalized);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatRelative(fromDate, now = new Date()) {
      const diffMs = now - fromDate;
      if (diffMs < 0) return "just now";

      const sec = Math.floor(diffMs / 1000);
      if (sec < 10) return "just now";
      if (sec < 60) return `${sec}s ago`;

      const min = Math.floor(sec / 60);
      if (min < 60) return `${min}m ago`;

      const hr = Math.floor(min / 60);
      if (hr < 24) return `${hr}h ago`;

      const day = Math.floor(hr / 24);
      if (day < 14) return `${day}d ago`;

      const wk = Math.floor(day / 7);
      if (wk < 8) return `${wk}w ago`;

      const mo = Math.floor(day / 30);
      if (mo < 12) return `${mo}mo ago`;

      const yr = Math.floor(day / 365);
      return `${yr}y ago`;
    }

    function updateRelativeTimes() {
      const now = new Date();
      document.querySelectorAll(".js-rel-time").forEach(el => {
        const ts = el.getAttribute("data-ts");
        const d = parseTimestamp(ts);
        if (!d) return;
        el.textContent = formatRelative(d, now);
      });
    }

    updateRelativeTimes();
    setInterval(updateRelativeTimes, 60 * 1000);
  </script>
</body>
</html>
