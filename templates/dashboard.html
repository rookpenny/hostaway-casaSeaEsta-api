<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PMC Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Sidebar transition */
    .sidebar-hidden {
      transform: translateX(-100%);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex h-screen overflow-hidden">

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed z-30 inset-y-0 left-0 w-64 bg-white shadow-lg transform transition-transform duration-300 md:relative md:translate-x-0 md:block">
    <div class="p-4 border-b">
      <h2 class="text-xl font-bold">ğŸ¡ PMC Portal</h2>
    </div>
    <nav class="p-4 flex flex-col gap-4 text-gray-700">
      <a href="#" class="hover:text-blue-500">ğŸ“Š Dashboard</a>
      <a href="#" class="hover:text-blue-500">ğŸ˜ï¸ Properties</a>
      <a href="#" class="hover:text-blue-500">âš™ï¸ Settings</a>
      <a href="/auth/logout" class="text-red-500 hover:underline mt-8">ğŸšª Logout</a>
    </nav>
  </aside>

  <!-- Content -->
  <div class="flex-1 flex flex-col">

    <!-- Top nav -->
    <header class="flex items-center justify-between bg-white p-4 shadow-md md:hidden">
      <button onclick="toggleSidebar()" class="text-xl">â˜°</button>
      <h1 class="font-semibold">PMC Dashboard</h1>
    </header>

    <!-- Main -->
    <main class="p-6 overflow-auto">

      <!-- Header -->
      <div class="flex justify-between items-center flex-wrap mb-4">
        <div>
          <h1 class="text-2xl font-bold">Welcome, {{ user.name or 'PMC User' }}</h1>
          <p class="text-sm text-gray-500">PMC Email: {{ user.email }}</p>
        </div>
        <div class="text-sm text-gray-500 mt-2 md:mt-0">
          ğŸ•“ Last synced: {{ properties[0].last_synced.strftime('%b %d, %H:%M') if properties and properties[0].last_synced else 'N/A' }}
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg shadow">
          <p class="text-gray-500">Total Properties</p>
          <h2 class="text-2xl font-bold">{{ properties|length }}</h2>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <p class="text-gray-500">Live</p>
          <h2 class="text-2xl font-bold">
            {{ properties | selectattr("sandy_enabled") | list | length }}
          </h2>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <p class="text-gray-500">Offline</p>
          <h2 class="text-2xl font-bold">
            {{ properties | rejectattr("sandy_enabled") | list | length }}
          </h2>
        </div>
      </div>

      <!-- Chart -->
      <div class="bg-white p-4 rounded-lg shadow mb-6">
        <h2 class="text-lg font-semibold mb-2">Live vs Offline</h2>
        <canvas id="statusChart" width="400" height="200"></canvas>
      </div>

      <!-- Search -->
      <div class="mb-4">
        <input type="text" placeholder="Search properties..." oninput="filterProperties(this.value)"
               class="w-full md:w-1/3 px-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:ring focus:outline-none">
      </div>

      <!-- Properties Grid -->
      <div id="propertyGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for prop in properties %}
        <div class="bg-white rounded-lg shadow p-4 property-card">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-semibold property-name">{{ prop.property_name }}</h3>
            <span class="text-sm px-2 py-1 rounded-full 
                {% if prop.sandy_enabled %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
              {% if prop.sandy_enabled %}LIVE{% else %}OFFLINE{% endif %}
            </span>
          </div>
          <div class="flex flex-col gap-2">
            <a href="/admin/edit-file?file={{ prop.data_folder_path }}/config.json"
               class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
              Edit Config
            </a>
            <a href="/admin/edit-file?file={{ prop.data_folder_path }}/manual.txt"
               class="text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
              Edit Manual
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </main>
  </div>
</div>

<!-- JS for Sidebar Toggle & Filtering -->
<script>
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('sidebar-hidden');
  }

  function filterProperties(query) {
    query = query.toLowerCase();
    document.querySelectorAll('.property-card').forEach(card => {
      const name = card.querySelector('.property-name').textContent.toLowerCase();
      card.style.display = name.includes(query) ? 'block' : 'none';
    });
  }

  // Chart.js
  const ctx = document.getElementById('statusChart').getContext('2d');
  const live = {{ properties | selectattr("sandy_enabled") | list | length }};
  const offline = {{ properties | rejectattr("sandy_enabled") | list | length }};

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Live', 'Offline'],
      datasets: [{
        data: [live, offline],
        backgroundColor: ['#10B981', '#EF4444'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
</script>

</body>
</html>
