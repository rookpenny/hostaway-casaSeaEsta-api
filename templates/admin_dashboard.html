<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HostScout Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06), 0 10px 24px rgba(15, 23, 42, 0.06); }
    .hairline { box-shadow: inset 0 1px 0 rgba(255,255,255,.7); }

    /* Active nav state */
    .nav-item[aria-current="page"] { background: rgb(248 250 252); color: rgb(15 23 42); }
    .nav-item[aria-current="page"] .nav-icon-wrap { background: rgb(15 23 42); border-color: rgb(15 23 42); }
    .nav-item[aria-current="page"] svg { color: white; }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  

</head>

<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex">
{% set initial_view = request.query_params.get('view') or ('chats' if request.query_params.get('session_id') else 'overview') %}

    <!-- Sidebar -->
    <aside id="sidebar"
      class="sticky top-0 h-screen bg-white border-r border-slate-200 flex flex-col
             w-72 transition-[width] duration-200 ease-out">

      <!-- Brand -->
      <div class="h-16 px-4 flex items-center justify-between border-b border-slate-200">
        <a href="#" class="flex items-center gap-2 overflow-hidden">
          <div class="w-9 h-9 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            H
          </div>
          <div class="sidebar-label whitespace-nowrap">
            <div class="text-sm font-semibold leading-4">HostScout</div>
            <div class="text-xs text-slate-500">
              {% if user_role == "super" %}Super Admin{% else %}PMC Dashboard{% endif %}
            </div>
          </div>
        </a>

        <button id="sidebar-toggle"
          class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50 grid place-items-center"
          aria-label="Toggle sidebar"
          type="button">
          <svg class="h-5 w-5 text-slate-600" viewBox="0 0 24 24" fill="none">
            <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <!-- Nav -->
<nav class="p-3 space-y-1">

  <!-- Overview -->
  <button data-view="overview"
    class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
    aria-current="{{ 'page' if initial_view == 'overview' else 'false' }}"
    type="button">
    <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
      <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
        <path d="M3 13h8V3H3v10zm10 8h8V11h-8v10zM3 21h8v-6H3v6zm10-18v6h8V3h-8z"
          stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
      </svg>
    </span>
    <span class="sidebar-label font-medium">Overview</span>
  </button>

  <!-- Chats (PMC + Super) -->

    <button data-view="chats"
    class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
    aria-current="{{ 'page' if initial_view == 'chats' else 'false' }}"
      type="button">
    <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
      <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
        <path d="M4 19V5a2 2 0 0 1 2-2h12v18H6a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="1.7"/>
      </svg>
    </span>
    <span class="sidebar-label font-medium">Chats</span>
  </button>

  {% if user_role == "super" %}
    <!-- PMCs (Super only) -->
    <button data-view="pmcs"
      class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
      aria-current="{{ 'page' if initial_view == 'pmcs' else 'false' }}"
      type="button">
      <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
        <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
          <path d="M4 21V3h10v18M14 9h6v12M8 7h2M8 11h2M8 15h2M18 13h2M18 17h2"
            stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
      <span class="sidebar-label font-medium">PMCs</span>
    </button>

    <!-- Files (Super only) -->
    <button data-view="files"
      class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
      aria-current="{{ 'page' if initial_view == 'files' else 'false' }}"
      type="button">
      <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
        <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"
            stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
          <path d="M14 2v6h6" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
        </svg>
      </span>
      <span class="sidebar-label font-medium">Configs & Manuals</span>
    </button>
  {% endif %}

    <!-- Analytics (Super + PMC) -->
    <button data-view="analytics"
      class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
      aria-current="{{ 'page' if initial_view == 'analytics' else 'false' }}"
      type="button">
      <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
        <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
          <path d="M4 19V5M4 19h16M8 15v-6M12 19V9M16 13v-4M20 19V7"
            stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
        </svg>
      </span>
      <span class="sidebar-label font-medium">Analytics</span>
    </button>


  <!-- Properties -->
  <button data-view="properties"
    class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
    aria-current="{{ 'page' if initial_view == 'properties' else 'false' }}"
    type="button">
    <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
      <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
        <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5z"
          stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
      </svg>
    </span>
    <span class="sidebar-label font-medium">Properties</span>
  </button>

  <!-- Guides -->
  <button data-view="guides"
    class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
    aria-current="{{ 'page' if initial_view == 'guides' else 'false' }}"
    type="button">
    <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
      <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
        <path d="M4 19V5a2 2 0 0 1 2-2h12v18H6a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="1.7"/>
      </svg>
    </span>
    <span class="sidebar-label font-medium">Guides</span>
  </button>

  <!-- Upgrades -->
  <button data-view="upgrades"
    class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
    aria-current="{{ 'page' if initial_view == 'upgrades' else 'false' }}"
    type="button">
    <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
      <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
        <path d="M7 7h10M7 11h10M7 15h6" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
        <path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"
          stroke="currentColor" stroke-width="1.2"/>
      </svg>
    </span>
    <span class="sidebar-label font-medium">Upgrades</span>
  </button>

  <!-- Settings -->
  <button data-view="settings"
    class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
    aria-current="{{ 'page' if initial_view == 'settings' else 'false' }}"
    type="button">
    <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
      <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.7"/>
        <path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.3-2-3.4-2.3.6a8 8 0 0 0-1.7-1L15 3h-6l-.5 2.9a8 8 0 0 0-1.7 1L4.5 6.3l-2 3.4 2 1.3a7.8 7.8 0 0 0 0 2l-2 1.3 2 3.4 2.3-.6a8 8 0 0 0 1.7 1L9 21h6l.5-2.9a8 8 0 0 0 1.7-1l2.3.6 2-3.4-2-1.3z"
          stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/>
      </svg>
    </span>
    <span class="sidebar-label font-medium">Settings</span>
  </button>

  <!-- Logout -->
  <a href="/auth/logout"
     class="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-rose-50 text-slate-700">
    <span class="h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
      <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
        <path d="M10 17l-1 0a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4h1" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
        <path d="M14 7l5 5-5 5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M19 12H10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
      </svg>
    </span>
    <span class="sidebar-label font-medium text-rose-700">Logout</span>
  </a>
</nav>


      <!-- Footer -->
      <div class="mt-auto p-3 border-t border-slate-200">
        <div class="flex items-center gap-3 px-2">
          <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            {{ (pmc_name[0] if pmc_name else "U") }}
          </div>
          <div class="sidebar-label overflow-hidden">
            <div class="text-sm font-semibold leading-4 truncate">
              {{ pmc_name if pmc_name else "User" }}
            </div>
            <div class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}Super User{% else %}PMC{% endif %}
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 min-w-0">
      <!-- Topbar -->
      <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200 hairline">
        <div class="h-16 px-6 flex items-center gap-4">
          <div class="min-w-0">
            <div id="page-title" class="text-sm font-semibold truncate">Overview</div>
            <div id="page-subtitle" class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}System health & activity{% else %}Your portfolio at a glance{% endif %}
            </div>
          </div>

          <div class="flex-1"></div>

          <div class="hidden lg:block w-[420px]">
            <div class="flex items-center gap-2 px-3 h-10 rounded-xl border border-slate-200 bg-white">
              <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <input id="globalSearch"
                class="w-full text-sm outline-none placeholder:text-slate-400"
                placeholder="{% if user_role == 'super' %}Search chats, guests, properties‚Ä¶{% else %}Search properties‚Ä¶{% endif %}" />
              <kbd class="text-[11px] px-2 py-1 rounded-lg border border-slate-200 bg-slate-50 text-slate-500">‚åò K</kbd>
            </div>
          </div>

          {% if user_role == "super" %}
          <div class="flex items-center gap-2">
            <a href="/admin/chats"
              class="h-10 px-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm grid place-items-center">
              Chats
            </a>
            <a href="/admin/new-pmc"
              class="h-10 px-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm grid place-items-center">
              New PMC
            </a>
          </div>
          {% endif %}
        </div>
      </header>

      <!-- Content -->
      <div class="p-6">

        {% set is_locked = (user_role == "pmc" and needs_payment) %}

        {% if is_locked %}
        <!-- Billing Banner -->
        <div class="mb-6 rounded-2xl border border-amber-300/60 bg-amber-50 p-4 card">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold text-amber-900">
                {{ billing_banner_title or "Complete payment to activate your account" }}
              </div>
              <div class="text-sm text-amber-900/80 mt-1">
                {{ billing_banner_body or "Your account is pending. Once payment is confirmed, you can sync properties and enable Sandy." }}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <a href="/pmc/signup"
                 class="h-10 px-4 rounded-xl bg-amber-500 hover:bg-amber-600 text-black font-semibold grid place-items-center">
                Complete setup & payment
              </a>
              <a href="/auth/login/google"
                 class="h-10 px-4 rounded-xl border border-amber-300 bg-white hover:bg-amber-50 text-amber-900 font-semibold grid place-items-center">
                Refresh login
              </a>
            </div>
          </div>
        </div>
        {% endif %}

 <!-- OVERVIEW -->
<section id="view-overview" class="view space-y-6 {% if initial_view != 'overview' %}hidden{% endif %}">

  {% set total_props = properties|length %}

  {% if is_locked %}
    {% set live_props = 0 %}
    {% set offline_props = total_props %}
  {% else %}
    {% set live_props = (properties | selectattr('sandy_enabled') | list | length) %}
    {% set offline_props = (properties | rejectattr('sandy_enabled') | list | length) %}
  {% endif %}

  <div class="grid grid-cols-12 gap-4">
    <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
      <div class="text-xs text-slate-500">Properties</div>
      <div class="mt-2 text-3xl font-semibold" id="stat-total">{{ total_props }}</div>
      <div class="mt-2 text-xs text-slate-500">Portfolio size</div>
    </div>

    <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
      <div class="text-xs text-slate-500">Live</div>
      <div class="mt-2 text-3xl font-semibold" id="stat-live">{{ live_props }}</div>
      <div class="mt-2 text-xs text-emerald-600">Sandy enabled</div>
    </div>

    <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
      <div class="text-xs text-slate-500">Offline</div>
      <div class="mt-2 text-3xl font-semibold" id="stat-offline">{{ offline_props }}</div>
      <div class="mt-2 text-xs text-rose-600">Needs attention</div>
    </div>

    <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
      <div class="text-xs text-slate-500">Last Sync</div>
      <div class="mt-2 text-lg font-semibold">
        {% if properties and properties[0].last_synced %}
          {% set seconds = (now - properties[0].last_synced).total_seconds() %}
          {% if seconds < 60 %} just now
          {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
          {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
          {% else %} {{ (seconds // 86400)|int }} days ago
          {% endif %}
        {% else %}
          ‚Äî
        {% endif %}
      </div>
      <div class="mt-2 text-xs text-slate-500">Most recent property record</div>
    </div>
  </div>

  <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold">Status Overview</div>
        <div class="text-xs text-slate-500">LIVE vs OFFLINE</div>
      </div>
      <div class="text-xs text-slate-500">Auto-updates with your data</div>
    </div>
    <div class="mt-4">
      <canvas id="statusChart" height="90"></canvas>
    </div>
  </div>

  {% if user_role == "super" %}
  <div class="grid grid-cols-12 gap-4">
    <div class="col-span-12 xl:col-span-7 bg-white border border-slate-200 rounded-2xl p-4 card">
      <div class="text-sm font-semibold">Chat Volume</div>
      <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
        Chart placeholder
      </div>
    </div>
    <div class="col-span-12 xl:col-span-5 bg-white border border-slate-200 rounded-2xl p-4 card">
      <div class="text-sm font-semibold">Priority Inbox</div>
      <div class="mt-2 text-xs text-slate-500">Escalations & time-sensitive issues</div>
      <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
        Queue placeholder
      </div>
    </div>
  </div>
  {% endif %}
</section>

<!-- PROPERTIES -->
<section id="view-properties" class="view hidden space-y-4">

  <!-- Filters / header (we hide this when config is open) -->
  <div id="propertiesHeaderCard" class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex flex-col lg:flex-row lg:items-center gap-3 justify-between">
      <div>
        <div class="text-sm font-semibold">Properties</div>
        <div class="text-xs text-slate-500">Search and manage your portfolio</div>
      </div>

      <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
        <input
          type="text"
          id="searchInput"
          placeholder="Search properties‚Ä¶"
          class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72"
        />
        <select
          id="statusFilter"
          class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-48"
        >
          <option value="all">All statuses</option>
          <option value="live">LIVE</option>
          <option value="offline">OFFLINE</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Inline Assistant Config Panel -->
  <div id="configPanelWrap" class="hidden">
    <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">Assistant Config</div>
          <div class="text-xs text-slate-500" id="configScopeLabel">Editing‚Ä¶</div>
        </div>

        <button
          type="button"
          class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm"
          onclick="closeInlineConfig()"
        >
          Close
        </button>
      </div>

      <div class="mt-4">
        <iframe
          id="configIframe"
          class="w-full rounded-xl border border-slate-200 bg-white"
          style="height: calc(100vh - 240px); min-height: 720px;"
          src="about:blank"
        ></iframe>
      </div>
    </div>
  </div>

  <!-- Property cards (we hide this when config is open) -->
  <div id="propertiesGridWrap" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
    {% for prop in properties %}
    <div class="bg-white border border-slate-200 rounded-2xl p-4 card"
         data-property-card
         data-name="{{ prop.property_name }}"
         data-live="{{ 'true' if prop.sandy_enabled else 'false' }}">

      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-lg font-semibold truncate">{{ prop.property_name }}</div>
          <div class="mt-1 text-xs text-slate-500">
            ID: {{ prop.id }}{% if prop.pms_property_id %} ‚Ä¢ PMS: {{ prop.pms_property_id }}{% endif %}
          </div>
        </div>

        {% if is_locked %}
          <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200 font-semibold">
            LOCKED
          </span>
        {% else %}
          {% if prop.sandy_enabled %}
            <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold">
              LIVE
            </span>
          {% else %}
            <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold">
              OFFLINE
            </span>
          {% endif %}
        {% endif %}
      </div>

      <div class="mt-3 text-xs text-slate-500">
        <span class="font-semibold text-slate-700">Last synced:</span>
        {% if prop.last_synced %}
          {% set seconds = (now - prop.last_synced).total_seconds() %}
          {% if seconds < 60 %} just now
          {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
          {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
          {% else %} {{ (seconds // 86400)|int }} days ago
          {% endif %}
        {% else %}
          ‚Äî
        {% endif %}
      </div>

      <div class="mt-4 flex gap-2 flex-wrap items-center">
        {% if prop.data_folder_path %}
          <a
            href="/admin/config-ui?file={{ prop.data_folder_path }}/config.json"
            onclick="return openInlineConfig('{{ prop.data_folder_path }}/config.json', '{{ prop.property_name|e }}');"
            class="h-9 px-3 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800 {% if is_locked %}opacity-50 pointer-events-none{% endif %}"
            {% if is_locked %}aria-disabled="true" tabindex="-1"{% endif %}
          >
            Assistant Config
          </a>

          <a
            href="/admin/edit-file?file={{ prop.data_folder_path }}/manual.txt"
            class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50 {% if is_locked %}opacity-50 pointer-events-none{% endif %}"
            {% if is_locked %}aria-disabled="true" tabindex="-1"{% endif %}
          >
            House Manual
          </a>
        {% endif %}

        <button
          onclick="syncProperty({{ prop.id }}, this)"
          class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
          type="button"
          {% if is_locked %}disabled{% endif %}
        >
          Sync
        </button>

        <button
          onclick="toggleProperty({{ prop.id }}, this)"
          class="h-9 px-3 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
          type="button"
          {% if is_locked %}disabled{% endif %}
        >
          {% if prop.sandy_enabled %}Take Offline{% else %}Go Live{% endif %}
        </button>

        {% if is_locked %}
          <a href="/pmc/signup" class="text-xs font-semibold text-amber-700 hover:underline ml-1">
            Unlock ‚Üí
          </a>
        {% endif %}
      </div>

    </div>
    {% endfor %}
  </div>

</section>

<script>
  // Opens the full Config UI in an iframe (keeps its CSS intact),
  // and hides the properties list until Close is pressed.
  window.openInlineConfig = function (filePath, propertyName) {
    const wrap = document.getElementById("configPanelWrap");
    const iframe = document.getElementById("configIframe");
    const label = document.getElementById("configScopeLabel");

    const grid = document.getElementById("propertiesGridWrap");
    const header = document.getElementById("propertiesHeaderCard");

    if (!wrap || !iframe) return false;

    if (label) label.textContent = `Editing: ${propertyName || ""}`.trim();

    const url = `/admin/config-ui?file=${encodeURIComponent(filePath)}`;
    iframe.src = url;

    // show config
    wrap.classList.remove("hidden");

    // hide list + filters
    if (grid) grid.classList.add("hidden");
    if (header) header.classList.add("hidden");

    // scroll into view
    wrap.scrollIntoView({ behavior: "smooth", block: "start" });

    // prevent navigation
    return false;
  };

  window.closeInlineConfig = function () {
    const wrap = document.getElementById("configPanelWrap");
    const iframe = document.getElementById("configIframe");
    const label = document.getElementById("configScopeLabel");

    const grid = document.getElementById("propertiesGridWrap");
    const header = document.getElementById("propertiesHeaderCard");

    if (iframe) iframe.src = "about:blank";
    if (label) label.textContent = "Select a property to edit its config.";

    if (wrap) wrap.classList.add("hidden");
    if (grid) grid.classList.remove("hidden");
    if (header) header.classList.remove("hidden");

    header?.scrollIntoView({ behavior: "smooth", block: "start" });
  };
</script>




        <section id="view-guides" class="view hidden space-y-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">Guides</div>
                <div class="mt-1 text-sm text-slate-500">Create and manage guest guides per property.</div>
              </div>
              <select id="guidesPropertyFilter"
                class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72">
                <option value="">All properties</option>
                {% for p in properties %}
                  <option value="{{ p.id }}">{{ p.property_name }}</option>
                {% endfor %}
              </select>
              <button
                type="button"
                onclick="Guides.openNew()"
                class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold {% if is_locked %}opacity-50 cursor-not-allowed{% endif %}"
                {% if is_locked %}disabled{% endif %}
              >
                New Guide
              </button>

            </div>
        
            {% if is_locked %}
              <div class="mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">
                Content editing is locked until payment is complete.
              </div>
            {% endif %}
        
            <div id="guides-flash" class="mt-3"></div>
        
            <div class="mt-4 grid grid-cols-12 gap-4">
              <div class="col-span-12 xl:col-span-7">
                <div id="guides-list" class="text-sm text-slate-500">Loading‚Ä¶</div>
              </div>
        
              <div class="col-span-12 xl:col-span-5">
                <div id="guides-editor" class="hidden bg-slate-50 border border-slate-200 rounded-2xl p-4">
                  <div class="flex items-center justify-between">
                    <div id="guides-editor-title" class="text-sm font-semibold">Editor</div>
                    <button class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm"
                      type="button" onclick="Guides.closeEditor()">Close</button>
                  </div>
                  <div id="guides-editor-body" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>
        </section>


        <section id="view-upgrades" class="view hidden space-y-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">Upgrades</div>
                <div class="mt-1 text-sm text-slate-500">Create and manage paid add-ons per property.</div>
              </div>
              <select id="upgradesPropertyFilter"
                class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72">
                <option value="">All properties</option>
                {% for p in properties %}
                  <option value="{{ p.id }}">{{ p.property_name }}</option>
                {% endfor %}
              </select>
              <button
              type="button"
              onclick="Upgrades.openNew()"
              class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm font-semibold
                     {% if is_locked %}
                       opacity-50 cursor-not-allowed
                     {% else %}
                       hover:bg-slate-800
                     {% endif %}"
              {% if is_locked %}disabled{% endif %}
            >
              New Upgrade
            </button>
              
            </div>
        
            {% if is_locked %}
              <div class="mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">
                Content editing is locked until payment is complete.
              </div>
            {% endif %}
        
            <div id="upgrades-flash" class="mt-3"></div>
        
            <div class="mt-4 grid grid-cols-12 gap-4">
              <div class="col-span-12 xl:col-span-7">
                <div id="upgrades-list" class="text-sm text-slate-500">Loading‚Ä¶</div>
              </div>
        
              <div class="col-span-12 xl:col-span-5">
                <div id="upgrades-editor" class="hidden bg-slate-50 border border-slate-200 rounded-2xl p-4">
                  <div class="flex items-center justify-between">
                    <div id="upgrades-editor-title" class="text-sm font-semibold">Editor</div>
                    <button class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm"
                      type="button" onclick="Upgrades.closeEditor()">Close</button>
                  </div>
                  <div id="upgrades-editor-body" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>
        </section>



        
        <section id="view-chats" class="view space-y-4 {% if initial_view != 'chats' %}hidden{% endif %}">

  <!-- Inline chat detail (replaces modal) -->
<div id="chat-detail-inline" class="hidden bg-white border border-slate-200 rounded-2xl card">
  <div class="flex items-center justify-between p-3 border-b border-slate-200">
    <div class="text-sm font-semibold text-slate-800">Chat Detail</div>
    <button type="button"
            id="chat-detail-back"
            class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
      ‚Üê Back to chats
    </button>
  </div>

  <div id="chat-detail-panel" class="p-4">
    <!-- injected partial goes here -->
  </div>
</div>


  <!-- Top strip -->
  <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
      <div>
        <div class="text-sm font-semibold">Chats</div>
        <div class="text-xs text-slate-500">
          {% if user_role == "super" %}
            Monitor all PMCs and properties.
          {% else %}
            Monitor chats across your properties.
          {% endif %}
        </div>
      </div>

      <div class="text-xs text-slate-500">
        Tip: click a row to open the conversation.
      </div>
    </div>
  </div>

  <!-- Analytics strip-->
  {% if not selected_session %}
  <div id="chat-analytics-strip" class="grid grid-cols-2 md:grid-cols-5 gap-2">
    <div class="bg-white rounded-2xl border border-slate-200 p-3 card">
      <div class="text-xs text-slate-500">Pre-booking</div>
      <div class="text-xl font-semibold">{{ analytics.pre_booking }}</div>
    </div>
    <div class="bg-white rounded-2xl border border-slate-200 p-3 card">
      <div class="text-xs text-slate-500">Active</div>
      <div class="text-xl font-semibold">{{ analytics.active }}</div>
    </div>
    <div class="bg-white rounded-2xl border border-slate-200 p-3 card">
      <div class="text-xs text-slate-500">Post-stay</div>
      <div class="text-xl font-semibold">{{ analytics.post_stay }}</div>
    </div>
    <div class="bg-white rounded-2xl border border-slate-200 p-3 card">
      <div class="text-xs text-slate-500">Urgent sessions</div>
      <div class="text-xl font-semibold">{{ analytics.urgent_sessions }}</div>
    </div>
    <div class="bg-white rounded-2xl border border-slate-200 p-3 card">
      <div class="text-xs text-slate-500">Unhappy sessions</div>
      <div class="text-xl font-semibold">{{ analytics.unhappy_sessions }}</div>
    </div>
        </div>
 {% endif %}

  <!-- FULL-WIDTH LIST -->
  <div id="chat-list-wrap" class="space-y-3">
    <!-- Filters -->
    <form id="chatFilters"
          class="bg-white rounded-2xl border border-slate-200 p-3 card flex flex-wrap gap-2 items-center"
          method="get">
      <input type="hidden" name="view" value="chats" />

      {% if user_role == "super" %}
        <select name="pmc_id" class="border rounded-xl px-2 py-2 text-sm">
          <option value="">All PMCs</option>
          {% for p in pmcs %}
            <option value="{{ p.id }}" {% if (filters.pmc_id|string) == (p.id|string) %}selected{% endif %}>
              {{ p.pmc_name }}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      <select name="property_id" class="border rounded-xl px-2 py-2 text-sm">
        <option value="">All Properties</option>
        {% for pr in properties %}
          <option value="{{ pr.id }}" {% if (filters.property_id|string) == (pr.id|string) %}selected{% endif %}>
            {{ pr.property_name }}
          </option>
        {% endfor %}
      </select>

      <select name="status" class="border rounded-xl px-2 py-2 text-sm">
        <option value="">All statuses</option>
        <option value="pre_booking" {% if filters.status=="pre_booking" %}selected{% endif %}>Pre-booking</option>
        <option value="active" {% if filters.status=="active" %}selected{% endif %}>Active</option>
        <option value="post_stay" {% if filters.status=="post_stay" %}selected{% endif %}>Post-stay</option>
      </select>

      <select name="priority" class="border rounded-xl px-2 py-2 text-sm">
        <option value="">All priorities</option>
        <option value="urgent" {% if filters.priority=="urgent" %}selected{% endif %}>üî• Urgent only</option>
        <option value="unhappy" {% if filters.priority=="unhappy" %}selected{% endif %}>üòü Unhappy only</option>
      </select>

      <label class="flex items-center gap-2 text-sm text-slate-700 px-2">
        <input type="checkbox" name="mine" value="1" {% if filters.mine %}checked{% endif %} />
        Mine
      </label>

      <input
        name="assigned_to"
        value="{{ filters.assigned_to or '' }}"
        class="border rounded-xl px-3 py-2 text-sm w-[180px]"
        placeholder="Assigned to‚Ä¶"
      />

      <input
        name="q"
        value="{{ filters.q or '' }}"
        class="border rounded-xl px-3 py-2 text-sm flex-1 min-w-[220px]"
        placeholder="Search guest, property, message‚Ä¶"
      />

      <button class="bg-slate-900 text-white rounded-xl px-4 py-2 text-sm font-semibold">Filter</button>
      <a href="/admin/dashboard?view=chats" class="text-sm text-slate-600 hover:underline ml-auto">Reset</a>
    </form>

    <script>
      document.getElementById("chatFilters")?.addEventListener("submit", (e) => {
        const form = e.currentTarget;
        const url = new URL(form.action || window.location.pathname, window.location.origin);
        const fd = new FormData(form);

        // Build query string, skipping empty values
        for (const [k, v] of fd.entries()) {
          if (String(v).trim() !== "") url.searchParams.set(k, String(v));
        }

        e.preventDefault();
        window.location.href = url.toString();
      });
    </script>

    <!-- Table -->
    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden card">
      {% if sessions %}
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3 text-left">Property</th>
              <th class="px-4 py-3 text-left">Guest</th>
              <th class="px-4 py-3 text-left">Assigned</th>
              <th class="px-4 py-3 text-left">Stage</th>
              <th class="px-4 py-3 text-left">Priority</th>
              <th class="px-4 py-3 text-left">Last</th>
              <th class="px-4 py-3 text-left">Snippet</th>
            </tr>
          </thead>

          <tbody>
            {% for s in sessions %}
              <tr
                class="border-t hover:bg-slate-50 cursor-pointer"
                onclick="openChatDetail({{ s.id }})"
              >
                <td class="px-4 py-3">
                  <div class="font-semibold">{{ s.property_name or "Unknown property" }}</div>
                  <div class="text-xs text-slate-500">ID: {{ s.property_id }}</div>

                  {% if s.escalation_level %}
                    <div class="mt-1 text-[11px]">
                      {% if s.escalation_level == "high" %}
                        <span class="px-2 py-0.5 rounded-full bg-rose-100 text-rose-800 font-semibold">üî¥ Escalation</span>
                      {% elif s.escalation_level == "medium" %}
                        <span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold">üü° Escalation</span>
                      {% else %}
                        <span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 font-semibold">üü¢ Escalation</span>
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if s.is_resolved %}
                    <div class="mt-1 text-[11px]">
                      <span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800 font-semibold">‚úÖ Resolved</span>
                    </div>
                  {% endif %}
                </td>

                <td class="px-4 py-3">
                  <div class="font-medium">{{ s.guest_name or "‚Äî" }}</div>
                </td>

                <td class="px-4 py-3 text-xs">
                  {% if s.assigned_to %}
                    <span class="inline-block px-2 py-1 rounded-xl bg-slate-100 text-slate-800 font-semibold">
                      {{ s.assigned_to }}
                    </span>
                  {% else %}
                    <span class="text-slate-400">‚Äî</span>
                  {% endif %}
                </td>

                <td class="px-4 py-3 text-xs">
                  {% if s.reservation_status == "active" %}
                    <span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-semibold">üèñ Active</span>
                  {% elif s.reservation_status == "pre_booking" %}
                    <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold">üí¨ Pre-booking</span>
                  {% elif s.reservation_status == "post_stay" %}
                    <span class="px-2 py-1 rounded-full bg-slate-200 text-slate-700 font-semibold">üì¨ Post-stay</span>
                  {% else %}
                    <span class="text-slate-400">Unknown</span>
                  {% endif %}
                </td>

                <td class="px-4 py-3 text-xs">
                  {% if s.escalation_level == "critical" %}
                    <span class="px-2 py-1 rounded-full bg-rose-100 text-rose-800 font-semibold">üî• Critical</span>
                  {% elif s.escalation_level == "attention" %}
                    <span class="px-2 py-1 rounded-full bg-amber-100 text-amber-800 font-semibold">‚ö†Ô∏è Attention</span>
                  {% else %}
                    <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 font-semibold">üï∞ Routine</span>
                  {% endif %}
                </td>

                <td class="px-4 py-3 text-xs text-slate-600">
                  {% if s.last_activity_at %}
                    <span class="js-rel-time" data-ts="{{ s.last_activity_at.isoformat() }}">
                      {{ s.last_activity_at.strftime("%b %d ¬∑ %I:%M %p") }}
                    </span>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <td class="px-4 py-3 text-xs text-slate-600">
                  {% set snip = "" %}
                  <div class="line-clamp-2" title="{{ snip }}">
                    {{ snip[:140] }}{% if snip|length > 140 %}‚Ä¶{% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="p-6 text-slate-500 text-sm">No chat sessions yet.</div>
      {% endif %}
    </div>
  </div>

  <script>
    // ----------------------------
// Inline detail helpers
// ----------------------------
function setInlineDetailOpen(open) {
  const inline = document.getElementById("chat-detail-inline");
  const list = document.getElementById("chat-list-wrap");
  const analytics = document.getElementById("chat-analytics-strip"); // ‚úÖ add
  if (!inline || !list) return;

  inline.classList.toggle("hidden", !open);
  list.classList.toggle("hidden", open);

  // ‚úÖ hide analytics while detail is open
  if (analytics) analytics.classList.toggle("hidden", open);

  if (open) inline.scrollIntoView({ behavior: "smooth", block: "start" });
}


function pushChatUrl(sessionId) {
  const url = new URL(window.location.href);
  url.searchParams.set("view", "chats");
  url.searchParams.set("session_id", String(sessionId));
  url.hash = "#chats";
  history.pushState({ session_id: String(sessionId) }, "", url.toString());
}

function clearChatUrl() {
  const url = new URL(window.location.href);
  url.searchParams.set("view", "chats");
  url.searchParams.delete("session_id");
  url.hash = "#chats";
  history.pushState({}, "", url.toString());
}

// Back button
document.addEventListener("click", (e) => {
  if (e.target && e.target.closest("#chat-detail-back")) {
    closeChatDetail();
  }
});

/*// Back/forward support
window.addEventListener("popstate", () => {
  const params = new URLSearchParams(window.location.search);
  const sid = params.get("session_id");
  if (sid) {
    setInlineDetailOpen(true);
    loadChatDetail(sid);
  } else {
    closeChatDetail();
  }
});*/

// Load on entry if session_id exists
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const sid = params.get("session_id");
  if (sid) {
    setInlineDetailOpen(true);
    loadChatDetail(sid);
  } else {
    setInlineDetailOpen(false);
  }
});


    async function chatPostJSON(url, body) {
      const res = await fetch(url, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : undefined,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) throw new Error(data.error || "Request failed");
      return data;
    }

    function initChatDetailHandlers(sessionId, panelEl) {
  const $ = (sel) => panelEl.querySelector(sel);

  const summaryBtn = $("#summary-btn");
  const summaryBox = $("#summary-box");

  summaryBtn?.addEventListener("click", async () => {
    summaryBtn.disabled = true;
    summaryBtn.textContent = "Generating‚Ä¶";
    try {
      const res = await fetch(`/admin/chats/${sessionId}/summarize`, {
        method: "POST",
        credentials: "include",
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) throw new Error(data.error || "Failed");
      if (summaryBox) summaryBox.textContent = data.summary || "";
    } catch (e) {
      if (summaryBox) summaryBox.textContent = `Summary error: ${e.message}`;
    } finally {
      summaryBtn.disabled = false;
      summaryBtn.textContent = "Generate / Refresh";
    }
  });

  $("#resolve-btn")?.addEventListener("click", async () => {
    await chatPostJSON(`/admin/chats/${sessionId}/resolve`);
    await loadChatDetail(sessionId);
  });

  $("#unresolve-btn")?.addEventListener("click", async () => {
    await chatPostJSON(`/admin/chats/${sessionId}/unresolve`);
    await loadChatDetail(sessionId);
  });

  $("#escalation-select")?.addEventListener("change", async (e) => {
    await chatPostJSON(`/admin/chats/${sessionId}/escalate`, { level: e.target.value });
    await loadChatDetail(sessionId);
  });

  $("#assign-btn")?.addEventListener("click", async () => {
    const v = $("#assigned-input")?.value || "";
    await chatPostJSON(`/admin/chats/${sessionId}/assign`, { assigned_to: v });
    await loadChatDetail(sessionId);
  });

  $("#save-note-btn")?.addEventListener("click", async () => {
    const note = $("#note-input")?.value || "";
    await chatPostJSON(`/admin/chats/${sessionId}/note`, { note });

    const s = $("#note-status");
    if (s) {
      s.textContent = "Saved ‚úÖ";
      setTimeout(() => (s.textContent = ""), 1200);
    }
  });
}


    let chatDetailAbort = null;

async function loadChatDetail(sessionId) {
  const panel = document.getElementById("chat-detail-panel");
  if (!panel) return;

  // Cancel any in-flight request so we don't render stale content
  if (chatDetailAbort) chatDetailAbort.abort();
  chatDetailAbort = new AbortController();

  panel.innerHTML = `<div class="text-sm text-slate-500">Loading‚Ä¶</div>`;

  try {
    const res = await fetch(
      `/admin/chats/partial/detail?session_id=${encodeURIComponent(sessionId)}`,
      {
        credentials: "include",
        headers: { "X-Requested-With": "fetch" },
        signal: chatDetailAbort.signal,
      }
    );

    if (res.status === 401 || res.status === 403) return loginRedirect?.();

    if (!res.ok) {
      panel.innerHTML = `<div class="text-sm text-rose-700">Could not load chat.</div>`;
      return;
    }

    panel.innerHTML = await res.text();

    // IMPORTANT: bind handlers after injection
    initChatDetailHandlers(sessionId, panel);
  } catch (err) {
    // Abort is expected when switching chats quickly
    if (err?.name === "AbortError") return;
    console.error("loadChatDetail error:", err);
    panel.innerHTML = `<div class="text-sm text-rose-700">Could not load chat.</div>`;
  }
}


   async function openChatDetail(sessionId) {
  setInlineDetailOpen(true);
  pushChatUrl(sessionId);
  await loadChatDetail(String(sessionId));
}

function closeChatDetail() {
  setInlineDetailOpen(false);
  clearChatUrl();
  const panel = document.getElementById("chat-detail-panel");
  if (panel) panel.innerHTML = "";
}

window.openChatDetail = openChatDetail;

    // ----------------------------
    // Relative time updater
    // ----------------------------
    function parseTimestamp(ts) {
      if (!ts) return null;
      const normalized = ts.includes("T") ? ts : ts.replace(" ", "T");
      const d = new Date(normalized);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatRelative(fromDate, now = new Date()) {
      const diffMs = now - fromDate;
      if (diffMs < 0) return "just now";
      const sec = Math.floor(diffMs / 1000);
      if (sec < 10) return "just now";
      if (sec < 60) return `${sec}s ago`;
      const min = Math.floor(sec / 60);
      if (min < 60) return `${min}m ago`;
      const hr = Math.floor(min / 60);
      if (hr < 24) return `${hr}h ago`;
      const day = Math.floor(hr / 24);
      if (day < 14) return `${day}d ago`;
      const wk = Math.floor(day / 7);
      if (wk < 8) return `${wk}w ago`;
      const mo = Math.floor(day / 30);
      if (mo < 12) return `${mo}mo ago`;
      const yr = Math.floor(day / 365);
      return `${yr}y ago`;
    }

    function updateRelativeTimes() {
      const now = new Date();
      document.querySelectorAll(".js-rel-time").forEach(el => {
        const ts = el.getAttribute("data-ts");
        const d = parseTimestamp(ts);
        if (!d) return;
        el.textContent = formatRelative(d, now);
      });
    }

    updateRelativeTimes();
    setInterval(updateRelativeTimes, 60 * 1000);
  </script>

</section>




        <section id="view-pmcs" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">PMCs</div>
            <div class="mt-2 text-sm text-slate-500">Create/manage PMCs, integrations, permissions.</div>
          </div>
        </section>

        <section id="view-files" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Configs & Manuals</div>
            <div class="mt-2 text-sm text-slate-500">Central file management.</div>
          </div>
        </section>

        <section id="view-analytics" class="view hidden space-y-4">
  <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <div class="text-sm font-semibold">Chat Analytics</div>
        <div class="text-xs text-slate-500">Trends & performance</div>
      </div>

      <div class="flex flex-col sm:flex-row gap-2">
        <!-- Range -->
        <select id="analyticsRange" class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>

        <!-- Super: PMC filter -->
        {% if user_role == "super" %}
          <select id="analyticsPmcFilter" class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm">
            <option value="">All PMCs</option>
            {% for p in pmcs %}
              <option value="{{ p.id }}">{{ p.pmc_name }}</option>
            {% endfor %}
          </select>
        {% endif %}

        <!-- Everyone: Property filter -->
        <select id="analyticsPropertyFilter" class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm">
          <option value="">All Properties</option>
          {% for pr in properties %}
            <option value="{{ pr.id }}">{{ pr.property_name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="mt-4 grid grid-cols-2 md:grid-cols-6 gap-2" id="analyticsCards">
      <div class="bg-slate-50 rounded-2xl border border-slate-200 p-3">
        <div class="text-xs text-slate-500">Sessions</div>
        <div class="text-xl font-semibold" data-kpi="sessions_total">‚Äî</div>
      </div>
      <div class="bg-slate-50 rounded-2xl border border-slate-200 p-3">
        <div class="text-xs text-slate-500">User msgs</div>
        <div class="text-xl font-semibold" data-kpi="user_messages">‚Äî</div>
      </div>
      <div class="bg-slate-50 rounded-2xl border border-slate-200 p-3">
        <div class="text-xs text-slate-500">Assistant msgs</div>
        <div class="text-xl font-semibold" data-kpi="assistant_messages">‚Äî</div>
      </div>
      <div class="bg-slate-50 rounded-2xl border border-slate-200 p-3">
        <div class="text-xs text-slate-500">Response rate</div>
        <div class="text-xl font-semibold" data-kpi="response_rate">‚Äî</div>
      </div>
      <div class="bg-slate-50 rounded-2xl border border-slate-200 p-3">
        <div class="text-xs text-slate-500">Followup clicks</div>
        <div class="text-xl font-semibold" data-kpi="followup_clicks">‚Äî</div>
      </div>
      <div class="bg-slate-50 rounded-2xl border border-slate-200 p-3">
        <div class="text-xs text-slate-500">Errors</div>
        <div class="text-xl font-semibold" data-kpi="chat_errors">‚Äî</div>
      </div>
    </div>

    <div class="mt-4">
      <canvas id="chatAnalyticsChart" height="100"></canvas>
    </div>
  </div>

  <!-- Top Properties table -->
  <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold">Top Properties</div>
        <div class="text-xs text-slate-500">Most active in selected range</div>
      </div>
      <div class="text-xs text-slate-500">Sorted by sessions</div>
    </div>

    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-4 py-3 text-left">Property</th>
            <th class="px-4 py-3 text-left">Sessions</th>
            <th class="px-4 py-3 text-left">Messages</th>
            <th class="px-4 py-3 text-left">Followup CTR</th>
            <th class="px-4 py-3 text-left">Errors</th>
            <th class="px-4 py-3 text-left">Escalations</th>
          </tr>
        </thead>
        <tbody id="analyticsTopPropsBody">
          <tr><td class="px-4 py-4 text-slate-500" colspan="6">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>


       

        <section id="view-settings" class="view hidden space-y-4">

  <!-- Header card -->
  <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm font-semibold">Settings</div>
        <div class="mt-1 text-sm text-slate-500">
          {% if user_role == "super" %}
            Manage your profile, PMCs, roles, and platform notifications.
          {% else %}
            Manage your profile, team, and notifications for your PMC.
          {% endif %}
        </div>
      </div>

      <div class="text-xs text-slate-500">
        Signed in as <span class="font-semibold text-slate-700">{{ user_email }}</span>
      </div>
    </div>
  </div>

  <!-- Settings layout -->
  <div class="grid grid-cols-12 gap-4">

    <!-- Settings sub-nav -->
    <aside class="col-span-12 lg:col-span-3">
      <div class="bg-white border border-slate-200 rounded-2xl p-2 card">
        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="profile" type="button">
          Profile
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="team" type="button">
          Team
        </button>

        {% if user_role == "super" %}
        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="roles" type="button">
          Roles & Permissions
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="pmcs" type="button">
          PMCs
        </button>
        {% endif %}

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="notifications" type="button">
          Notifications
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="integrations" type="button">
          Integrations
        </button>
      </div>
    </aside>

    <!-- Settings panels -->
    <div class="col-span-12 lg:col-span-9 space-y-4">

      <!-- Profile -->
      <div id="settings-profile" class="settings-panel bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Profile</div>
        <div class="mt-1 text-sm text-slate-500">Update your personal preferences.</div>

        <form id="profileForm" class="mt-4 grid grid-cols-12 gap-3">
          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Full name</label>
            <input name="full_name" value="{{ user_full_name or '' }}"
                   class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm" />
          </div>

          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Email</label>
            <input value="{{ user_email }}" disabled
                   class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-slate-50 text-slate-500" />
            <div class="mt-1 text-xs text-slate-500">Managed by Google OAuth.</div>
          </div>

          <!-- NOTE: This is safe to keep even if you haven't added a DB column yet;
               your backend can ignore it until you're ready. -->
          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Timezone</label>
            <select name="timezone" class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-white">
              <option value="">Select‚Ä¶</option>
              {% for tz in ["America/Los_Angeles","America/Denver","America/Chicago","America/New_York"] %}
                <option value="{{ tz }}" {% if user_timezone == tz %}selected{% endif %}>{{ tz }}</option>
              {% endfor %}
            </select>
            <div class="mt-1 text-xs text-slate-500">We‚Äôll use this for scheduling + notifications.</div>
          </div>

          <div class="col-span-12 md:col-span-6 flex items-end justify-end">
            <button type="submit"
              class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
              Save Profile
            </button>
          </div>
        </form>
      </div>

      <!-- Team -->
<div id="settings-team" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
  <div class="flex items-start justify-between gap-3">
    <div>
      <div class="text-sm font-semibold">Team</div>
      <div class="mt-1 text-sm text-slate-500">
        Invite cleaners, maintenance, and internal staff. Owners/Admins can edit roles and enable/disable users.
      </div>
    </div>

    <button id="openInvite"
      class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
      Invite Member
    </button>
  </div>

  <div class="mt-4 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="text-xs text-slate-500">
        <tr class="border-b border-slate-200">
          <th class="text-left py-2">Name</th>
          <th class="text-left py-2">Email</th>
          <th class="text-left py-2">Role</th>
          <th class="text-left py-2">Status</th>
          <th class="text-right py-2">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for m in team_members %}
        <tr class="border-b border-slate-100" data-member-row="{{ m.id }}">
          <td class="py-2 font-medium">{{ m.full_name or "‚Äî" }}</td>

          <td class="py-2 text-slate-600">
            <div class="flex items-center gap-2">
              <span>{{ m.email }}</span>
              {% if not m.last_login_at %}
                <span class="text-[11px] px-2 py-0.5 rounded-full border border-slate-200 bg-slate-50 text-slate-600 font-semibold">
                  Invite pending
                </span>
              {% endif %}
            </div>
          </td>

          <!-- Role -->
          <td class="py-2">
            <div class="flex items-center gap-2">
              <select
                class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm"
                data-member-role
                data-member-id="{{ m.id }}"
                data-original-role="{{ m.role or 'staff' }}"
                {% if m.email == user_email %}disabled title="You can't change your own role here."{% endif %}
              >
                {% for r in ["owner","admin","staff","ops_manager","maintenance","cleaner","read_only"] %}
                  <option value="{{ r }}" {% if (m.role or '') == r %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
              </select>

              {% if m.email != user_email %}
              <button
                class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold"
                data-member-save-role
                data-member-id="{{ m.id }}"
                type="button"
                title="Save role change"
              >
                Save
              </button>
              {% else %}
              <span class="text-xs text-slate-400">‚Äî</span>
              {% endif %}
            </div>
          </td>

          <!-- Status -->
          <td class="py-2">
            {% if m.is_active %}
              <span class="text-xs font-semibold text-emerald-700" data-member-status>Active</span>
            {% else %}
              <span class="text-xs font-semibold text-rose-700" data-member-status>Disabled</span>
            {% endif %}
          </td>

          <!-- Actions -->
          <td class="py-2 text-right">
            {% if m.email != user_email %}
            <div class="flex items-center justify-end gap-3">
              <button
                class="text-xs font-semibold hover:underline"
                data-member-toggle
                data-member-id="{{ m.id }}"
                data-next-active="{{ 'false' if m.is_active else 'true' }}"
                type="button"
              >
                {% if m.is_active %}Disable{% else %}Enable{% endif %}
              </button>

              <button
                class="text-xs font-semibold hover:underline text-rose-700"
                data-member-delete
                data-member-id="{{ m.id }}"
                data-delete-label="{% if not m.last_login_at %}Delete invite{% else %}Remove{% endif %}"
                type="button"
              >
                {% if not m.last_login_at %}Delete invite{% else %}Remove{% endif %}
              </button>
            </div>
            {% else %}
              <span class="text-xs text-slate-400">‚Äî</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}

        {% if not team_members %}
        <tr>
          <td colspan="5" class="py-6 text-center text-slate-500">No team members yet.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Invite modal -->
  <div id="inviteModal" class="hidden fixed inset-0 z-[9999] bg-black/30 p-4">
    <div class="max-w-lg mx-auto mt-24 bg-white rounded-2xl border border-slate-200 p-4 card">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Invite team member</div>
        <button id="closeInvite" class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50" type="button">‚úï</button>
      </div>

      <div class="mt-2 text-xs text-slate-500">
        We use Google OAuth. Invited users will be able to sign in with this email.
      </div>

      <form id="inviteForm" class="mt-4 space-y-3">
        <div>
          <label class="text-xs font-semibold text-slate-600">Email</label>
          <input name="email" type="email" required
                 class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm" />
        </div>

        <div>
          <label class="text-xs font-semibold text-slate-600">Role</label>
          <select name="role" class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-white">
            <option value="staff">Staff</option>
            <option value="ops_manager">Ops Manager</option>
            <option value="maintenance">Maintenance</option>
            <option value="cleaner">Cleaner</option>
            <option value="read_only">Read-only</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
          </select>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancelInvite"
                  class="h-10 px-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
            Cancel
          </button>
          <button type="submit"
                  class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
            Send Invite
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


      {% if user_role == "super" %}
      <!-- Roles & Permissions (superusers) -->
      <div id="settings-roles" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Roles & Permissions</div>
        <div class="mt-1 text-sm text-slate-500">
          Define roles (cleaner, maintenance, staff) and what they can access.
        </div>

        <div class="mt-4 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm text-slate-700">
          MVP suggestion: start with fixed roles + hardcoded permissions, then move to DB-driven roles.
        </div>
      </div>

      <!-- PMCs (superusers) -->
      <div id="settings-pmcs" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">PMCs</div>
        <div class="mt-1 text-sm text-slate-500">Activate/deactivate PMCs, billing status, support tools.</div>
      </div>
      {% endif %}

      <!-- Notifications -->
      <div id="settings-notifications" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Notifications</div>
        <div class="mt-1 text-sm text-slate-500">
          Choose what you get notified about. Slack settings will live here later.
        </div>

        {% set prefs = notif_prefs or {} %}

        <form id="notifForm" class="mt-4 space-y-3">

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Guest messages</div>
              <div class="text-xs text-slate-500">Notify when a new guest message arrives.</div>
            </div>
            <input name="guest_messages" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("guest_messages") %}checked{% endif %} />
          </label>

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Maintenance assigned</div>
              <div class="text-xs text-slate-500">Notify when a maintenance request is assigned.</div>
            </div>
            <input name="maintenance_assigned" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("maintenance_assigned") %}checked{% endif %} />
          </label>

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Turnover due soon</div>
              <div class="text-xs text-slate-500">Notify when a cleaner task is due soon.</div>
            </div>
            <input name="turnover_due" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("turnover_due") %}checked{% endif %} />
          </label>

          <div class="flex justify-end pt-2">
            <button type="submit"
              class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
              Save Notifications
            </button>
          </div>
        </form>

        <div class="mt-4 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm text-slate-700">
          Slack (coming soon): connect workspace, pick channel per event, and map properties ‚Üí channels.
        </div>
      </div>

      <!-- Integrations -->
      <div id="settings-integrations" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Integrations</div>
        <div class="mt-1 text-sm text-slate-500">PMS, Slack, and other connections.</div>
      </div>

    </div>
  </div>
</section>



      </div>

                    <!-- Assistant Config Drawer -->
<div id="configDrawer" class="fixed inset-0 z-[9999] hidden">
  <!-- Backdrop -->
  <div
    class="absolute inset-0 bg-black/30"
    onclick="closeAssistantConfig()"
    aria-hidden="true"
  ></div>

  <!-- Panel -->
  <div class="absolute right-0 top-0 h-full w-full sm:max-w-[720px] bg-white border-l border-slate-200 shadow-2xl flex flex-col">
    <div class="h-16 px-5 flex items-center justify-between border-b border-slate-200">
      <div class="min-w-0">
        <div class="text-sm font-semibold">Assistant Config</div>
        <div id="configDrawerLabel" class="text-xs text-slate-500 truncate">Select a property</div>
      </div>

      <button
        type="button"
        class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm"
        onclick="closeAssistantConfig()"
      >
        Close
      </button>
    </div>

    <div id="configDrawerBody" class="flex-1 overflow-auto p-4 bg-slate-50">
      <div class="text-sm text-slate-500">Select a property to edit its config.</div>
    </div>
  </div>
</div>

    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

 <script>
  // -------- Paywall flag (server-rendered) --------
  const IS_LOCKED = {{ 'true' if (user_role == 'pmc' and needs_payment) else 'false' }};
  const CONTENT_LOCKED = IS_LOCKED;


 // let chatAnalyticsChart = null;

// ----------------------------
// Analytics (clean + single load function)
// ----------------------------

// ----------------------------
// Analytics (single definition)
// ----------------------------
window.chatAnalyticsChart = window.chatAnalyticsChart || null;

function rangeToMs(days) {
  const to = Date.now();
  const from = to - (Number(days) * 24 * 60 * 60 * 1000);
  return { from, to };
}

function fmtPct(x) {
  const n = Number(x);
  if (!Number.isFinite(n)) return "‚Äî";
  return `${Math.round(n * 1000) / 10}%`;
}

function getAnalyticsFilters() {
  const days = document.getElementById("analyticsRange")?.value || 30;
  const propertyId = document.getElementById("analyticsPropertyFilter")?.value || "";
  const pmcId = document.getElementById("analyticsPmcFilter")?.value || ""; // super only
  return { days, propertyId, pmcId };
}

function buildAnalyticsQS({ from, to, propertyId, pmcId }) {
  const qs = new URLSearchParams({ from: String(from), to: String(to) });
  if (propertyId) qs.set("property_id", String(propertyId));
  if (pmcId) qs.set("pmc_id", String(pmcId));
  return qs.toString();
}

async function loadTopProperties({ from, to, pmcId, propertyId }) {
  const tbody = document.getElementById("analyticsTopPropsBody");
  if (!tbody) return;

  const qs = new URLSearchParams({ from: String(from), to: String(to), limit: "10" });
  if (pmcId) qs.set("pmc_id", String(pmcId));
  if (propertyId) qs.set("property_id", String(propertyId)); // ‚úÖ add


  tbody.innerHTML = `<tr><td class="px-4 py-4 text-slate-500" colspan="6">Loading‚Ä¶</td></tr>`;

  const res = await fetch(`/admin/analytics/chat/top-properties?${qs.toString()}`, {
    credentials: "include",
    headers: { Accept: "application/json" },
  });

  if (res.status === 401 || res.status === 403) return loginRedirect();

  const data = await res.json().catch(() => ({}));
  const rows = data.rows || [];

  if (!rows.length) {
    tbody.innerHTML = `<tr><td class="px-4 py-4 text-slate-500" colspan="6">No data yet.</td></tr>`;
    return;
  }

  const selectedPid = (propertyId || "").trim();

  tbody.innerHTML = rows.map((r) => {
    const pid = String(r.property_id ?? "");
    const isSelected = selectedPid && pid === selectedPid;

    return `
      <tr class="border-t ${isSelected ? "bg-slate-50" : ""}">
        <td class="px-4 py-3 font-medium">${r.property_name ? r.property_name : `#${pid}`}</td>
        <td class="px-4 py-3">${r.sessions ?? 0}</td>
        <td class="px-4 py-3">${r.messages ?? 0}</td>
        <td class="px-4 py-3">${fmtPct(r.followup_conversion_rate)}</td>
        <td class="px-4 py-3">${r.chat_errors ?? 0}</td>
        <td class="px-4 py-3">${r.contact_host_clicks ?? 0}</td>
      </tr>
    `;
  }).join("");
}

async function loadChatAnalytics(daysOverride = null) {
  try {
    const { days, propertyId, pmcId } = getAnalyticsFilters();
    const daysToUse = daysOverride != null ? daysOverride : days;

    const { from, to } = rangeToMs(daysToUse);
    const qs = buildAnalyticsQS({ from, to, propertyId, pmcId });

    // Summary KPIs
    const summaryRes = await fetch(`/admin/analytics/chat/summary?${qs}`, {
      credentials: "include",
      headers: { Accept: "application/json" },
    });
    if (summaryRes.status === 401 || summaryRes.status === 403) return loginRedirect();
    const summary = await summaryRes.json().catch(() => ({}));

    document.querySelectorAll("[data-kpi]").forEach((el) => {
      const k = el.getAttribute("data-kpi");
      let val = summary?.[k];

      if (k === "response_rate") val = fmtPct(val);

      el.textContent = (val != null && val !== "") ? String(val) : "0";
    });

    // Timeseries
// Timeseries
// Timeseries (robust chart init/update)
const tsRes = await fetch(`/admin/analytics/chat/timeseries?bucket=day&${qs}`, {
  credentials: "include",
  headers: { Accept: "application/json" },
});
if (tsRes.status === 401 || tsRes.status === 403) return loginRedirect();

let ts = {};
try {
  if (!tsRes.ok) throw new Error(`timeseries HTTP ${tsRes.status}`);
  ts = await tsRes.json();
} catch (e) {
  console.error("timeseries parse/fetch failed:", e);
  ts = { labels: [], series: {} };
}

const canvas = document.getElementById("chatAnalyticsChart");
if (!canvas || typeof canvas.getContext !== "function" || !window.Chart) {
  console.warn("Chart canvas or Chart.js missing; skipping render.");
} else {
  const ctx = canvas.getContext("2d");

  const labels = Array.isArray(ts.labels) ? ts.labels : [];
  const series = ts.series && typeof ts.series === "object" ? ts.series : {};

  const sessions = Array.isArray(series.sessions) ? series.sessions : [];
  const messages = Array.isArray(series.messages) ? series.messages : [];
  const followupClicks = Array.isArray(series.followup_clicks) ? series.followup_clicks : [];
  const chatErrors = Array.isArray(series.chat_errors) ? series.chat_errors : [];

  const datasets = [
    { label: "Sessions", data: sessions },
    { label: "Messages", data: messages },
    { label: "Followup clicks", data: followupClicks },
    { label: "Errors", data: chatErrors },
  ];

  const existing = window.chatAnalyticsChart;

  // Valid Chart.js instance check
  const isValidChart =
    existing &&
    typeof existing.update === "function" &&
    existing.data &&
    typeof existing.data === "object" &&
    Array.isArray(existing.data.datasets);

  // If something non-chart got assigned, clean it up
  if (existing && !isValidChart) {
    try { existing.destroy?.(); } catch {}
    window.chatAnalyticsChart = null;
  }

  if (!window.chatAnalyticsChart) {
    window.chatAnalyticsChart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } },
      },
    });
  } else {
    // Ensure dataset slots exist (in case something mutated the chart)
    window.chatAnalyticsChart.data.labels = labels;
    window.chatAnalyticsChart.data.datasets = datasets;
    window.chatAnalyticsChart.update();
  }
}



    await loadTopProperties({ from, to, pmcId, propertyId });
  } catch (err) {
    console.error("loadChatAnalytics failed:", err);
    toast("Analytics failed to load (check console).");
  }
}

function resizeChatAnalyticsChartSoon() {
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      if (window.chatAnalyticsChart && typeof window.chatAnalyticsChart.resize === "function") {
        window.chatAnalyticsChart.resize();
      }
    });
  });
}

// Debounced filter reload ONLY when Analytics view is visible
let analyticsDebounce = null;
function isAnalyticsVisible() {
  const el = document.getElementById("view-analytics");
  return el && !el.classList.contains("hidden");
}

document.addEventListener("change", (e) => {
  const t = e.target;
  if (!t || !(t instanceof HTMLElement)) return;

  const isAnalyticsControl =
    t.id === "analyticsRange" ||
    t.id === "analyticsPropertyFilter" ||
    t.id === "analyticsPmcFilter";

  if (!isAnalyticsControl) return;
  if (!isAnalyticsVisible()) return;

  const days = document.getElementById("analyticsRange")?.value || 30;

  clearTimeout(analyticsDebounce);
  analyticsDebounce = setTimeout(() => {
    loadChatAnalytics(days);
    resizeChatAnalyticsChartSoon();
  }, 150);
});


   

  // ----------------------------
  // Small UI helpers
  // ----------------------------
  function toast(message) {
    const el = document.createElement("div");
    el.className =
      "fixed bottom-5 right-5 z-[9999] bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-lg";
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2400);
  }

  function loginRedirect() {
    const next = encodeURIComponent(
      window.location.pathname + window.location.search + window.location.hash
    );
    window.location.href = `/auth/login/google?next=${next}`;
  }

  async function apiJson(url, opts = {}) {
  const res = await fetch(url, {
    credentials: "include",
    headers: { Accept: "application/json", ...(opts.headers || {}) },
    ...opts,
  });

  if (res.status === 401 || res.status === 403) {
    toast("Session expired. Please sign in again.");
    loginRedirect();
    throw new Error("auth");
  }

  const text = await res.text().catch(() => "");
  let data = {};
  try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

  return { res, data };
}

  async function postJson(url) {
    return fetch(url, {
      method: "POST",
      credentials: "include",
      headers: { Accept: "application/json" },
    });
  }

  // ----------------------------
  // Overview counters + chart refresh (no hard refresh)
  // NOTE: make sure your HTML has:
  //   <div id="stat-total">...</div>
  //   <div id="stat-live">...</div>
  //   <div id="stat-offline">...</div>
  // ----------------------------
  let statusChartInstance = null;

  function recomputeLiveOffline() {
    const cards = document.querySelectorAll("[data-property-card]");
    const total = cards.length;
    let live = 0;
    cards.forEach((c) => {
      if (c.dataset.live === "true") live += 1;
    });
    return { total, live, offline: total - live };
  }

  function updateOverviewUI() {
    const { total, live, offline } = recomputeLiveOffline();

    const totalEl = document.getElementById("stat-total");
    const liveEl = document.getElementById("stat-live");
    const offEl = document.getElementById("stat-offline");

    if (totalEl) totalEl.textContent = String(total);
    if (liveEl) liveEl.textContent = String(live);
    if (offEl) offEl.textContent = String(offline);

    if (statusChartInstance) {
      statusChartInstance.data.datasets[0].data = [live, offline];
      statusChartInstance.update();
    }
  }

  // ----------------------------
  // Sidebar collapse/expand
  // ----------------------------
  function initSidebar() {
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebar-toggle");
    const labelEls = () =>
      Array.from(document.querySelectorAll(".sidebar-label"));

    if (!sidebar || !toggleBtn) return;

    function setCollapsed(isCollapsed) {
      sidebar.classList.toggle("w-72", !isCollapsed);
      sidebar.classList.toggle("w-20", isCollapsed);
      labelEls().forEach((el) => el.classList.toggle("hidden", isCollapsed));

      const svg = toggleBtn.querySelector("svg");
      if (svg) {
        svg.style.transform = isCollapsed ? "rotate(180deg)" : "rotate(0deg)";
        svg.style.transition = "transform 200ms ease";
      }
      localStorage.setItem(
        "dashboard_sidebar_collapsed",
        isCollapsed ? "1" : "0"
      );
    }

    setCollapsed(localStorage.getItem("dashboard_sidebar_collapsed") === "1");

    toggleBtn.addEventListener("click", () => {
      const isCollapsed = sidebar.classList.contains("w-20");
      setCollapsed(!isCollapsed);
    });

    // ‚åòK focus
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        document.getElementById("globalSearch")?.focus();
      }
    });
  }

  // ----------------------------
  // Properties filter
  // ----------------------------
  function filterProperties() {
    const search = (
      document.getElementById("searchInput")?.value || ""
    ).toLowerCase();
    const status = document.getElementById("statusFilter")?.value || "all";
    const cards = document.querySelectorAll("[data-property-card]");

    cards.forEach((card) => {
      const name = (card.dataset.name || "").toLowerCase();
      const live = card.dataset.live === "true";
      const matchesSearch = name.includes(search);
      const matchesStatus =
        status === "all" ||
        (status === "live" && live) ||
        (status === "offline" && !live);

      card.style.display = matchesSearch && matchesStatus ? "" : "none";
    });
  }
  window.filterProperties = filterProperties;

  // ----------------------------
  // Property actions
  // ----------------------------
  window.syncProperty = async function (id, btn) {
    if (IS_LOCKED) return toast("Complete payment to unlock property syncing.");

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = "Syncing‚Ä¶";

    try {
      const res = await postJson(`/auth/sync-property/${id}`);

      if (res.status === 401 || res.status === 403) return loginRedirect();
      if (res.status === 402) return (window.location.href = "/pmc/signup");

      let data = {};
      try {
        data = await res.json();
      } catch {}
      btn.innerHTML =
        res.ok && data.status === "success"
          ? "Synced ‚úì"
          : data.message || data.detail || "Failed";
    } catch (err) {
      console.error("Sync error:", err);
      btn.innerHTML = "Error";
    } finally {
      setTimeout(() => {
        btn.innerHTML = original;
        btn.disabled = false;
      }, 1200);
    }
  };

  window.toggleProperty = async function (id, btn) {
    if (IS_LOCKED) return toast("Complete payment to unlock Sandy activation.");

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = "Toggling‚Ä¶";

    try {
      const res = await postJson(`/auth/toggle-property/${id}`);
      if (res.status === 401 || res.status === 403) return loginRedirect();

      let data = null;
      try {
        data = await res.json();
      } catch {
        data = null;
      }

      if (data && data.status === "needs_billing" && data.checkout_url) {
        window.location.href = data.checkout_url;
        return;
      }

      if (!res.ok) {
        toast((data && (data.detail || data.message)) || "Request failed");
        btn.innerHTML = original;
        return;
      }

      if (data && data.status === "success") {
        const isLive = data.new_status === "LIVE";
        btn.innerHTML = isLive ? "Take Offline" : "Go Live";

        const card = btn.closest("[data-property-card]");
        if (card) {
          card.dataset.live = isLive ? "true" : "false";

          const pill = card.querySelector("span.rounded-full");
          if (pill) {
            if (isLive) {
              pill.textContent = "LIVE";
              pill.className =
                "shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold";
            } else {
              pill.textContent = "OFFLINE";
              pill.className =
                "shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold";
            }
          }
        }

        filterProperties();
        updateOverviewUI(); // ‚úÖ update overview immediately
        return;
      }

      btn.innerHTML = original;
      toast("Toggle failed.");
    } catch (err) {
      console.error("Toggle error:", err);
      btn.innerHTML = original;
      toast("Network error. Please try again.");
    } finally {
      btn.disabled = false;
    }
  };


   document.addEventListener("click", (e) => {
  const editBtn = e.target.closest("[data-guide-edit]");
  if (editBtn) {
    const id = (editBtn.getAttribute("data-guide-edit") || "").trim();
    if (id) Guides.openEdit(id);
    return;
  }

  const delBtn = e.target.closest("[data-guide-delete]");
  if (delBtn) {
    const id = (delBtn.getAttribute("data-guide-delete") || "").trim();
    if (id) Guides.remove(id);
    return;
  }
});

  

   document.addEventListener("change", async (e) => {
  const el = e.target;
  if (!(el instanceof HTMLInputElement)) return;
  if (!el.matches("[data-guide-active]")) return;

  if (window.CONTENT_LOCKED) {
    toast("Complete payment to unlock Guides.");
    el.checked = !el.checked;
    return;
  }

  const id = el.dataset.guideId;
  const checked = el.checked;

  const row = el.closest("[data-guide-row]");
  const label = row?.querySelector("[data-guide-status-label]");

  if (label) {
    label.textContent = checked ? "Active" : "Inactive";
    label.className =
      "text-xs font-semibold " + (checked ? "text-emerald-700" : "text-slate-400");
  }

  try {
    const { res, data } = await apiJson("/admin/guides/ajax/toggle-active", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, is_active: checked }),
    });

    if (!res.ok || !data.ok) {
      toast(data.error || "Failed to update.");
      el.checked = !checked;

      if (label) {
        const reverted = el.checked;
        label.textContent = reverted ? "Active" : "Inactive";
        label.className =
          "text-xs font-semibold " + (reverted ? "text-emerald-700" : "text-slate-400");
      }
    }
  } catch (err) {
    toast("Failed to update.");
    el.checked = !checked;

    if (label) {
      const reverted = el.checked;
      label.textContent = reverted ? "Active" : "Inactive";
      label.className =
        "text-xs font-semibold " + (reverted ? "text-emerald-700" : "text-slate-400");
    }
  }
});

   window.Chats = {
  async refreshSummary(sessionId) {
    const box = document.getElementById("summary-box");
    if (!box) return;

    try {
      box.textContent = "Generating‚Ä¶";
      const res = await fetch(`/admin/chats/${sessionId}/summarize`, { method: "POST", credentials: "include" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) throw new Error(data.error || "Failed");
      box.textContent = data.summary || "";
    } catch (e) {
      box.textContent = `Summary error: ${e.message}`;
    }
  }
};

   function initQuillEditor({ editorId, inputId, placeholder = "" }) {
  const editorEl = document.getElementById(editorId);
  const inputEl = document.getElementById(inputId);

  if (!editorEl || !inputEl) {
    console.warn("Quill init skipped: missing elements", { editorId, inputId });
    return null;
  }
  if (!window.Quill) {
    console.warn("Quill init skipped: Quill library not loaded");
    return null;
  }

  // Prevent double-init if you reopen editor
  if (editorEl.__quill) return editorEl.__quill;

  const quill = new Quill(editorEl, {
    theme: "snow",
    placeholder,
    modules: {
      toolbar: [
        ["bold", "italic", "underline", "strike"],
        [{ header: [1, 2, 3, false] }],
        [{ list: "ordered" }, { list: "bullet" }],
        ["link", "blockquote"],
        ["clean"]
      ],
    },
  });

  // seed initial content from hidden input
  quill.root.innerHTML = inputEl.value || "";

  // keep hidden input updated for form submit
  quill.on("text-change", () => {
    inputEl.value = quill.root.innerHTML;
  });

  editorEl.__quill = quill;
  return quill;
}


// ----------------------------
// Upgrades (single definition + resilient AJAX handling)
// ----------------------------
window.Upgrades = {
  loaded: false,

async refresh() {
  const listEl = document.getElementById("upgrades-list");
  if (!listEl) return;

  const pid = document.getElementById("upgradesPropertyFilter")?.value || "";
  const qs = pid ? `?property_id=${encodeURIComponent(pid)}` : "";

  listEl.innerHTML = "Loading‚Ä¶";

  try {
    const res = await fetch(`/admin/upgrades/partial/list${qs}`, {
      credentials: "include",
      headers: { "X-Requested-With": "fetch" },
    });

    if (res.status === 401 || res.status === 403) return loginRedirect();
    if (!res.ok) {
      listEl.innerHTML = "Could not load upgrades.";
      return;
    }

    const html = await res.text();
    listEl.innerHTML = html;

    // ‚úÖ Always rebind after injection (don‚Äôt rely on local query only)
    initAllReorderTables();

    console.log("Upgrades list refreshed; reorder bound:", !!listEl.querySelector("table[data-list-kind]"));
  } catch (err) {
    console.error("Upgrades.refresh error:", err);
    listEl.innerHTML = "Could not load upgrades.";
  }
},

  openNew() {
    return window.Upgrades.openEditor(null);
  },

async openEditor(id) {
  if (window.CONTENT_LOCKED) return toast("Complete payment to unlock Upgrades.");

  const editorWrap = document.getElementById("upgrades-editor");
  const editorBody = document.getElementById("upgrades-editor-body");
  const editorTitle = document.getElementById("upgrades-editor-title");
  if (!editorWrap || !editorBody) return;

  const url = id
    ? `/admin/upgrades/partial/form?id=${encodeURIComponent(id)}`
    : `/admin/upgrades/partial/form`;

  // Show modal immediately (better UX, and ensures DOM exists)
  if (editorTitle) editorTitle.textContent = id ? "Edit Upgrade" : "New Upgrade";
  editorWrap.classList.remove("hidden");
  editorBody.innerHTML = `<div class="text-sm text-slate-500">Loading‚Ä¶</div>`;

  try {
    const res = await fetch(url, { credentials: "include" });

    if (res.status === 401 || res.status === 403) return loginRedirect();
    if (!res.ok) {
      editorBody.innerHTML = `<div class="text-sm text-rose-700">Could not load upgrade editor.</div>`;
      return;
    }

    editorBody.innerHTML = await res.text();

    // ‚úÖ Don‚Äôt let editor init break the modal
    try {
      if (typeof initQuillEditor === "function") {
        initQuillEditor({
          editorId: "upgrade-longdesc-editor",
          inputId: "upgrade-longdesc-input",
          placeholder: "Shown in the upgrade details / guest UI...",
        });
      } else {
        console.warn("initQuillEditor is not defined (Quill init skipped).");
      }
    } catch (e) {
      console.error("Quill init failed (skipped):", e);
    }
  } catch (err) {
    console.error("Fetch failed:", err);
    editorBody.innerHTML = `<div class="text-sm text-rose-700">Network error loading editor.</div>`;
  }
},


  closeEditor() {
    document.getElementById("upgrades-editor")?.classList.add("hidden");
    const body = document.getElementById("upgrades-editor-body");
    if (body) body.innerHTML = "";
  },

  async submit(form) {
    if (window.CONTENT_LOCKED) return toast("Complete payment to unlock Upgrades.");
    if (!form) return;

    const flash = document.getElementById("upgrades-flash");

    const showFlash = (msg, ok = true) => {
      if (!flash) return toast(msg);

      flash.innerHTML = `
        <div class="rounded-xl border ${
          ok
            ? "border-emerald-200 bg-emerald-50 text-emerald-900"
            : "border-rose-200 bg-rose-50 text-rose-900"
        } p-3 text-sm">
          ${msg}
        </div>`;

      setTimeout(() => {
        if (flash) flash.innerHTML = "";
      }, 2400);
    };

    try {
      const res = await fetch("/admin/upgrades/ajax/save", {
        method: "POST",
        credentials: "include",
        body: new FormData(form),
      });

      if (res.status === 401 || res.status === 403) return loginRedirect();

      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      if (!contentType.includes("application/json")) {
        const text = await res.text().catch(() => "");
        console.error("Save returned non-JSON:", {
          status: res.status,
          contentType,
          preview: text.slice(0, 500),
        });
        showFlash("Save failed (server returned non-JSON).", false);
        return;
      }

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok) {
        showFlash(data.error || data.detail || data.message || "Save failed.", false);
        return;
      }

      showFlash("Saved ‚úì", true);
      await window.Upgrades.refresh();
      window.Upgrades.closeEditor();
    } catch (err) {
      console.error(err);
      showFlash("Network error saving upgrade.", false);
    }
  },
};




   document.addEventListener("input", (e) => {
  const titleInput = e.target;
  if (!(titleInput instanceof HTMLInputElement)) return;
  if (!titleInput.matches('input[name="title"]')) return;

  const form = titleInput.closest("form");
  if (!form) return;

  const slugInput = form.querySelector('[data-upgrade-slug]');
  if (!slugInput) return;

  // Only auto-generate if slug is empty (don‚Äôt overwrite existing edits)
  if (slugInput.value) return;

  slugInput.value = titleInput.value
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");
});


   // Upgrade image upload (delegated ‚Äî works for AJAX-loaded form)
/*document.addEventListener("change", async (e) => {
  const input = e.target;
  if (!(input instanceof HTMLInputElement)) return;
  if (!input.matches("[data-upgrade-image-file]")) return;

  if (IS_LOCKED) {
    toast("Complete payment to unlock Upgrades.");
    input.value = "";
    return;
  }

  const file = input.files?.[0];
  if (!file) return;

  const editor = input.closest("#upgrades-editor-body") || document;
  const hiddenUrl = editor.querySelector("[data-upgrade-image-url]");
  const preview = editor.querySelector("[data-upgrade-image-preview]");
  const upgradeId = editor.querySelector('input[name="id"]')?.value || "";

  try {
    toast("Uploading image‚Ä¶");

    const fd = new FormData();
    fd.append("file", file);
    if (upgradeId) fd.append("upgrade_id", upgradeId);

    const res = await fetch("/admin/upgrades/ajax/upload-image", {
      method: "POST",
      credentials: "include",
      body: fd,
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok || !data.url) {
      toast(data.error || "Upload failed.");
      return;
    }

    // Persist for Save Upgrade
    if (hiddenUrl) hiddenUrl.value = data.url;

    // Preview
    if (preview) {
      preview.src = data.url;
      preview.classList.remove("hidden");
    }

    toast("Image uploaded ‚úì");
  } catch (err) {
    console.error(err);
    toast("Upload failed.");
  } finally {
    // allow re-uploading same file
    input.value = "";
  }
});*/

// Upload image (delegated) ‚Äî works after partial loads
document.addEventListener("click", async (e) => {
  const uploadBtn = e.target.closest("[data-upgrade-image-upload]");
  if (!uploadBtn) return;

  const form = uploadBtn.closest("form");
  if (!form) return;

  const fileInput = form.querySelector("[data-upgrade-image-file]");
  const preview = form.querySelector("[data-upgrade-image-preview]");
  const tmpKeyInput = form.querySelector('input[name="image_tmp_key"]');
  const imageUrlInput = form.querySelector('input[name="image_url"]'); // keep existing DB value!

  const file = fileInput?.files?.[0];
  if (!file) return toast("Choose an image first.");

  const fd = new FormData();
  fd.append("file", file);

  // If editing, pass upgrade id (optional, but useful on backend)
  const upgradeId = (form.querySelector('input[name="id"]')?.value || "").trim();
  if (upgradeId) fd.append("upgrade_id", upgradeId);

  // IMPORTANT: pass previous tmp key so backend can delete/replace it
  const prevTmpKey = (tmpKeyInput?.value || "").trim();
  if (prevTmpKey) fd.append("prev_tmp_key", prevTmpKey);

  uploadBtn.disabled = true;
  const original = uploadBtn.textContent;
  uploadBtn.textContent = "Uploading‚Ä¶";

  try {
    const res = await fetch("/admin/upgrades/ajax/upload-image", {
      method: "POST",
      credentials: "include",
      body: fd,
    });

    if (res.status === 401 || res.status === 403) return loginRedirect();

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      toast(data.error || "Upload failed.");
      return;
    }

    // Set ONLY the temp key (for finalize on Save)
    if (tmpKeyInput) tmpKeyInput.value = data.tmp_key || "";

    // DO NOT overwrite the saved image_url here if using tmp-key finalize workflow.
    // Keep existing DB image_url until Save runs.
    // imageUrlInput.value should only be changed in /admin/upgrades/ajax/save after finalize.
    // (But we can still show preview below.)

    // Preview from returned preview_url (could be temp-served or final)
    const previewUrl = data.preview_url || "";
    if (preview) {
      preview.src = previewUrl;
      preview.classList.toggle("hidden", !previewUrl);
    }

    // Optional: visually indicate pending unsaved change
    // e.g., store a data flag for later if you want
    if (imageUrlInput) imageUrlInput.dataset.pendingUpload = "1";

    // Clear file input so user can reselect same file again if needed
    if (fileInput) fileInput.value = "";

    toast("Image uploaded. Click Save Upgrade to apply.");
  } catch (err) {
    console.error(err);
    toast("Upload failed.");
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.textContent = original;
  }
});


document.addEventListener("click", async (e) => {
  const clearBtn = e.target.closest("[data-upgrade-image-clear]");
  if (!clearBtn) return;

  const form = clearBtn.closest("form");
  if (!form) return;

  const preview = form.querySelector("[data-upgrade-image-preview]");
  const imageUrlInput = form.querySelector('input[name="image_url"]');
  const tmpKeyInput = form.querySelector('input[name="image_tmp_key"]');

  const tmpKey = (tmpKeyInput?.value || "").trim();

  // Clear UI immediately
  if (preview) {
    preview.src = "";
    preview.classList.add("hidden");
  }
  if (imageUrlInput) imageUrlInput.value = "";   // clear persisted url
  if (tmpKeyInput) tmpKeyInput.value = "";       // clear temp key

  // If there was a temp upload, delete it server-side
  if (tmpKey) {
    try {
      const res = await fetch("/admin/upgrades/ajax/delete-temp-image", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tmp_key: tmpKey }),
      });
      if (res.status === 401 || res.status === 403) return loginRedirect();
    } catch (err) {
      console.error(err);
    }
  }

  toast("Image removed.");
});


// Upgrades: delegated events (ONLY ONCE)
document.addEventListener("click", async (e) => {
  // Edit
  const editBtn = e.target.closest("[data-upgrade-edit]");
  if (editBtn) {
    const id = (editBtn.getAttribute("data-upgrade-edit") || "").trim();
    if (!id || id === "None" || id === "null" || id === "undefined") return;
    Upgrades.openEditor(id);
    return;
  }

  // Delete
  const delBtn = e.target.closest("[data-upgrade-delete]");
  if (!delBtn) return;

  if (window.CONTENT_LOCKED) {
    toast("Complete payment to unlock Upgrades.");
    return;
  }

  const id = (delBtn.getAttribute("data-upgrade-delete") || "").trim();
  if (!id || id === "None" || id === "null" || id === "undefined") return;

  if (!confirm("Delete this upgrade?")) return;

  try {
    const { res, data } = await apiJson(`/admin/upgrades/ajax/delete?id=${encodeURIComponent(id)}`, {
      method: "POST",
    });

    if (!res.ok || !data.ok) {
      toast(data.error || data.detail || "Delete failed.");
      return;
    }

    toast("Upgrade deleted");
    await Upgrades.refresh();
    Upgrades.closeEditor();
  } catch (err) {
    console.error(err);
    toast("Delete failed.");
  }
});


/*
   // Upgrade image upload (delegated)
document.addEventListener("change", async (e) => {
  const input = e.target;
  if (!(input instanceof HTMLInputElement)) return;
  if (!input.matches("[data-upgrade-image-file]")) return;

  if (IS_LOCKED) {
    toast("Complete payment to unlock Upgrades.");
    input.value = "";
    return;
  }

  const file = input.files?.[0];
  if (!file) return;

  const editor = input.closest("#upgrades-editor-body") || document;
  const hiddenUrl = editor.querySelector("[data-upgrade-image-url]");
  const preview = editor.querySelector("[data-upgrade-image-preview]");
  const upgradeId = editor.querySelector('input[name="id"]')?.value || "";

  try {
    toast("Uploading image‚Ä¶");

    const fd = new FormData();
    fd.append("file", file);
    if (upgradeId) fd.append("upgrade_id", upgradeId);

    const res = await fetch("/admin/upgrades/ajax/upload-image", {
      method: "POST",
      credentials: "include",
      body: fd,
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok || !data.url) {
      toast(data.error || "Upload failed.");
      return;
    }

    if (hiddenUrl) hiddenUrl.value = data.url;

    if (preview) {
      preview.src = data.url;
      preview.classList.remove("hidden");
    }

    toast("Image uploaded ‚úì");
  } catch (err) {
    console.error(err);
    toast("Upload failed.");
  } finally {
    input.value = "";
  }
});
*/



   

  document.addEventListener("change", async (e) => {
    const el = e.target;
    if (!(el instanceof HTMLInputElement)) return;
    if (!el.matches("[data-upgrade-active]")) return;

    const id = el.dataset.upgradeId;
    const checked = el.checked;

    // Optional: label support if you add it in the table partial
    const row = el.closest("[data-upgrade-row]");
    const label = row?.querySelector("[data-upgrade-status-label]");
    if (label) {
      label.textContent = checked ? "Active" : "Inactive";
      label.className =
        "text-xs font-semibold " +
        (checked ? "text-emerald-700" : "text-slate-400");
    }

    try {
      const { res, data } = await apiJson("/admin/upgrades/ajax/toggle-active", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, is_active: checked }),
      });

      if (!res.ok || !data.ok) {
        toast(data.error || "Failed to update.");
        el.checked = !checked;

        if (label) {
          const reverted = el.checked;
          label.textContent = reverted ? "Active" : "Inactive";
          label.className =
            "text-xs font-semibold " +
            (reverted ? "text-emerald-700" : "text-slate-400");
        }
      }
    } catch (err) {
      toast("Failed to update.");
      el.checked = !checked;

      if (label) {
        const reverted = el.checked;
        label.textContent = reverted ? "Active" : "Inactive";
        label.className =
          "text-xs font-semibold " +
          (reverted ? "text-emerald-700" : "text-slate-400");
      }
    }
  });

  // ----------------------------
  // Guides (single definition)
  // ----------------------------
  function flashIn(elId, msg, ok = true) {
    const el = document.getElementById(elId);
    if (!el) return;
    el.innerHTML = `<div class="text-sm rounded-xl px-3 py-2 ${
      ok
        ? "bg-emerald-50 border border-emerald-200 text-emerald-800"
        : "bg-rose-50 border border-rose-200 text-rose-800"
    }">${msg}</div>`;
    setTimeout(() => (el.innerHTML = ""), 2400);
  }

 async function loadHtmlInto(url, targetId) {
  const r = await fetch(url, {
    credentials: "include",
    headers: { "X-Requested-With": "fetch" },
  });

  if (r.status === 401 || r.status === 403) return loginRedirect();

  const target = document.getElementById(targetId);
  if (!target) return;

  const html = await r.text();
  target.innerHTML = html;

  // ‚úÖ Rebind ALL reorder tables after any partial inject
  initAllReorderTables();

  // Helpful debug (you can remove later)
  console.log("Injected partial into:", targetId, "tables:", document.querySelectorAll("table[data-list-kind]").length);
}



  window.Guides = {
    loaded: false,

    refresh() {
      const pid = document.getElementById("guidesPropertyFilter")?.value || "";
      const qs = pid ? `?property_id=${encodeURIComponent(pid)}` : "";
      return loadHtmlInto(`/admin/guides/partial/list${qs}`, "guides-list");
    },

    openNew() {
      return Guides.openForm("/admin/guides/partial/form", "New Guide");
    },

    openEdit(id) {
      return Guides.openForm(
        `/admin/guides/partial/form?id=${encodeURIComponent(id)}`,
        "Edit Guide"
      );
    },

    async openForm(url, title) {
      if (CONTENT_LOCKED) return toast("Complete payment to unlock Guides.");
      document.getElementById("guides-editor-title").textContent = title || "Editor";
      await loadHtmlInto(url, "guides-editor-body");
      document.getElementById("guides-editor")?.classList.remove("hidden");
    },

    closeEditor() {
      document.getElementById("guides-editor")?.classList.add("hidden");
      const body = document.getElementById("guides-editor-body");
      if (body) body.innerHTML = "";
    },

    async submit(formEl) {
      if (CONTENT_LOCKED) return toast("Complete payment to unlock Guides.");
      const r = await fetch("/admin/guides/ajax/save", {
        method: "POST",
        credentials: "include",
        body: new FormData(formEl),
      });
      if (r.status === 401 || r.status === 403) return loginRedirect();
      const j = await r.json().catch(() => ({}));
      if (!j.ok) return flashIn("guides-flash", j.error || "Save failed", false);
      flashIn("guides-flash", "Guide saved");
      Guides.closeEditor();
      Guides.refresh();
    },

    async remove(id) {
      if (CONTENT_LOCKED) return toast("Complete payment to unlock Guides.");
      if (!confirm("Delete this guide?")) return;
      const r = await fetch(`/admin/guides/ajax/delete?id=${encodeURIComponent(id)}`, {
        method: "POST",
        credentials: "include",
      });
      const j = await r.json().catch(() => ({}));
      if (!j.ok) return flashIn("guides-flash", j.error || "Delete failed", false);
      flashIn("guides-flash", "Guide deleted");
      Guides.refresh();
    },
  };

  // ----------------------------
  // Settings tabs + Team settings
  // ----------------------------
  function getSettingsTabFromHash() {
    const h = location.hash || "";
    if (!h.startsWith("#settings")) return "profile";
    const q = h.split("?")[1] || "";
    const params = new URLSearchParams(q);
    return params.get("tab") || "profile";
  }

  function showSettingsPanel(key) {
    document.querySelectorAll(".settings-panel").forEach((p) => p.classList.add("hidden"));
    document.getElementById(`settings-${key}`)?.classList.remove("hidden");

    document.querySelectorAll(".settings-tab").forEach((b) => b.classList.remove("bg-slate-50"));
    document
      .querySelector(`.settings-tab[data-settings="${key}"]`)
      ?.classList.add("bg-slate-50");

    const base = (location.hash || "#overview").split("?")[0];
    if (base === "#settings") history.replaceState(null, "", `#settings?tab=${key}`);
  }

  function updateMemberStatusUI(memberId, isActive) {
    const row = document.querySelector(`[data-member-row="${memberId}"]`);
    if (!row) return;

    const statusEl = row.querySelector("[data-member-status]");
    if (statusEl) {
      statusEl.textContent = isActive ? "Active" : "Disabled";
      statusEl.className = isActive
        ? "text-xs font-semibold text-emerald-700"
        : "text-xs font-semibold text-rose-700";
    }

    const toggleBtn = row.querySelector("[data-member-toggle]");
    if (toggleBtn) {
      toggleBtn.textContent = isActive ? "Disable" : "Enable";
      toggleBtn.dataset.nextActive = isActive ? "false" : "true";
    }
  }

  function setSaveEnabled(memberId, enabled) {
    const btn = document.querySelector(`[data-member-save-role][data-member-id="${memberId}"]`);
    if (!btn) return;
    btn.disabled = !enabled;
    btn.classList.toggle("opacity-50", !enabled);
    btn.classList.toggle("cursor-not-allowed", !enabled);
  }

  async function refreshTeamRows() {
    const res = await fetch("/admin/settings/team/table", { credentials: "include" });

    if (res.status === 401 || res.status === 403) {
      toast("Session expired. Please sign in again.");
      loginRedirect();
      return false;
    }
    if (!res.ok) {
      toast("Could not refresh team list.");
      return false;
    }

    const html = await res.text();
    const tbody = document.querySelector("#settings-team tbody");
    if (tbody) tbody.innerHTML = html;

    // re-disable Save buttons by default
    document.querySelectorAll("[data-member-save-role]").forEach((b) => {
      b.disabled = true;
      b.classList.add("opacity-50", "cursor-not-allowed");
    });

    return true;
  }

  function initTeamSettings() {
    const teamPanel = document.getElementById("settings-team");
    if (!teamPanel) return;

    // Disable Save buttons initially
    document.querySelectorAll("[data-member-save-role]").forEach((b) => {
      b.disabled = true;
      b.classList.add("opacity-50", "cursor-not-allowed");
    });

    // Modal open/close
    const inviteModal = document.getElementById("inviteModal");
    document.getElementById("openInvite")?.addEventListener("click", () => inviteModal?.classList.remove("hidden"));
    ["closeInvite", "cancelInvite"].forEach((id) => {
      document.getElementById(id)?.addEventListener("click", () => inviteModal?.classList.add("hidden"));
    });

    // Invite submit
    document.getElementById("inviteForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formEl = e.currentTarget;
      const body = Object.fromEntries(new FormData(formEl).entries());

      try {
        const res = await fetch("/admin/settings/team/invite", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok && data.ok) {
          toast(data.message || "Invite saved.");
          formEl.reset();
          inviteModal?.classList.add("hidden");
          await refreshTeamRows();
        } else {
          toast(data.detail || data.message || "Invite failed.");
        }
      } catch (err) {
        console.error(err);
        toast("Invite failed.");
      }
    });

    // Role dropdown -> enable Save if changed
    teamPanel.addEventListener("change", (e) => {
      const el = e.target;
      if (!(el instanceof HTMLSelectElement)) return;
      if (!el.matches("[data-member-role]")) return;

      const memberId = el.dataset.memberId;
      const original = (el.dataset.originalRole || "").trim();
      const current = (el.value || "").trim();
      if (!memberId) return;

      setSaveEnabled(memberId, current !== original);
    });

    // Delegated team actions
    teamPanel.addEventListener("click", async (e) => {
      const btn = e.target instanceof HTMLElement ? e.target.closest("button") : null;
      if (!btn) return;

      // Save role
      if (btn.matches("[data-member-save-role]")) {
        const memberId = btn.dataset.memberId;
        const select = document.querySelector(`[data-member-role][data-member-id="${memberId}"]`);
        const role = select?.value;
        if (!memberId || !role) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role }),
          });

          if (res.ok && data.ok) {
            toast(data.message || "Role saved.");
            await refreshTeamRows();
          } else {
            toast(data.detail || data.message || "Failed to save role.");
            btn.disabled = false;
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Failed to save role.");
          btn.disabled = false;
        }
        return;
      }

      // Enable / Disable
      if (btn.matches("[data-member-toggle]")) {
        const memberId = btn.dataset.memberId;
        const nextActive = btn.dataset.nextActive;
        if (!memberId || (nextActive !== "true" && nextActive !== "false")) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ is_active: nextActive === "true" }),
          });

          if (res.ok && data.ok) {
            const nowActive = nextActive === "true";
            updateMemberStatusUI(memberId, nowActive);
            toast(nowActive ? "User enabled." : "User disabled.");
          } else {
            toast(data.detail || data.message || "Failed to update status.");
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Failed to update status.");
        } finally {
          btn.disabled = false;
        }
        return;
      }

      // Delete invite / Remove
      if (btn.matches("[data-member-delete]")) {
        const memberId = btn.dataset.memberId;
        const label = btn.dataset.deleteLabel || "Remove";
        if (!memberId) return;

        if (!confirm(`${label}? This cannot be undone.`)) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, { method: "DELETE" });
          if (res.ok && data.ok) {
            document.querySelector(`[data-member-row="${memberId}"]`)?.remove();
            toast(label === "Delete invite" ? "Invite deleted." : "User removed.");
          } else {
            toast(data.detail || data.message || "Delete failed.");
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Delete failed.");
        } finally {
          btn.disabled = false;
        }
      }
    });
  }

  // ----------------------------
  // Settings init (only once)
  // ----------------------------
  let settingsInitialized = false;

  function initSettingsUI() {
    if (settingsInitialized) return;
    settingsInitialized = true;

    document.querySelectorAll(".settings-tab").forEach((btn) => {
      btn.addEventListener("click", () => showSettingsPanel(btn.dataset.settings));
    });

    document.getElementById("profileForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const body = Object.fromEntries(new FormData(form).entries());

      try {
        const { res, data } = await apiJson("/admin/settings/profile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (res.ok && (data.ok ?? true)) toast("Profile saved.");
        else toast(data.detail || data.message || "Failed to save profile.");
      } catch (err) {
        if (String(err) !== "Error: auth") toast("Failed to save profile.");
      }
    });

    document.getElementById("notifForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);

      const keys = ["guest_messages", "maintenance_assigned", "turnover_due"];
      const prefs = {};
      keys.forEach((k) => (prefs[k] = fd.get(k) !== null));

      try {
        const { res, data } = await apiJson("/admin/settings/notifications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prefs }),
        });
        if (res.ok && (data.ok ?? true)) toast("Notifications saved.");
        else toast(data.detail || data.message || "Failed to save notifications.");
      } catch (err) {
        if (String(err) !== "Error: auth") toast("Failed to save notifications.");
      }
    });

    initTeamSettings();
    showSettingsPanel(getSettingsTabFromHash());
  }




// Helper: "guides" -> "guide", "upgrades" -> "upgrade"
function singularize(kind) {
  const k = String(kind || "").trim().toLowerCase();
  if (!k) return "";
  if (k.endsWith("ies")) return k.slice(0, -3) + "y";
  if (k.endsWith("s")) return k.slice(0, -1);
  return k;
}

// Helper: accept "guide" or "guides" and normalize to plural route kind
function normalizeKind(kind) {
  const k = String(kind || "").trim().toLowerCase();
  if (k === "guide") return "guides";
  if (k === "upgrade") return "upgrades";
  return k;
}

function initReorderForTable(rootEl) {
  if (!rootEl) return;

  if (!window.Sortable) {
    console.warn("Sortable missing ‚Äî drag/drop disabled.");
    return;
  }

  // ‚úÖ normalize (critical)
  const rawKind = (rootEl.getAttribute("data-list-kind") || "").trim();
  const kind = normalizeKind(rawKind); // "guides" | "upgrades"
  if (!kind) {
    console.warn("Missing data-list-kind on table.");
    return;
  }

  const tbody = rootEl.querySelector("[data-reorder-body]") || rootEl.querySelector("tbody");
  if (!tbody) {
    console.warn("No tbody found for reorder table.");
    return;
  }

  // Prevent double init
  if (tbody._sortable) return;

  const singular = singularize(kind); // "guide" | "upgrade"
  const rowAttrSingular = `data-${singular}-row`; // data-guide-row
  const rowAttrPlural = `data-${kind}-row`;       // data-guides-row

  const hasHandles = rootEl.querySelectorAll("[data-reorder-handle]").length > 0;

  tbody._sortable = new Sortable(tbody, {
    animation: 150,
    draggable: "tr",
    ...(hasHandles ? { handle: "[data-reorder-handle]" } : {}),

    onEnd: async () => {
      // Prefer singular row attr, fallback to plural
      let rows = Array.from(tbody.querySelectorAll(`tr[${rowAttrSingular}]`));
      if (!rows.length) rows = Array.from(tbody.querySelectorAll(`tr[${rowAttrPlural}]`));

      const idsRaw = rows
        .map((tr) => (tr.getAttribute(rowAttrSingular) || tr.getAttribute(rowAttrPlural) || "").trim())
        .filter(Boolean);

      const ids = idsRaw.map(Number).filter(Number.isFinite);

      if (!ids.length) {
        console.error("Reorder: no valid numeric IDs found.", {
          rawKind, kind, idsRaw, rowAttrSingular, rowAttrPlural
        });
        toast("Could not reorder: row IDs missing.");
        return;
      }

      const url =
        kind === "guides"
          ? "/admin/guides/ajax/reorder"
          : "/admin/upgrades/ajax/reorder";

      const payload = { ids };

      try {
        const { res, data } = await apiJson(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok || !data.ok) {
          console.error("Reorder failed:", { url, status: res.status, data, payload });
          toast(data?.error || data?.detail || "Failed to save order.");
          // revert UI to DB order
          if (kind === "guides") await Guides.refresh();
          if (kind === "upgrades") await Upgrades.refresh();
          return;
        }

        toast("Order saved ‚úì");
      } catch (err) {
        console.error("Reorder error:", err);
        toast("Failed to save order.");
        if (kind === "guides") await Guides.refresh();
        if (kind === "upgrades") await Upgrades.refresh();
      }
    },
  });

  console.log("Sortable bound:", { rawKind, kind, rowAttrSingular, rowAttrPlural, hasHandles });
}
function initAllReorderTables() {
  document.querySelectorAll("table[data-list-kind]").forEach(initReorderForTable);
}


let routingInitialized = false;
let currentViewKey = null;

function initRouting() {
  if (routingInitialized) return;
  routingInitialized = true;

  const pageTitle = document.getElementById("page-title");
  const pageSubtitle = document.getElementById("page-subtitle");
  const navItems = Array.from(document.querySelectorAll(".nav-item"));
  const views = Array.from(document.querySelectorAll(".view"));

  const subtitles = {
    overview: "{{ 'System health & activity' if user_role == 'super' else 'Your portfolio at a glance' }}",
    properties: "Search and manage your portfolio",
    chats: "Lifecycle, priority, escalations",
    pmcs: "Partners, integrations, access",
    guides: "Guest-facing guides per property",
    upgrades: "Paid add-ons per property",
    files: "Configs & manuals",
    analytics: "{{ 'Trends & performance' if user_role == 'super' else 'Your chat trends & performance' }}",
    settings: "Account and system settings",
  };

  async function showView(key) {
    key = (key || "overview").toLowerCase();

    // fallback safety FIRST
    if (!document.getElementById(`view-${key}`)) key = "overview";

    if (key === currentViewKey) return;
    currentViewKey = key;

    // show/hide views
    views.forEach(v => v.classList.add("hidden"));
    document.getElementById(`view-${key}`)?.classList.remove("hidden");

    // active nav
    navItems.forEach(btn => btn.setAttribute("aria-current", "false"));
    const activeBtn = navItems.find(b => (b.dataset.view || "").toLowerCase() === key);
    if (activeBtn) activeBtn.setAttribute("aria-current", "page");

    // titles
    const label = activeBtn?.querySelector(".sidebar-label")?.textContent?.trim() || "Overview";
    if (pageTitle) pageTitle.textContent = label;
    if (pageSubtitle) pageSubtitle.textContent = subtitles[key] || "";

    // view hooks
    if (key === "properties") filterProperties();

    if (key === "settings") {
      initSettingsUI();
      showSettingsPanel(getSettingsTabFromHash());
    }

    if (key === "guides" && !Guides.loaded) {
      Guides.loaded = true;
      Guides.refresh();
    }

    if (key === "upgrades" && !Upgrades.loaded) {
      Upgrades.loaded = true;
      Upgrades.refresh();
    }

    if (key === "analytics") {
      const days = document.getElementById("analyticsRange")?.value || 30;
      requestAnimationFrame(() => {
        loadChatAnalytics(days);
        resizeChatAnalyticsChartSoon();
      });
    }
  }

  function route() {
    const params = new URLSearchParams(window.location.search);

    // If a session is selected, ALWAYS show chats
    if (params.has("session_id")) {
      showView("chats");
      return;
    }

    const keyFromHash = (location.hash || "").slice(1).split("?")[0].toLowerCase();
    const keyFromView = (params.get("view") || "").toLowerCase();

    showView(keyFromHash || keyFromView || "overview");
  }

  // nav clicks
  navItems.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const key = (btn.dataset.view || "overview").toLowerCase();

      const url = new URL(window.location.href);
      url.searchParams.delete("session_id");
      url.searchParams.set("view", key);
      url.hash = `#${key}`;

      history.pushState(null, "", url.toString());
      showView(key);
    });
  });

  window.addEventListener("popstate", route);
  window.addEventListener("hashchange", route);

  route();
}


  // ----------------------------
// DOM ready (single, clean)
// ----------------------------
document.addEventListener("DOMContentLoaded", () => {
  initSidebar();
  initRouting();

  // Hook property filters
  document.getElementById("searchInput")?.addEventListener("input", filterProperties);
  document.getElementById("statusFilter")?.addEventListener("change", filterProperties);

  // Guides / Upgrades dropdowns
  document.getElementById("guidesPropertyFilter")?.addEventListener("change", () => Guides.refresh());
  document.getElementById("upgradesPropertyFilter")?.addEventListener("change", () => {
    Upgrades.closeEditor();
    Upgrades.refresh();
  });

  // Chart init (run after DOM is ready)
  const ctx = document.getElementById("statusChart");
  if (ctx && window.Chart) {
    statusChartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["LIVE", "OFFLINE"],
        datasets: [{ label: "Properties", data: [{{ live_props }}, {{ offline_props }}] }],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
      },
    });
  }

  updateOverviewUI();
});

</script>

</body>
</html>
