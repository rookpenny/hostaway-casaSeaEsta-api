<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HostScout Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06), 0 10px 24px rgba(15, 23, 42, 0.06); }
    .hairline { box-shadow: inset 0 1px 0 rgba(255,255,255,.7); }

    /* Active nav state */
    .nav-item[aria-current="page"] { background: rgb(248 250 252); color: rgb(15 23 42); }
    .nav-item[aria-current="page"] .nav-icon-wrap { background: rgb(15 23 42); border-color: rgb(15 23 42); }
    .nav-item[aria-current="page"] svg { color: white; }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

</head>

<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex">

    <!-- Sidebar -->
    <aside id="sidebar"
      class="sticky top-0 h-screen bg-white border-r border-slate-200 flex flex-col
             w-72 transition-[width] duration-200 ease-out">

      <!-- Brand -->
      <div class="h-16 px-4 flex items-center justify-between border-b border-slate-200">
        <a href="#" class="flex items-center gap-2 overflow-hidden">
          <div class="w-9 h-9 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            H
          </div>
          <div class="sidebar-label whitespace-nowrap">
            <div class="text-sm font-semibold leading-4">HostScout</div>
            <div class="text-xs text-slate-500">
              {% if user_role == "super" %}Super Admin{% else %}PMC Dashboard{% endif %}
            </div>
          </div>
        </a>

        <button id="sidebar-toggle"
          class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50 grid place-items-center"
          aria-label="Toggle sidebar"
          type="button">
          <svg class="h-5 w-5 text-slate-600" viewBox="0 0 24 24" fill="none">
            <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <!-- Nav -->
      <nav class="p-3 space-y-1">

        <!-- Overview -->
        <button data-view="overview"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          aria-current="page"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M3 13h8V3H3v10zm10 8h8V11h-8v10zM3 21h8v-6H3v6zm10-18v6h8V3h-8z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Overview</span>
        </button>

        {% if user_role == "super" %}
        <button data-view="chats"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Chats</span>
        </button>

        <button data-view="pmcs"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M4 21V3h10v18M14 9h6v12M8 7h2M8 11h2M8 15h2M18 13h2M18 17h2"
                stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">PMCs</span>
        </button>

        <button data-view="files"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
              <path d="M14 2v6h6" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Configs & Manuals</span>
        </button>

        <button data-view="analytics"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M4 19V5M4 19h16M8 15v-6M12 19V9M16 13v-4M20 19V7"
                stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Analytics</span>
        </button>
        {% endif %}

        <button data-view="properties"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Properties</span>
        </button>

        <button data-view="guides"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M4 19V5a2 2 0 0 1 2-2h12v18H6a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="1.7"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Guides</span>
        </button>
        
        <button data-view="upgrades"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M7 7h10M7 11h10M7 15h6" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              <path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"
                stroke="currentColor" stroke-width="1.2"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Upgrades</span>
        </button>

        <button data-view="settings"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.7"/>
              <path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.3-2-3.4-2.3.6a8 8 0 0 0-1.7-1L15 3h-6l-.5 2.9a8 8 0 0 0-1.7 1L4.5 6.3l-2 3.4 2 1.3a7.8 7.8 0 0 0 0 2l-2 1.3 2 3.4 2.3-.6a8 8 0 0 0 1.7 1L9 21h6l.5-2.9a8 8 0 0 0 1.7-1l2.3.6 2-3.4-2-1.3z"
                stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Settings</span>
        </button>

        <a href="/auth/logout"
           class="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-rose-50 text-slate-700">
          <span class="h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M10 17l-1 0a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4h1" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              <path d="M14 7l5 5-5 5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M19 12H10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium text-rose-700">Logout</span>
        </a>
      </nav>

      <!-- Footer -->
      <div class="mt-auto p-3 border-t border-slate-200">
        <div class="flex items-center gap-3 px-2">
          <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            {{ (pmc_name[0] if pmc_name else "U") }}
          </div>
          <div class="sidebar-label overflow-hidden">
            <div class="text-sm font-semibold leading-4 truncate">
              {{ pmc_name if pmc_name else "User" }}
            </div>
            <div class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}Super User{% else %}PMC{% endif %}
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 min-w-0">
      <!-- Topbar -->
      <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200 hairline">
        <div class="h-16 px-6 flex items-center gap-4">
          <div class="min-w-0">
            <div id="page-title" class="text-sm font-semibold truncate">Overview</div>
            <div id="page-subtitle" class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}System health & activity{% else %}Your portfolio at a glance{% endif %}
            </div>
          </div>

          <div class="flex-1"></div>

          <div class="hidden lg:block w-[420px]">
            <div class="flex items-center gap-2 px-3 h-10 rounded-xl border border-slate-200 bg-white">
              <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <input id="globalSearch"
                class="w-full text-sm outline-none placeholder:text-slate-400"
                placeholder="{% if user_role == 'super' %}Search chats, guests, properties…{% else %}Search properties…{% endif %}" />
              <kbd class="text-[11px] px-2 py-1 rounded-lg border border-slate-200 bg-slate-50 text-slate-500">⌘ K</kbd>
            </div>
          </div>

          {% if user_role == "super" %}
          <div class="flex items-center gap-2">
            <a href="/admin/chats"
              class="h-10 px-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm grid place-items-center">
              Chats
            </a>
            <a href="/admin/new-pmc"
              class="h-10 px-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm grid place-items-center">
              New PMC
            </a>
          </div>
          {% endif %}
        </div>
      </header>

      <!-- Content -->
      <div class="p-6">

        {% set is_locked = (user_role == "pmc" and needs_payment) %}

        {% if is_locked %}
        <!-- Billing Banner -->
        <div class="mb-6 rounded-2xl border border-amber-300/60 bg-amber-50 p-4 card">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold text-amber-900">
                {{ billing_banner_title or "Complete payment to activate your account" }}
              </div>
              <div class="text-sm text-amber-900/80 mt-1">
                {{ billing_banner_body or "Your account is pending. Once payment is confirmed, you can sync properties and enable Sandy." }}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <a href="/pmc/signup"
                 class="h-10 px-4 rounded-xl bg-amber-500 hover:bg-amber-600 text-black font-semibold grid place-items-center">
                Complete setup & payment
              </a>
              <a href="/auth/login/google"
                 class="h-10 px-4 rounded-xl border border-amber-300 bg-white hover:bg-amber-50 text-amber-900 font-semibold grid place-items-center">
                Refresh login
              </a>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- OVERVIEW -->
        <section id="view-overview" class="view space-y-6">

          {% set total_props = properties|length %}

          {% if is_locked %}
            {% set live_props = 0 %}
            {% set offline_props = total_props %}
          {% else %}
            {% set live_props = (properties | selectattr('sandy_enabled') | list | length) %}
            {% set offline_props = (properties | rejectattr('sandy_enabled') | list | length) %}
          {% endif %}

          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Properties</div>
              <div class="mt-2 text-3xl font-semibold" id="stat-total">{{ total_props }}</div>
              <div class="mt-2 text-xs text-slate-500">Portfolio size</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Live</div>
              <div class="mt-2 text-3xl font-semibold" id="stat-live">{{ live_props }}</div>
              <div class="mt-2 text-xs text-emerald-600">Sandy enabled</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Offline</div>
              <div class="mt-2 text-3xl font-semibold" id="stat-offline">{{ offline_props }}</div>
              <div class="mt-2 text-xs text-rose-600">Needs attention</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Last Sync</div>
              <div class="mt-2 text-lg font-semibold">
                {% if properties and properties[0].last_synced %}
                  {% set seconds = (now - properties[0].last_synced).total_seconds() %}
                  {% if seconds < 60 %} just now
                  {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
                  {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
                  {% else %} {{ (seconds // 86400)|int }} days ago
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="mt-2 text-xs text-slate-500">Most recent property record</div>
            </div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Status Overview</div>
                <div class="text-xs text-slate-500">LIVE vs OFFLINE</div>
              </div>
              <div class="text-xs text-slate-500">Auto-updates with your data</div>
            </div>
            <div class="mt-4">
              <canvas id="statusChart" height="90"></canvas>
            </div>
          </div>

          {% if user_role == "super" %}
          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-12 xl:col-span-7 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-sm font-semibold">Chat Volume</div>
              <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
                Chart placeholder
              </div>
            </div>
            <div class="col-span-12 xl:col-span-5 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-sm font-semibold">Priority Inbox</div>
              <div class="mt-2 text-xs text-slate-500">Escalations & time-sensitive issues</div>
              <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
                Queue placeholder
              </div>
            </div>
          </div>
          {% endif %}
        </section>

        <!-- PROPERTIES -->
        <section id="view-properties" class="view hidden space-y-4">

          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex flex-col lg:flex-row lg:items-center gap-3 justify-between">
              <div>
                <div class="text-sm font-semibold">Properties</div>
                <div class="text-xs text-slate-500">Search and manage your portfolio</div>
              </div>

              <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search properties…"
                  class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72"
                />
                <select
                  id="statusFilter"
                  class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-48"
                >
                  <option value="all">All statuses</option>
                  <option value="live">LIVE</option>
                  <option value="offline">OFFLINE</option>
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            {% for prop in properties %}
            <div class="bg-white border border-slate-200 rounded-2xl p-4 card"
                 data-property-card
                 data-name="{{ prop.property_name }}"
                 data-live="{{ 'true' if prop.sandy_enabled else 'false' }}">

              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-lg font-semibold truncate">{{ prop.property_name }}</div>
                  <div class="mt-1 text-xs text-slate-500">
                    ID: {{ prop.id }}{% if prop.pms_property_id %} • PMS: {{ prop.pms_property_id }}{% endif %}
                  </div>
                </div>

                {% if is_locked %}
                  <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200 font-semibold">
                    LOCKED
                  </span>
                {% else %}
                  {% if prop.sandy_enabled %}
                    <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold">
                      LIVE
                    </span>
                  {% else %}
                    <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold">
                      OFFLINE
                    </span>
                  {% endif %}
                {% endif %}
              </div>

              <div class="mt-3 text-xs text-slate-500">
                <span class="font-semibold text-slate-700">Last synced:</span>
                {% if prop.last_synced %}
                  {% set seconds = (now - prop.last_synced).total_seconds() %}
                  {% if seconds < 60 %} just now
                  {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
                  {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
                  {% else %} {{ (seconds // 86400)|int }} days ago
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </div>

              <div class="mt-4 flex gap-2 flex-wrap items-center">
                {% if user_role == "super" and prop.data_folder_path %}
                  <a href="/edit-file?file={{ prop.data_folder_path }}/config.json"
                     class="h-9 px-3 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">
                    Edit Config
                  </a>
                  <a href="/edit-file?file={{ prop.data_folder_path }}/manual.txt"
                     class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50">
                    Edit Manual
                  </a>
                {% endif %}

                <button
                  onclick="syncProperty({{ prop.id }}, this)"
                  class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  type="button"
                  {% if is_locked %}disabled{% endif %}>
                  Sync
                </button>

                <button
                  onclick="toggleProperty({{ prop.id }}, this)"
                  class="h-9 px-3 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  type="button"
                  {% if is_locked %}disabled{% endif %}>
                  {% if prop.sandy_enabled %}Take Offline{% else %}Go Live{% endif %}
                </button>

                {% if is_locked %}
                  <a href="/pmc/signup" class="text-xs font-semibold text-amber-700 hover:underline ml-1">
                    Unlock →
                  </a>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </section>


        <section id="view-guides" class="view hidden space-y-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">Guides</div>
                <div class="mt-1 text-sm text-slate-500">Create and manage guest guides per property.</div>
              </div>
              <select id="guidesPropertyFilter"
                class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72">
                <option value="">All properties</option>
                {% for p in properties %}
                  <option value="{{ p.id }}">{{ p.property_name }}</option>
                {% endfor %}
              </select>
              <button
                type="button"
                onclick="Guides.openNew()"
                class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold {% if is_locked %}opacity-50 cursor-not-allowed{% endif %}"
                {% if is_locked %}disabled{% endif %}
              >
                New Guide
              </button>

            </div>
        
            {% if is_locked %}
              <div class="mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">
                Content editing is locked until payment is complete.
              </div>
            {% endif %}
        
            <div id="guides-flash" class="mt-3"></div>
        
            <div class="mt-4 grid grid-cols-12 gap-4">
              <div class="col-span-12 xl:col-span-7">
                <div id="guides-list" class="text-sm text-slate-500">Loading…</div>
              </div>
        
              <div class="col-span-12 xl:col-span-5">
                <div id="guides-editor" class="hidden bg-slate-50 border border-slate-200 rounded-2xl p-4">
                  <div class="flex items-center justify-between">
                    <div id="guides-editor-title" class="text-sm font-semibold">Editor</div>
                    <button class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm"
                      type="button" onclick="Guides.closeEditor()">Close</button>
                  </div>
                  <div id="guides-editor-body" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>
        </section>


        <section id="view-upgrades" class="view hidden space-y-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">Upgrades</div>
                <div class="mt-1 text-sm text-slate-500">Create and manage paid add-ons per property.</div>
              </div>
              <select id="upgradesPropertyFilter"
                class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72">
                <option value="">All properties</option>
                {% for p in properties %}
                  <option value="{{ p.id }}">{{ p.property_name }}</option>
                {% endfor %}
              </select>
              <button
              type="button"
              onclick="Upgrades.openNew()"
              class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm font-semibold
                     {% if is_locked %}
                       opacity-50 cursor-not-allowed
                     {% else %}
                       hover:bg-slate-800
                     {% endif %}"
              {% if is_locked %}disabled{% endif %}
            >
              New Upgrade
            </button>
              
            </div>
        
            {% if is_locked %}
              <div class="mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">
                Content editing is locked until payment is complete.
              </div>
            {% endif %}
        
            <div id="upgrades-flash" class="mt-3"></div>
        
            <div class="mt-4 grid grid-cols-12 gap-4">
              <div class="col-span-12 xl:col-span-7">
                <div id="upgrades-list" class="text-sm text-slate-500">Loading…</div>
              </div>
        
              <div class="col-span-12 xl:col-span-5">
                <div id="upgrades-editor" class="hidden bg-slate-50 border border-slate-200 rounded-2xl p-4">
                  <div class="flex items-center justify-between">
                    <div id="upgrades-editor-title" class="text-sm font-semibold">Editor</div>
                    <button class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm"
                      type="button" onclick="Upgrades.closeEditor()">Close</button>
                  </div>
                  <div id="upgrades-editor-body" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>
        </section>



        {% if user_role == "super" %}
        <section id="view-chats" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Chats</div>
            <div class="mt-2 text-sm text-slate-500">
              Go to <a class="underline font-semibold" href="/admin/chats">/admin/chats</a>.
            </div>
          </div>
        </section>

        <section id="view-pmcs" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">PMCs</div>
            <div class="mt-2 text-sm text-slate-500">Create/manage PMCs, integrations, permissions.</div>
          </div>
        </section>

        <section id="view-files" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Configs & Manuals</div>
            <div class="mt-2 text-sm text-slate-500">Central file management.</div>
          </div>
        </section>

        <section id="view-analytics" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Analytics</div>
            <div class="mt-2 text-sm text-slate-500">Response time, containment, outcomes.</div>
          </div>
        </section>
        {% endif %}

        <section id="view-settings" class="view hidden space-y-4">

  <!-- Header card -->
  <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm font-semibold">Settings</div>
        <div class="mt-1 text-sm text-slate-500">
          {% if user_role == "super" %}
            Manage your profile, PMCs, roles, and platform notifications.
          {% else %}
            Manage your profile, team, and notifications for your PMC.
          {% endif %}
        </div>
      </div>

      <div class="text-xs text-slate-500">
        Signed in as <span class="font-semibold text-slate-700">{{ user_email }}</span>
      </div>
    </div>
  </div>

  <!-- Settings layout -->
  <div class="grid grid-cols-12 gap-4">

    <!-- Settings sub-nav -->
    <aside class="col-span-12 lg:col-span-3">
      <div class="bg-white border border-slate-200 rounded-2xl p-2 card">
        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="profile" type="button">
          Profile
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="team" type="button">
          Team
        </button>

        {% if user_role == "super" %}
        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="roles" type="button">
          Roles & Permissions
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="pmcs" type="button">
          PMCs
        </button>
        {% endif %}

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="notifications" type="button">
          Notifications
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="integrations" type="button">
          Integrations
        </button>
      </div>
    </aside>

    <!-- Settings panels -->
    <div class="col-span-12 lg:col-span-9 space-y-4">

      <!-- Profile -->
      <div id="settings-profile" class="settings-panel bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Profile</div>
        <div class="mt-1 text-sm text-slate-500">Update your personal preferences.</div>

        <form id="profileForm" class="mt-4 grid grid-cols-12 gap-3">
          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Full name</label>
            <input name="full_name" value="{{ user_full_name or '' }}"
                   class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm" />
          </div>

          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Email</label>
            <input value="{{ user_email }}" disabled
                   class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-slate-50 text-slate-500" />
            <div class="mt-1 text-xs text-slate-500">Managed by Google OAuth.</div>
          </div>

          <!-- NOTE: This is safe to keep even if you haven't added a DB column yet;
               your backend can ignore it until you're ready. -->
          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Timezone</label>
            <select name="timezone" class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-white">
              <option value="">Select…</option>
              {% for tz in ["America/Los_Angeles","America/Denver","America/Chicago","America/New_York"] %}
                <option value="{{ tz }}" {% if user_timezone == tz %}selected{% endif %}>{{ tz }}</option>
              {% endfor %}
            </select>
            <div class="mt-1 text-xs text-slate-500">We’ll use this for scheduling + notifications.</div>
          </div>

          <div class="col-span-12 md:col-span-6 flex items-end justify-end">
            <button type="submit"
              class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
              Save Profile
            </button>
          </div>
        </form>
      </div>

      <!-- Team -->
<div id="settings-team" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
  <div class="flex items-start justify-between gap-3">
    <div>
      <div class="text-sm font-semibold">Team</div>
      <div class="mt-1 text-sm text-slate-500">
        Invite cleaners, maintenance, and internal staff. Owners/Admins can edit roles and enable/disable users.
      </div>
    </div>

    <button id="openInvite"
      class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
      Invite Member
    </button>
  </div>

  <div class="mt-4 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="text-xs text-slate-500">
        <tr class="border-b border-slate-200">
          <th class="text-left py-2">Name</th>
          <th class="text-left py-2">Email</th>
          <th class="text-left py-2">Role</th>
          <th class="text-left py-2">Status</th>
          <th class="text-right py-2">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for m in team_members %}
        <tr class="border-b border-slate-100" data-member-row="{{ m.id }}">
          <td class="py-2 font-medium">{{ m.full_name or "—" }}</td>

          <td class="py-2 text-slate-600">
            <div class="flex items-center gap-2">
              <span>{{ m.email }}</span>
              {% if not m.last_login_at %}
                <span class="text-[11px] px-2 py-0.5 rounded-full border border-slate-200 bg-slate-50 text-slate-600 font-semibold">
                  Invite pending
                </span>
              {% endif %}
            </div>
          </td>

          <!-- Role -->
          <td class="py-2">
            <div class="flex items-center gap-2">
              <select
                class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm"
                data-member-role
                data-member-id="{{ m.id }}"
                data-original-role="{{ m.role or 'staff' }}"
                {% if m.email == user_email %}disabled title="You can't change your own role here."{% endif %}
              >
                {% for r in ["owner","admin","staff","ops_manager","maintenance","cleaner","read_only"] %}
                  <option value="{{ r }}" {% if (m.role or '') == r %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
              </select>

              {% if m.email != user_email %}
              <button
                class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold"
                data-member-save-role
                data-member-id="{{ m.id }}"
                type="button"
                title="Save role change"
              >
                Save
              </button>
              {% else %}
              <span class="text-xs text-slate-400">—</span>
              {% endif %}
            </div>
          </td>

          <!-- Status -->
          <td class="py-2">
            {% if m.is_active %}
              <span class="text-xs font-semibold text-emerald-700" data-member-status>Active</span>
            {% else %}
              <span class="text-xs font-semibold text-rose-700" data-member-status>Disabled</span>
            {% endif %}
          </td>

          <!-- Actions -->
          <td class="py-2 text-right">
            {% if m.email != user_email %}
            <div class="flex items-center justify-end gap-3">
              <button
                class="text-xs font-semibold hover:underline"
                data-member-toggle
                data-member-id="{{ m.id }}"
                data-next-active="{{ 'false' if m.is_active else 'true' }}"
                type="button"
              >
                {% if m.is_active %}Disable{% else %}Enable{% endif %}
              </button>

              <button
                class="text-xs font-semibold hover:underline text-rose-700"
                data-member-delete
                data-member-id="{{ m.id }}"
                data-delete-label="{% if not m.last_login_at %}Delete invite{% else %}Remove{% endif %}"
                type="button"
              >
                {% if not m.last_login_at %}Delete invite{% else %}Remove{% endif %}
              </button>
            </div>
            {% else %}
              <span class="text-xs text-slate-400">—</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}

        {% if not team_members %}
        <tr>
          <td colspan="5" class="py-6 text-center text-slate-500">No team members yet.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Invite modal -->
  <div id="inviteModal" class="hidden fixed inset-0 z-[9999] bg-black/30 p-4">
    <div class="max-w-lg mx-auto mt-24 bg-white rounded-2xl border border-slate-200 p-4 card">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Invite team member</div>
        <button id="closeInvite" class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50" type="button">✕</button>
      </div>

      <div class="mt-2 text-xs text-slate-500">
        We use Google OAuth. Invited users will be able to sign in with this email.
      </div>

      <form id="inviteForm" class="mt-4 space-y-3">
        <div>
          <label class="text-xs font-semibold text-slate-600">Email</label>
          <input name="email" type="email" required
                 class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm" />
        </div>

        <div>
          <label class="text-xs font-semibold text-slate-600">Role</label>
          <select name="role" class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-white">
            <option value="staff">Staff</option>
            <option value="ops_manager">Ops Manager</option>
            <option value="maintenance">Maintenance</option>
            <option value="cleaner">Cleaner</option>
            <option value="read_only">Read-only</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
          </select>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancelInvite"
                  class="h-10 px-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
            Cancel
          </button>
          <button type="submit"
                  class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
            Send Invite
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


      {% if user_role == "super" %}
      <!-- Roles & Permissions (superusers) -->
      <div id="settings-roles" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Roles & Permissions</div>
        <div class="mt-1 text-sm text-slate-500">
          Define roles (cleaner, maintenance, staff) and what they can access.
        </div>

        <div class="mt-4 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm text-slate-700">
          MVP suggestion: start with fixed roles + hardcoded permissions, then move to DB-driven roles.
        </div>
      </div>

      <!-- PMCs (superusers) -->
      <div id="settings-pmcs" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">PMCs</div>
        <div class="mt-1 text-sm text-slate-500">Activate/deactivate PMCs, billing status, support tools.</div>
      </div>
      {% endif %}

      <!-- Notifications -->
      <div id="settings-notifications" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Notifications</div>
        <div class="mt-1 text-sm text-slate-500">
          Choose what you get notified about. Slack settings will live here later.
        </div>

        {% set prefs = notif_prefs or {} %}

        <form id="notifForm" class="mt-4 space-y-3">

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Guest messages</div>
              <div class="text-xs text-slate-500">Notify when a new guest message arrives.</div>
            </div>
            <input name="guest_messages" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("guest_messages") %}checked{% endif %} />
          </label>

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Maintenance assigned</div>
              <div class="text-xs text-slate-500">Notify when a maintenance request is assigned.</div>
            </div>
            <input name="maintenance_assigned" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("maintenance_assigned") %}checked{% endif %} />
          </label>

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Turnover due soon</div>
              <div class="text-xs text-slate-500">Notify when a cleaner task is due soon.</div>
            </div>
            <input name="turnover_due" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("turnover_due") %}checked{% endif %} />
          </label>

          <div class="flex justify-end pt-2">
            <button type="submit"
              class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
              Save Notifications
            </button>
          </div>
        </form>

        <div class="mt-4 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm text-slate-700">
          Slack (coming soon): connect workspace, pick channel per event, and map properties → channels.
        </div>
      </div>

      <!-- Integrations -->
      <div id="settings-integrations" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Integrations</div>
        <div class="mt-1 text-sm text-slate-500">PMS, Slack, and other connections.</div>
      </div>

    </div>
  </div>
</section>



      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

 <script>
  // -------- Paywall flag (server-rendered) --------
  const IS_LOCKED = {{ 'true' if (user_role == 'pmc' and needs_payment) else 'false' }};
  const CONTENT_LOCKED = IS_LOCKED;

  // ----------------------------
  // Small UI helpers
  // ----------------------------
  function toast(message) {
    const el = document.createElement("div");
    el.className =
      "fixed bottom-5 right-5 z-[9999] bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-lg";
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2400);
  }

  function loginRedirect() {
    const next = encodeURIComponent(
      window.location.pathname + window.location.search + window.location.hash
    );
    window.location.href = `/auth/login/google?next=${next}`;
  }

  async function apiJson(url, opts = {}) {
    const res = await fetch(url, {
      credentials: "include",
      headers: { Accept: "application/json", ...(opts.headers || {}) },
      ...opts,
    });

    if (res.status === 401 || res.status === 403) {
      toast("Session expired. Please sign in again.");
      loginRedirect();
      throw new Error("auth");
    }

    let data = {};
    try {
      data = await res.json();
    } catch {}
    return { res, data };
  }

  async function postJson(url) {
    return fetch(url, {
      method: "POST",
      credentials: "include",
      headers: { Accept: "application/json" },
    });
  }

  // ----------------------------
  // Overview counters + chart refresh (no hard refresh)
  // NOTE: make sure your HTML has:
  //   <div id="stat-total">...</div>
  //   <div id="stat-live">...</div>
  //   <div id="stat-offline">...</div>
  // ----------------------------
  let statusChartInstance = null;

  function recomputeLiveOffline() {
    const cards = document.querySelectorAll("[data-property-card]");
    const total = cards.length;
    let live = 0;
    cards.forEach((c) => {
      if (c.dataset.live === "true") live += 1;
    });
    return { total, live, offline: total - live };
  }

  function updateOverviewUI() {
    const { total, live, offline } = recomputeLiveOffline();

    const totalEl = document.getElementById("stat-total");
    const liveEl = document.getElementById("stat-live");
    const offEl = document.getElementById("stat-offline");

    if (totalEl) totalEl.textContent = String(total);
    if (liveEl) liveEl.textContent = String(live);
    if (offEl) offEl.textContent = String(offline);

    if (statusChartInstance) {
      statusChartInstance.data.datasets[0].data = [live, offline];
      statusChartInstance.update();
    }
  }

  // ----------------------------
  // Sidebar collapse/expand
  // ----------------------------
  function initSidebar() {
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebar-toggle");
    const labelEls = () =>
      Array.from(document.querySelectorAll(".sidebar-label"));

    if (!sidebar || !toggleBtn) return;

    function setCollapsed(isCollapsed) {
      sidebar.classList.toggle("w-72", !isCollapsed);
      sidebar.classList.toggle("w-20", isCollapsed);
      labelEls().forEach((el) => el.classList.toggle("hidden", isCollapsed));

      const svg = toggleBtn.querySelector("svg");
      if (svg) {
        svg.style.transform = isCollapsed ? "rotate(180deg)" : "rotate(0deg)";
        svg.style.transition = "transform 200ms ease";
      }
      localStorage.setItem(
        "dashboard_sidebar_collapsed",
        isCollapsed ? "1" : "0"
      );
    }

    setCollapsed(localStorage.getItem("dashboard_sidebar_collapsed") === "1");

    toggleBtn.addEventListener("click", () => {
      const isCollapsed = sidebar.classList.contains("w-20");
      setCollapsed(!isCollapsed);
    });

    // ⌘K focus
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        document.getElementById("globalSearch")?.focus();
      }
    });
  }

  // ----------------------------
  // Properties filter
  // ----------------------------
  function filterProperties() {
    const search = (
      document.getElementById("searchInput")?.value || ""
    ).toLowerCase();
    const status = document.getElementById("statusFilter")?.value || "all";
    const cards = document.querySelectorAll("[data-property-card]");

    cards.forEach((card) => {
      const name = (card.dataset.name || "").toLowerCase();
      const live = card.dataset.live === "true";
      const matchesSearch = name.includes(search);
      const matchesStatus =
        status === "all" ||
        (status === "live" && live) ||
        (status === "offline" && !live);

      card.style.display = matchesSearch && matchesStatus ? "" : "none";
    });
  }
  window.filterProperties = filterProperties;

  // ----------------------------
  // Property actions
  // ----------------------------
  window.syncProperty = async function (id, btn) {
    if (IS_LOCKED) return toast("Complete payment to unlock property syncing.");

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = "Syncing…";

    try {
      const res = await postJson(`/auth/sync-property/${id}`);

      if (res.status === 401 || res.status === 403) return loginRedirect();
      if (res.status === 402) return (window.location.href = "/pmc/signup");

      let data = {};
      try {
        data = await res.json();
      } catch {}
      btn.innerHTML =
        res.ok && data.status === "success"
          ? "Synced ✓"
          : data.message || data.detail || "Failed";
    } catch (err) {
      console.error("Sync error:", err);
      btn.innerHTML = "Error";
    } finally {
      setTimeout(() => {
        btn.innerHTML = original;
        btn.disabled = false;
      }, 1200);
    }
  };

  window.toggleProperty = async function (id, btn) {
    if (IS_LOCKED) return toast("Complete payment to unlock Sandy activation.");

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = "Toggling…";

    try {
      const res = await postJson(`/auth/toggle-property/${id}`);
      if (res.status === 401 || res.status === 403) return loginRedirect();

      let data = null;
      try {
        data = await res.json();
      } catch {
        data = null;
      }

      if (data && data.status === "needs_billing" && data.checkout_url) {
        window.location.href = data.checkout_url;
        return;
      }

      if (!res.ok) {
        toast((data && (data.detail || data.message)) || "Request failed");
        btn.innerHTML = original;
        return;
      }

      if (data && data.status === "success") {
        const isLive = data.new_status === "LIVE";
        btn.innerHTML = isLive ? "Take Offline" : "Go Live";

        const card = btn.closest("[data-property-card]");
        if (card) {
          card.dataset.live = isLive ? "true" : "false";

          const pill = card.querySelector("span.rounded-full");
          if (pill) {
            if (isLive) {
              pill.textContent = "LIVE";
              pill.className =
                "shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold";
            } else {
              pill.textContent = "OFFLINE";
              pill.className =
                "shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold";
            }
          }
        }

        filterProperties();
        updateOverviewUI(); // ✅ update overview immediately
        return;
      }

      btn.innerHTML = original;
      toast("Toggle failed.");
    } catch (err) {
      console.error("Toggle error:", err);
      btn.innerHTML = original;
      toast("Network error. Please try again.");
    } finally {
      btn.disabled = false;
    }
  };


   document.addEventListener("click", (e) => {
  const editBtn = e.target.closest("[data-guide-edit]");
  if (editBtn) {
    const id = (editBtn.getAttribute("data-guide-edit") || "").trim();
    if (id) Guides.openEdit(id);
    return;
  }

  const delBtn = e.target.closest("[data-guide-delete]");
  if (delBtn) {
    const id = (delBtn.getAttribute("data-guide-delete") || "").trim();
    if (id) Guides.remove(id);
    return;
  }
});

  

   document.addEventListener("change", async (e) => {
  const el = e.target;
  if (!(el instanceof HTMLInputElement)) return;
  if (!el.matches("[data-guide-active]")) return;

  if (window.CONTENT_LOCKED) {
    toast("Complete payment to unlock Guides.");
    el.checked = !el.checked;
    return;
  }

  const id = el.dataset.guideId;
  const checked = el.checked;

  const row = el.closest("[data-guide-row]");
  const label = row?.querySelector("[data-guide-status-label]");

  if (label) {
    label.textContent = checked ? "Active" : "Inactive";
    label.className =
      "text-xs font-semibold " + (checked ? "text-emerald-700" : "text-slate-400");
  }

  try {
    const { res, data } = await apiJson("/admin/guides/ajax/toggle-active", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, is_active: checked }),
    });

    if (!res.ok || !data.ok) {
      toast(data.error || "Failed to update.");
      el.checked = !checked;

      if (label) {
        const reverted = el.checked;
        label.textContent = reverted ? "Active" : "Inactive";
        label.className =
          "text-xs font-semibold " + (reverted ? "text-emerald-700" : "text-slate-400");
      }
    }
  } catch (err) {
    toast("Failed to update.");
    el.checked = !checked;

    if (label) {
      const reverted = el.checked;
      label.textContent = reverted ? "Active" : "Inactive";
      label.className =
        "text-xs font-semibold " + (reverted ? "text-emerald-700" : "text-slate-400");
    }
  }
});


  // ----------------------------
// Upgrades (single definition + resilient AJAX handling)
// ----------------------------
window.Upgrades = {
  loaded: false,

  async refresh() {
  const listEl = document.getElementById("upgrades-list");
  if (!listEl) return;

  const pid = document.getElementById("upgradesPropertyFilter")?.value || "";
  const qs = pid ? `?property_id=${encodeURIComponent(pid)}` : "";

  listEl.innerHTML = "Loading…";

  try {
    const res = await fetch(`/admin/upgrades/partial/list${qs}`, {
      credentials: "include",
      headers: { "X-Requested-With": "fetch" },
    });

    // Auth / billing handling
    if (res.status === 401 || res.status === 403) {
      if (typeof loginRedirect === "function") return loginRedirect();
      listEl.innerHTML = "Session expired. Please log in again.";
      return;
    }

    if (res.status === 402) {
      window.location.href = "/pmc/signup";
      return;
    }

    if (!res.ok) {
      listEl.innerHTML = "Could not load upgrades.";
      return;
    }

    const html = await res.text();

    // Guard: backend returned a full HTML login page (often happens with 200 OK)
    const lower = html.toLowerCase();
    if (html.includes("<html") && (lower.includes("login") || lower.includes("sign in"))) {
      if (typeof loginRedirect === "function") return loginRedirect();
      listEl.innerHTML = "Please log in again.";
      return;
    }

    // Inject partial HTML
    listEl.innerHTML = html;

    // ✅ Re-init Sortable AFTER partial is injected
    const table = listEl.querySelector('table[data-list-kind="upgrades"]');
    if (table && typeof initReorderForTable === "function") {
      initReorderForTable(table);
    }
  } catch (err) {
    console.error("Upgrades.refresh error:", err);
    listEl.innerHTML = "Could not load upgrades.";
  }
},



  openNew() {
    return window.Upgrades.openEditor(null);
  },

  async openEditor(id) {
    if (window.CONTENT_LOCKED) return toast("Complete payment to unlock Upgrades.");

    const editorWrap = document.getElementById("upgrades-editor");
    const editorBody = document.getElementById("upgrades-editor-body");
    const editorTitle = document.getElementById("upgrades-editor-title");
    if (!editorWrap || !editorBody) return;

    const url = id
      ? `/admin/upgrades/partial/form?id=${encodeURIComponent(id)}`
      : `/admin/upgrades/partial/form`;

    try {
      const res = await fetch(url, { credentials: "include" });

      if (res.status === 401 || res.status === 403) {
        if (typeof loginRedirect === "function") return loginRedirect();
        return toast("Please log in again.");
      }

      if (!res.ok) return toast("Could not load upgrade editor.");

      editorBody.innerHTML = await res.text();
      if (editorTitle) editorTitle.textContent = id ? "Edit Upgrade" : "New Upgrade";
      editorWrap.classList.remove("hidden");
    } catch (err) {
      console.error(err);
      toast("Network error loading editor.");
    }
  },

  closeEditor() {
    document.getElementById("upgrades-editor")?.classList.add("hidden");
    const body = document.getElementById("upgrades-editor-body");
    if (body) body.innerHTML = "";
  },

  async submit(form) {
    if (window.CONTENT_LOCKED) return toast("Complete payment to unlock Upgrades.");
    if (!form) return;

    const flash = document.getElementById("upgrades-flash");

    const showFlash = (msg, ok = true) => {
      if (!flash) return toast(msg);

      flash.innerHTML = `
        <div class="rounded-xl border ${
          ok
            ? "border-emerald-200 bg-emerald-50 text-emerald-900"
            : "border-rose-200 bg-rose-50 text-rose-900"
        } p-3 text-sm">
          ${msg}
        </div>`;

      setTimeout(() => {
        if (flash) flash.innerHTML = "";
      }, 2400);
    };

    try {
      const res = await fetch("/admin/upgrades/ajax/save", {
        method: "POST",
        credentials: "include",
        body: new FormData(form),
      });

      // 🔐 Handle auth like your upload-image handler
      if (res.status === 401 || res.status === 403) {
        if (typeof loginRedirect === "function") return loginRedirect();
        showFlash("Session expired. Please log in again.", false);
        return;
      }

      // ✅ Robustly handle non-JSON responses (e.g., HTML login page with 200 OK)
      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      if (!contentType.includes("application/json")) {
        const text = await res.text().catch(() => "");
        console.error("Save returned non-JSON:", {
          status: res.status,
          contentType,
          preview: text.slice(0, 500),
        });
        showFlash("Save failed (server returned non-JSON).", false);
        return;
      }

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok) {
        showFlash(data.error || data.detail || data.message || "Save failed.", false);
        return;
      }

      showFlash("Saved ✓", true);
      await window.Upgrades.refresh();
      window.Upgrades.closeEditor();
    } catch (err) {
      console.error(err);
      showFlash("Network error saving upgrade.", false);
    }
  },
};


   document.addEventListener("input", (e) => {
  const titleInput = e.target;
  if (!(titleInput instanceof HTMLInputElement)) return;
  if (!titleInput.matches('input[name="title"]')) return;

  const form = titleInput.closest("form");
  if (!form) return;

  const slugInput = form.querySelector('[data-upgrade-slug]');
  if (!slugInput) return;

  // Only auto-generate if slug is empty (don’t overwrite existing edits)
  if (slugInput.value) return;

  slugInput.value = titleInput.value
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");
});


   // Upgrade image upload (delegated — works for AJAX-loaded form)
/*document.addEventListener("change", async (e) => {
  const input = e.target;
  if (!(input instanceof HTMLInputElement)) return;
  if (!input.matches("[data-upgrade-image-file]")) return;

  if (IS_LOCKED) {
    toast("Complete payment to unlock Upgrades.");
    input.value = "";
    return;
  }

  const file = input.files?.[0];
  if (!file) return;

  const editor = input.closest("#upgrades-editor-body") || document;
  const hiddenUrl = editor.querySelector("[data-upgrade-image-url]");
  const preview = editor.querySelector("[data-upgrade-image-preview]");
  const upgradeId = editor.querySelector('input[name="id"]')?.value || "";

  try {
    toast("Uploading image…");

    const fd = new FormData();
    fd.append("file", file);
    if (upgradeId) fd.append("upgrade_id", upgradeId);

    const res = await fetch("/admin/upgrades/ajax/upload-image", {
      method: "POST",
      credentials: "include",
      body: fd,
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok || !data.url) {
      toast(data.error || "Upload failed.");
      return;
    }

    // Persist for Save Upgrade
    if (hiddenUrl) hiddenUrl.value = data.url;

    // Preview
    if (preview) {
      preview.src = data.url;
      preview.classList.remove("hidden");
    }

    toast("Image uploaded ✓");
  } catch (err) {
    console.error(err);
    toast("Upload failed.");
  } finally {
    // allow re-uploading same file
    input.value = "";
  }
});*/

// Upload image (delegated) — works after partial loads
document.addEventListener("click", async (e) => {
  const uploadBtn = e.target.closest("[data-upgrade-image-upload]");
  if (!uploadBtn) return;

  const form = uploadBtn.closest("form");
  if (!form) return;

  const fileInput = form.querySelector("[data-upgrade-image-file]");
  const preview = form.querySelector("[data-upgrade-image-preview]");
  const tmpKeyInput = form.querySelector('input[name="image_tmp_key"]');
  const imageUrlInput = form.querySelector('input[name="image_url"]'); // keep existing DB value!

  const file = fileInput?.files?.[0];
  if (!file) return toast("Choose an image first.");

  const fd = new FormData();
  fd.append("file", file);

  // If editing, pass upgrade id (optional, but useful on backend)
  const upgradeId = (form.querySelector('input[name="id"]')?.value || "").trim();
  if (upgradeId) fd.append("upgrade_id", upgradeId);

  // IMPORTANT: pass previous tmp key so backend can delete/replace it
  const prevTmpKey = (tmpKeyInput?.value || "").trim();
  if (prevTmpKey) fd.append("prev_tmp_key", prevTmpKey);

  uploadBtn.disabled = true;
  const original = uploadBtn.textContent;
  uploadBtn.textContent = "Uploading…";

  try {
    const res = await fetch("/admin/upgrades/ajax/upload-image", {
      method: "POST",
      credentials: "include",
      body: fd,
    });

    if (res.status === 401 || res.status === 403) return loginRedirect();

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      toast(data.error || "Upload failed.");
      return;
    }

    // Set ONLY the temp key (for finalize on Save)
    if (tmpKeyInput) tmpKeyInput.value = data.tmp_key || "";

    // DO NOT overwrite the saved image_url here if using tmp-key finalize workflow.
    // Keep existing DB image_url until Save runs.
    // imageUrlInput.value should only be changed in /admin/upgrades/ajax/save after finalize.
    // (But we can still show preview below.)

    // Preview from returned preview_url (could be temp-served or final)
    const previewUrl = data.preview_url || "";
    if (preview) {
      preview.src = previewUrl;
      preview.classList.toggle("hidden", !previewUrl);
    }

    // Optional: visually indicate pending unsaved change
    // e.g., store a data flag for later if you want
    if (imageUrlInput) imageUrlInput.dataset.pendingUpload = "1";

    // Clear file input so user can reselect same file again if needed
    if (fileInput) fileInput.value = "";

    toast("Image uploaded. Click Save Upgrade to apply.");
  } catch (err) {
    console.error(err);
    toast("Upload failed.");
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.textContent = original;
  }
});


document.addEventListener("click", async (e) => {
  const clearBtn = e.target.closest("[data-upgrade-image-clear]");
  if (!clearBtn) return;

  const form = clearBtn.closest("form");
  if (!form) return;

  const preview = form.querySelector("[data-upgrade-image-preview]");
  const imageUrlInput = form.querySelector('input[name="image_url"]');
  const tmpKeyInput = form.querySelector('input[name="image_tmp_key"]');

  const tmpKey = (tmpKeyInput?.value || "").trim();

  // Clear UI immediately
  if (preview) {
    preview.src = "";
    preview.classList.add("hidden");
  }
  if (imageUrlInput) imageUrlInput.value = "";   // clear persisted url
  if (tmpKeyInput) tmpKeyInput.value = "";       // clear temp key

  // If there was a temp upload, delete it server-side
  if (tmpKey) {
    try {
      const res = await fetch("/admin/upgrades/ajax/delete-temp-image", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tmp_key: tmpKey }),
      });
      if (res.status === 401 || res.status === 403) return loginRedirect();
    } catch (err) {
      console.error(err);
    }
  }

  toast("Image removed.");
});


// Upgrades: delegated events (ONLY ONCE)
document.addEventListener("click", async (e) => {
  // Edit
  const editBtn = e.target.closest("[data-upgrade-edit]");
  if (editBtn) {
    const id = (editBtn.getAttribute("data-upgrade-edit") || "").trim();
    if (!id || id === "None" || id === "null" || id === "undefined") return;
    Upgrades.openEditor(id);
    return;
  }

  // Delete
  const delBtn = e.target.closest("[data-upgrade-delete]");
  if (!delBtn) return;

  if (window.CONTENT_LOCKED) {
    toast("Complete payment to unlock Upgrades.");
    return;
  }

  const id = (delBtn.getAttribute("data-upgrade-delete") || "").trim();
  if (!id || id === "None" || id === "null" || id === "undefined") return;

  if (!confirm("Delete this upgrade?")) return;

  try {
    const { res, data } = await apiJson(`/admin/upgrades/ajax/delete?id=${encodeURIComponent(id)}`, {
      method: "POST",
    });

    if (!res.ok || !data.ok) {
      toast(data.error || data.detail || "Delete failed.");
      return;
    }

    toast("Upgrade deleted");
    await Upgrades.refresh();
    Upgrades.closeEditor();
  } catch (err) {
    console.error(err);
    toast("Delete failed.");
  }
});


/*
   // Upgrade image upload (delegated)
document.addEventListener("change", async (e) => {
  const input = e.target;
  if (!(input instanceof HTMLInputElement)) return;
  if (!input.matches("[data-upgrade-image-file]")) return;

  if (IS_LOCKED) {
    toast("Complete payment to unlock Upgrades.");
    input.value = "";
    return;
  }

  const file = input.files?.[0];
  if (!file) return;

  const editor = input.closest("#upgrades-editor-body") || document;
  const hiddenUrl = editor.querySelector("[data-upgrade-image-url]");
  const preview = editor.querySelector("[data-upgrade-image-preview]");
  const upgradeId = editor.querySelector('input[name="id"]')?.value || "";

  try {
    toast("Uploading image…");

    const fd = new FormData();
    fd.append("file", file);
    if (upgradeId) fd.append("upgrade_id", upgradeId);

    const res = await fetch("/admin/upgrades/ajax/upload-image", {
      method: "POST",
      credentials: "include",
      body: fd,
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok || !data.url) {
      toast(data.error || "Upload failed.");
      return;
    }

    if (hiddenUrl) hiddenUrl.value = data.url;

    if (preview) {
      preview.src = data.url;
      preview.classList.remove("hidden");
    }

    toast("Image uploaded ✓");
  } catch (err) {
    console.error(err);
    toast("Upload failed.");
  } finally {
    input.value = "";
  }
});
*/



   

  document.addEventListener("change", async (e) => {
    const el = e.target;
    if (!(el instanceof HTMLInputElement)) return;
    if (!el.matches("[data-upgrade-active]")) return;

    const id = el.dataset.upgradeId;
    const checked = el.checked;

    // Optional: label support if you add it in the table partial
    const row = el.closest("[data-upgrade-row]");
    const label = row?.querySelector("[data-upgrade-status-label]");
    if (label) {
      label.textContent = checked ? "Active" : "Inactive";
      label.className =
        "text-xs font-semibold " +
        (checked ? "text-emerald-700" : "text-slate-400");
    }

    try {
      const { res, data } = await apiJson("/admin/upgrades/ajax/toggle-active", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, is_active: checked }),
      });

      if (!res.ok || !data.ok) {
        toast(data.error || "Failed to update.");
        el.checked = !checked;

        if (label) {
          const reverted = el.checked;
          label.textContent = reverted ? "Active" : "Inactive";
          label.className =
            "text-xs font-semibold " +
            (reverted ? "text-emerald-700" : "text-slate-400");
        }
      }
    } catch (err) {
      toast("Failed to update.");
      el.checked = !checked;

      if (label) {
        const reverted = el.checked;
        label.textContent = reverted ? "Active" : "Inactive";
        label.className =
          "text-xs font-semibold " +
          (reverted ? "text-emerald-700" : "text-slate-400");
      }
    }
  });

  // ----------------------------
  // Guides (single definition)
  // ----------------------------
  function flashIn(elId, msg, ok = true) {
    const el = document.getElementById(elId);
    if (!el) return;
    el.innerHTML = `<div class="text-sm rounded-xl px-3 py-2 ${
      ok
        ? "bg-emerald-50 border border-emerald-200 text-emerald-800"
        : "bg-rose-50 border border-rose-200 text-rose-800"
    }">${msg}</div>`;
    setTimeout(() => (el.innerHTML = ""), 2400);
  }

  async function loadHtmlInto(url, targetId) {
    const r = await fetch(url, {
      credentials: "include",
      headers: { "X-Requested-With": "fetch" },
    });
    if (r.status === 401 || r.status === 403) return loginRedirect();
    const target = document.getElementById(targetId);
    if (target) target.innerHTML = await r.text();

     initAllReorderTables();
  }

  window.Guides = {
    loaded: false,

    refresh() {
      const pid = document.getElementById("guidesPropertyFilter")?.value || "";
      const qs = pid ? `?property_id=${encodeURIComponent(pid)}` : "";
      return loadHtmlInto(`/admin/guides/partial/list${qs}`, "guides-list");
    },

    openNew() {
      return Guides.openForm("/admin/guides/partial/form", "New Guide");
    },

    openEdit(id) {
      return Guides.openForm(
        `/admin/guides/partial/form?id=${encodeURIComponent(id)}`,
        "Edit Guide"
      );
    },

    async openForm(url, title) {
      if (CONTENT_LOCKED) return toast("Complete payment to unlock Guides.");
      document.getElementById("guides-editor-title").textContent = title || "Editor";
      await loadHtmlInto(url, "guides-editor-body");
      document.getElementById("guides-editor")?.classList.remove("hidden");
    },

    closeEditor() {
      document.getElementById("guides-editor")?.classList.add("hidden");
      const body = document.getElementById("guides-editor-body");
      if (body) body.innerHTML = "";
    },

    async submit(formEl) {
      if (CONTENT_LOCKED) return toast("Complete payment to unlock Guides.");
      const r = await fetch("/admin/guides/ajax/save", {
        method: "POST",
        credentials: "include",
        body: new FormData(formEl),
      });
      if (r.status === 401 || r.status === 403) return loginRedirect();
      const j = await r.json().catch(() => ({}));
      if (!j.ok) return flashIn("guides-flash", j.error || "Save failed", false);
      flashIn("guides-flash", "Guide saved");
      Guides.closeEditor();
      Guides.refresh();
    },

    async remove(id) {
      if (CONTENT_LOCKED) return toast("Complete payment to unlock Guides.");
      if (!confirm("Delete this guide?")) return;
      const r = await fetch(`/admin/guides/ajax/delete?id=${encodeURIComponent(id)}`, {
        method: "POST",
        credentials: "include",
      });
      const j = await r.json().catch(() => ({}));
      if (!j.ok) return flashIn("guides-flash", j.error || "Delete failed", false);
      flashIn("guides-flash", "Guide deleted");
      Guides.refresh();
    },
  };

  // ----------------------------
  // Settings tabs + Team settings
  // ----------------------------
  function getSettingsTabFromHash() {
    const h = location.hash || "";
    if (!h.startsWith("#settings")) return "profile";
    const q = h.split("?")[1] || "";
    const params = new URLSearchParams(q);
    return params.get("tab") || "profile";
  }

  function showSettingsPanel(key) {
    document.querySelectorAll(".settings-panel").forEach((p) => p.classList.add("hidden"));
    document.getElementById(`settings-${key}`)?.classList.remove("hidden");

    document.querySelectorAll(".settings-tab").forEach((b) => b.classList.remove("bg-slate-50"));
    document
      .querySelector(`.settings-tab[data-settings="${key}"]`)
      ?.classList.add("bg-slate-50");

    const base = (location.hash || "#overview").split("?")[0];
    if (base === "#settings") history.replaceState(null, "", `#settings?tab=${key}`);
  }

  function updateMemberStatusUI(memberId, isActive) {
    const row = document.querySelector(`[data-member-row="${memberId}"]`);
    if (!row) return;

    const statusEl = row.querySelector("[data-member-status]");
    if (statusEl) {
      statusEl.textContent = isActive ? "Active" : "Disabled";
      statusEl.className = isActive
        ? "text-xs font-semibold text-emerald-700"
        : "text-xs font-semibold text-rose-700";
    }

    const toggleBtn = row.querySelector("[data-member-toggle]");
    if (toggleBtn) {
      toggleBtn.textContent = isActive ? "Disable" : "Enable";
      toggleBtn.dataset.nextActive = isActive ? "false" : "true";
    }
  }

  function setSaveEnabled(memberId, enabled) {
    const btn = document.querySelector(`[data-member-save-role][data-member-id="${memberId}"]`);
    if (!btn) return;
    btn.disabled = !enabled;
    btn.classList.toggle("opacity-50", !enabled);
    btn.classList.toggle("cursor-not-allowed", !enabled);
  }

  async function refreshTeamRows() {
    const res = await fetch("/admin/settings/team/table", { credentials: "include" });

    if (res.status === 401 || res.status === 403) {
      toast("Session expired. Please sign in again.");
      loginRedirect();
      return false;
    }
    if (!res.ok) {
      toast("Could not refresh team list.");
      return false;
    }

    const html = await res.text();
    const tbody = document.querySelector("#settings-team tbody");
    if (tbody) tbody.innerHTML = html;

    // re-disable Save buttons by default
    document.querySelectorAll("[data-member-save-role]").forEach((b) => {
      b.disabled = true;
      b.classList.add("opacity-50", "cursor-not-allowed");
    });

    return true;
  }

  function initTeamSettings() {
    const teamPanel = document.getElementById("settings-team");
    if (!teamPanel) return;

    // Disable Save buttons initially
    document.querySelectorAll("[data-member-save-role]").forEach((b) => {
      b.disabled = true;
      b.classList.add("opacity-50", "cursor-not-allowed");
    });

    // Modal open/close
    const inviteModal = document.getElementById("inviteModal");
    document.getElementById("openInvite")?.addEventListener("click", () => inviteModal?.classList.remove("hidden"));
    ["closeInvite", "cancelInvite"].forEach((id) => {
      document.getElementById(id)?.addEventListener("click", () => inviteModal?.classList.add("hidden"));
    });

    // Invite submit
    document.getElementById("inviteForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formEl = e.currentTarget;
      const body = Object.fromEntries(new FormData(formEl).entries());

      try {
        const res = await fetch("/admin/settings/team/invite", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok && data.ok) {
          toast(data.message || "Invite saved.");
          formEl.reset();
          inviteModal?.classList.add("hidden");
          await refreshTeamRows();
        } else {
          toast(data.detail || data.message || "Invite failed.");
        }
      } catch (err) {
        console.error(err);
        toast("Invite failed.");
      }
    });

    // Role dropdown -> enable Save if changed
    teamPanel.addEventListener("change", (e) => {
      const el = e.target;
      if (!(el instanceof HTMLSelectElement)) return;
      if (!el.matches("[data-member-role]")) return;

      const memberId = el.dataset.memberId;
      const original = (el.dataset.originalRole || "").trim();
      const current = (el.value || "").trim();
      if (!memberId) return;

      setSaveEnabled(memberId, current !== original);
    });

    // Delegated team actions
    teamPanel.addEventListener("click", async (e) => {
      const btn = e.target instanceof HTMLElement ? e.target.closest("button") : null;
      if (!btn) return;

      // Save role
      if (btn.matches("[data-member-save-role]")) {
        const memberId = btn.dataset.memberId;
        const select = document.querySelector(`[data-member-role][data-member-id="${memberId}"]`);
        const role = select?.value;
        if (!memberId || !role) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role }),
          });

          if (res.ok && data.ok) {
            toast(data.message || "Role saved.");
            await refreshTeamRows();
          } else {
            toast(data.detail || data.message || "Failed to save role.");
            btn.disabled = false;
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Failed to save role.");
          btn.disabled = false;
        }
        return;
      }

      // Enable / Disable
      if (btn.matches("[data-member-toggle]")) {
        const memberId = btn.dataset.memberId;
        const nextActive = btn.dataset.nextActive;
        if (!memberId || (nextActive !== "true" && nextActive !== "false")) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ is_active: nextActive === "true" }),
          });

          if (res.ok && data.ok) {
            const nowActive = nextActive === "true";
            updateMemberStatusUI(memberId, nowActive);
            toast(nowActive ? "User enabled." : "User disabled.");
          } else {
            toast(data.detail || data.message || "Failed to update status.");
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Failed to update status.");
        } finally {
          btn.disabled = false;
        }
        return;
      }

      // Delete invite / Remove
      if (btn.matches("[data-member-delete]")) {
        const memberId = btn.dataset.memberId;
        const label = btn.dataset.deleteLabel || "Remove";
        if (!memberId) return;

        if (!confirm(`${label}? This cannot be undone.`)) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, { method: "DELETE" });
          if (res.ok && data.ok) {
            document.querySelector(`[data-member-row="${memberId}"]`)?.remove();
            toast(label === "Delete invite" ? "Invite deleted." : "User removed.");
          } else {
            toast(data.detail || data.message || "Delete failed.");
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Delete failed.");
        } finally {
          btn.disabled = false;
        }
      }
    });
  }

  // ----------------------------
  // Settings init (only once)
  // ----------------------------
  let settingsInitialized = false;

  function initSettingsUI() {
    if (settingsInitialized) return;
    settingsInitialized = true;

    document.querySelectorAll(".settings-tab").forEach((btn) => {
      btn.addEventListener("click", () => showSettingsPanel(btn.dataset.settings));
    });

    document.getElementById("profileForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const body = Object.fromEntries(new FormData(form).entries());

      try {
        const { res, data } = await apiJson("/admin/settings/profile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (res.ok && (data.ok ?? true)) toast("Profile saved.");
        else toast(data.detail || data.message || "Failed to save profile.");
      } catch (err) {
        if (String(err) !== "Error: auth") toast("Failed to save profile.");
      }
    });

    document.getElementById("notifForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);

      const keys = ["guest_messages", "maintenance_assigned", "turnover_due"];
      const prefs = {};
      keys.forEach((k) => (prefs[k] = fd.get(k) !== null));

      try {
        const { res, data } = await apiJson("/admin/settings/notifications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prefs }),
        });
        if (res.ok && (data.ok ?? true)) toast("Notifications saved.");
        else toast(data.detail || data.message || "Failed to save notifications.");
      } catch (err) {
        if (String(err) !== "Error: auth") toast("Failed to save notifications.");
      }
    });

    initTeamSettings();
    showSettingsPanel(getSettingsTabFromHash());
  }

   function initReorderForTable(rootEl) {
  if (!rootEl || !window.Sortable) return;

  const tbody = rootEl.querySelector("[data-reorder-body]");
  if (!tbody) return;

  // Prevent double init on the same tbody
  if (tbody._sortable) return;

  const kind = rootEl.getAttribute("data-list-kind") || "";

  tbody._sortable = new Sortable(tbody, {
    animation: 150,
    handle: "[data-reorder-handle]",
    draggable: "tr",

    onEnd: async () => {
      // rows are like: data-guides-row="ID" or data-upgrades-row="ID"
      const rowAttr = `data-${kind}-row`;
    
      const ids = Array.from(tbody.querySelectorAll(`tr[${rowAttr}]`))
        .map((tr) => tr.getAttribute(rowAttr))
        .filter(Boolean);
    
      // selected property filter
      const propertyIdRaw =
        (kind === "guides"
          ? document.getElementById("guidesPropertyFilter")?.value
          : document.getElementById("upgradesPropertyFilter")?.value) || "";
    
      // IMPORTANT: avoid sending "" (empty string) to FastAPI int parser
      const propertyId = propertyIdRaw ? Number(propertyIdRaw) : null;
    
      // IMPORTANT: send numeric IDs if your backend expects ints
      const order = ids.map((x) => Number(x)).filter((n) => Number.isFinite(n));
    
      if (!order.length) {
        toast("Could not determine new order.");
        return;
      }
    
      try {
        const url =
          kind === "guides"
            ? "/admin/guides/ajax/reorder"
            : "/admin/upgrades/ajax/reorder";
    
        const { res, data } = await apiJson(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ property_id: propertyId, order }),
        });
    
        if (!res.ok || !data.ok) toast(data.error || "Failed to save order.");
      } catch (e) {
        toast("Failed to save order.");
      }
    },

  });
}

function initAllReorderTables() {
  document.querySelectorAll('table[data-list-kind]').forEach(initReorderForTable);
}


  // ----------------------------
  // Main view routing (left nav)
  // ----------------------------
  function initRouting() {
    const pageTitle = document.getElementById("page-title");
    const pageSubtitle = document.getElementById("page-subtitle");
    const navItems = Array.from(document.querySelectorAll(".nav-item"));
    const views = Array.from(document.querySelectorAll(".view"));

    const subtitles = {
      overview: "{{ 'System health & activity' if user_role == 'super' else 'Your portfolio at a glance' }}",
      properties: "Search and manage your portfolio",
      chats: "Lifecycle, priority, escalations",
      pmcs: "Partners, integrations, access",
      guides: "Guest-facing guides per property",
      upgrades: "Paid add-ons per property",
      files: "Configs & manuals",
      analytics: "Trends & performance",
      settings: "Account and system settings",
    };

    function showView(key) {
      const target = document.getElementById(`view-${key}`);
      if (!target) key = "overview";

      views.forEach((v) => v.classList.add("hidden"));
      document.getElementById(`view-${key}`)?.classList.remove("hidden");

      navItems.forEach((btn) => btn.setAttribute("aria-current", "false"));
      const activeBtn = navItems.find((b) => b.dataset.view === key);
      if (activeBtn) activeBtn.setAttribute("aria-current", "page");

      const label =
        activeBtn?.querySelector(".sidebar-label")?.textContent?.trim() || "Overview";
      if (pageTitle) pageTitle.textContent = label;
      if (pageSubtitle) pageSubtitle.textContent = subtitles[key] || "";

      history.replaceState(null, "", `#${key}`);

      if (key === "properties") {
        const global = document.getElementById("globalSearch");
        const local = document.getElementById("searchInput");
        if (global && local && global.value && !local.value) local.value = global.value;
        filterProperties();
      }

      if (key === "settings") {
        initSettingsUI();
        showSettingsPanel(getSettingsTabFromHash());
      }

      if (key === "guides" && !Guides.loaded) {
        Guides.loaded = true;
        Guides.refresh();
      }

      if (key === "upgrades" && !Upgrades.loaded) {
        Upgrades.loaded = true;
        Upgrades.refresh();
      }
    }

    window.showView = showView;
    navItems.forEach((btn) => btn.addEventListener("click", () => showView(btn.dataset.view)));

    const initial = (location.hash || "#overview").replace("#", "").split("?")[0];
    showView(initial);
  }

  // ----------------------------
  // DOM ready
  // ----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    initSidebar();
    initRouting();

    // Chart init
    const ctx = document.getElementById("statusChart");
    if (ctx && window.Chart) {
      statusChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["LIVE", "OFFLINE"],
          datasets: [
            { label: "Properties", data: [{{ live_props }}, {{ offline_props }}] },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
        },
      });
    }

    // Hook filters
    document.getElementById("searchInput")?.addEventListener("input", filterProperties);
    document.getElementById("statusFilter")?.addEventListener("change", filterProperties);

    // Property filters for guides/upgrades
    document.getElementById("guidesPropertyFilter")?.addEventListener("change", () => Guides.refresh());
    document.getElementById("upgradesPropertyFilter")?.addEventListener("change", () => {
      Upgrades.closeEditor();
      Upgrades.refresh();
    });

    // Optional: keep overview counters consistent if you render stat ids
    updateOverviewUI();
  });
</script>

</body>
</html>
