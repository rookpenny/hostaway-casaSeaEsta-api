<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HostScout Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06), 0 10px 24px rgba(15, 23, 42, 0.06); }
    .hairline { box-shadow: inset 0 1px 0 rgba(255,255,255,.7); }

    /* Active nav state */
    .nav-item[aria-current="page"] { background: rgb(248 250 252); color: rgb(15 23 42); }
    .nav-item[aria-current="page"] .nav-icon-wrap { background: rgb(15 23 42); border-color: rgb(15 23 42); }
    .nav-item[aria-current="page"] svg { color: white; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex">

    <!-- Sidebar -->
    <aside id="sidebar"
      class="sticky top-0 h-screen bg-white border-r border-slate-200 flex flex-col
             w-72 transition-[width] duration-200 ease-out">

      <!-- Brand -->
      <div class="h-16 px-4 flex items-center justify-between border-b border-slate-200">
        <a href="#" class="flex items-center gap-2 overflow-hidden">
          <div class="w-9 h-9 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            H
          </div>
          <div class="sidebar-label whitespace-nowrap">
            <div class="text-sm font-semibold leading-4">HostScout</div>
            <div class="text-xs text-slate-500">
              {% if user_role == "super" %}Super Admin{% else %}PMC Dashboard{% endif %}
            </div>
          </div>
        </a>

        <button id="sidebar-toggle"
          class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50 grid place-items-center"
          aria-label="Toggle sidebar"
          type="button">
          <svg class="h-5 w-5 text-slate-600" viewBox="0 0 24 24" fill="none">
            <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <!-- Nav -->
      <nav class="p-3 space-y-1">

        <!-- Overview -->
        <button data-view="overview"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          aria-current="page"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M3 13h8V3H3v10zm10 8h8V11h-8v10zM3 21h8v-6H3v6zm10-18v6h8V3h-8z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Overview</span>
        </button>

        {% if user_role == "super" %}
        <button data-view="chats"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Chats</span>
        </button>

        <button data-view="pmcs"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M4 21V3h10v18M14 9h6v12M8 7h2M8 11h2M8 15h2M18 13h2M18 17h2"
                stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">PMCs</span>
        </button>

        <button data-view="files"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
              <path d="M14 2v6h6" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Configs & Manuals</span>
        </button>

        <button data-view="analytics"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M4 19V5M4 19h16M8 15v-6M12 19V9M16 13v-4M20 19V7"
                stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Analytics</span>
        </button>
        {% endif %}

        <button data-view="properties"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Properties</span>
        </button>

        <button data-view="settings"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.7"/>
              <path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.3-2-3.4-2.3.6a8 8 0 0 0-1.7-1L15 3h-6l-.5 2.9a8 8 0 0 0-1.7 1L4.5 6.3l-2 3.4 2 1.3a7.8 7.8 0 0 0 0 2l-2 1.3 2 3.4 2.3-.6a8 8 0 0 0 1.7 1L9 21h6l.5-2.9a8 8 0 0 0 1.7-1l2.3.6 2-3.4-2-1.3z"
                stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Settings</span>
        </button>

        <a href="/auth/logout"
           class="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-rose-50 text-slate-700">
          <span class="h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M10 17l-1 0a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4h1" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              <path d="M14 7l5 5-5 5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M19 12H10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium text-rose-700">Logout</span>
        </a>
      </nav>

      <!-- Footer -->
      <div class="mt-auto p-3 border-t border-slate-200">
        <div class="flex items-center gap-3 px-2">
          <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            {{ (pmc_name[0] if pmc_name else "U") }}
          </div>
          <div class="sidebar-label overflow-hidden">
            <div class="text-sm font-semibold leading-4 truncate">
              {{ pmc_name if pmc_name else "User" }}
            </div>
            <div class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}Super User{% else %}PMC{% endif %}
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 min-w-0">
      <!-- Topbar -->
      <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200 hairline">
        <div class="h-16 px-6 flex items-center gap-4">
          <div class="min-w-0">
            <div id="page-title" class="text-sm font-semibold truncate">Overview</div>
            <div id="page-subtitle" class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}System health & activity{% else %}Your portfolio at a glance{% endif %}
            </div>
          </div>

          <div class="flex-1"></div>

          <div class="hidden lg:block w-[420px]">
            <div class="flex items-center gap-2 px-3 h-10 rounded-xl border border-slate-200 bg-white">
              <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <input id="globalSearch"
                class="w-full text-sm outline-none placeholder:text-slate-400"
                placeholder="{% if user_role == 'super' %}Search chats, guests, properties…{% else %}Search properties…{% endif %}" />
              <kbd class="text-[11px] px-2 py-1 rounded-lg border border-slate-200 bg-slate-50 text-slate-500">⌘ K</kbd>
            </div>
          </div>

          {% if user_role == "super" %}
          <div class="flex items-center gap-2">
            <a href="/admin/chats"
              class="h-10 px-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm grid place-items-center">
              Chats
            </a>
            <a href="/admin/new-pmc"
              class="h-10 px-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm grid place-items-center">
              New PMC
            </a>
          </div>
          {% endif %}
        </div>
      </header>

      <!-- Content -->
      <div class="p-6">

        {% set is_locked = (user_role == "pmc" and needs_payment) %}

        {% if is_locked %}
        <!-- Billing Banner -->
        <div class="mb-6 rounded-2xl border border-amber-300/60 bg-amber-50 p-4 card">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold text-amber-900">
                {{ billing_banner_title or "Complete payment to activate your account" }}
              </div>
              <div class="text-sm text-amber-900/80 mt-1">
                {{ billing_banner_body or "Your account is pending. Once payment is confirmed, you can sync properties and enable Sandy." }}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <a href="/pmc/signup"
                 class="h-10 px-4 rounded-xl bg-amber-500 hover:bg-amber-600 text-black font-semibold grid place-items-center">
                Complete setup & payment
              </a>
              <a href="/auth/login/google"
                 class="h-10 px-4 rounded-xl border border-amber-300 bg-white hover:bg-amber-50 text-amber-900 font-semibold grid place-items-center">
                Refresh login
              </a>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- OVERVIEW -->
        <section id="view-overview" class="view space-y-6">

          {% set total_props = properties|length %}

          {% if is_locked %}
            {% set live_props = 0 %}
            {% set offline_props = total_props %}
          {% else %}
            {% set live_props = (properties | selectattr('sandy_enabled') | list | length) %}
            {% set offline_props = (properties | rejectattr('sandy_enabled') | list | length) %}
          {% endif %}

          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Properties</div>
              <div class="mt-2 text-3xl font-semibold">{{ total_props }}</div>
              <div class="mt-2 text-xs text-slate-500">Portfolio size</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Live</div>
              <div class="mt-2 text-3xl font-semibold">{{ live_props }}</div>
              <div class="mt-2 text-xs text-emerald-600">Sandy enabled</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Offline</div>
              <div class="mt-2 text-3xl font-semibold">{{ offline_props }}</div>
              <div class="mt-2 text-xs text-rose-600">Needs attention</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Last Sync</div>
              <div class="mt-2 text-lg font-semibold">
                {% if properties and properties[0].last_synced %}
                  {% set seconds = (now - properties[0].last_synced).total_seconds() %}
                  {% if seconds < 60 %} just now
                  {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
                  {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
                  {% else %} {{ (seconds // 86400)|int }} days ago
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="mt-2 text-xs text-slate-500">Most recent property record</div>
            </div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Status Overview</div>
                <div class="text-xs text-slate-500">LIVE vs OFFLINE</div>
              </div>
              <div class="text-xs text-slate-500">Auto-updates with your data</div>
            </div>
            <div class="mt-4">
              <canvas id="statusChart" height="90"></canvas>
            </div>
          </div>

          {% if user_role == "super" %}
          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-12 xl:col-span-7 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-sm font-semibold">Chat Volume</div>
              <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
                Chart placeholder
              </div>
            </div>
            <div class="col-span-12 xl:col-span-5 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-sm font-semibold">Priority Inbox</div>
              <div class="mt-2 text-xs text-slate-500">Escalations & time-sensitive issues</div>
              <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
                Queue placeholder
              </div>
            </div>
          </div>
          {% endif %}
        </section>

        <!-- PROPERTIES -->
        <section id="view-properties" class="view hidden space-y-4">

          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex flex-col lg:flex-row lg:items-center gap-3 justify-between">
              <div>
                <div class="text-sm font-semibold">Properties</div>
                <div class="text-xs text-slate-500">Search and manage your portfolio</div>
              </div>

              <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search properties…"
                  class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72"
                />
                <select
                  id="statusFilter"
                  class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-48"
                >
                  <option value="all">All statuses</option>
                  <option value="live">LIVE</option>
                  <option value="offline">OFFLINE</option>
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            {% for prop in properties %}
            <div class="bg-white border border-slate-200 rounded-2xl p-4 card"
                 data-property-card
                 data-name="{{ prop.property_name }}"
                 data-live="{{ 'true' if prop.sandy_enabled else 'false' }}">

              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-lg font-semibold truncate">{{ prop.property_name }}</div>
                  <div class="mt-1 text-xs text-slate-500">
                    ID: {{ prop.id }}{% if prop.pms_property_id %} • PMS: {{ prop.pms_property_id }}{% endif %}
                  </div>
                </div>

                {% if is_locked %}
                  <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200 font-semibold">
                    LOCKED
                  </span>
                {% else %}
                  {% if prop.sandy_enabled %}
                    <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold">
                      LIVE
                    </span>
                  {% else %}
                    <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold">
                      OFFLINE
                    </span>
                  {% endif %}
                {% endif %}
              </div>

              <div class="mt-3 text-xs text-slate-500">
                <span class="font-semibold text-slate-700">Last synced:</span>
                {% if prop.last_synced %}
                  {% set seconds = (now - prop.last_synced).total_seconds() %}
                  {% if seconds < 60 %} just now
                  {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
                  {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
                  {% else %} {{ (seconds // 86400)|int }} days ago
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </div>

              <div class="mt-4 flex gap-2 flex-wrap items-center">
                {% if user_role == "super" and prop.data_folder_path %}
                  <a href="/edit-file?file={{ prop.data_folder_path }}/config.json"
                     class="h-9 px-3 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">
                    Edit Config
                  </a>
                  <a href="/edit-file?file={{ prop.data_folder_path }}/manual.txt"
                     class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50">
                    Edit Manual
                  </a>
                {% endif %}

                <button
                  onclick="syncProperty({{ prop.id }}, this)"
                  class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  type="button"
                  {% if is_locked %}disabled{% endif %}>
                  Sync
                </button>

                <button
                  onclick="toggleProperty({{ prop.id }}, this)"
                  class="h-9 px-3 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  type="button"
                  {% if is_locked %}disabled{% endif %}>
                  {% if prop.sandy_enabled %}Take Offline{% else %}Go Live{% endif %}
                </button>

                {% if is_locked %}
                  <a href="/pmc/signup" class="text-xs font-semibold text-amber-700 hover:underline ml-1">
                    Unlock →
                  </a>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </section>

        {% if user_role == "super" %}
        <section id="view-chats" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Chats</div>
            <div class="mt-2 text-sm text-slate-500">
              Go to <a class="underline font-semibold" href="/admin/chats">/admin/chats</a>.
            </div>
          </div>
        </section>

        <section id="view-pmcs" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">PMCs</div>
            <div class="mt-2 text-sm text-slate-500">Create/manage PMCs, integrations, permissions.</div>
          </div>
        </section>

        <section id="view-files" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Configs & Manuals</div>
            <div class="mt-2 text-sm text-slate-500">Central file management.</div>
          </div>
        </section>

        <section id="view-analytics" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Analytics</div>
            <div class="mt-2 text-sm text-slate-500">Response time, containment, outcomes.</div>
          </div>
        </section>
        {% endif %}

        <section id="view-settings" class="view hidden space-y-4">

  <!-- Header card -->
  <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm font-semibold">Settings</div>
        <div class="mt-1 text-sm text-slate-500">
          {% if user_role == "super" %}
            Manage your profile, PMCs, roles, and platform notifications.
          {% else %}
            Manage your profile, team, and notifications for your PMC.
          {% endif %}
        </div>
      </div>

      <div class="text-xs text-slate-500">
        Signed in as <span class="font-semibold text-slate-700">{{ user_email }}</span>
      </div>
    </div>
  </div>

  <!-- Settings layout -->
  <div class="grid grid-cols-12 gap-4">

    <!-- Settings sub-nav -->
    <aside class="col-span-12 lg:col-span-3">
      <div class="bg-white border border-slate-200 rounded-2xl p-2 card">
        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="profile" type="button">
          Profile
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="team" type="button">
          Team
        </button>

        {% if user_role == "super" %}
        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="roles" type="button">
          Roles & Permissions
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="pmcs" type="button">
          PMCs
        </button>
        {% endif %}

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="notifications" type="button">
          Notifications
        </button>

        <button class="settings-tab w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 text-sm font-medium"
                data-settings="integrations" type="button">
          Integrations
        </button>
      </div>
    </aside>

    <!-- Settings panels -->
    <div class="col-span-12 lg:col-span-9 space-y-4">

      <!-- Profile -->
      <div id="settings-profile" class="settings-panel bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Profile</div>
        <div class="mt-1 text-sm text-slate-500">Update your personal preferences.</div>

        <form id="profileForm" class="mt-4 grid grid-cols-12 gap-3">
          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Full name</label>
            <input name="full_name" value="{{ user_full_name or '' }}"
                   class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm" />
          </div>

          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Email</label>
            <input value="{{ user_email }}" disabled
                   class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-slate-50 text-slate-500" />
            <div class="mt-1 text-xs text-slate-500">Managed by Google OAuth.</div>
          </div>

          <!-- NOTE: This is safe to keep even if you haven't added a DB column yet;
               your backend can ignore it until you're ready. -->
          <div class="col-span-12 md:col-span-6">
            <label class="text-xs font-semibold text-slate-600">Timezone</label>
            <select name="timezone" class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-white">
              <option value="">Select…</option>
              <option value="America/Los_Angeles">America/Los_Angeles</option>
              <option value="America/Denver">America/Denver</option>
              <option value="America/Chicago">America/Chicago</option>
              <option value="America/New_York">America/New_York</option>
            </select>
            <div class="mt-1 text-xs text-slate-500">We’ll use this for scheduling + notifications.</div>
          </div>

          <div class="col-span-12 md:col-span-6 flex items-end justify-end">
            <button type="submit"
              class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
              Save Profile
            </button>
          </div>
        </form>
      </div>

      <!-- Team -->
<div id="settings-team" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
  <div class="flex items-start justify-between gap-3">
    <div>
      <div class="text-sm font-semibold">Team</div>
      <div class="mt-1 text-sm text-slate-500">
        Invite cleaners, maintenance, and internal staff. Owners/Admins can edit roles and enable/disable users.
      </div>
    </div>

    <button id="openInvite"
      class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
      Invite Member
    </button>
  </div>

  <div class="mt-4 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="text-xs text-slate-500">
        <tr class="border-b border-slate-200">
          <th class="text-left py-2">Name</th>
          <th class="text-left py-2">Email</th>
          <th class="text-left py-2">Role</th>
          <th class="text-left py-2">Status</th>
          <th class="text-right py-2">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for m in team_members %}
        <tr class="border-b border-slate-100" data-member-row="{{ m.id }}">
          <td class="py-2 font-medium">{{ m.full_name or "—" }}</td>

          <td class="py-2 text-slate-600">
            <div class="flex items-center gap-2">
              <span>{{ m.email }}</span>
              {% if not m.last_login_at %}
                <span class="text-[11px] px-2 py-0.5 rounded-full border border-slate-200 bg-slate-50 text-slate-600 font-semibold">
                  Invite pending
                </span>
              {% endif %}
            </div>
          </td>

          <!-- Role -->
          <td class="py-2">
            <div class="flex items-center gap-2">
              <select
                class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm"
                data-member-role
                data-member-id="{{ m.id }}"
                data-original-role="{{ m.role or 'staff' }}"
                {% if m.email == user_email %}disabled title="You can't change your own role here."{% endif %}
              >
                {% for r in ["owner","admin","staff","ops_manager","maintenance","cleaner","read_only"] %}
                  <option value="{{ r }}" {% if (m.role or '') == r %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
              </select>

              {% if m.email != user_email %}
              <button
                class="h-9 px-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold"
                data-member-save-role
                data-member-id="{{ m.id }}"
                type="button"
                title="Save role change"
              >
                Save
              </button>
              {% else %}
              <span class="text-xs text-slate-400">—</span>
              {% endif %}
            </div>
          </td>

          <!-- Status -->
          <td class="py-2">
            {% if m.is_active %}
              <span class="text-xs font-semibold text-emerald-700" data-member-status>Active</span>
            {% else %}
              <span class="text-xs font-semibold text-rose-700" data-member-status>Disabled</span>
            {% endif %}
          </td>

          <!-- Actions -->
          <td class="py-2 text-right">
            {% if m.email != user_email %}
            <div class="flex items-center justify-end gap-3">
              <button
                class="text-xs font-semibold hover:underline"
                data-member-toggle
                data-member-id="{{ m.id }}"
                data-next-active="{{ 'false' if m.is_active else 'true' }}"
                type="button"
              >
                {% if m.is_active %}Disable{% else %}Enable{% endif %}
              </button>

              <button
                class="text-xs font-semibold hover:underline text-rose-700"
                data-member-delete
                data-member-id="{{ m.id }}"
                data-delete-label="{% if not m.last_login_at %}Delete invite{% else %}Remove{% endif %}"
                type="button"
              >
                {% if not m.last_login_at %}Delete invite{% else %}Remove{% endif %}
              </button>
            </div>
            {% else %}
              <span class="text-xs text-slate-400">—</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}

        {% if not team_members %}
        <tr>
          <td colspan="5" class="py-6 text-center text-slate-500">No team members yet.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Invite modal -->
  <div id="inviteModal" class="hidden fixed inset-0 z-[9999] bg-black/30 p-4">
    <div class="max-w-lg mx-auto mt-24 bg-white rounded-2xl border border-slate-200 p-4 card">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Invite team member</div>
        <button id="closeInvite" class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50" type="button">✕</button>
      </div>

      <div class="mt-2 text-xs text-slate-500">
        We use Google OAuth. Invited users will be able to sign in with this email.
      </div>

      <form id="inviteForm" class="mt-4 space-y-3">
        <div>
          <label class="text-xs font-semibold text-slate-600">Email</label>
          <input name="email" type="email" required
                 class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm" />
        </div>

        <div>
          <label class="text-xs font-semibold text-slate-600">Role</label>
          <select name="role" class="mt-1 h-10 w-full px-3 rounded-xl border border-slate-200 text-sm bg-white">
            <option value="staff">Staff</option>
            <option value="ops_manager">Ops Manager</option>
            <option value="maintenance">Maintenance</option>
            <option value="cleaner">Cleaner</option>
            <option value="read_only">Read-only</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
          </select>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancelInvite"
                  class="h-10 px-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
            Cancel
          </button>
          <button type="submit"
                  class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
            Send Invite
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


      {% if user_role == "super" %}
      <!-- Roles & Permissions (superusers) -->
      <div id="settings-roles" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Roles & Permissions</div>
        <div class="mt-1 text-sm text-slate-500">
          Define roles (cleaner, maintenance, staff) and what they can access.
        </div>

        <div class="mt-4 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm text-slate-700">
          MVP suggestion: start with fixed roles + hardcoded permissions, then move to DB-driven roles.
        </div>
      </div>

      <!-- PMCs (superusers) -->
      <div id="settings-pmcs" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">PMCs</div>
        <div class="mt-1 text-sm text-slate-500">Activate/deactivate PMCs, billing status, support tools.</div>
      </div>
      {% endif %}

      <!-- Notifications -->
      <div id="settings-notifications" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Notifications</div>
        <div class="mt-1 text-sm text-slate-500">
          Choose what you get notified about. Slack settings will live here later.
        </div>

        {% set prefs = notif_prefs or {} %}

        <form id="notifForm" class="mt-4 space-y-3">

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Guest messages</div>
              <div class="text-xs text-slate-500">Notify when a new guest message arrives.</div>
            </div>
            <input name="guest_messages" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("guest_messages") %}checked{% endif %} />
          </label>

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Maintenance assigned</div>
              <div class="text-xs text-slate-500">Notify when a maintenance request is assigned.</div>
            </div>
            <input name="maintenance_assigned" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("maintenance_assigned") %}checked{% endif %} />
          </label>

          <label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200">
            <div>
              <div class="text-sm font-semibold">Turnover due soon</div>
              <div class="text-xs text-slate-500">Notify when a cleaner task is due soon.</div>
            </div>
            <input name="turnover_due" type="checkbox" class="h-5 w-5"
                   {% if prefs.get("turnover_due") %}checked{% endif %} />
          </label>

          <div class="flex justify-end pt-2">
            <button type="submit"
              class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold">
              Save Notifications
            </button>
          </div>
        </form>

        <div class="mt-4 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm text-slate-700">
          Slack (coming soon): connect workspace, pick channel per event, and map properties → channels.
        </div>
      </div>

      <!-- Integrations -->
      <div id="settings-integrations" class="settings-panel hidden bg-white border border-slate-200 rounded-2xl p-4 card">
        <div class="text-sm font-semibold">Integrations</div>
        <div class="mt-1 text-sm text-slate-500">PMS, Slack, and other connections.</div>
      </div>

    </div>
  </div>
</section>



      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <script>
  // -------- Paywall flag (server-rendered) --------
  const IS_LOCKED = {{ 'true' if (user_role == 'pmc' and needs_payment) else 'false' }};

  // ----------------------------
  // Small UI helpers
  // ----------------------------
  function toast(message) {
    const el = document.createElement("div");
    el.className =
      "fixed bottom-5 right-5 z-[9999] bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-lg";
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2400);
  }

  function loginRedirect() {
    const next = encodeURIComponent(window.location.pathname + window.location.search + window.location.hash);
    window.location.href = `/auth/login/google?next=${next}`;
  }

  async function apiJson(url, opts = {}) {
    const res = await fetch(url, {
      credentials: "include",
      headers: { Accept: "application/json", ...(opts.headers || {}) },
      ...opts,
    });

    if (res.status === 401 || res.status === 403) {
      toast("Session expired. Please sign in again.");
      loginRedirect();
      throw new Error("auth");
    }

    let data = {};
    try { data = await res.json(); } catch {}
    return { res, data };
  }


   async function refreshTeamRows() {
    const res = await fetch("/admin/settings/team/table", { credentials: "include" });
  
    if (res.status === 401 || res.status === 403) {
      toast("Session expired. Please sign in again.");
      loginRedirect();
      return false;
    }
  
    if (!res.ok) {
      toast("Could not refresh team list.");
      return false;
    }
  
    const html = await res.text();
    const tbody = document.querySelector("#settings-team tbody");
    if (tbody) tbody.innerHTML = html;
  
    // re-disable Save buttons by default
    document.querySelectorAll("[data-member-save-role]").forEach((b) => {
      b.disabled = true;
      b.classList.add("opacity-50", "cursor-not-allowed");
    });
  
    return true;
  }


  // ----------------------------
  // Sidebar collapse/expand
  // ----------------------------
  function initSidebar() {
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebar-toggle");
    const labelEls = () => Array.from(document.querySelectorAll(".sidebar-label"));

    if (!sidebar || !toggleBtn) return;

    function setCollapsed(isCollapsed) {
      sidebar.classList.toggle("w-72", !isCollapsed);
      sidebar.classList.toggle("w-20", isCollapsed);
      labelEls().forEach((el) => el.classList.toggle("hidden", isCollapsed));

      const svg = toggleBtn.querySelector("svg");
      if (svg) {
        svg.style.transform = isCollapsed ? "rotate(180deg)" : "rotate(0deg)";
        svg.style.transition = "transform 200ms ease";
      }
      localStorage.setItem("dashboard_sidebar_collapsed", isCollapsed ? "1" : "0");
    }

    setCollapsed(localStorage.getItem("dashboard_sidebar_collapsed") === "1");

    toggleBtn.addEventListener("click", () => {
      const isCollapsed = sidebar.classList.contains("w-20");
      setCollapsed(!isCollapsed);
    });

    // ⌘K focus
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        document.getElementById("globalSearch")?.focus();
      }
    });
  }

  // ----------------------------
  // Properties filter
  // ----------------------------
  function filterProperties() {
    const search = (document.getElementById("searchInput")?.value || "").toLowerCase();
    const status = document.getElementById("statusFilter")?.value || "all";
    const cards = document.querySelectorAll("[data-property-card]");

    cards.forEach((card) => {
      const name = (card.dataset.name || "").toLowerCase();
      const live = card.dataset.live === "true";
      const matchesSearch = name.includes(search);
      const matchesStatus =
        status === "all" ||
        (status === "live" && live) ||
        (status === "offline" && !live);

      card.style.display = (matchesSearch && matchesStatus) ? "" : "none";
    });
  }
  window.filterProperties = filterProperties;

  // ----------------------------
  // Settings tabs
  // ----------------------------
  function getSettingsTabFromHash() {
    const h = location.hash || "";
    if (!h.startsWith("#settings")) return "profile";
    const q = h.split("?")[1] || "";
    const params = new URLSearchParams(q);
    return params.get("tab") || "profile";
  }

  function showSettingsPanel(key) {
    document.querySelectorAll(".settings-panel").forEach((p) => p.classList.add("hidden"));
    document.getElementById(`settings-${key}`)?.classList.remove("hidden");

    document.querySelectorAll(".settings-tab").forEach((b) => b.classList.remove("bg-slate-50"));
    document.querySelector(`.settings-tab[data-settings="${key}"]`)?.classList.add("bg-slate-50");

    const base = (location.hash || "#overview").split("?")[0];
    if (base === "#settings") history.replaceState(null, "", `#settings?tab=${key}`);
  }

  // ----------------------------
  // Team settings (invite / role save / enable / delete)
  // ----------------------------
  function updateMemberStatusUI(memberId, isActive) {
    const row = document.querySelector(`[data-member-row="${memberId}"]`);
    if (!row) return;

    const statusEl = row.querySelector("[data-member-status]");
    if (statusEl) {
      statusEl.textContent = isActive ? "Active" : "Disabled";
      statusEl.className = isActive
        ? "text-xs font-semibold text-emerald-700"
        : "text-xs font-semibold text-rose-700";
    }

    const toggleBtn = row.querySelector("[data-member-toggle]");
    if (toggleBtn) {
      toggleBtn.textContent = isActive ? "Disable" : "Enable";
      toggleBtn.dataset.nextActive = isActive ? "false" : "true";
    }
  }

  function setSaveEnabled(memberId, enabled) {
    const btn = document.querySelector(`[data-member-save-role][data-member-id="${memberId}"]`);
    if (!btn) return;
    btn.disabled = !enabled;
    btn.classList.toggle("opacity-50", !enabled);
    btn.classList.toggle("cursor-not-allowed", !enabled);
  }

  function markRoleSaved(memberId, newRole) {
    const select = document.querySelector(`[data-member-role][data-member-id="${memberId}"]`);
    if (select) select.dataset.originalRole = newRole;
    setSaveEnabled(memberId, false);
  }

  function initTeamSettings() {
    const teamPanel = document.getElementById("settings-team");
    if (!teamPanel) return;

    // Disable Save buttons initially
    document.querySelectorAll("[data-member-save-role]").forEach((b) => {
      b.disabled = true;
      b.classList.add("opacity-50", "cursor-not-allowed");
    });

    // Modal open/close
    const inviteModal = document.getElementById("inviteModal");
    document.getElementById("openInvite")?.addEventListener("click", () => inviteModal?.classList.remove("hidden"));
    ["closeInvite", "cancelInvite"].forEach(id => {
      document.getElementById(id)?.addEventListener("click", () => inviteModal?.classList.add("hidden"));
    });

    // Invite submit (stay on page + refresh team rows)
document.getElementById("inviteForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = e.currentTarget;
  const submitBtn = form.querySelector('button[type="submit"]');
  const body = Object.fromEntries(new FormData(form).entries());

  // basic front-end validation
  const email = String(body.email || "").trim();
  if (!email) {
    toast("Email is required.");
    return;
  }

  const originalBtnText = submitBtn?.textContent || "Send Invite";
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = "Sending…";
    submitBtn.classList.add("opacity-60", "cursor-not-allowed");
  }

  try {
    const { res, data } = await apiJson("/admin/settings/team/invite", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    if (!res.ok || !data?.ok) {
      toast(data?.detail || data?.message || "Invite failed.");
      return;
    }

    toast(data?.message || "Invite saved.");
    form.reset();
    inviteModal?.classList.add("hidden");

    // ✅ Refresh team table rows without full page reload
    // You need an endpoint that returns only the <tr> rows (no full HTML page)
    const { res: tRes } = await apiJson("/admin/settings/team/table", { method: "GET" });
    if (tRes.ok) {
      const rowsHtml = await tRes.text();
      const tbody = document.querySelector("#settings-team tbody");
      if (tbody) tbody.innerHTML = rowsHtml;
    }
  } catch (err) {
    if (String(err) !== "Error: auth") toast("Invite failed.");
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText;
      submitBtn.classList.remove("opacity-60", "cursor-not-allowed");
    }
  }
});


    // Change role dropdown -> enable Save if changed
    teamPanel.addEventListener("change", (e) => {
      const el = e.target;
      if (!(el instanceof HTMLSelectElement)) return;
      if (!el.matches("[data-member-role]")) return;

      const memberId = el.dataset.memberId;
      const original = (el.dataset.originalRole || "").trim();
      const current = (el.value || "").trim();
      if (!memberId) return;

      setSaveEnabled(memberId, current !== original);
    });

    // Delegated clicks (save role / toggle / delete)
    teamPanel.addEventListener("click", async (e) => {
      const btn = e.target instanceof HTMLElement ? e.target.closest("button") : null;
      if (!btn) return;

      // Save role
      if (btn.matches("[data-member-save-role]")) {
        const memberId = btn.dataset.memberId;
        const select = document.querySelector(`[data-member-role][data-member-id="${memberId}"]`);
        const role = select?.value;

        if (!memberId || !role) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role }),
          });

          if (res.ok && data.ok) {
            toast(data.message || "Invite saved.");
            form.reset();
            inviteModal?.classList.add("hidden");
            await refreshTeamRows(); // ✅ new member appears immediately
          } else {
            toast(data.detail || data.message || "Invite failed.");
          }

        } catch (err) {
          if (String(err) !== "Error: auth") toast("Failed to save role.");
          setSaveEnabled(memberId, true);
        }
        return;
      }

      // Enable / Disable
      if (btn.matches("[data-member-toggle]")) {
        const memberId = btn.dataset.memberId;
        const nextActive = btn.dataset.nextActive; // "true"/"false"
        if (!memberId || (nextActive !== "true" && nextActive !== "false")) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ is_active: nextActive === "true" }),
          });

          if (res.ok && data.ok) {
            const nowActive = nextActive === "true";
            updateMemberStatusUI(memberId, nowActive);
            toast(nowActive ? "User enabled." : "User disabled.");
          } else {
            toast(data.detail || data.message || "Failed to update status.");
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Failed to update status.");
        } finally {
          btn.disabled = false;
        }
        return;
      }

      async function refreshTeamTable() {
        const res = await fetch("/admin/settings/team", { credentials: "include" });
        if (!res.ok) return;
      
        const html = await res.text();
        document.querySelector("#settings-team tbody").innerHTML = html;
      }

      // Delete invite / Remove
      if (btn.matches("[data-member-delete]")) {
        const memberId = btn.dataset.memberId;
        const label = btn.dataset.deleteLabel || "Remove";
        if (!memberId) return;

        if (!confirm(`${label}? This cannot be undone.`)) return;

        btn.disabled = true;
        try {
          const { res, data } = await apiJson(`/admin/settings/team/${memberId}`, { method: "DELETE" });

          if (res.ok && data.ok) {
            document.querySelector(`[data-member-row="${memberId}"]`)?.remove();
            toast(label === "Delete invite" ? "Invite deleted." : "User removed.");
          } else {
            toast(data.detail || data.message || "Delete failed.");
          }
        } catch (err) {
          if (String(err) !== "Error: auth") toast("Delete failed.");
        } finally {
          btn.disabled = false;
        }
      }
    });
  }

  // ----------------------------
  // Settings init (only once)
  // ----------------------------
  let settingsInitialized = false;

  function initSettingsUI() {
    if (settingsInitialized) return;
    settingsInitialized = true;

    // Tabs
    document.querySelectorAll(".settings-tab").forEach((btn) => {
      btn.addEventListener("click", () => showSettingsPanel(btn.dataset.settings));
    });

    // Profile save
    document.getElementById("profileForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const body = Object.fromEntries(new FormData(form).entries());

      try {
        const { res, data } = await apiJson("/admin/settings/profile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (res.ok && (data.ok ?? true)) toast("Profile saved.");
        else toast(data.detail || data.message || "Failed to save profile.");
      } catch (err) {
        if (String(err) !== "Error: auth") toast("Failed to save profile.");
      }
    });

    // Notifications save
    document.getElementById("notifForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);

      const keys = ["guest_messages", "maintenance_assigned", "turnover_due"];
      const prefs = {};
      keys.forEach((k) => (prefs[k] = fd.get(k) !== null));

      try {
        const { res, data } = await apiJson("/admin/settings/notifications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prefs }),
        });
        if (res.ok && (data.ok ?? true)) toast("Notifications saved.");
        else toast(data.detail || data.message || "Failed to save notifications.");
      } catch (err) {
        if (String(err) !== "Error: auth") toast("Failed to save notifications.");
      }
    });

    // Team UI
    initTeamSettings();

    // Show correct initial tab
    showSettingsPanel(getSettingsTabFromHash());
  }

  // ----------------------------
  // Main view routing (left nav)
  // ----------------------------
  function initRouting() {
    const pageTitle = document.getElementById("page-title");
    const pageSubtitle = document.getElementById("page-subtitle");
    const navItems = Array.from(document.querySelectorAll(".nav-item"));
    const views = Array.from(document.querySelectorAll(".view"));

    const subtitles = {
      overview: "{{ 'System health & activity' if user_role == 'super' else 'Your portfolio at a glance' }}",
      properties: "Search and manage your portfolio",
      chats: "Lifecycle, priority, escalations",
      pmcs: "Partners, integrations, access",
      files: "Configs & manuals",
      analytics: "Trends & performance",
      settings: "Account and system settings",
    };

    function showView(key) {
      const target = document.getElementById(`view-${key}`);
      if (!target) key = "overview";

      views.forEach((v) => v.classList.add("hidden"));
      document.getElementById(`view-${key}`)?.classList.remove("hidden");

      navItems.forEach((btn) => btn.setAttribute("aria-current", "false"));
      const activeBtn = navItems.find((b) => b.dataset.view === key);
      if (activeBtn) activeBtn.setAttribute("aria-current", "page");

      const label = activeBtn?.querySelector(".sidebar-label")?.textContent?.trim() || "Overview";
      if (pageTitle) pageTitle.textContent = label;
      if (pageSubtitle) pageSubtitle.textContent = subtitles[key] || "";

      history.replaceState(null, "", `#${key}`);

      if (key === "properties") {
        const global = document.getElementById("globalSearch");
        const local = document.getElementById("searchInput");
        if (global && local && global.value && !local.value) local.value = global.value;
        filterProperties();
      }

      if (key === "settings") {
        initSettingsUI();
        showSettingsPanel(getSettingsTabFromHash());
      }
    }

    // expose if you need it elsewhere
    window.showView = showView;

    navItems.forEach((btn) => btn.addEventListener("click", () => showView(btn.dataset.view)));

    const initial = (location.hash || "#overview").replace("#", "").split("?")[0];
    showView(initial);
  }

  // ----------------------------
  // Property actions
  // ----------------------------
  async function postJson(url) {
    return fetch(url, {
      method: "POST",
      credentials: "include",
      headers: { Accept: "application/json" },
    });
  }

  window.syncProperty = async function (id, btn) {
    if (IS_LOCKED) return toast("Complete payment to unlock property syncing.");

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = "Syncing…";

    try {
      const res = await postJson(`/auth/sync-property/${id}`);

      if (res.status === 401 || res.status === 403) return loginRedirect();
      if (res.status === 402) return (window.location.href = "/pmc/signup");

      let data = {};
      try { data = await res.json(); } catch (_) {}
      btn.innerHTML = (res.ok && data.status === "success") ? "Synced ✓" : (data.message || data.detail || "Failed");
    } catch (err) {
      console.error("Sync error:", err);
      btn.innerHTML = "Error";
    } finally {
      setTimeout(() => {
        btn.innerHTML = original;
        btn.disabled = false;
      }, 1200);
    }
  };

  window.toggleProperty = async function (id, btn) {
    if (IS_LOCKED) return toast("Complete payment to unlock Sandy activation.");

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = "Toggling…";

    try {
      const res = await postJson(`/auth/toggle-property/${id}`);
      if (res.status === 401 || res.status === 403) return loginRedirect();

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      if (data && data.status === "needs_billing" && data.checkout_url) {
        window.location.href = data.checkout_url;
        return;
      }

      if (!res.ok) {
        toast((data && (data.detail || data.message)) || "Request failed");
        btn.innerHTML = original;
        return;
      }

      if (data && data.status === "success") {
        const isLive = data.new_status === "LIVE";
        btn.innerHTML = isLive ? "Take Offline" : "Go Live";

        const card = btn.closest("[data-property-card]");
        if (card) {
          card.dataset.live = isLive ? "true" : "false";
          const pill = card.querySelector("span.rounded-full");
          if (pill) {
            if (isLive) {
              pill.textContent = "LIVE";
              pill.className = "shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold";
            } else {
              pill.textContent = "OFFLINE";
              pill.className = "shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold";
            }
          }
        }

        filterProperties();
      } else {
        btn.innerHTML = original;
        toast("Toggle failed.");
      }
    } catch (err) {
      console.error("Toggle error:", err);
      btn.innerHTML = original;
      toast("Network error. Please try again.");
    } finally {
      btn.disabled = false;
    }
  };

  // ----------------------------
  // DOM ready
  // ----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    initSidebar();
    initRouting();

    // Chart
    const ctx = document.getElementById("statusChart");
    if (ctx && window.Chart) {
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["LIVE", "OFFLINE"],
          datasets: [{ label: "Properties", data: [{{ live_props }}, {{ offline_props }}] }],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
        },
      });
    }

    document.getElementById("searchInput")?.addEventListener("input", filterProperties);
    document.getElementById("statusFilter")?.addEventListener("change", filterProperties);
  });
</script>
</body>
</html>
