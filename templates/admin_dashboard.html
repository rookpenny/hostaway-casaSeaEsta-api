<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    a.button, button.sync-one {
      background: #2d72d9;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    button.sync-one:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status-select {
      padding: 0.4rem;
    }
    .warning-row {
      background-color: #fff3cd;
      color: #856404;
    }
    .sync-result.success {
      color: #27ae60;
    }
    .sync-result.error {
      color: #c0392b;
    }
    #sync-progress {
      margin: 1rem 0;
      font-style: italic;
    }
  </style>
</head>
<body>

<h1>ğŸ› ï¸ Admin Dashboard</h1>

<div class="top-bar">
  <input type="text" id="search" placeholder="Search PMCs..." />
  <div>
    <button id="add-pmc-btn">â• Add New PMC</button>
    <button id="sync-all">ğŸ”„ Sync All</button>
  </div>
</div>

<div id="sync-progress" style="display:none;"></div>

<table>
  <thead>
    <tr>
      <th>âœï¸ Edit</th>
      <th>PMC</th>
      <th>PMS Account ID</th>
      <th>API Key</th>
      <th>Contact</th>
      <th>Integration</th>
      <th>Active</th>
      <th>Sync</th>
      <th>Last Synced</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for record in pmc %}
      {% if not record.pms_account_id or not record.pms_api_key %}
        <tr class="warning-row">
          <td colspan="9">
            âš ï¸ <strong>{{ record.pmc_name }}</strong> is missing PMS credentials (API key or Account ID).
          </td>
        </tr>
      {% else %}
        <tr>
          <td>{{ record.pmc_name }}</td>
          <td>{{ record.pms_account_id }}</td>
          <td>{{ record.pms_api_key }}</td>
          <td>{{ record.email }}</td>
          <td>{{ record.pms_integration }}</td>
          <td>
            <select class="status-select" data-record-id="{{ record.id }}">
              <option value="true" {% if record.active %}selected{% endif %}>âœ…</option>
              <option value="false" {% if not record.active %}selected{% endif %}>âŒ</option>
            </select>
          </td>
          <td>
            <button
              class="sync-one"
              data-account-id="{{ record.pms_account_id }}"
              {% if not record.pms_account_id %}disabled{% endif %}
            >
              ğŸ”„ Sync
            </button>
            <span id="status-{{ record.pms_account_id }}"></span>
          </td>
          <td>
            <span id="last-{{ record.pms_account_id }}">
              {% if record.last_synced_at %}
                {{ record.last_synced_at.strftime('%Y-%m-%d %H:%M UTC') }}
              {% else %}
                Never
              {% endif %}
            </span>
          </td>
          <td>
            <span class="sync-result" id="result-{{ record.pms_account_id }}">â€”</span>
          </td>
          <td>
            <button class="edit-pmc-btn" data-pmc='{{ record | tojson | safe }}'>âœï¸ Edit</button>
            <button class="edit-properties-btn" onclick='openPropertiesModal({{ record | tojson | safe }})'>ğŸ˜ï¸ Properties</button>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>

  <!-- âœ… Toast Notification -->
<div id="toast" style="
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: #333;
  color: #fff;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  font-size: 1rem;
  opacity: 0;
  transition: opacity 0.4s ease;
  z-index: 9999;
  pointer-events: none;
"></div>

  <!-- ğŸ”§ Edit PMC Modal -->
<div id="editModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:2rem; border-radius:8px; width:90%; max-width:500px; position:relative;">
    <h3>Edit PMC</h3>
    <form id="editPmcForm">
      <input type="hidden" id="edit-id">
      <label>Name:<br><input type="text" id="edit-name" required></label><br><br>
      <label>Email:<br><input type="email" id="edit-email"></label><br><br>
      <label>Main Contact:<br><input type="text" id="edit-contact"></label><br><br>
      <label>Subscription Plan:<br><input type="text" id="edit-subscription"></label><br><br>
      <label>PMS Integration:<br><input type="text" id="edit-integration"></label><br><br>
      <label>Client ID:<br><input type="text" id="edit-client-id" required></label><br><br>
      <label>Secret:<br><input type="text" id="edit-secret" required></label><br><br>
      <label>Active: <input type="checkbox" id="edit-active"></label><br><br>

      <div id="edit-spinner" style="display:none;">ğŸŒ€ Saving...</div>
      <div id="edit-success" style="display:none; color:green;">âœ… Saved!</div>
      <div id="edit-error" style="display:none; color:red;"></div>

      <button type="submit">ğŸ’¾ Save</button>
      <button type="button" onclick="closeModal()">âŒ Cancel</button>
      <button type="button" id="delete-btn" style="float:right; color:red;">ğŸ—‘ï¸ Delete</button>
    </form>
  </div>
</div>
  <!-- ğŸ˜ï¸ Edit PMC Properties Modal -->
<div id="propertiesModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:2rem; border-radius:8px; width:90%; max-width:600px; position:relative;">
    <h3>Edit Properties for <span id="propertiesModalTitle"></span></h3>
    <form id="propertiesForm">
      <div id="propertiesList" style="max-height:300px; overflow-y:auto; margin-bottom:1rem;"></div>
      <div id="properties-spinner" style="display:none;">ğŸŒ€ Saving...</div>
      <div id="properties-success" style="display:none; color:green;">âœ… Saved!</div>
      <div id="properties-error" style="display:none; color:red;"></div>
      <button type="submit">ğŸ’¾ Save</button>
      <button type="button" onclick="closePropertiesModal()">âŒ Cancel</button>
    </form>
  </div>
</div>

<script>

  function openPropertiesModal(pmc) {
  document.getElementById("propertiesModalTitle").textContent = pmc.pmc_name;
  document.getElementById("propertiesModal").style.display = "flex";

  fetch(`/admin/pmc-properties/${pmc.id}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("propertiesList");
      container.innerHTML = "";

      data.properties.forEach(prop => {
        const row = document.createElement("div");
        row.innerHTML = `
          <label>
            <input type="checkbox" name="sandy_enabled" data-id="${prop.id}" ${prop.sandy_enabled ? 'checked' : ''}>
            ${prop.property_name} (${prop.pms_property_id})
          </label>`;
        container.appendChild(row);
      });
    })
    .catch(err => {
      showToast("âŒ Failed to load properties", "error");
      closePropertiesModal();
    });
}

function closePropertiesModal() {
  document.getElementById("propertiesModal").style.display = "none";
  document.getElementById("properties-spinner").style.display = "none";
  document.getElementById("properties-success").style.display = "none";
  document.getElementById("properties-error").style.display = "none";
}

document.getElementById("propertiesForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  showPropertiesSpinner();

  const checkboxes = document.querySelectorAll("#propertiesList input[name='sandy_enabled']");
  const payload = Array.from(checkboxes).map(cb => ({
    id: cb.dataset.id,
    sandy_enabled: cb.checked
  }));

  try {
    const res = await fetch("/admin/update-properties", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      hidePropertiesSpinner();
      showToast("âœ… Properties updated!");
      closePropertiesModal();
    } else {
      throw new Error("Server returned error");
    }
  } catch (err) {
    hidePropertiesSpinner();
    showToast("âŒ Update failed", "error");
  }
});

function showPropertiesSpinner() {
  document.getElementById("properties-spinner").style.display = "block";
}
function hidePropertiesSpinner() {
  document.getElementById("properties-spinner").style.display = "none";
}

  
  async function syncPMC(accountId) {
    const status = document.getElementById(`status-${accountId}`);
    const result = document.getElementById(`result-${accountId}`);
    const last = document.getElementById(`last-${accountId}`);

    status.textContent = "â³";
    result.textContent = "Syncing...";

    try {
      const res = await fetch(`/admin/sync-properties/${accountId}`, { method: "POST" });
      const data = await res.json();

      if (res.ok && data.success) {
        status.textContent = "âœ…";
        result.textContent = data.message;
        result.className = "sync-result success";
        if (data.synced_at) {
          const dt = new Date(data.synced_at);
          last.textContent = `${dt.toLocaleString('en-US', { timeZone: 'UTC' })} UTC`;
        }
      } else {
        throw new Error(data.error || "Sync failed");
      }
    } catch (err) {
      status.textContent = "âŒ";
      result.textContent = `Error: ${err.message}`;
      result.className = "sync-result error";
    }

    setTimeout(() => status.textContent = "", 5000);
  }

  document.querySelectorAll(".sync-one").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.accountId;
      syncPMC(id);
    });
  });

  document.getElementById("sync-all")?.addEventListener("click", async () => {
    const progress = document.getElementById("sync-progress");
    const buttons = document.querySelectorAll(".sync-one:not([disabled])");
    progress.style.display = "block";

    let count = 0;
    for (const btn of buttons) {
      count++;
      progress.textContent = `ğŸ”„ Syncing ${count} of ${buttons.length}...`;
      await syncPMC(btn.dataset.accountId);
    }

    progress.textContent = "âœ… All synced";
    setTimeout(() => progress.style.display = "none", 4000);
  });

  document.querySelectorAll(".status-select").forEach(select => {
    select.addEventListener("change", async e => {
      const id = e.target.dataset.recordId;
      const isActive = e.target.value === "true";
      await fetch("/admin/update-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ record_id: id, active: isActive })
      });
    });
  });

  document.getElementById("search")?.addEventListener("input", function (e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll("tbody tr").forEach(row => {
      const name = row.cells[0]?.textContent.toLowerCase() || "";
      if (name.includes(query)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });

  function closeModal() {
    document.getElementById("editModal").style.display = "none";
    document.getElementById("edit-spinner").style.display = "none";
    document.getElementById("edit-success").style.display = "none";
    document.getElementById("edit-error").style.display = "none";
  }

// âœï¸ Populate form and open modal
  document.querySelectorAll(".edit-pmc-btn").forEach(button => {
    button.addEventListener("click", () => {
      const data = JSON.parse(button.dataset.pmc);
      document.getElementById("edit-id").value = data.id;
      document.getElementById("edit-name").value = data.pmc_name || "";
      document.getElementById("edit-email").value = data.email || "";
      document.getElementById("edit-contact").value = data.main_contact || "";
      document.getElementById("edit-subscription").value = data.subscription_plan || "";
      document.getElementById("edit-integration").value = data.pms_integration || "";
      document.getElementById("edit-client-id").value = data.pms_api_key || "";
      document.getElementById("edit-secret").value = data.pms_api_secret || "";
      document.getElementById("edit-active").checked = !!data.active;

      document.getElementById("editModal").style.display = "flex";
    });
  });

  // â• Add PMC
document.getElementById("add-pmc-btn").addEventListener("click", () => {
  document.getElementById("edit-id").value = "";
  document.getElementById("edit-name").value = "";
  document.getElementById("edit-email").value = "";
  document.getElementById("edit-contact").value = "";
  document.getElementById("edit-subscription").value = "";
  document.getElementById("edit-integration").value = "";
  document.getElementById("edit-client-id").value = "";
  document.getElementById("edit-secret").value = "";
  document.getElementById("edit-active").checked = true;

  document.getElementById("editModal").style.display = "flex";
});




// ğŸ’¾ Submit form with inline feedback
  document.getElementById("editPmcForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const payload = {
      id: document.getElementById("edit-id").value,
      pmc_name: document.getElementById("edit-name").value.trim(),
      email: document.getElementById("edit-email").value.trim(),
      main_contact: document.getElementById("edit-contact").value.trim(),
      subscription_plan: document.getElementById("edit-subscription").value.trim(),
      pms_integration: document.getElementById("edit-integration").value.trim(),
      pms_api_key: document.getElementById("edit-client-id").value.trim(),
      pms_api_secret: document.getElementById("edit-secret").value.trim(),
      active: document.getElementById("edit-active").checked,
    };

    if (!payload.pmc_name || !payload.pms_api_key || !payload.pms_api_secret) {
      showToast("âŒ Name, Client ID, and Secret are required.", "error");
      return;
    }

    showSpinner();

    try {
      const res = await fetch("/admin/update-pmc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (res.ok && result.success) {
        hideSpinner();
        closeModal();
        showToast("âœ… PMC updated!");
        setTimeout(() => location.reload(), 1000);
      } else {
        hideSpinner();
        showToast(result.error || "âŒ Update failed.", "error")
      }
    } catch (error) {
      hideSpinner();
      console.error("Error:", error);
      showToast("âŒ Error submitting form.", "error");
    }
  });

  // ğŸ—‘ï¸ Delete PMC
  document.getElementById("delete-btn").addEventListener("click", async () => {
    const id = document.getElementById("edit-id").value;
    if (!confirm("Are you sure you want to delete this PMC?")) return;

    showSpinner();

    try {
      const res = await fetch(`/admin/delete-pmc/${id}`, {
        method: "DELETE"
      });

      if (res.ok) {
        showToast("ğŸ—‘ï¸ Deleted!", "success");
        setTimeout(() => location.reload(), 1000);
      } else {
        const result = await res.json();
        hideSpinner();
        showToast(result.error || "âŒ Message here", "error");
      }
    } catch (err) {
      hideSpinner();
      showToast("âŒ Message here", "error");
    }
  });

  function showToast(message, type = "success") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.backgroundColor = type === "error" ? "#c0392b" : "#2ecc71";
  toast.style.opacity = "1";

  setTimeout(() => {
    toast.style.opacity = "0";
  }, 3000);
}

function showSpinner() {
  document.getElementById("edit-spinner").style.display = "block";
}

function hideSpinner() {
  document.getElementById("edit-spinner").style.display = "none";
}

  function showSuccess(msg = "âœ… Saved!") {
    document.getElementById("edit-spinner").style.display = "none";
    document.getElementById("edit-success").textContent = msg;
    document.getElementById("edit-success").style.display = "block";
  }

  function showError(message) {
    document.getElementById("edit-spinner").style.display = "none";
    document.getElementById("edit-error").textContent = message;
    document.getElementById("edit-error").style.display = "block";
  }
</script>


</body>
</html>
