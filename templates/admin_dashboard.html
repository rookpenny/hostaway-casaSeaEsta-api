<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    a.button {
      background: #2d72d9;
      color: white;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      text-decoration: none;
    }
    button.sync-one {
      background: #2d72d9;
      color: white;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    button.sync-one:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    select.status-select {
      padding: 0.3rem;
      border-radius: 4px;
    }
    .message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      text-align: center;
    }
    .sync-result {
      font-size: 0.9rem;
      color: #555;
    }
    .sync-result.error {
      color: #c0392b;
    }
    .sync-result.success {
      color: #27ae60;
    }
    .sync-result.success {
      color: #27ae60; /* green */
    }
    .sync-result.error {
      color: #c0392b; /* red */
    }

  </style>
</head>
<body>
{% if request.query_params.get('status') == 'error' %}
  <div class="message error">‚ùå Sync failed. Please check logs.</div>
{% endif %}

{% if debug_info %}
  <div class="message">
    <h3>üõ† Airtable Debug Info</h3>
    <ul>
      {% for key, value in debug_info.items() %}
        <li><strong>{{ key }}:</strong> {{ value }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<h1>PMC Dashboard</h1>

<div class="top-bar">
  <a href="/admin/new-pmc" class="button">‚ûï Add New PMC</a>
  <button id="sync-all" class="button">üîÅ Sync All</button>
</div>
<div id="sync-progress" style="display:none; margin-top: 1rem; text-align: right; font-weight: bold;"></div>
<input type="text" id="search" placeholder="üîç Search by name or PMS..." style="padding: 0.5rem; width: 100%; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #ccc;">
{% if pmc %}
<table>
  <thead>
    <tr>
      <th>PMC Name</th>
      <th>Hostaway ID</th>
      <th>Main Contact</th>
      <th>Email</th>
      <th>Plan</th>
      <th>PMS</th>
      <th>Status</th>
      <th>Sync</th>
      <th>Last Synced</th>
      <th>Result</th>
    </tr>
  </thead>
  <tbody>
        {% for record in pmc %}
        {% if not record.pms_client_id or not record.pms_secret %}
    <tr style="background-color: #f8d7da;">
      <td colspan="10" style="color: #721c24;">
        ‚ö†Ô∏è <strong>{{ record.pmc_name }}</strong> is missing PMS credentials.
        Please provide both <code>Client ID</code> and <code>Secret</code> to enable sync.
      </td>
    </tr>
    {% else %}
    <tr>
      <td>{{ record.pmc_name }}</td>
      <td>{{ record.pms_client_id }}</td>
      <td>{{ record.main_contact }}</td>
      <td>{{ record.email }}</td>
      <td>{{ record.subscription_plan }}</td>
      <td>{{ record.pms_integration }}</td>
      <td>
        <select class="status-select" data-record-id="{{ record.id }}">
          <option value="true" {% if record.active %}selected{% endif %}>‚úÖ Active</option>
          <option value="false" {% if not record.active %}selected{% endif %}>‚ùå Inactive</option>
        </select>
      </td>
      <td>
        <button
          class="sync-one"
          data-account-id="{{ record.pms_account_id }}"
          {% if not record.pms_account_id %}disabled title="Missing PMS Account ID"{% endif %}
        >
          üîÑ Sync
        </button>
        <span class="sync-status" id="status-{{ record.pms_account_id }}"></span>
      </td>
      <td>
        <span class="last-synced" id="last-{{ record.pms_account_id }}">
          {% if record.last_synced_at %}
            {{ record.last_synced_at.strftime('%Y-%m-%d %H:%M UTC') }}
          {% else %}
            Never
          {% endif %}
        </span>
      </td>
      <td>
        <span class="sync-result" id="result-{{ record.pms_account_id }}">‚Äî</span>
      </td>
    </tr>
    {% endif %}

  </tbody>
</table>
{% else %}
  <p>No PMCs found. Add one to get started!</p>
{% endif %}

<script>
  async function syncPMC(accountId) {
    const statusSpan = document.getElementById(`status-${accountId}`);
    const resultSpan = document.getElementById(`result-${accountId}`);
    const lastSyncedSpan = document.getElementById(`last-${accountId}`);

    statusSpan.textContent = "‚è≥";
    resultSpan.textContent = "Syncing...";

    try {
      const res = await fetch(`/admin/sync-properties/${accountId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const data = await res.json();

      if (res.ok && data.success) {
        statusSpan.textContent = "‚úÖ";
        resultSpan.textContent = data.message || "Synced";
        resultSpan.className = "sync-result success"; // ‚úÖ add this line

        if (lastSyncedSpan && data.synced_at) {
          const date = new Date(data.synced_at);
          lastSyncedSpan.textContent = `${date.toLocaleString('en-US', { timeZone: 'UTC' })} UTC`;
        }
      } else {
        throw new Error(data.error || "Sync failed");
      }
    } catch (err) {
      console.error(`[SYNC ERROR] ${accountId}`, err);
      statusSpan.textContent = "‚ùå";
      resultSpan.textContent = `Error: ${err.message || "Unknown error"}`;
      resultSpan.className = "sync-result error"; // ‚úÖ add this line
    }

    // Reset status icon after 5 seconds
    setTimeout(() => statusSpan.textContent = "", 5000);
  }

  // üöÄ Wire up per-PMC sync buttons
  document.querySelectorAll(".sync-one").forEach(button => {
    button.addEventListener("click", async (e) => {
      e.preventDefault();
      const accountId = button.dataset.accountId;
      if (accountId) {
        await syncPMC(accountId);
      }
    });
  });

  // üîÅ Sync All Button
  document.getElementById("sync-all")?.addEventListener("click", async () => {
    const buttons = document.querySelectorAll(".sync-one:not([disabled])");
    const progress = document.getElementById("sync-progress");
  
    let count = 0;
    progress.style.display = "block";
    progress.textContent = `üîÑ Syncing 0 of ${buttons.length}...`;
  
    for (const button of buttons) {
      const accountId = button.dataset.accountId;
      count++;
      progress.textContent = `üîÑ Syncing ${count} of ${buttons.length}...`;
      await syncPMC(accountId);
    }
  
    progress.textContent = "‚úÖ All PMCs synced.";
    setTimeout(() => (progress.style.display = "none"), 4000);
  });


  // ‚úÖ Toggle PMC Active Status
  document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', async (e) => {
      const recordId = e.target.dataset.recordId;
      const isActive = e.target.value === 'true';

      try {
        const res = await fetch('/admin/update-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ record_id: recordId, active: isActive }),
        });

        if (!res.ok) {
          alert("‚ùå Failed to update status");
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Error updating status");
      }
    });
  });
  document.getElementById("search")?.addEventListener("input", function (e) {
  const query = e.target.value.toLowerCase();
  const rows = document.querySelectorAll("tbody tr");

  rows.forEach(row => {
    const name = row.cells[0]?.textContent.toLowerCase() || "";
    const pms = row.cells[5]?.textContent.toLowerCase() || "";

    if (name.includes(query) || pms.includes(query)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});

</script>


</body>
</html>
