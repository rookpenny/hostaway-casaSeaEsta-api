<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    a.button, button.sync-one {
      background: #2d72d9;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    button.sync-one:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status-select {
      padding: 0.4rem;
    }
    .warning-row {
      background-color: #fff3cd;
      color: #856404;
    }
    .sync-result.success {
      color: #27ae60;
    }
    .sync-result.error {
      color: #c0392b;
    }
    #sync-progress {
      margin: 1rem 0;
      font-style: italic;
    }
  </style>
</head>
<body>

<h1>üõ†Ô∏è Admin Dashboard</h1>

<div class="top-bar">
  <input type="text" id="search" placeholder="Search PMCs..." />
  <button id="sync-all">üîÑ Sync All</button>
</div>

<div id="sync-progress" style="display:none;"></div>

<table>
  <thead>
    <tr>
      <th>PMC</th>
      <th>PMS Account ID</th>
      <th>API Key</th>
      <th>Contact</th>
      <th>Integration</th>
      <th>Active</th>
      <th>Sync</th>
      <th>Last Synced</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for record in pmc %}
      {% if not record.pms_account_id or not record.pms_api_key %}
        <tr class="warning-row">
          <td colspan="9">
            ‚ö†Ô∏è <strong>{{ record.pmc_name }}</strong> is missing PMS credentials (API key or Account ID).
          </td>
        </tr>
      {% else %}
        <tr>
          <td>{{ record.pmc_name }}</td>
          <td>{{ record.pms_account_id }}</td>
          <td>{{ record.pms_api_key }}</td>
          <td>{{ record.email }}</td>
          <td>{{ record.pms_integration }}</td>
          <td>
            <select class="status-select" data-record-id="{{ record.id }}">
              <option value="true" {% if record.active %}selected{% endif %}>‚úÖ</option>
              <option value="false" {% if not record.active %}selected{% endif %}>‚ùå</option>
            </select>
          </td>
          <td>
            <button
              class="sync-one"
              data-account-id="{{ record.pms_account_id }}"
              {% if not record.pms_account_id %}disabled{% endif %}
            >
              üîÑ Sync
            </button>
            <span id="status-{{ record.pms_account_id }}"></span>
          </td>
          <td>
            <span id="last-{{ record.pms_account_id }}">
              {% if record.last_synced_at %}
                {{ record.last_synced_at.strftime('%Y-%m-%d %H:%M UTC') }}
              {% else %}
                Never
              {% endif %}
            </span>
          </td>
          <td>
            <span class="sync-result" id="result-{{ record.pms_account_id }}">‚Äî</span>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>

<script>
  async function syncPMC(accountId) {
    const status = document.getElementById(`status-${accountId}`);
    const result = document.getElementById(`result-${accountId}`);
    const last = document.getElementById(`last-${accountId}`);

    status.textContent = "‚è≥";
    result.textContent = "Syncing...";

    try {
      const res = await fetch(`/admin/sync-properties/${accountId}`, { method: "POST" });
      const data = await res.json();

      if (res.ok && data.success) {
        status.textContent = "‚úÖ";
        result.textContent = data.message;
        result.className = "sync-result success";
        if (data.synced_at) {
          const dt = new Date(data.synced_at);
          last.textContent = `${dt.toLocaleString('en-US', { timeZone: 'UTC' })} UTC`;
        }
      } else {
        throw new Error(data.error || "Sync failed");
      }
    } catch (err) {
      status.textContent = "‚ùå";
      result.textContent = `Error: ${err.message}`;
      result.className = "sync-result error";
    }

    setTimeout(() => status.textContent = "", 5000);
  }

  document.querySelectorAll(".sync-one").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.accountId;
      syncPMC(id);
    });
  });

  document.getElementById("sync-all")?.addEventListener("click", async () => {
    const progress = document.getElementById("sync-progress");
    const buttons = document.querySelectorAll(".sync-one:not([disabled])");
    progress.style.display = "block";

    let count = 0;
    for (const btn of buttons) {
      count++;
      progress.textContent = `üîÑ Syncing ${count} of ${buttons.length}...`;
      await syncPMC(btn.dataset.accountId);
    }

    progress.textContent = "‚úÖ All synced";
    setTimeout(() => progress.style.display = "none", 4000);
  });

  document.querySelectorAll(".status-select").forEach(select => {
    select.addEventListener("change", async e => {
      const id = e.target.dataset.recordId;
      const isActive = e.target.value === "true";
      await fetch("/admin/update-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ record_id: id, active: isActive })
      });
    });
  });

  document.getElementById("search")?.addEventListener("input", function (e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll("tbody tr").forEach(row => {
      const name = row.cells[0]?.textContent.toLowerCase() || "";
      if (name.includes(query)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });
</script>

</body>
</html>
