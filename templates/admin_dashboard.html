<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HostScout Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06), 0 10px 24px rgba(15, 23, 42, 0.06); }
    .hairline { box-shadow: inset 0 1px 0 rgba(255,255,255,.7); }
    /* Active nav state */
    .nav-item[aria-current="page"] { background: rgb(248 250 252); color: rgb(15 23 42); }
    .nav-item[aria-current="page"] .nav-icon-wrap { background: rgb(15 23 42); border-color: rgb(15 23 42); }
    .nav-item[aria-current="page"] svg { color: white; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex">

    <!-- Sidebar -->
    <aside id="sidebar"
      class="sticky top-0 h-screen bg-white border-r border-slate-200 flex flex-col
             w-72 transition-[width] duration-200 ease-out">

      <!-- Brand -->
      <div class="h-16 px-4 flex items-center justify-between border-b border-slate-200">
        <a href="#" class="flex items-center gap-2 overflow-hidden">
          <div class="w-9 h-9 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            H
          </div>
          <div class="sidebar-label whitespace-nowrap">
            <div class="text-sm font-semibold leading-4">HostScout</div>
            <div class="text-xs text-slate-500">
              {% if user_role == "super" %}Super Admin{% else %}PMC Dashboard{% endif %}
            </div>
          </div>
        </a>

        <button id="sidebar-toggle"
          class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50 grid place-items-center"
          aria-label="Toggle sidebar">
          <svg class="h-5 w-5 text-slate-600" viewBox="0 0 24 24" fill="none">
            <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <!-- Nav -->
      <nav class="p-3 space-y-1">

        <!-- Overview -->
        <button data-view="overview"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          aria-current="page"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M3 13h8V3H3v10zm10 8h8V11h-8v10zM3 21h8v-6H3v6zm10-18v6h8V3h-8z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Overview</span>
        </button>

        {% if user_role == "super" %}
        <button data-view="chats"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Chats</span>
        </button>

        <button data-view="pmcs"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M4 21V3h10v18M14 9h6v12M8 7h2M8 11h2M8 15h2M18 13h2M18 17h2"
                stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">PMCs</span>
        </button>

        <button data-view="files"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
              <path d="M14 2v6h6" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Configs & Manuals</span>
        </button>

        <button data-view="analytics"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M4 19V5M4 19h16M8 15v-6M12 19V9M16 13v-4M20 19V7"
                stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Analytics</span>
        </button>
        {% endif %}

        <button data-view="properties"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5z"
                stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Properties</span>
        </button>

        <button data-view="settings"
          class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50 text-slate-700"
          type="button">
          <span class="nav-icon-wrap h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.7"/>
              <path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.3-2-3.4-2.3.6a8 8 0 0 0-1.7-1L15 3h-6l-.5 2.9a8 8 0 0 0-1.7 1L4.5 6.3l-2 3.4 2 1.3a7.8 7.8 0 0 0 0 2l-2 1.3 2 3.4 2.3-.6a8 8 0 0 0 1.7 1L9 21h6l.5-2.9a8 8 0 0 0 1.7-1l2.3.6 2-3.4-2-1.3z"
                stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium">Settings</span>
        </button>

        <a href="/auth/logout"
           class="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-rose-50 text-slate-700">
          <span class="h-9 w-9 rounded-xl bg-slate-100 grid place-items-center border border-slate-200">
            <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M10 17l-1 0a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4h1" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              <path d="M14 7l5 5-5 5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M19 12H10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="sidebar-label font-medium text-rose-700">Logout</span>
        </a>
      </nav>

      <!-- Footer -->
      <div class="mt-auto p-3 border-t border-slate-200">
        <div class="flex items-center gap-3 px-2">
          <div class="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">
            {{ (pmc_name[0] if pmc_name else "U") }}
          </div>
          <div class="sidebar-label overflow-hidden">
            <div class="text-sm font-semibold leading-4 truncate">
              {{ pmc_name if pmc_name else "User" }}
            </div>
            <div class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}Super User{% else %}PMC{% endif %}
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 min-w-0">
      <!-- Topbar -->
      <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200 hairline">
        <div class="h-16 px-6 flex items-center gap-4">
          <div class="min-w-0">
            <div id="page-title" class="text-sm font-semibold truncate">Overview</div>
            <div id="page-subtitle" class="text-xs text-slate-500 truncate">
              {% if user_role == "super" %}System health & activity{% else %}Your portfolio at a glance{% endif %}
            </div>
          </div>

          <div class="flex-1"></div>

          <div class="hidden lg:block w-[420px]">
            <div class="flex items-center gap-2 px-3 h-10 rounded-xl border border-slate-200 bg-white">
              <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <input id="globalSearch"
                class="w-full text-sm outline-none placeholder:text-slate-400"
                placeholder="{% if user_role == 'super' %}Search chats, guests, propertiesâ€¦{% else %}Search propertiesâ€¦{% endif %}" />
              <kbd class="text-[11px] px-2 py-1 rounded-lg border border-slate-200 bg-slate-50 text-slate-500">âŒ˜ K</kbd>
            </div>
          </div>

          {% if user_role == "super" %}
          <div class="flex items-center gap-2">
            <a href="/admin/chats"
              class="h-10 px-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm grid place-items-center">
              Chats
            </a>
            <a href="/admin/new-pmc"
              class="h-10 px-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm grid place-items-center">
              New PMC
            </a>
          </div>
          {% endif %}
        </div>
      </header>

      <!-- Content -->
      <div class="p-6">

        {% set is_locked = (user_role == "pmc" and needs_payment) %}

        {% if is_locked %}
        <!-- Billing Banner -->
        <div class="mb-6 rounded-2xl border border-amber-300/60 bg-amber-50 p-4 card">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold text-amber-900">
                {{ billing_banner_title or "Complete payment to activate your account" }}
              </div>
              <div class="text-sm text-amber-900/80 mt-1">
                {{ billing_banner_body or "Your account is pending. Once payment is confirmed, you can sync properties and enable Sandy." }}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <a href="/pmc/signup"
                 class="h-10 px-4 rounded-xl bg-amber-500 hover:bg-amber-600 text-black font-semibold grid place-items-center">
                Complete setup & payment
              </a>
              <a href="/auth/login/google"
                 class="h-10 px-4 rounded-xl border border-amber-300 bg-white hover:bg-amber-50 text-amber-900 font-semibold grid place-items-center">
                Refresh login
              </a>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- OVERVIEW -->
        <section id="view-overview" class="view space-y-6">

          {% set total_props = properties|length %}

          {% if is_locked %}
            {% set live_props = 0 %}
            {% set offline_props = total_props %}
          {% else %}
            {% set live_props = (properties | selectattr('sandy_enabled') | list | length) %}
            {% set offline_props = (properties | rejectattr('sandy_enabled') | list | length) %}
          {% endif %}


          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Properties</div>
              <div class="mt-2 text-3xl font-semibold">{{ total_props }}</div>
              <div class="mt-2 text-xs text-slate-500">Portfolio size</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Live</div>
              <div class="mt-2 text-3xl font-semibold">{{ live_props }}</div>
              <div class="mt-2 text-xs text-emerald-600">Sandy enabled</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Offline</div>
              <div class="mt-2 text-3xl font-semibold">{{ offline_props }}</div>
              <div class="mt-2 text-xs text-rose-600">Needs attention</div>
            </div>

            <div class="col-span-12 md:col-span-3 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-xs text-slate-500">Last Sync</div>
              <div class="mt-2 text-lg font-semibold">
                {% if properties and properties[0].last_synced %}
                  {% set seconds = (now - properties[0].last_synced).total_seconds() %}
                  {% if seconds < 60 %} just now
                  {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
                  {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
                  {% else %} {{ (seconds // 86400)|int }} days ago
                  {% endif %}
                {% else %}
                  â€”
                {% endif %}
              </div>
              <div class="mt-2 text-xs text-slate-500">Most recent property record</div>
            </div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Status Overview</div>
                <div class="text-xs text-slate-500">LIVE vs OFFLINE</div>
              </div>
              <div class="text-xs text-slate-500">Auto-updates with your data</div>
            </div>
            <div class="mt-4">
              <canvas id="statusChart" height="90"></canvas>
            </div>
          </div>

          {% if user_role == "super" %}
          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-12 xl:col-span-7 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-sm font-semibold">Chat Volume</div>
              <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
                Chart placeholder
              </div>
            </div>
            <div class="col-span-12 xl:col-span-5 bg-white border border-slate-200 rounded-2xl p-4 card">
              <div class="text-sm font-semibold">Priority Inbox</div>
              <div class="mt-2 text-xs text-slate-500">Escalations & time-sensitive issues</div>
              <div class="mt-4 h-56 rounded-xl border border-dashed border-slate-200 grid place-items-center text-slate-400 text-sm">
                Queue placeholder
              </div>
            </div>
          </div>
          {% endif %}
        </section>

        <!-- PROPERTIES -->
        <section id="view-properties" class="view hidden space-y-4">

          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="flex flex-col lg:flex-row lg:items-center gap-3 justify-between">
              <div>
                <div class="text-sm font-semibold">Properties</div>
                <div class="text-xs text-slate-500">Search and manage your portfolio</div>
              </div>

              <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search propertiesâ€¦"
                  class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-72"
                />
                <select
                  id="statusFilter"
                  class="h-10 px-3 rounded-xl border border-slate-200 bg-white text-sm w-full sm:w-48"
                >
                  <option value="all">All statuses</option>
                  <option value="live">LIVE</option>
                  <option value="offline">OFFLINE</option>
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            {% for prop in properties %}
            <div class="bg-white border border-slate-200 rounded-2xl p-4 card"
                 data-property-card
                 data-name="{{ prop.property_name }}"
                 data-live="{{ 'true' if prop.sandy_enabled else 'false' }}">

              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-lg font-semibold truncate">{{ prop.property_name }}</div>
                  <div class="mt-1 text-xs text-slate-500">
                    ID: {{ prop.id }}{% if prop.pms_property_id %} â€¢ PMS: {{ prop.pms_property_id }}{% endif %}
                  </div>
                </div>

                {% if is_locked %}
                  <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200 font-semibold">
                    LOCKED
                  </span>
                {% else %}
                  {% if prop.sandy_enabled %}
                    <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold">
                      LIVE
                    </span>
                  {% else %}
                    <span class="shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold">
                      OFFLINE
                    </span>
                  {% endif %}
                {% endif %}
              </div>

              <div class="mt-3 text-xs text-slate-500">
                <span class="font-semibold text-slate-700">Last synced:</span>
                {% if prop.last_synced %}
                  {% set seconds = (now - prop.last_synced).total_seconds() %}
                  {% if seconds < 60 %} just now
                  {% elif seconds < 3600 %} {{ (seconds // 60)|int }} minutes ago
                  {% elif seconds < 86400 %} {{ (seconds // 3600)|int }} hours ago
                  {% else %} {{ (seconds // 86400)|int }} days ago
                  {% endif %}
                {% else %}
                  â€”
                {% endif %}
              </div>

              <div class="mt-4 flex gap-2 flex-wrap items-center">
                {% if user_role == "super" and prop.data_folder_path %}
                  <a href="/edit-file?file={{ prop.data_folder_path }}/config.json"
                     class="h-9 px-3 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">
                    Edit Config
                  </a>
                  <a href="/edit-file?file={{ prop.data_folder_path }}/manual.txt"
                     class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50">
                    Edit Manual
                  </a>
                {% endif %}

                <button
                  onclick="syncProperty({{ prop.id }}, this)"
                  class="h-9 px-3 rounded-xl border border-slate-200 bg-white text-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  type="button"
                  {% if is_locked %}disabled{% endif %}>
                  Sync
                </button>

                <button
                  onclick="toggleProperty({{ prop.id }}, this)"
                  class="h-9 px-3 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  type="button"
                  {% if is_locked %}disabled{% endif %}>
                  {% if prop.sandy_enabled %}Take Offline{% else %}Go Live{% endif %}
                </button>

                {% if is_locked %}
                  <a href="/pmc/signup" class="text-xs font-semibold text-amber-700 hover:underline ml-1">
                    Unlock â†’
                  </a>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </section>

        {% if user_role == "super" %}
        <section id="view-chats" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Chats</div>
            <div class="mt-2 text-sm text-slate-500">
              Go to <a class="underline font-semibold" href="/admin/chats">/admin/chats</a>.
            </div>
          </div>
        </section>

        <section id="view-pmcs" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">PMCs</div>
            <div class="mt-2 text-sm text-slate-500">Create/manage PMCs, integrations, permissions.</div>
          </div>
        </section>

        <section id="view-files" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Configs & Manuals</div>
            <div class="mt-2 text-sm text-slate-500">Central file management.</div>
          </div>
        </section>

        <section id="view-analytics" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Analytics</div>
            <div class="mt-2 text-sm text-slate-500">Response time, containment, outcomes.</div>
          </div>
        </section>
        {% endif %}

        <section id="view-settings" class="view hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
            <div class="text-sm font-semibold">Settings</div>
            <div class="mt-2 text-sm text-slate-500">
              {% if user_role == "super" %}
                Users, roles, permissions, system config.
              {% else %}
                PMC profile, users, notifications (limited).
              {% endif %}
            </div>

            <div class="mt-4">
              <div class="p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm text-slate-700">
                Login uses Google OAuth for all users. If you need to re-authenticate, use
                <a class="underline font-semibold" href="/auth/login/google">Google Sign-In</a>.
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // -------- Paywall flag (server-rendered) --------
    const IS_LOCKED = {{ 'true' if (user_role == 'pmc' and needs_payment) else 'false' }};

    function toast(message) {
      const el = document.createElement("div");
      el.className = "fixed bottom-5 right-5 z-[9999] bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-lg";
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2400);
    }

    // --- Sidebar collapse/expand ---
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebar-toggle");
    const labelEls = () => Array.from(document.querySelectorAll(".sidebar-label"));

    function setCollapsed(isCollapsed) {
      sidebar.classList.toggle("w-72", !isCollapsed);
      sidebar.classList.toggle("w-20", isCollapsed);
      labelEls().forEach(el => el.classList.toggle("hidden", isCollapsed));

      const svg = toggleBtn.querySelector("svg");
      svg.style.transform = isCollapsed ? "rotate(180deg)" : "rotate(0deg)";
      svg.style.transition = "transform 200ms ease";
      localStorage.setItem("dashboard_sidebar_collapsed", isCollapsed ? "1" : "0");
    }

    setCollapsed(localStorage.getItem("dashboard_sidebar_collapsed") === "1");

    toggleBtn.addEventListener("click", () => {
      const isCollapsed = sidebar.classList.contains("w-20");
      setCollapsed(!isCollapsed);
    });

    // âŒ˜K focus
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        document.getElementById("globalSearch")?.focus();
      }
    });

    // --- View routing ---
    const pageTitle = document.getElementById("page-title");
    const pageSubtitle = document.getElementById("page-subtitle");
    const navItems = Array.from(document.querySelectorAll(".nav-item"));
    const views = Array.from(document.querySelectorAll(".view"));

    const subtitles = {
      overview: "{{ 'System health & activity' if user_role == 'super' else 'Your portfolio at a glance' }}",
      properties: "Search and manage your portfolio",
      chats: "Lifecycle, priority, escalations",
      pmcs: "Partners, integrations, access",
      files: "Configs & manuals",
      analytics: "Trends & performance",
      settings: "Account and system settings"
    };

    function showView(key) {
      const target = document.getElementById(`view-${key}`);
      if (!target) key = "overview";

      views.forEach(v => v.classList.add("hidden"));
      document.getElementById(`view-${key}`)?.classList.remove("hidden");

      navItems.forEach(btn => btn.setAttribute("aria-current", "false"));
      const activeBtn = navItems.find(b => b.dataset.view === key);
      if (activeBtn) activeBtn.setAttribute("aria-current", "page");

      const label = activeBtn?.querySelector(".sidebar-label")?.textContent?.trim() || "Overview";
      pageTitle.textContent = label;
      if (pageSubtitle) pageSubtitle.textContent = subtitles[key] || "";

      history.replaceState(null, "", `#${key}`);

      if (key === "properties") {
        const global = document.getElementById("globalSearch");
        const local = document.getElementById("searchInput");
        if (global && local && global.value && !local.value) {
          local.value = global.value;
          filterProperties();
        }
      }
    }

    navItems.forEach(btn => btn.addEventListener("click", () => showView(btn.dataset.view)));

    const initial = (location.hash || "#overview").replace("#", "");
    showView(initial);

    // --- Chart + filter + actions ---
    document.addEventListener("DOMContentLoaded", () => {
      const ctx = document.getElementById("statusChart");
      if (ctx) {
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["LIVE", "OFFLINE"],
            datasets: [{
              label: "Properties",
              data: [{{ live_props }}, {{ offline_props }}]
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
          }
        });
      }

      window.filterProperties = function () {
        const search = (document.getElementById("searchInput")?.value || "").toLowerCase();
        const status = document.getElementById("statusFilter")?.value || "all";
        const cards = document.querySelectorAll("[data-property-card]");

        cards.forEach((card) => {
          const name = (card.dataset.name || "").toLowerCase();
          const live = card.dataset.live === "true";
          const matchesSearch = name.includes(search);
          const matchesStatus =
            status === "all" ||
            (status === "live" && live) ||
            (status === "offline" && !live);

          card.style.display = (matchesSearch && matchesStatus) ? "" : "none";
        });
      };

      document.getElementById("searchInput")?.addEventListener("input", filterProperties);
      document.getElementById("statusFilter")?.addEventListener("change", filterProperties);

      window.syncProperty = async function (id, btn) {
  // ðŸ”’ Client-side gate (fast feedback)
  if (IS_LOCKED) {
    toast("Complete payment to unlock property syncing.");
    return;
  }

  btn.disabled = true;
  const original = btn.innerHTML;
  btn.innerHTML = "Syncingâ€¦";

  try {
    const res = await fetch(`/auth/sync-property/${id}`, { method: "POST" });

    // ðŸ” Server-side paywall (authoritative)
    if (res.status === 402) {
      toast("Payment required to sync properties.");
      window.location.href = "/pmc/signup";
      return;
    }

    let data = {};
    try {
      data = await res.json();
    } catch (_) {
      // Non-JSON response
    }

    if (res.ok && data.status === "success") {
      btn.innerHTML = "Synced âœ“";
    } else {
      btn.innerHTML = data.message || "Failed";
    }

  } catch (err) {
    console.error("Sync error:", err);
    btn.innerHTML = "Error";
  } finally {
    setTimeout(() => {
      btn.innerHTML = original;
      btn.disabled = false;
    }, 1200);
  }
};


      window.toggleProperty = async function (id, btn) {
        if (IS_LOCKED) {
          toast("Complete payment to unlock Sandy activation.");
          return;
        }

        btn.disabled = true;
        const original = btn.innerHTML;
        btn.innerHTML = "Togglingâ€¦";

        try {
          const res = await fetch(`/auth/toggle-property/${id}`, { method: "POST" });
          const data = await res.json();

          if (data.status === "success") {
            btn.innerHTML = (data.new_status === "LIVE") ? "Take Offline" : "Go Live";

            const card = btn.closest("[data-property-card]");
            if (card) {
              card.dataset.live = (data.new_status === "LIVE") ? "true" : "false";

              const pill = card.querySelector("span.rounded-full");
              if (pill) {
                if (data.new_status === "LIVE") {
                  pill.textContent = "LIVE";
                  pill.className = "shrink-0 text-xs px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold";
                } else {
                  pill.textContent = "OFFLINE";
                  pill.className = "shrink-0 text-xs px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold";
                }
              }

              filterProperties();
            }
          } else {
            btn.innerHTML = "Failed";
          }
        } catch (err) {
          btn.innerHTML = "Error";
        }

        setTimeout(() => { btn.innerHTML = original; btn.disabled = false; }, 1200);
      };
    });
  </script>
</body>
</html>
