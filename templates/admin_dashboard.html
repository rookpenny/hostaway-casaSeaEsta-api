<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    a.button, button.sync-one {
      background: #2d72d9;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    button.sync-one:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status-select {
      padding: 0.4rem;
    }
    .warning-row {
      background-color: #fff3cd;
      color: #856404;
    }
    .sync-result.success {
      color: #27ae60;
    }
    .sync-result.error {
      color: #c0392b;
    }
    #sync-progress {
      margin: 1rem 0;
      font-style: italic;
    }
  </style>
</head>
<body>

<h1>üõ†Ô∏è Admin Dashboard</h1>

<div class="top-bar">
  <input type="text" id="search" placeholder="Search PMCs..." />
  <button id="sync-all">üîÑ Sync All</button>
</div>

<div id="sync-progress" style="display:none;"></div>

<table>
  <thead>
    <tr>
      <th>‚úèÔ∏è Edit</th>
      <th>PMC</th>
      <th>PMS Account ID</th>
      <th>API Key</th>
      <th>Contact</th>
      <th>Integration</th>
      <th>Active</th>
      <th>Sync</th>
      <th>Last Synced</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for record in pmc %}
      {% if not record.pms_account_id or not record.pms_api_key %}
        <tr class="warning-row">
          <td colspan="9">
            ‚ö†Ô∏è <strong>{{ record.pmc_name }}</strong> is missing PMS credentials (API key or Account ID).
          </td>
        </tr>
      {% else %}
        <tr>
          <td>{{ record.pmc_name }}</td>
          <td>{{ record.pms_account_id }}</td>
          <td>{{ record.pms_api_key }}</td>
          <td>{{ record.email }}</td>
          <td>{{ record.pms_integration }}</td>
          <td>
            <select class="status-select" data-record-id="{{ record.id }}">
              <option value="true" {% if record.active %}selected{% endif %}>‚úÖ</option>
              <option value="false" {% if not record.active %}selected{% endif %}>‚ùå</option>
            </select>
          </td>
          <td>
            <button
              class="sync-one"
              data-account-id="{{ record.pms_account_id }}"
              {% if not record.pms_account_id %}disabled{% endif %}
            >
              üîÑ Sync
            </button>
            <span id="status-{{ record.pms_account_id }}"></span>
          </td>
          <td>
            <span id="last-{{ record.pms_account_id }}">
              {% if record.last_synced_at %}
                {{ record.last_synced_at.strftime('%Y-%m-%d %H:%M UTC') }}
              {% else %}
                Never
              {% endif %}
            </span>
          </td>
          <td>
            <span class="sync-result" id="result-{{ record.pms_account_id }}">‚Äî</span>
          </td>
          <td>
            <button class="edit-pmc-btn" data-pmc='{{ record | tojson | safe }}'>‚úèÔ∏è Edit</button>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>

  <!-- üîß Edit PMC Modal -->
<div id="editModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:2rem; border-radius:8px; width:90%; max-width:500px; position:relative;">
    <h3>Edit PMC</h3>
    <form id="editPmcForm">
      <input type="hidden" id="edit-id">
      <label>Name:<br><input type="text" id="edit-name" required></label><br><br>
      <label>Email:<br><input type="email" id="edit-email"></label><br><br>
      <label>Main Contact:<br><input type="text" id="edit-contact"></label><br><br>
      <label>Subscription Plan:<br><input type="text" id="edit-subscription"></label><br><br>
      <label>PMS Integration:<br><input type="text" id="edit-integration"></label><br><br>
      <label>Client ID:<br><input type="text" id="edit-client-id" required></label><br><br>
      <label>Secret:<br><input type="text" id="edit-secret" required></label><br><br>
      <label>Active: <input type="checkbox" id="edit-active"></label><br><br>

      <div id="edit-spinner" style="display:none;">üåÄ Saving...</div>
      <div id="edit-success" style="display:none; color:green;">‚úÖ Saved!</div>
      <div id="edit-error" style="display:none; color:red;"></div>

      <button type="submit">üíæ Save</button>
      <button type="button" onclick="closeModal()">‚ùå Cancel</button>
      <button type="button" id="delete-btn" style="float:right; color:red;">üóëÔ∏è Delete</button>
    </form>
  </div>
</div>
  
<script>
  async function syncPMC(accountId) {
    const status = document.getElementById(`status-${accountId}`);
    const result = document.getElementById(`result-${accountId}`);
    const last = document.getElementById(`last-${accountId}`);

    status.textContent = "‚è≥";
    result.textContent = "Syncing...";

    try {
      const res = await fetch(`/admin/sync-properties/${accountId}`, { method: "POST" });
      const data = await res.json();

      if (res.ok && data.success) {
        status.textContent = "‚úÖ";
        result.textContent = data.message;
        result.className = "sync-result success";
        if (data.synced_at) {
          const dt = new Date(data.synced_at);
          last.textContent = `${dt.toLocaleString('en-US', { timeZone: 'UTC' })} UTC`;
        }
      } else {
        throw new Error(data.error || "Sync failed");
      }
    } catch (err) {
      status.textContent = "‚ùå";
      result.textContent = `Error: ${err.message}`;
      result.className = "sync-result error";
    }

    setTimeout(() => status.textContent = "", 5000);
  }

  document.querySelectorAll(".sync-one").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.accountId;
      syncPMC(id);
    });
  });

  document.getElementById("sync-all")?.addEventListener("click", async () => {
    const progress = document.getElementById("sync-progress");
    const buttons = document.querySelectorAll(".sync-one:not([disabled])");
    progress.style.display = "block";

    let count = 0;
    for (const btn of buttons) {
      count++;
      progress.textContent = `üîÑ Syncing ${count} of ${buttons.length}...`;
      await syncPMC(btn.dataset.accountId);
    }

    progress.textContent = "‚úÖ All synced";
    setTimeout(() => progress.style.display = "none", 4000);
  });

  document.querySelectorAll(".status-select").forEach(select => {
    select.addEventListener("change", async e => {
      const id = e.target.dataset.recordId;
      const isActive = e.target.value === "true";
      await fetch("/admin/update-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ record_id: id, active: isActive })
      });
    });
  });

  document.getElementById("search")?.addEventListener("input", function (e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll("tbody tr").forEach(row => {
      const name = row.cells[0]?.textContent.toLowerCase() || "";
      if (name.includes(query)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });

  function closeModal() {
    document.getElementById("editModal").style.display = "none";
    document.getElementById("edit-spinner").style.display = "none";
    document.getElementById("edit-success").style.display = "none";
    document.getElementById("edit-error").style.display = "none";
  }

// ‚úèÔ∏è Populate form and open modal
  document.querySelectorAll(".edit-pmc-btn").forEach(button => {
    button.addEventListener("click", () => {
      const data = JSON.parse(button.dataset.pmc);
      document.getElementById("edit-id").value = data.id;
      document.getElementById("edit-name").value = data.pmc_name || "";
      document.getElementById("edit-email").value = data.email || "";
      document.getElementById("edit-contact").value = data.main_contact || "";
      document.getElementById("edit-subscription").value = data.subscription_plan || "";
      document.getElementById("edit-integration").value = data.pms_integration || "";
      document.getElementById("edit-client-id").value = data.pms_client_id || "";
      document.getElementById("edit-secret").value = data.pms_secret || "";
      document.getElementById("edit-active").checked = !!data.active;

      document.getElementById("editModal").style.display = "flex";
    });
  });

// üíæ Submit form with inline feedback
  document.getElementById("editPmcForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const payload = {
      id: document.getElementById("edit-id").value,
      pmc_name: document.getElementById("edit-name").value.trim(),
      email: document.getElementById("edit-email").value.trim(),
      main_contact: document.getElementById("edit-contact").value.trim(),
      subscription_plan: document.getElementById("edit-subscription").value.trim(),
      pms_integration: document.getElementById("edit-integration").value.trim(),
      pms_client_id: document.getElementById("edit-client-id").value.trim(),
      pms_secret: document.getElementById("edit-secret").value.trim(),
      active: document.getElementById("edit-active").checked,
    };

    if (!payload.pmc_name || !payload.pms_client_id || !payload.pms_secret) {
      showError("Name, Client ID, and Secret are required.");
      return;
    }

    showSpinner();

    try {
      const res = await fetch("/admin/update-pmc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (res.ok && result.success) {
        showSuccess();
        setTimeout(() => location.reload(), 1000);
      } else {
        showError(result.error || "Update failed.");
      }
    } catch (error) {
      console.error("Error:", error);
      showError("‚ùå Error submitting form.");
    }
  });

  // üóëÔ∏è Delete PMC
  document.getElementById("delete-btn").addEventListener("click", async () => {
    const id = document.getElementById("edit-id").value;
    if (!confirm("Are you sure you want to delete this PMC?")) return;

    showSpinner();

    try {
      const res = await fetch(`/admin/delete-pmc/${id}`, {
        method: "DELETE"
      });

      if (res.ok) {
        showSuccess("Deleted");
        setTimeout(() => location.reload(), 1000);
      } else {
        const result = await res.json();
        showError(result.error || "Failed to delete.");
      }
    } catch (err) {
      showError("‚ùå Error deleting.");
    }
  });

  function showSpinner() {
    document.getElementById("edit-spinner").style.display = "block";
    document.getElementById("edit-success").style.display = "none";
    document.getElementById("edit-error").style.display = "none";
  }

  function showSuccess(msg = "‚úÖ Saved!") {
    document.getElementById("edit-spinner").style.display = "none";
    document.getElementById("edit-success").textContent = msg;
    document.getElementById("edit-success").style.display = "block";
  }

  function showError(message) {
    document.getElementById("edit-spinner").style.display = "none";
    document.getElementById("edit-error").textContent = message;
    document.getElementById("edit-error").style.display = "block";
  }
</script>


</body>
</html>
