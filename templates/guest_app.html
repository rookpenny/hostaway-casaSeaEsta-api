<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ property_name }} ‚Äì Guest Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / icons -->
  <link rel="manifest" href="/manifest/{{ property_id }}.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="theme-color" content="#020617" />
  <link rel="apple-touch-icon" href="/static/icons/app-icon-192.png" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    window.PROPERTY_ID = {{ property_id | tojson }};
    window.PROPERTY_NAME = {{ property_name | tojson }};
    window.SANDY_LIVE = {{ ("true" if is_live else "false") | tojson }};
    window.INITIAL_VERIFIED = {{ ("true" if is_verified else "false") | tojson }};
  </script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 flex flex-col">

  <!-- Top hero (hidden on chat screen) -->
  <header id="app-header" class="relative w-full">
    <div class="h-40 w-full relative">
      {% if hero_image_url %}
        <img src="{{ hero_image_url }}" alt="{{ property_name }}" class="w-full h-full object-cover">
      {% else %}
        <div class="w-full h-full bg-slate-900"></div>
      {% endif %}
      <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-slate-950"></div>

      <!-- language + logout (only for non-chat screens) -->
      <div id="language-bar" class="absolute top-4 right-4">
        <div class="flex items-center gap-2">
          <!-- logout icon -->
          <button
            id="logout-button"
            type="button"
            class="p-2 rounded-full hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40"
          >
            <!-- your logout SVG icon here -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M18 12H9.75M18 12l-2.25-2.25M18 12l-2.25 2.25" />
            </svg>
          </button>


          <!-- language select -->
          <div class="bg-black/60 border border-slate-700 rounded-full px-2 py-0.5 text-[11px]">
            <select
              id="language-select"
              class="bg-transparent text-xs text-slate-100 focus:outline-none"
            >
              <option value="auto">Auto</option>
              <option value="en">English</option>
              <option value="es">Espa√±ol</option>
              <option value="fr">Fran√ßais</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main
  id="screen-container"
  class="flex-1 flex flex-col overflow-y-auto px-4 pt-3 pb-24"
>
    <!-- HOME -->
    <section
  id="screen-home"
  class="flex-1 flex flex-col justify-end gap-4"
>
      <!-- LOGIN STATE -->
      <div id="home-login" class="space-y-4">
        <div class="space-y-2">
          <h2 class="text-2xl font-semibold">Unlock your stay</h2>
          <p class="text-sm text-slate-300">
            Enter the <span class="font-semibold">last 4 digits of the phone number</span> on your booking
            to unlock your trip details, chat with Sandy, and browse guides.
          </p>
        </div>

        <div class="bg-slate-900/80 rounded-2xl p-4 space-y-3">
          <label for="unlock-code" class="block text-xs font-medium text-slate-300 mb-1">
            Last 4 digits
          </label>
          <input
                id="unlock-code"
                type="text"
                inputmode="numeric"
                maxlength="4"
                placeholder="1234"
                class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"
              />
          <button
            id="unlock-button"
            type="button"
            data-property-id="{{ property_id }}"
            class="w-full mt-1 inline-flex justify-center items-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-sm font-semibold text-slate-950 py-2.5 transition">
            <span>Unlock experience</span>
            <span id="unlock-spinner" class="hidden w-4 h-4 border-2 border-slate-900 border-t-transparent rounded-full animate-spin"></span>
          </button>
          <p id="unlock-error" class="text-xs text-rose-400 min-h-[1.125rem]"></p>
          <p class="text-[11px] text-slate-400">
            Not sure which number is on the booking? Check your confirmation email or message your host.
          </p>
        </div>

        <div class="mt-1 text-xs text-slate-400 flex items-center gap-2">
          {% if is_live %}
            <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
            <span>Sandy is live for this property üåä</span>
          {% else %}
            <span class="h-2 w-2 rounded-full bg-rose-500"></span>
            <span>Sandy is currently offline ‚Äì you can still view trip details.</span>
          {% endif %}
        </div>
      </div>

      <!-- UNLOCKED HOME CARD -->
      <div id="home-stay" class="space-y-4 hidden">
        <div class="rounded-2xl overflow-hidden bg-black shadow-xl">
          <!-- hero card -->
          <div class="h-44 w-full relative">
            {% if hero_image_url %}
              <img src="{{ hero_image_url }}" alt="{{ property_name }}" class="w-full h-full object-cover">
            {% else %}
              <div class="w-full h-full bg-slate-800"></div>
            {% endif %}
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>

            <div class="absolute bottom-4 left-4 right-4">
              <h1 class="text-2xl font-semibold leading-tight">
                Welcome to Casa {{ property_name }},
                <span id="guest-name-span">{{ reservation_name or "Guest" }}</span>!
              </h1>
            </div>
          </div>

          <!-- body -->
          <div class="px-4 py-4 space-y-4 text-sm">
            <!-- address + map -->
            <div class="flex items-start justify-between gap-3">
              <div class="text-xs leading-snug text-slate-200">
                <p>{{ property_address or "123 Any Street" }}</p>
                <p>{{ city_name or "Anywhere, AB A0A 1A1" }}</p>
                <p>Anyplace</p>
              </div>
              {% if property_address %}
                {% if google_maps_link %}
                  {% set maps_href = google_maps_link %}
                {% else %}
                  {% set maps_href = "#" %}
                {% endif %}
                <a href="{{ maps_href }}" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center justify-center rounded-full border border-slate-600 px-3 py-1 text-[11px] bg-slate-950/80">
                  <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M12 21s6-4.35 6-10.125C18 7.014 15.314 4.5 12 4.5S6 7.014 6 10.875C6 16.65 12 21 12 21z"/>
                    <circle cx="12" cy="10.5" r="2.25" stroke-width="1.5" />
                  </svg>
                  <span>Map</span>
                </a>
              {% endif %}
            </div>

            <div class="border-t border-slate-800 my-2"></div>

            <!-- wifi row -->
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">WiFi Network</p>
                <p class="text-base font-medium">
                  {{ wifi_ssid if wifi_ssid is defined and wifi_ssid else "Blueshore-5G" }}
                </p>
              </div>
              <div class="text-right">
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Password</p>
                <p class="text-base font-medium">
                  {{ wifi_password if wifi_password is defined and wifi_password else "Shore6345" }}
                </p>
              </div>
            </div>

            <div class="border-t border-slate-800 my-2"></div>

            <!-- check-in/out -->
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Check-in</p>
                <p class="text-base font-medium">
                  {{ checkin_time if checkin_time is defined and checkin_time else "3:00 PM" }}
                </p>
              </div>
              <div class="text-right">
                <p class="text-[11px] uppercase tracking-wide text-slate-400">Check-out</p>
                <p class="text-base font-medium">
                  {{ checkout_time if checkout_time is defined and checkout_time else "11:00 AM" }}
                </p>
              </div>
            </div>

            {% if arrival_date or departure_date %}
              <div class="flex items-start justify-between gap-4 text-xs text-slate-300">
                <div>
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Arrival</p>
                  <p class="font-medium" id="arrival-date-span">{{ arrival_date or "-" }}</p>
                </div>
                <div class="text-right">
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Departure</p>
                  <p class="font-medium" id="departure-date-span">{{ departure_date or "-" }}</p>
                </div>
              </div>
            {% endif %}

            <!-- Buttons: Check-in + Upgrades -->
            <div class="mt-3 flex items-center gap-3">
              <button
                id="checkin-button"
                class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl border border-slate-600 py-2.5 text-sm font-semibold bg-transparent">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M7 12h10M12 7l5 5-5 5"/>
                  <rect x="3.75" y="5.25" width="16.5" height="13.5" rx="2" ry="2" stroke-width="1.5"/>
                </svg>
                <span>Check-in</span>
              </button>

              <button
                id="upgrades-button"
                class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl border border-emerald-500 py-2.5 text-sm font-semibold bg-emerald-500 text-slate-950">
                <span>Upgrades</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>


<!-- CHAT (full screen: header hidden, no logout/language) -->
<section
  id="screen-chat"
  class="hidden flex-1 flex flex-col -mx-4 -mt-3"
>
  <div class="flex-1 flex flex-col bg-slate-900">
    <div
      id="chat-box"
      class="flex-1 overflow-y-auto px-4 py-4 space-y-1 text-sm"
    ></div>

<div class="bg-slate-950 px-3 py-3">
  <div class="flex items-center gap-2 rounded-full bg-slate-800 px-3 py-2">
    <!-- + button (left) -->
    <button
      type="button"
      class="flex items-center justify-center w-7 h-7 rounded-full bg-slate-900/80 text-slate-200 text-base leading-none"
    >
      +
    </button>

    <!-- text input -->
    <input
      id="chat-input"
      type="text"
      placeholder="Type a message here..."
      class="flex-1 bg-transparent border-0 text-[13px] text-slate-50 placeholder:text-slate-400 focus:outline-none focus:ring-0"
    />

    <!-- send button (up arrow) -->
    <button
      id="chat-send"
      type="button"
      class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 text-xs font-semibold"
    >
      <!-- up arrow icon -->
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.6"
          d="M12 19V5M6.5 10.5L12 5l5.5 5.5"
        />
      </svg>
    </button>
  </div>
</div>

  </div>
</section>



    <!-- GUIDES -->
    <section id="screen-experiences" class="hidden flex flex-col gap-4">
      <div class="h-32 w-full relative rounded-2xl overflow-hidden">
        {% if experiences_hero_url %}
          <img src="{{ experiences_hero_url }}" alt="Guides" class="w-full h-full object-cover">
        {% elif hero_image_url %}
          <img src="{{ hero_image_url }}" alt="Guides" class="w-full h-full object-cover">
        {% else %}
          <div class="w-full h-full bg-slate-800"></div>
        {% endif %}
        <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-black/40 to-transparent"></div>
        <div class="absolute bottom-3 left-3 right-3">
          <h2 class="text-2xl font-semibold">Guides</h2>
          <p class="text-sm text-slate-200">
            Local guidebooks, ideas, and upgrades to make your stay extra special.
          </p>
        </div>
      </div>

      <!-- cards (same as before) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <article class="sm:col-span-2 bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
          <div class="h-32 relative">
            {% if feature_image_url %}
              <img src="{{ feature_image_url }}" alt="Our Story" class="w-full h-full object-cover">
            {% else %}
              <div class="w-full h-full bg-slate-800"></div>
            {% endif %}
            <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-black/40 to-transparent"></div>
            <div class="absolute bottom-3 left-3 right-3">
              <h3 class="text-base font-semibold">Our Story</h3>
              <p class="text-[11px] text-slate-200 line-clamp-2">
                In the heart of {{ city_name or "our favorite town" }}, this place came to life‚Ä¶
              </p>
            </div>
          </div>
        </article>

        <article class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
          <div class="h-24 bg-slate-800">
            {% if family_image_url %}
              <img src="{{ family_image_url }}" alt="Family activities" class="w-full h-full object-cover">
            {% endif %}
          </div>
          <div class="p-3 space-y-1">
            <h3 class="text-sm font-semibold">Fun Family Activities</h3>
            <p class="text-[11px] text-slate-300 line-clamp-2">
              Kid-friendly beaches, playgrounds, and rainy-day ideas within a short drive.
            </p>
          </div>
        </article>

        <article class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
          <div class="h-24 bg-slate-800">
            {% if foodie_image_url %}
              <img src="{{ foodie_image_url }}" alt="Foodie guide" class="w-full h-full object-cover">
            {% endif %}
          </div>
          <div class="p-3 space-y-1">
            <h3 class="text-sm font-semibold">The Foodie Travel Guide</h3>
            <p class="text-[11px] text-slate-300 line-clamp-2">
              Coffee, brunch, seafood, and dessert spots we genuinely love.
            </p>
          </div>
        </article>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="fixed bottom-0 inset-x-0 bg-slate-950/95 border-t border-slate-800 h-16 flex items-center justify-around text-[11px] backdrop-blur">
    <button data-screen="home" class="nav-item flex flex-col items-center gap-0.5 text-slate-50">
      <span class="w-6 h-6 rounded-xl bg-slate-100 text-slate-900 flex items-center justify-center text-xs font-semibold">
        üè†
      </span>
      <span>Home</span>
    </button>
    <button data-screen="chat" class="nav-item flex flex-col items-center gap-0.5 text-slate-400">
      <span class="w-6 h-6 rounded-xl bg-slate-900 flex items-center justify-center">
        üí¨
      </span>
      <span>Chat</span>
    </button>
    <button data-screen="experiences" class="nav-item flex flex-col items-center gap-0.5 text-slate-400">
      <span class="w-6 h-6 rounded-xl bg-slate-900 flex items-center justify-center">
        üìö
      </span>
      <span>Guides</span>
    </button>
  </nav>

  <!-- Fullscreen Check-in modal (unchanged from last version) -->
  <div
    id="checkin-modal"
    class="fixed inset-0 z-40 bg-black/85 hidden items-center justify-center px-6">
    <div class="absolute top-4 right-4">
      <button
        id="checkin-close"
        class="w-9 h-9 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center text-slate-100 text-xl leading-none">
        √ó
      </button>
    </div>
    <div class="text-center space-y-4">
      <p class="text-sm uppercase tracking-[0.2em] text-slate-300">Your door code</p>
      <p id="checkin-code" class="text-5xl md:text-6xl font-semibold tracking-[0.25em]">
        ----
      </p>
      <p class="text-xs text-slate-300 max-w-xs mx-auto">
        This code matches the last 4 digits of the phone number on your reservation.
        Enter it slowly on the keypad. If the lock gives you trouble, contact your host.
      </p>
    </div>
  </div>


  <!-- üîê Logout Confirmation Modal -->
<div
  id="logout-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
>
  <div class="mx-4 w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-base font-semibold text-slate-900">Leaving already?</h2>
        <p class="mt-1 text-sm text-slate-500">
          To regain access to {{ property_name }}, you‚Äôll need to enter the last 4 digits of your booking phone number.
        </p>
      </div>
      <button
        id="logout-close"
        type="button"
        class="rounded-full p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-700"
      >
        <span class="sr-only">Close</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M10 8.586l4.95-4.95a1 1 0 111.414 1.414L11.414 10l4.95 4.95a1 1 0 01-1.414 1.414L10 11.414l-4.95 4.95a1 1 0 01-1.414-1.414L8.586 10l-4.95-4.95A1 1 0 115.05 3.636L10 8.586z"
            clip-rule="evenodd"
          />
        </svg>
      </button>
    </div>

    <div class="mt-5 flex items-center justify-end gap-3">
      <button
        id="logout-cancel"
        type="button"
        class="rounded-full border border-slate-200 px-4 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-50"
      >
        Cancel
      </button>
      <button
        id="logout-confirm"
        type="button"
        class="rounded-full bg-slate-900 px-4 py-1.5 text-sm font-semibold text-white hover:bg-slate-800"
      >
        Log out
      </button>
    </div>
  </div>
</div>

  
  <!-- JS -->
  <script>
    const screens = {
      home: document.getElementById('screen-home'),
      chat: document.getElementById('screen-chat'),
      experiences: document.getElementById('screen-experiences'),
    };

    let isUnlocked = (window.INITIAL_VERIFIED === "true");
    let lastUnlockCode = null;

    const navButtons = document.querySelectorAll('button.nav-item');
    const homeLogin = document.getElementById('home-login');
    const homeStay = document.getElementById('home-stay');
    const headerEl = document.getElementById('app-header');
    const languageBar = document.getElementById('language-bar');

    function updateHomeState() {
      if (isUnlocked) {
        homeLogin?.classList.add('hidden');
        homeStay?.classList.remove('hidden');
      } else {
        homeLogin?.classList.remove('hidden');
        homeStay?.classList.add('hidden');
      }
    }

    function showScreen(name) {
      Object.entries(screens).forEach(([key, el]) => {
        if (!el) return;
        if (key === name) el.classList.remove('hidden');
        else el.classList.add('hidden');
      });

      // header + language/logout: hide on chat, show otherwise
      if (name === 'chat') {
        headerEl?.classList.add('hidden');
      } else {
        headerEl?.classList.remove('hidden');
      }

      navButtons.forEach(btn => {
        const target = btn.getAttribute('data-screen');
        if (target === name) {
          btn.classList.remove('text-slate-400');
          btn.classList.add('text-slate-50');
        } else {
          btn.classList.add('text-slate-400');
          btn.classList.remove('text-slate-50');
        }
      });
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-screen');
        if (!isUnlocked && target !== 'home') {
          const err = document.getElementById('unlock-error');
          if (err) {
            err.textContent = "Please unlock your stay first with the last 4 digits of your booking phone number.";
          }
          showScreen('home');
          return;
        }
        showScreen(target);
      });
    });

    updateHomeState();
    showScreen('home');

    // Logout
    /*
    const logoutButton = document.getElementById('logout-button');
    if (logoutButton) {
      logoutButton.addEventListener('click', () => {
        window.location.href = '/auth/logout';
      });
    }*/

    // Language ‚Äì store in localStorage, used for chat
    const langSelect = document.getElementById('language-select');
    function getSelectedLanguage() {
      if (!langSelect) return 'auto';
      return langSelect.value || 'auto';
    }
    if (langSelect) {
      const saved = window.localStorage.getItem('guest_language');
      if (saved) {
        langSelect.value = saved;
      }
      langSelect.addEventListener('change', () => {
        window.localStorage.setItem('guest_language', langSelect.value);
      });
    }

    // Unlock flow
    const unlockBtn = document.getElementById('unlock-button');
    const unlockCodeInput = document.getElementById('unlock-code');
    const unlockError = document.getElementById('unlock-error');
    const unlockSpinner = document.getElementById('unlock-spinner');

    // --- Press Enter to unlock ---
    if (unlockCodeInput) {
      unlockCodeInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          attemptUnlock();
        }
      });
    }
  
    // --- Clicking the unlock button ---
    if (unlockBtn) {
      unlockBtn.addEventListener("click", attemptUnlock);
    }

/*
    function getCurrentPropertyId() {
      if (unlockSubmit && unlockSubmit.dataset.propertyId) {
        return unlockSubmit.dataset.propertyId;
      }
      // Fallback if something goes wrong
      return "{{ property_id }}";
    }
*/        
    async function attemptUnlock() {
  const code = (unlockCodeInput?.value || "").trim();
  if (unlockError) unlockError.textContent = "";

  if (!/^\d{4}$/.test(code)) {
    if (unlockError) unlockError.textContent = "Please enter exactly 4 digits.";
    return;
  }

  if (unlockBtn) unlockBtn.disabled = true;
  unlockSpinner?.classList.remove("hidden");

  try {
    const res = await fetch(`/guest/${window.PROPERTY_ID}/verify-json`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code }),
    });
    const data = await res.json();

    if (!res.ok || !data.success) {
      if (unlockError) {
        unlockError.textContent =
          data.error ||
          "We couldn‚Äôt verify that code. Please double-check or contact your host.";
      }
      return;
    }

    // ‚úÖ Unlocked!
    isUnlocked = true;
    lastUnlockCode = code;
    if (unlockError) unlockError.textContent = "";
    if (unlockCodeInput) unlockCodeInput.value = "";

    // üîπ Update guest name + dates in the UI if provided
    try {
      if (data.guest_name) {
        const nameEl = document.getElementById("guest-name-span");
        if (nameEl) nameEl.textContent = data.guest_name;
      }
      if (data.arrival_date) {
        const arrEl = document.getElementById("arrival-date-span");
        if (arrEl) arrEl.textContent = data.arrival_date;
      }
      if (data.departure_date) {
        const depEl = document.getElementById("departure-date-span");
        if (depEl) depEl.textContent = data.departure_date;
      }
    } catch (e) {
      console.warn("Error applying PMS guest info to UI:", e);
    }

    updateHomeState();
    showScreen("home");
  } catch (err) {
    console.error(err);
    if (unlockError) {
      unlockError.textContent =
        "Something went wrong while verifying. Please try again.";
    }
  } finally {
    if (unlockBtn) unlockBtn.disabled = false;
    unlockSpinner?.classList.add("hidden");
  }
}


    // Check-in modal
    const checkinButton = document.getElementById('checkin-button');
    const upgradesButton = document.getElementById('upgrades-button');
    const checkinModal = document.getElementById('checkin-modal');
    const checkinClose = document.getElementById('checkin-close');
    const checkinCodeEl = document.getElementById('checkin-code');

    function openCheckinModal() {
      if (!checkinModal) return;
      const code = lastUnlockCode || '----';
      if (checkinCodeEl) checkinCodeEl.textContent = code;
      checkinModal.classList.remove('hidden');
      checkinModal.classList.add('flex');
    }

    function closeCheckinModal() {
      if (!checkinModal) return;
      checkinModal.classList.add('hidden');
      checkinModal.classList.remove('flex');
    }

    if (checkinButton) {
      checkinButton.addEventListener('click', openCheckinModal);
    }
    if (checkinClose) {
      checkinClose.addEventListener('click', closeCheckinModal);
    }
    if (checkinModal) {
      checkinModal.addEventListener('click', (e) => {
        if (e.target === checkinModal) closeCheckinModal();
      });
    }

    // Upgrades ‚Üí Guides
    if (upgradesButton) {
      upgradesButton.addEventListener('click', () => {
        if (!isUnlocked) return;
        showScreen('experiences');
      });
    }

    // Chat logic
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    let currentSessionId = null;

    function scrollChatToBottom() {
      if (!chatBox) return;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

   function formatTime(date) {
  let hours = date.getHours();
  const minutes = date.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12;
  if (hours === 0) hours = 12;
  return `${hours.toString().padStart(2, "0")}:${minutes} ${ampm}`;
}

function renderMessage(text, sender) {
  if (!chatBox) return;

  const ts = formatTime(new Date());
  const isUser = sender === "user";

  // Outer row
  const row = document.createElement("div");
  row.className = `flex items-end gap-2 mb-4 ${
    isUser ? "justify-end" : "justify-start"
  }`;

  // Avatar
  const avatar = document.createElement("div");
  avatar.className =
    "w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0";
  if (isUser) {
    avatar.classList.add("bg-slate-300", "text-[11px]", "text-slate-800");
    avatar.textContent = "You".slice(0, 1); // simple user avatar
  } else {
    avatar.classList.add("bg-emerald-500", "text-[11px]", "text-slate-950");
    avatar.textContent = "S"; // Sandy avatar
  }

  // Bubble + time container
  const msgColumn = document.createElement("div");
  msgColumn.className = "max-w-[260px]";

  const bubble = document.createElement("div");
  bubble.className =
    "inline-block w-full rounded-2xl px-3 py-2 text-[13px] leading-relaxed";
  if (isUser) {
    bubble.classList.add(
      "bg-emerald-500",
      "text-slate-950",
      "rounded-br-sm"
    );
  } else {
    bubble.classList.add(
      "bg-slate-800",
      "text-slate-50",
      "rounded-bl-sm"
    );
  }
  bubble.innerHTML = formatMessage(text); // preserves emojis, links, newlines

  const timeRow = document.createElement("div");
  timeRow.className = "mt-1 text-[11px] text-slate-400 text-right";
  timeRow.textContent = ts;

  msgColumn.appendChild(bubble);
  msgColumn.appendChild(timeRow);

  if (isUser) {
    // bubble then avatar (right side)
    row.appendChild(msgColumn);
    row.appendChild(avatar);
  } else {
    // avatar then bubble (left side)
    row.appendChild(avatar);
    row.appendChild(msgColumn);
  }

  chatBox.appendChild(row);
  scrollChatToBottom();
}


    function addTyping() {
      if (!chatBox) return;
      const el = document.createElement('div');
      el.id = "typing-indicator";
      el.className = "flex justify-start";
      el.innerHTML = `
        <div class="max-w-[70%] rounded-2xl px-3 py-2 mb-1 text-xs bg-slate-800 text-slate-50 rounded-bl-sm inline-flex items-center gap-1">
          <span class="w-1.5 h-1.5 rounded-full bg-slate-400 animate-pulse"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-slate-400 animate-pulse" style="animation-delay:150ms;"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-slate-400 animate-pulse" style="animation-delay:300ms;"></span>
        </div>`;
      chatBox.appendChild(el);
      scrollChatToBottom();
    }

    function removeTyping() {
      const el = document.getElementById('typing-indicator');
      if (el) el.remove();
    }

    function formatMessage(text) {
      let escaped = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      escaped = escaped.replace(
        /(https:\/\/www\.google\.com\/maps[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer" class="underline underline-offset-2">üìç View on Google Maps</a>'
      );
      escaped = escaped.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer" class="underline underline-offset-2">$1</a>'
      );

      return escaped.replace(/\n/g, "<br>");
    }

    async function sendChat() {
      const text = (chatInput?.value || "").trim();
      if (!text) return;

      if (window.SANDY_LIVE === "false") {
        renderMessage("Sandy is currently offline for this property. Please contact your host directly. üôè", "bot");
        return;
      }

      renderMessage(text, "user");
      if (chatInput) chatInput.value = "";
      addTyping();

      try {
        const body = {
          message: text,
          session_id: currentSessionId,
          language: getSelectedLanguage()
        };

        const res = await fetch(`/properties/${window.PROPERTY_ID}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        removeTyping();

        if (data.session_id) currentSessionId = data.session_id;

        if (data.error) {
          renderMessage(data.error, "bot");
        } else {
          renderMessage(data.response || "Hmm, I didn‚Äôt catch that ‚Äî could you try again? üå¥", "bot");
        }
      } catch (err) {
        console.error(err);
        removeTyping();
        renderMessage("Oops! Something went wrong. Please try again in a moment. üêö", "bot");
      }
    }

    if (chatSend && chatInput) {
      chatSend.addEventListener('click', sendChat);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });
    }

    // üîê Logout modal wiring
const logoutButton = document.getElementById("logout-button");
const logoutModal = document.getElementById("logout-modal");
const logoutClose = document.getElementById("logout-close");
const logoutCancel = document.getElementById("logout-cancel");
const logoutConfirm = document.getElementById("logout-confirm");

function openLogoutModal() {
  if (logoutModal) {
    logoutModal.classList.remove("hidden");
    logoutModal.classList.add("flex");
  }
}

function closeLogoutModal() {
  if (logoutModal) {
    logoutModal.classList.add("hidden");
    logoutModal.classList.remove("flex");
  }
}

if (logoutButton) {
  logoutButton.addEventListener("click", (e) => {
    e.preventDefault();
    openLogoutModal();
  });
}

if (logoutClose) {
  logoutClose.addEventListener("click", (e) => {
    e.preventDefault();
    closeLogoutModal();
  });
}

if (logoutCancel) {
  logoutCancel.addEventListener("click", (e) => {
    e.preventDefault();
    closeLogoutModal();
  });
}

// Confirm ‚Üí hit backend logout route
if (logoutConfirm) {
  logoutConfirm.addEventListener("click", (e) => {
    e.preventDefault();
    // This will clear session and redirect to /guest/{property_id}
    window.location.href = "/auth/logout";
  });
}

// Optional: click on backdrop to close
if (logoutModal) {
  logoutModal.addEventListener("click", (e) => {
    if (e.target === logoutModal) {
      closeLogoutModal();
    }
  });
}

  </script>
</body>
</html>
