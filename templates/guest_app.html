<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>{{ property_name }} ‚Äì Guest Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / icons -->
  <link rel="manifest" href="/manifest/{{ property_id }}.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="theme-color" content="#020617" />
  <link rel="apple-touch-icon" href="/static/icons/app-icon-192.png" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,
    body {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 0.95rem;
      overflow-x: hidden;
      /* only block horizontal scroll */
    }


    * {
      box-sizing: border-box;
    }

    body.menu-open {
      overflow: hidden;
    }

    /* === HAMBURGER / X BUTTON === */

    /* === Hamburger / X toggle for #menu-toggle === */
    /* === Hamburger / X toggle for #menu-toggle === */
    #menu-toggle {
      position: relative;
    }

    /* Top + bottom bars */
    #menu-toggle::before,
    #menu-toggle::after {
      content: "";
      position: absolute;
      left: 50%;
      width: 24px;
      height: 2px;
      border-radius: 999px;
      background: #020617;
      /* closed: white bars on blue */
      transform: translateX(-50%);
      transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
    }

    /* Top bar (hamburger) */
    #menu-toggle::before {
      transform: translate(-50%, -6px);
    }

    /* Bottom bar (hamburger) */
    #menu-toggle::after {
      transform: translate(-50%, 6px);
    }

    /* Middle bar */
    #menu-toggle .menu-toggle-middle {
      width: 24px;
      height: 2px;
      border-radius: 999px;
      background: #020617 !important; /* black */
      transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
    }

    /* === OPEN STATE transforms hamburger into "X" === */
    #menu-toggle.menu-toggle-open::before {
      transform: translate(-50%, 0) rotate(45deg);
    }

    #menu-toggle.menu-toggle-open::after {
      transform: translate(-50%, 0) rotate(-45deg);
    }

    #menu-toggle.menu-toggle-open .menu-toggle-middle {
      opacity: 0;
      transform: scaleX(0.5);
    }

 /* When menu is open ‚Üí switch to white (on black menu) */
#menu-toggle.menu-toggle-open::before,
#menu-toggle.menu-toggle-open::after,
#menu-toggle.menu-toggle-open .menu-toggle-middle {
  background: #FFFFFF !important; /* white */
}




    .menu-toggle {
      position: relative;
    }

    /* Top + bottom bars */
    .menu-toggle::before,
    .menu-toggle::after {
      content: "";
      position: absolute;
      left: 50%;
      width: 24px;
      height: 2px;
      background: #ffffff;
      border-radius: 999px;
      transform: translateX(-50%);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* Top bar (default) */
    .menu-toggle::before {
      transform: translate(-50%, -6px);
    }

    /* Bottom bar (default) */
    .menu-toggle::after {
      transform: translate(-50%, 6px);
    }

    /* Middle bar */
    .menu-toggle-middle {
      width: 24px;
      height: 2px;
      background: #ffffff;
      border-radius: 999px;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    /* === OPEN STATE === */
    .menu-toggle.menu-toggle-open::before {
      transform: translate(-50%, 0) rotate(45deg);
    }

    .menu-toggle.menu-toggle-open::after {
      transform: translate(-50%, 0) rotate(-45deg);
    }

    .menu-toggle.menu-toggle-open .menu-toggle-middle {
      opacity: 0;
      transform: scaleX(0.5);
    }

    /* Smooth fade on logo when we swap pngs */
#logo-img {
  transition: opacity 180ms ease;
}

    /* Keep Tailwind layout; only tweak visuals
nav[role="navigation"] {
  height: 120px !important; 
}
 */
    /* Make the nav buttons visually clean but DO NOT touch layout */
    nav .nav-item {
      background: none !important;
      border: none !important;
      padding: 0;
      margin: 0;
      box-shadow: none !important;
    }

    /* Icon images */
    .nav-icon-img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      opacity: 0.65;
      transition: opacity 0.25s ease;
    }

    /* Hover + active: just change opacity, nothing else */
    nav .nav-item:hover .nav-icon-img,
    nav .nav-item[aria-current="page"] .nav-icon-img {
      opacity: 1;
    }



    /* REMOVE any unwanted Tailwind classes JS might apply */
    nav .nav-icon {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      transform: none !important;
      /* stops scale-110 */
    }


    /* OPTIONAL ‚Äî dim inactive icons (if JS toggles text-slate-400/50) */
    .nav-item.text-slate-400 .nav-icon-img {
      opacity: 0.6;
    }

    .nav-item.text-slate-50 .nav-icon-img {
      opacity: 1;
    }



    /* header labels (Arrival, Check-in, WiFi Network, etc.) */
    .detail-label {
      font-size: 0.65rem !important;
      font-weight: 700 !important;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgb(148 163 184);
      /* slate-400 */
    }

    .detail-label-results {
      font-size: 1rem !important;
      font-weight: 600 !important;
      text-transform: uppercase;
      /* letter-spacing: 0.05em;*/
      color: rgb(255 255 255);
      /* slate-400 */
    }

    /* Sandy avatar photo */
    .avatar-sandy {
      background-image: url("/static/img/sandy.png");
      background-size: cover;
      background-position: center;
      background-color: transparent;
    }


    #chat-box {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }


    .msg {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0.75rem;
      animation: fadeInUp 0.35s ease-out;
      animation-fill-mode: both;
      scroll-margin-bottom: 7rem;
    }


    .msg.user {
      justify-content: flex-end;
    }

    /* Column that wraps bubble + timestamp for user messages */
    .msg.user>div {
      max-width: 70%;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-end;
      /* bubble & timestamp align to right together */

    }

    /* Column that wraps bubble + timestamp for bot messages */
    .msg.bot>div:last-child {
      max-width: 70%;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
    }


    .msg.bot {
      justify-content: flex-start;
    }



    .bubble {
      display: inline-block;
      /* hug contents */
      padding: 0.6rem 1rem;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      max-width: 100%;
      /* let parent control width */
      font-size: 0.95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }


    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 999px; /* full circle */
      overflow: hidden;     /* prevents distortion */
      /* rounded square
      margin: 0 0.5rem;
      background-size: cover;
      background-position: center;
      flex-shrink: 0; */
    }


    .msg.bot .avatar {
      /*background-color: #22c55e;*/
      color: #022c22;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 1.25rem; /* adjust to taste */
      margin-right: 0.50rem; /* 12px */
    }

    /* Timestamp above bubble */
    .timestamp {
      font-size: 0.65rem;
      color: #64748b;
      margin-bottom: 0.25rem;  /* spacing below timestamp */
      margin-top: 0;           /* remove old spacing */
    }


    /* Bot timestamps align left under the bubble */
    .msg.bot .timestamp {
      text-align: left;
      align-self: flex-start;
      padding-left: 4px;
    }

    /* User timestamps align right, directly under user bubble */
    .msg.user .timestamp {
      text-align: right;
      align-self: flex-end;
      padding-right: 4px;
    }


    .message-text p {
      margin: 0.5rem 0;
    }

    .message-text ul {
      margin: 0.5rem 0;
      padding-left: 1.2rem;
    }

    .message-text li {
      margin-bottom: 0.3rem;
    }

    .message-text a {
      color: #22c55e;
      text-decoration: none;
      word-break: break-word;
    }

    .message-text a:hover {
      text-decoration: underline;
    }

    .message-text strong {
      font-weight: 600;
    }

    .message-text em {
      font-style: italic;
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      transform: translateY(-2px);
      /* raise it */
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      margin: 0 3px;
      background-color: #022c22;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 1s infinite ease-in-out;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.3;
        transform: scale(0.7);
      }

      50% {
        opacity: 1;
        transform: scale(1);
      }
    }



    .dots-anim {
      display: inline-block;
    }

    .dots-anim span {
      font-size: 1.25rem;
      animation: blink 1.4s infinite both;
      opacity: 0.3;
    }

    .dots-anim span:nth-child(1) {
      animation-delay: 0s;
    }

    .dots-anim span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .dots-anim span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0% {
        opacity: 0.3;
      }

      20% {
        opacity: 1;
      }

      100% {
        opacity: 0.3;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }


    
/* TOP layer: chrome (logo + hamburger) */
#top-bar-chrome {
  z-index: 70;
}
    
/* MIDDLE layer: menu (you already have z-[60] in HTML) */
#mobile-menu {
  z-index: 60;
}

    .chat-input-bar {
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0rem;
      /* above nav */
      z-index: 30;
    }

    /* Default hidden state */
    #mobile-menu .mobile-menu-content {
      opacity: 0;
      transform: translateY(-12px);
      transition:
        opacity .3s cubic-bezier(0.16, 1, 0.3, 1),
        transform .35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Opening animation */
    #mobile-menu.show-links {
      opacity: 1;
    }

    #mobile-menu.show-links .mobile-menu-content {
      opacity: 1;
      transform: translateY(0);
    }

    /* Closing fade-out ONLY */
    #mobile-menu.fade-out .mobile-menu-content {
      opacity: 0;
      transform: translateY(0);
      /* no slide on close */
      transition: opacity .25s ease;
    }

    /* When on chat screen: top bar becomes light grey */
body.chat-screen #top-bar {
  color: #020617 !important;
  /* if you want text on avatar label darker (you already do) */
}

body.chat-screen #top-bar::before {
  content: "";
  position: absolute;
  inset: 0;
  background: #f8fafc;      /* grey strip behind everything */
  z-index: 0;               /* under avatar */
}

    
#top-bar {
  z-index: 20;              /* below menu, below chrome */
}
    
    /* keep your existing color-swap rules for the hamburger */
body.chat-screen #menu-toggle::before,
body.chat-screen #menu-toggle::after,
body.chat-screen #menu-toggle .menu-toggle-middle {
  background: #000000 !important;
}

/* avatar on top of grey bar but under menu */
#chat-header-sandy {
  z-index: 1;
}
    
    /* Switch logos appropriately */
    body.chat-screen #logo-light {
      display: none !important;
    }

    body.chat-screen #logo-dark {
      display: block !important;
    }

    /* Show Sandy header only on chat screen */
    body.chat-screen #chat-header-sandy {
      display: flex;
    }

   

    .chat-input-inner {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      padding: 0.6rem 0.75rem;
    }

    .chat-input-bar input[type="text"] {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      outline: none;
      color: #1f2937;
    }

    .chat-plus {
      background: #0b1120;
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #e5e7eb;
    }

    .send-button {
      background: #22c55e;
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #022c22;
    }

    /* Light mode chat screen */
    #screen-chat {
      color: #1f2937;
      /* DO NOT set display or height here so .hidden can control it */
    }

    #screen-chat>.flex-1 {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }


    .msg.user .bubble {
      background: #e5e7eb;
      color: #111827;
    }

    .msg.bot .bubble {
      background: #22c55e;
      color: #022c22;
    }

  

    .timestamp {
      color: #64748b;
    }

    /* Push chat content below the fixed top bar (h-20 = 5rem) */
body.chat-screen #screen-chat {
  padding-top: 5rem; /* match header height (h-20) */
}

 /* NEW STYLES */

/* Light surfaces for main screens (Home / Guides / Upgrades) */
#screen-home,
#screen-experiences,
#screen-upgrades {
  background: #f5f5f5;
  color: #020617;
}

/* Home card heading + small label */
.home-property-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: #94a3b8;
}

/* Big hero heading on Home / Guides / Upgrades */
.hero-heading {
  font-size: 2rem;
  line-height: 1.2;
  font-weight: 600;
}

/* White ‚Äúpolaroid‚Äù card with image (Home + Upgrades cards) */
.surface-card {
  border-radius: 2rem;
  background: #ffffff;
  box-shadow:
    0 20px 45px rgba(15, 23, 42, 0.16),
    0 0 0 1px rgba(15, 23, 42, 0.04);
}

/* Pill CTA buttons (Door / WiFi / purchase) */
.pill-button {
  border-radius: 999px;
  border-width: 1px;
  padding: 0.9rem 1rem;
  font-size: 0.95rem;
  font-weight: 600;
}

/* Black full-screen menu */
#mobile-menu {
  background: #000000;
  color: #f9fafb;
}

#mobile-menu .mobile-menu-content {
  justify-content: flex-start;
}

#mobile-menu ul li button {
  font-size: 2rem;       /* big menu items */
  font-weight: 600;
}

#mobile-menu .menu-label {
  font-size: 0.7rem;
  letter-spacing: 0.24em;
  text-transform: uppercase;
  color: #9ca3af;
}

#mobile-menu .menu-footer {
  font-size: 0.75rem;
  color: #9ca3af;
}

/* Guide detail full-page layout */
#guide-modal section {
  border-radius: 0;
  max-height: none;
  max-width: 100%;
}

/* Make the guide/upgrades detail screens feel like full pages */
#screen-guide-detail,
#screen-upgrade-detail {
  background: #f5f5f5;
  color: #020617;
}


  </style>

  <script>
    window.PROPERTY_ID = {{ property_id | tojson }};
    window.PROPERTY_NAME = {{ property_name | tojson }};
    window.SANDY_LIVE = {{ ("true" if is_live else "false") | tojson }};
    window.INITIAL_VERIFIED = {{ ("true" if is_verified else "false") | tojson }};
  </script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 flex flex-col overflow-x-hidden">

  <!-- App shell with shared background image + gradient -->
  <div id="app-shell" class="relative min-h-screen w-full max-w-full flex flex-col overflow-x-hidden"
    style="background-image: url('{{ hero_image_url or default_image_url }}'); background-size: cover; background-position: top;">
    <!-- Gradient overlay -->
    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent pointer-events-none"></div>


    <!-- Foreground content -->
    <div class="relative z-10 flex flex-col min-h-screen">

      <!-- Top header / nav -->
      <header id="app-header" class="relative w-full">

  <!-- BOTTOM LAYER: grey bar + Sandy avatar -->
  <div id="top-bar"
       class="fixed top-0 inset-x-0 h-20 bg-transparent text-white
              transition-colors duration-300">
    <!-- Sandy avatar, centered in the bar -->
    <div id="chat-header-sandy"
         class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2
                hidden flex flex-col items-center pointer-events-none">
      <div class="avatar avatar-sandy shadow"></div>
      <span class="text-xs text-slate-900 mt-1">Sandy</span>
    </div>
  </div>

  <!-- TOP LAYER: logo + hamburger, always above menu + bar -->
  <div id="top-bar-chrome"
       class="fixed top-0 inset-x-0 h-20 z-[70]">
    <div id="top-bar-inner"
         class="max-w-3xl mx-auto flex items-center justify-between h-full px-4">
      <!-- Logo -->
      <a href="#" class="flex items-center gap-2">
        <!-- default: white logo -->
        <img id="logo-img"
             src="/static/img/neat-sleeps-white.png"
             alt="{{ property_name }}"
             class="h-7" />
      </a>

      <!-- Hamburger -->
      <button id="menu-toggle" type="button"
              class="relative w-9 h-9 flex items-center justify-center rounded-full bg-[#000] focus:outline-none p-1"
              aria-label="Toggle navigation menu">
        <span class="menu-toggle-middle"></span>
      </button>
    </div>
  </div>

</header>



      <!-- Full-screen slide-down mobile menu -->
      <!-- Full-screen slide-down mobile menu -->
<nav
  id="mobile-menu"
  class="fixed inset-0 z-[60]
         transform -translate-y-full pointer-events-none
         transition-transform duration-700 ease-out"
  aria-label="Main navigation"
>
  <div
    class="mobile-menu-content pt-24 pb-10 max-w-3xl mx-auto px-6 flex flex-col h-full"
  >
    <!-- Small label -->
    <div class="menu-label mb-10">
      Menu
    </div>

    <!-- Main links -->
    <ul class="space-y-8">
      <li>
        <button
          type="button"
          data-menu-screen="home"
          class="w-full text-left hover:text-white transition-colors"
        >
          Stay overview
        </button>
      </li>
      <li>
        <button
          type="button"
          data-menu-screen="chat"
          class="w-full text-left hover:text-white transition-colors"
        >
          Chat with Sandy
        </button>
      </li>
      <li>
        <button
          type="button"
          data-menu-screen="experiences"
          class="w-full text-left hover:text-white transition-colors"
        >
          Guides
        </button>
      </li>
      <li>
        <button
          type="button"
          data-menu-screen="upgrades"
          class="w-full text-left hover:text-white transition-colors"
        >
          Upgrades
        </button>
      </li>
    </ul>

    <!-- Footer -->
    <div class="mt-auto pt-8 menu-footer">
      Powered by HostScout
    </div>
  </div>
</nav>






      <!-- Main content area that swaps screens  overflow-hidden-->
      <main id="screen-container" class="flex-1 flex flex-col" role="main">
        
        
        
        <!-- HOME -->
<!-- HOME -->
<section
  id="screen-home"
  class="flex flex-col flex-1 bg-[#f4f4f4] text-[0.95rem] px-4 pb-8 pt-20"
  aria-label="Home"
>
  <!-- LOGIN STATE (unchanged) -->
  <div id="home-login" class="space-y-4">
    <div class="space-y-2">
      <h2 class="font-semibold text-slate-900">Unlock your stay</h2>
      <p class="text-slate-500">
        Enter the
        <span class="font-semibold">last 4 digits of the phone number</span>
        on your booking to unlock your trip details, chat with Sandy, and
        browse guides.
      </p>
    </div>

    <div class="bg-white rounded-3xl p-4 space-y-3 shadow-sm">
      <label
        for="unlock-code"
        class="block font-medium text-slate-700 mb-1"
      >
        Last 4 digits
      </label>
      <input
        id="unlock-code"
        type="text"
        inputmode="numeric"
        maxlength="4"
        autocomplete="off"
        placeholder="1234"
        pattern="[0-9]*"
        class="w-full rounded-2xl bg-slate-50 border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"
      />
      <button
        id="unlock-button"
        type="button"
        data-property-id="{{ property_id }}"
        class="w-full mt-1 inline-flex justify-center items-center gap-2 rounded-2xl bg-slate-900 hover:bg-slate-800 font-semibold text-slate-50 py-3 transition"
      >
        <span>Unlock experience</span>
        <span
          id="unlock-spinner"
          class="hidden w-4 h-4 border-2 border-slate-50 border-t-transparent rounded-full animate-spin"
        ></span>
      </button>
      <p
        id="unlock-error"
        class="text-rose-500 min-h-[1.125rem]"
        aria-live="polite"
      ></p>
      <p class="text-slate-500 text-xs">
        Not sure which number is on the booking? Check your confirmation email
        or message your host.
      </p>
    </div>

    <div class="mt-2 text-slate-500 flex items-center gap-2 text-xs">
      {% if is_live %}
      <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
      <span>Sandy is live for this property üåä</span>
      {% else %}
      <span class="h-2 w-2 rounded-full bg-rose-500"></span>
      <span>
        Sandy is currently offline ‚Äì you can still view trip details.
      </span>
      {% endif %}
    </div>
  </div>

  <!-- UNLOCKED HOME (matches mock) -->
  <div class="flex-1 flex flex-col justify-start">
    <div
      id="home-stay"
      class="hidden pt-0"
    >
      <!-- Top labels / heading -->
      <div class="text-center pb-3">
        <p class="text-[11px] font-semibold text-[#666666]">
          Casa {{ property_name or "Your stay" }}
        </p>
        <h1 class="mt-2 text-[32px] font-semibold text-[#000000] leading-tight">
          <span id="guest-name-span">{{ reservation_name or "Guest" }}</span>, breathe.<br />
          You‚Äôve made it.
        </h1>
      </div>

      <!-- Image card max-w-[407px] -->
      <div class="w-full flex justify-center mt-2 pl-2 pr-2">
        <div
          class="bg-white rounded-[32px] shadow-[0_10px_20px_rgba(0,0,0,0.35)] overflow-hidden w-full border-[4px] border-[#FFFFFF]"
        >
          <div class="h-[400px] w-full overflow-hidden">
            <img
              src="{{ hero_image_url or default_image_url }}"
              alt="{{ property_name }}"
              class="w-full h-full object-cover"
            />
          </div>
        </div>
      </div>

      <!-- Details + buttons -->
      <div class="mt-8 space-y-8">
        {% if arrival_date or departure_date %}
        <!-- Arrival / Departure row -->
        <div
          class="max-w-[360px] mx-auto flex items-start justify-between text-center text-sm"
        >
          <div class="flex-1 pb-3 pr-2">
            <p class="text-[11px] font-semibold text-[#666666] text-right">
              Arrival
            </p>
            <p
              id="arrival-date-span"
              class="mt-1 text-[20px] font-semibold text-[#000000] text-right"
            >{{ arrival_date or "-" }}></p>
             <p class="mt-1 text-[20px] font-semibold text-[#000000] text-right" pt-1>{{ checkin_time if checkin_time is defined and checkin_time else "3:00 PM" }}
            </p>
          </div>
          <div class="flex-1 pb-3 pl-2">
            <p class="text-[11px] font-semibold text-left text-[#666666]">
              Departure
            </p>
            <p
              id="departure-date-span"
              class="mt-1 text-[20px] font-semibold text-left text-[#000000]"
            >{{ departure_date or "-" }}</p>
              <p class="mt-1 text-[20px] font-semibold text-left text-[#000000] pt-1">{{ checkout_time if checkout_time is defined and checkout_time else "11:00 AM" }}
            </p>
          </div>
        </div>
        {% endif %}

        <!-- Door / WiFi buttons -->
        <div class="max-w-[360px] mx-auto grid grid-cols-2 gap-4 mt-2">
          <button
            id="checkin-button"
            type="button"
            class="w-full border border-slate-900 rounded-[999px] py-3 text-[15px] font-semibold bg-white text-slate-900">
            Door
          </button>
          <button
            type="button"
            class="w-full border border-slate-900 rounded-[999px] py-3 text-[15px] font-semibold bg-white text-slate-900"
          >
            WiFi
          </button>
        </div>
      </div>
    </div>
  </div>
</section>



        <!-- CHAT -->
        <section id="screen-chat" class="hidden bg-white min-h-screen" aria-label="Chat">

          <!-- NEW: Spacer for top navigation (same height as header h-16) 
  <div class="h-24"></div>-->

          <div id="chat-box" class="px-4 pt-4 pb-40 space-y-2 bg-white text-slate-800"></div>


          <div class="chat-input-bar">
            <div class="chat-input-inner">
              <button type="button" class="chat-plus" aria-label="Insert a suggested question">+</button>
              <input id="chat-input" type="text" placeholder="Type a message here..." aria-label="Chat message" />
              <button id="chat-send" type="button" class="send-button" aria-label="Send message">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                    d="M12 19V5M6.5 10.5L12 5l5.5 5.5" />
                </svg>
              </button>
            </div>
          </div>
        </section>

        <!-- GUIDES -->
<!-- GUIDES -->
<section
  id="screen-experiences"
  class="hidden bg-[#f5f5f5] px-4 pt-24 pb-24 space-y-6"
  aria-label="Guides and local tips"
>
  <!-- Hero -->
  <div class="text-left">
    <p class="home-property-label">
      {{ property_name or "Your stay" }}
    </p>
    <h1 class="hero-heading mt-2">
      Your stay just got easier,
      <span id="guest-name-span-guides">{{ reservation_name or "Guest" }}</span
      >.
    </h1>
  </div>

  <!-- Filters row -->
  <div class="flex items-center gap-2 overflow-x-auto pb-1 pt-1 text-[11px]">
    <!-- sort button -->
    <button
      type="button"
      class="guide-filter whitespace-nowrap px-3 py-1.5 rounded-full border border-slate-300 bg-white text-slate-900 inline-flex items-center gap-1"
      data-filter="all"
    >
      <span>Sort by</span>
      <span class="text-xs">‚ñº</span>
    </button>

    <!-- dynamic filters injected here -->
    <div
      id="guides-filters"
      class="flex gap-2 overflow-x-auto pb-1 pt-1 text-[11px]"
    ></div>
  </div>

  <!-- Guides grid: injected by JS -->
  <div
    id="guides-grid"
    class="grid grid-cols-2 gap-3"
  ></div>

  <!-- Fallback / empty state -->
  <p
    id="guides-empty-state"
    class="hidden text-xs text-slate-500 mt-4"
  >
    We don‚Äôt have any guides yet for this stay. Check back soon or ask Sandy
    for local tips.
  </p>
</section>





<!-- UPGRADES -->
<section
  id="screen-upgrades"
  class="hidden bg-[#f5f5f5] flex flex-col flex-1 text-[0.95rem] px-4 pt-24 pb-24"
  aria-label="Upgrades"
>
  <!-- Heading -->
  <div class="mb-6 text-left">
    <p class="home-property-label">
      {{ property_name or "Your stay" }}
    </p>
    <h1 class="hero-heading mt-2">
      Upgrades you‚Äôll love,
      <span>{{ reservation_name or "Guest" }}</span>.
    </h1>
  </div>

  <div class="space-y-6">
    {% if upgrades and upgrades|length > 0 %}
      {% for up in upgrades %}
        {% set slug = up.slug or "" %}
        {% set title_lower = (up.title or "")|lower %}

        {% set is_time_flex =
              slug in ["early-check-in", "late-checkout", "late-check-out"]
              or "early check" in title_lower
              or "late check" in title_lower
        %}

        {% if same_day_turnover and is_time_flex %}
          {# skip time-flex on same-day turnover #}
        {% else %}
          <button
            type="button"
            class="upgrade-card surface-card w-full overflow-hidden text-left focus:outline-none focus:ring-2 focus:ring-emerald-400 block mx-auto max-w-md"
            data-upgrade-id="{{ up.id }}"
            data-upgrade-title="{{ up.title }}"
            data-upgrade-price="{{ up.price_display or '' }}"
          >
            <!-- Card image -->
            <div class="h-64 w-full overflow-hidden">
              {% if up.image_url %}
                <img src="{{ up.image_url }}" alt="{{ up.title }}" class="w-full h-full object-cover">
              {% else %}
                <img src="{{ hero_image_url or default_image_url }}" alt="{{ up.title }}" class="w-full h-full object-cover">
              {% endif %}
            </div>

            <!-- Card body -->
            <div class="p-5 space-y-3">
              <h3 class="text-lg font-semibold leading-snug">
                {{ up.title }}
              </h3>

              {% if up.short_description or up.long_description %}
                <p class="text-sm text-slate-600 leading-relaxed">
                  {{ up.short_description or up.long_description }}
                </p>
              {% endif %}

              <p class="hidden upgrade-long">
                {{ up.long_description or up.short_description }}
              </p>

              <div class="pt-2 flex items-center justify-between text-sm">
                <span class="font-semibold text-slate-900">
                  {{ up.price_display or "" }}
                </span>
                <span class="text-[11px] uppercase tracking-[0.16em] text-slate-500">
                  View details
                </span>
              </div>
            </div>
          </button>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="text-xs text-slate-500">
        Upgrades aren‚Äôt available for this stay yet.
      </p>
    {% endif %}
  </div>
</section>



<!-- UPGRADE DETAIL (full page with purchase bar) -->
<div
  id="upgrade-modal"
  class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[80]"
>
  <section
    id="screen-upgrade-detail"
    class="bg-[#f5f5f5] text-slate-900 flex flex-col min-h-screen w-full"
    aria-label="Upgrade details"
  >
    <!-- Hero image with close -->
    <div class="relative h-64 w-full overflow-hidden">
      <img
        id="upgrade-detail-image"
        src="{{ hero_image_url or default_image_url }}"
        alt=""
        class="w-full h-full object-cover"
      />
      <button
        id="upgrade-modal-close"
        type="button"
        class="absolute top-6 right-5 w-9 h-9 rounded-full bg-black/80 flex items-center justify-center text-slate-50 text-xl leading-none"
      >
        √ó
      </button>
    </div>

    <!-- Text content -->
    <div class="px-6 pt-6 pb-32 flex-1 overflow-y-auto">
      <h2
        id="upgrade-detail-title"
        class="text-2xl font-semibold leading-tight"
      >
        Upgrade title
      </h2>

      <p
        id="upgrade-detail-body"
        class="mt-4 text-sm text-slate-800 leading-relaxed whitespace-pre-line"
      >
        Full description goes here.
      </p>

      <div class="mt-8 border border-slate-200 rounded-2xl p-4">
        <p
          class="text-[11px] uppercase tracking-[0.2em] text-slate-500 mb-2"
        >
          Your upgrade
        </p>
        <div class="flex items-center justify-between text-sm">
          <span id="upgrade-detail-name" class="font-medium">
            Upgrade name
          </span>
          <span id="upgrade-detail-price" class="font-semibold">
            $0.00
          </span>
        </div>
      </div>
    </div>

    <!-- Bottom purchase bar -->
    <div
      class="fixed bottom-0 left-0 right-0 px-4 pb-6 pt-3 bg-[#f5f5f5]/95 backdrop-blur-sm shadow-[0_-12px_30px_rgba(15,23,42,0.18)]"
    >
      <button
        id="upgrade-detail-purchase"
        type="button"
        class="w-full rounded-full py-3 text-sm font-semibold bg-slate-900 text-slate-50"
      >
        <span id="upgrade-detail-price-bottom">
          $0.00 ‚Äì Purchase
        </span>
      </button>
    </div>
  </section>
</div>

 

  <!-- Check-in modal -->
  <div id="checkin-modal" class="fixed inset-0 z-40 bg-black/85 hidden items-center justify-center px-6" role="dialog"
    aria-modal="true" aria-labelledby="checkin-title">
    <div class="absolute top-4 right-4">
      <button id="checkin-close" type="button"
        class="w-9 h-9 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center text-slate-100 text-xl leading-none"
        aria-label="Close">
        √ó
      </button>
    </div>
    <div class="text-center space-y-4">
      <p id="checkin-title" class="text-sm uppercase tracking-[0.2em] text-slate-300">
        Your door code
      </p>
      <p id="checkin-code" class="text-5xl md:text-6xl font-semibold tracking-[0.25em]">
        ----
      </p>
      <p class="text-xs text-slate-300 max-w-xs mx-auto">
        This code matches the last 4 digits of the phone number on your reservation.
        Enter it slowly on the keypad. If the lock gives you trouble, contact your host.
      </p>
    </div>
  </div>



 <!-- GUIDE DETAIL (full page) -->
<div
  id="guide-modal"
  class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[80]"
>
  <section
    id="screen-guide-detail"
    class="bg-[#f5f5f5] text-slate-900 flex flex-col min-h-screen w-full"
    aria-label="Guide details"
  >
    <!-- Close button -->
    <button
      id="guide-modal-close"
      type="button"
      class="absolute top-6 right-5 w-9 h-9 rounded-full bg-black/80 flex items-center justify-center text-slate-50 text-xl leading-none z-10"
    >
      √ó
    </button>

    <div class="pt-24 px-6 pb-12 flex-1 overflow-y-auto space-y-4">
      <h2
        id="guide-modal-title"
        class="text-2xl font-semibold leading-tight"
      >
        Headline
      </h2>
      <p
        id="guide-modal-body"
        class="mt-2 text-sm text-slate-800 leading-relaxed whitespace-pre-line"
      >
        Full description goes here.
      </p>
    </div>
  </section>
</div>




  <!-- Logout modal -->
  <div id="logout-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
    role="dialog" aria-modal="true" aria-labelledby="logout-title">
    <div class="mx-4 w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 id="logout-title" class="text-base font-semibold text-slate-900">Leaving already?</h2>
          <p class="mt-1 text-sm text-slate-500">
            To regain access to {{ property_name }}, you‚Äôll need to enter the last 4 digits of your booking phone
            number.
          </p>
        </div>
        <button id="logout-close" type="button"
          class="rounded-full p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-700">
          <span class="sr-only">Close</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"
            aria-hidden="true">
            <path fill-rule="evenodd"
              d="M10 8.586l4.95-4.95a1 1 0 111.414 1.414L11.414 10l4.95 4.95a1 1 0 01-1.414 1.414L10 11.414l-4.95 4.95a1 1 0 01-1.414-1.414L8.586 10l-4.95-4.95A1 1 0 115.05 3.636L10 8.586z"
              clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <div class="mt-5 flex items-center justify-end gap-3">
        <button id="logout-cancel" type="button"
          class="rounded-full border border-slate-200 px-4 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-50">
          Cancel
        </button>
        <button id="logout-confirm" type="button"
          class="rounded-full bg-slate-900 px-4 py-1.5 text-sm font-semibold text-white hover:bg-slate-800">
          Log out
        </button>
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Screens + core elements ---
    const screens = {
      home: document.getElementById("screen-home"),
      chat: document.getElementById("screen-chat"),
      experiences: document.getElementById("screen-experiences"),
      upgrades: document.getElementById("screen-upgrades"),
      //upgradeDetail: document.getElementById("screen-upgrade-detail"),
    };

    const LOGO_WHITE = "/static/img/neat-sleeps-white.png";
    const LOGO_BLACK = "/static/img/neat-sleeps-black.png";

    // helper: are we currently on the chat screen?
    function isChatVisible() {
      const chatScreen = screens.chat;
      return chatScreen && !chatScreen.classList.contains("hidden");
    }

    const navButtons = document.querySelectorAll("nav .nav-item");
    const homeLogin = document.getElementById("home-login");
    const homeStay = document.getElementById("home-stay");
    const headerEl = document.getElementById("app-header");
    const upgradeModal = document.getElementById("upgrade-modal");
    const upgradeModalClose = document.getElementById("upgrade-modal-close");

        // --- Guides / experiences (local tips) ---
    const guideModal = document.getElementById("guide-modal");
    const guideModalClose = document.getElementById("guide-modal-close");
    const guideModalTitle = document.getElementById("guide-modal-title");
    const guideModalBody = document.getElementById("guide-modal-body");
    const guideModalImage = document.getElementById("guide-modal-image");
    const guideCards = document.querySelectorAll(".guide-card");
    const guideFilters = document.querySelectorAll(".guide-filter");

    const guidesState = {
      loaded: false,
      loading: false,
      guides: [],
      activeFilter: "all",
    };

     function createGuideCard(guide) {
      const card = document.createElement("article");
      card.className =
        "guide-card bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden cursor-pointer transition hover:border-emerald-400/70 hover:shadow-lg";
      card.dataset.guideId = guide.id;
      card.dataset.tags = (guide.tags || []).join(",");

      // Featured ones can span 2 cols on larger screens
      if (guide.is_featured) {
        card.classList.add("sm:col-span-2");
      }

      const imageUrl =
        guide.image_url ||
        "{{ experiences_hero_url or hero_image_url or default_image_url }}";

      card.innerHTML = `
        <div class="${guide.is_featured ? "h-32" : "h-24"} relative bg-slate-800">
          <img src="${imageUrl}" alt="${guide.title || ""}" class="w-full h-full object-cover">
          ${
            guide.is_featured
              ? '<div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-black/40 to-transparent"></div>'
              : ""
          }
        </div>
        <div class="p-3 space-y-1">
          <h3 class="text-sm font-semibold">${guide.title || ""}</h3>
          <p class="text-[11px] text-slate-300 line-clamp-2">
            ${guide.short_description || ""}
          </p>
        </div>
      `;

      card.addEventListener("click", () => openGuideModalFromGuide(guide));
      return card;
    }

        function openGuideModalFromGuide(guide) {
      if (!guideModal) return;
      if (guideModalTitle) guideModalTitle.textContent = guide.title || "";
      if (guideModalBody) guideModalBody.textContent = guide.long_description || guide.short_description || "";

      const imageUrl =
        guide.image_url ||
        "{{ experiences_hero_url or hero_image_url or default_image_url }}";
      if (guideModalImage) guideModalImage.src = imageUrl;

      guideModal.classList.remove("hidden");
      guideModal.classList.add("flex");
    }

    function closeGuideModal() {
      if (!guideModal) return;
      guideModal.classList.add("hidden");
      guideModal.classList.remove("flex");
    }

    if (guideModalClose) {
      guideModalClose.addEventListener("click", (e) => {
        e.stopPropagation();
        closeGuideModal();
      });
    }

    if (guideModal) {
      guideModal.addEventListener("click", (e) => {
        if (e.target === guideModal) closeGuideModal();
      });
    }

        function buildGuideFiltersFromGuides(guides) {
      if (!guidesFiltersContainer) return;

      // Collect unique tags
      const tagSet = new Set();
      guides.forEach((g) => {
        (g.tags || []).forEach((t) => {
          if (t) tagSet.add(String(t).trim().toLowerCase());
        });
      });

      // Clear existing
      guidesFiltersContainer.innerHTML = "";

      // Always add "All"
      const allBtn = document.createElement("button");
      allBtn.type = "button";
      allBtn.textContent = "All";
      allBtn.dataset.filter = "all";
      allBtn.className =
        "guide-filter whitespace-nowrap px-3 py-1 rounded-full border border-slate-600/70 bg-slate-50 text-slate-900 font-medium";
      guidesFiltersContainer.appendChild(allBtn);

      // Add one chip per tag
      Array.from(tagSet)
        .sort()
        .forEach((tag) => {
          const label = tag.charAt(0).toUpperCase() + tag.slice(1);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.dataset.filter = tag;
          btn.textContent = label;
          btn.className =
            "guide-filter whitespace-nowrap px-3 py-1 rounded-full border border-slate-700/60 bg-transparent text-slate-300";
          guidesFiltersContainer.appendChild(btn);
        });

      // Wire click handlers
      const filterButtons = guidesFiltersContainer.querySelectorAll(".guide-filter");
      filterButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const filter = btn.dataset.filter || "all";
          guidesState.activeFilter = filter;

          // visual state
          filterButtons.forEach((b) => {
            b.classList.remove("bg-slate-50", "text-slate-900");
            b.classList.remove("bg-slate-900/80", "text-slate-100");
            b.classList.add("bg-transparent", "text-slate-300");
          });
          btn.classList.remove("bg-transparent", "text-slate-300");
          btn.classList.add("bg-slate-50", "text-slate-900");

          renderGuidesGrid();
        });
      });
    }


    function renderGuidesGrid() {
      if (!guidesGrid) return;

      guidesGrid.innerHTML = "";

      const filter = (guidesState.activeFilter || "all").toLowerCase();
      const filtered = guidesState.guides.filter((g) => {
        if (filter === "all") return true;
        const tags = (g.tags || []).map((t) => String(t).toLowerCase());
        return tags.includes(filter);
      });

      if (filtered.length === 0) {
        if (guidesEmptyState) guidesEmptyState.classList.remove("hidden");
        return;
      } else if (guidesEmptyState) {
        guidesEmptyState.classList.add("hidden");
      }

      filtered
        .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
        .forEach((guide) => {
          const card = createGuideCard(guide);
          guidesGrid.appendChild(card);
        });
    }

        async function loadGuidesIfNeeded() {
      if (guidesState.loaded || guidesState.loading) return;
      guidesState.loading = true;

      try {
        const res = await fetch(`/properties/${window.PROPERTY_ID}/guides`);
        if (!res.ok) throw new Error("Failed to load guides");
        const data = await res.json();

        const guides = Array.isArray(data.guides) ? data.guides : [];

        // Normalize tags to arrays
        guides.forEach((g) => {
          if (typeof g.tags === "string") {
            g.tags = g.tags
              .split(",")
              .map((t) => t.trim())
              .filter(Boolean);
          } else if (!Array.isArray(g.tags)) {
            g.tags = [];
          }
        });

        guidesState.guides = guides;
        guidesState.loaded = true;

        if (!guides.length && guidesEmptyState) {
          guidesEmptyState.classList.remove("hidden");
        }

        if (guides.length) {
          buildGuideFiltersFromGuides(guides);
          renderGuidesGrid();
        }
      } catch (err) {
        console.error("Error loading guides:", err);
        if (guidesEmptyState) {
          guidesEmptyState.textContent =
            "We couldn‚Äôt load guides right now. Please try again in a moment or ask Sandy for local tips.";
          guidesEmptyState.classList.remove("hidden");
        }
      } finally {
        guidesState.loading = false;
      }
    }



    function openGuideModal(card) {
      if (!guideModal || !card) return;

      const title = card.getAttribute("data-guide-title") || "";
      const body = card.getAttribute("data-guide-body") || "";
      const img = card.getAttribute("data-guide-image");

      if (guideModalTitle) guideModalTitle.textContent = title;
      if (guideModalBody) guideModalBody.textContent = body;
      if (guideModalImage && img) guideModalImage.src = img;

      guideModal.classList.remove("hidden");
      guideModal.classList.add("flex");
    }

    function closeGuideModal() {
      if (!guideModal) return;
      guideModal.classList.add("hidden");
      guideModal.classList.remove("flex");
    }

    // Attach click listeners to guide cards
    guideCards.forEach((card) => {
      card.addEventListener("click", () => openGuideModal(card));
    });

    // Close actions
    if (guideModalClose) {
      guideModalClose.addEventListener("click", (e) => {
        e.stopPropagation();
        closeGuideModal();
      });
    }

    if (guideModal) {
      guideModal.addEventListener("click", (e) => {
        // click on backdrop closes; clicks inside the panel do not
        if (e.target === guideModal) {
          closeGuideModal();
        }
      });
    }

    // Guide filters (chips)
    function applyGuideFilter(filter) {
      const normalized = (filter || "all").toLowerCase();

      guideCards.forEach((card) => {
        const tagsRaw = card.getAttribute("data-guide-tags") || "";
        const tags = tagsRaw.split(",").map((t) => t.trim().toLowerCase()).filter(Boolean);

        if (normalized === "all" || tags.includes(normalized)) {
          card.classList.remove("hidden");
        } else {
          card.classList.add("hidden");
        }
      });
    }

    guideFilters.forEach((btn) => {
      btn.addEventListener("click", () => {
        const filter = btn.getAttribute("data-filter") || "all";

        // visual active state
        guideFilters.forEach((b) => {
          b.classList.remove("bg-slate-50", "text-slate-900");
          b.classList.remove("bg-slate-900/80", "text-slate-100");
          b.classList.add("bg-transparent", "text-slate-300");
        });

        btn.classList.remove("bg-transparent", "text-slate-300");
        btn.classList.add("bg-slate-50", "text-slate-900");

        applyGuideFilter(filter);
      });
    });

    // default: show all
    applyGuideFilter("all");


    // OPEN modal (when an upgrade is clicked)
    function openUpgradeModal() {
      upgradeModal.classList.remove("hidden");
      upgradeModal.classList.add("flex");
    }

    // CLOSE modal
    function closeUpgradeModal() {
      upgradeModal.classList.add("hidden");
      upgradeModal.classList.remove("flex");
    }

    // X BUTTON closes modal
    if (upgradeModalClose) {
      upgradeModalClose.addEventListener("click", closeUpgradeModal);
    }

    // Clicking outside closes modal
    if (upgradeModal) {
      upgradeModal.addEventListener("click", (e) => {
        if (e.target === upgradeModal) closeUpgradeModal();
      });
    }

    // --- Global state ---
    let isUnlocked = window.INITIAL_VERIFIED === "true";

    // TEMP: force unlocked during UI testing //REMOVE when live
    //isUnlocked = true;

    let lastUnlockCode = null;
    let currentSessionId = null;
    let guestName = null;
    let arrivalDate = null;
    let departureDate = null;

    // üîπ helper: keep guest name in sync across all places we show it
    function updateGuestNameInUI(name) {
      const nameEls = document.querySelectorAll("#guest-name-span, #guest-name-span-guides");
      nameEls.forEach((el) => {
        el.textContent = name;
      });
    }

    const GUEST_STATE_KEY = `guest_state_${window.PROPERTY_ID}`;

    function saveGuestState() {
      try {
        const state = {
          isUnlocked,
          lastUnlockCode,
          sessionId: currentSessionId,
          guestName,
          arrivalDate,
          departureDate,
        };
        window.localStorage.setItem(GUEST_STATE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("Unable to save guest state:", e);
      }
    }

    function loadGuestState() {
      try {
        const raw = window.localStorage.getItem(GUEST_STATE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Unable to load guest state:", e);
        return null;
      }
    }

    const storedState = loadGuestState();
    if (storedState) {
      if (!isUnlocked && storedState.isUnlocked) {
        isUnlocked = true;
      }
      if (storedState.lastUnlockCode) {
        lastUnlockCode = storedState.lastUnlockCode;
      }
      if (storedState.sessionId) {
        currentSessionId = storedState.sessionId;
      }

      if (storedState.guestName) {
        guestName = storedState.guestName;
        updateGuestNameInUI(guestName);
      }
      if (storedState.arrivalDate) {
        arrivalDate = storedState.arrivalDate;
        const arrEl = document.getElementById("arrival-date-span");
        if (arrEl) arrEl.textContent = arrivalDate;
      }
      if (storedState.departureDate) {
        departureDate = storedState.departureDate;
        const depEl = document.getElementById("departure-date-span");
        if (depEl) depEl.textContent = departureDate;
      }
    }

    function updateHomeState() {
      if (isUnlocked) {
        if (homeLogin) homeLogin.classList.add("hidden");
        if (homeStay) homeStay.classList.remove("hidden");
      } else {
        if (homeLogin) homeLogin.classList.remove("hidden");
        if (homeStay) homeStay.classList.add("hidden");
      }
    }

    let chatHasWelcome = false;

    function showScreen(name) {
      // Show / hide screens
      Object.entries(screens).forEach(([key, el]) => {
        if (!el) return;
        if (key === name) el.classList.remove("hidden");
        else el.classList.add("hidden");
      });

      // Toggle body class for chat-specific styling (top nav, hamburger, etc.)
      if (name === "chat") {
        document.body.classList.add("chat-screen");
      } else {
        document.body.classList.remove("chat-screen");
      }

      if (name === "experiences") {
        loadGuidesIfNeeded();
      }

      // After switching screens, update logo accordingly
      if (name === "chat") {
        swapLogoWithFade(LOGO_BLACK);      // chat = black logo
      } else if (!isMenuOpen) {
        // Only switch back if the menu is not covering it
        swapLogoWithFade(LOGO_WHITE);      // home/experiences = white logo
      }

      // Chat-specific behavior
      if (name === "chat") {
        if (
          window.SANDY_LIVE === "true" &&
          chatBox &&
          !chatHasWelcome &&
          chatBox.children.length === 0
        ) {
          const intro = guestName
            ? `Hi ${guestName}! I‚Äôm Sandy, your stay assistant for ${window.PROPERTY_NAME}. You can ask about check-in, WiFi, parking, or local tips.`
            : `Hi there! I‚Äôm Sandy, your stay assistant for ${window.PROPERTY_NAME}. Ask me anything about check-in, WiFi, parking, or local recommendations.`;

          renderMessage(intro, "bot");
          chatHasWelcome = true;
        }

        scrollChatToBottom();
      }

    }

    // --- Upgrade cards ‚Üí detail screen + purchase ---
    const upgradeCards = document.querySelectorAll(".upgrade-card");
    const upgradeDetailTitle = document.getElementById("upgrade-detail-title");
    const upgradeDetailBody = document.getElementById("upgrade-detail-body");
    const upgradeDetailName = document.getElementById("upgrade-detail-name");
    const upgradeDetailPrice = document.getElementById("upgrade-detail-price");
    const upgradeDetailPriceBottom = document.getElementById("upgrade-detail-price-bottom");
    //const upgradeDetailClose = document.getElementById("upgrade-detail-close");
    const upgradeDetailPurchase = document.getElementById("upgrade-detail-purchase");

    let currentUpgradeId = null;

    upgradeCards.forEach((card) => {
      card.addEventListener("click", () => {
        const id = card.getAttribute("data-upgrade-id");
        const title = card.getAttribute("data-upgrade-title") || "";
        const price = card.getAttribute("data-upgrade-price") || "";
        const longEl = card.querySelector(".upgrade-long");
        const longText = longEl ? longEl.textContent.trim() : "";

        currentUpgradeId = id;

        if (upgradeDetailTitle) upgradeDetailTitle.textContent = title;
        if (upgradeDetailName) upgradeDetailName.textContent = title;
        if (upgradeDetailBody) upgradeDetailBody.textContent = longText;
        if (upgradeDetailPrice) upgradeDetailPrice.textContent = price;
        if (upgradeDetailPriceBottom)
          upgradeDetailPriceBottom.textContent = `${price} ‚Äì Purchase`;

        //showScreen("upgradeDetail");
        openUpgradeModal();
      });
    });

    if (upgradeDetailPurchase) {
      upgradeDetailPurchase.addEventListener("click", async () => {
        if (!currentUpgradeId) return;
        try {
          await purchaseUpgrade(currentUpgradeId, null);
        } catch (e) {
          console.error(e);
          alert("Something went wrong starting checkout.");
        }
      });
    }

    // --- Stripe checkout for upgrades ---
    async function purchaseUpgrade(upgradeId, guestEmail) {
      const res = await fetch(
        `/properties/${window.PROPERTY_ID}/upgrades/${upgradeId}/checkout`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ guest_email: guestEmail || null }),
        }
      );

      const data = await res.json();
      if (data.checkout_url) {
        window.location.href = data.checkout_url;
      } else {
        alert(data.detail || "Unable to start checkout, please try again.");
      }
    }

    // --- Top bar sliding menu nav ---
    const topBar = document.getElementById("top-bar");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuToggle = document.getElementById("menu-toggle");
    const logoImg = document.getElementById("logo-img");   // üëà new single logo
    const menuLinks = document.querySelectorAll("[data-menu-screen]");
    let isMenuOpen = false;

    // match Tailwind duration-400 on the panel
    const MOBILE_MENU_SLIDE_DURATION = 400;  // ms
    const MOBILE_MENU_LINKS_FADE_DURATION = 250; // ms

    // Fade-out ‚Üí swap image ‚Üí fade-in
    function swapLogoWithFade(newSrc) {
      if (!logoImg) return;

      const currentSrc = logoImg.getAttribute("src");
      // If we're already on this logo (e.g. black ‚Üí black), do nothing
      if (currentSrc === newSrc) return;

      // fade out
      logoImg.style.opacity = "0";

      // after fade-out, swap src, then fade back in
      setTimeout(() => {
        logoImg.src = newSrc;
        logoImg.style.opacity = "1";
      }, 120); // slightly less than CSS transition (180ms)
    }

    function openMenu() {
      if (!mobileMenu) return;
      isMenuOpen = true;

      // Reset any closing state
      mobileMenu.classList.remove("fade-out");

      // Slide panel down from top
      mobileMenu.classList.remove("-translate-y-full", "pointer-events-none");
      mobileMenu.classList.add("translate-y-0");

      // Change top bar to light theme
      topBar?.classList.remove("bg-transparent", "text-white");
      topBar?.classList.add("bg-slate-50", "text-slate-900");

      // fade to dark logo
      swapLogoWithFade(LOGO_BLACK);

      // Animate hamburger ‚Üí X
      menuToggle?.classList.add("menu-toggle-open");

      document.body.classList.add("menu-open");

      // After panel finishes sliding, fade/slide in the links
      setTimeout(() => {
        if (isMenuOpen && mobileMenu) {
          mobileMenu.classList.add("show-links");
        }
      }, MOBILE_MENU_SLIDE_DURATION);
    }

    function closeMenu() {
      if (!mobileMenu) return;
      isMenuOpen = false;

      // Start fade-out on menu links ONLY (no slide)
      mobileMenu.classList.add("fade-out");
      mobileMenu.classList.remove("show-links");

      // Change top bar back to dark while content is fading
      topBar?.classList.add("bg-transparent", "text-white");
      topBar?.classList.remove("bg-slate-50", "text-slate-900");

      // fade back based on current screen
      if (document.body.classList.contains("chat-screen")) {
        swapLogoWithFade(LOGO_BLACK);   // stay black on chat
      } else {
        swapLogoWithFade(LOGO_WHITE);   // white elsewhere
      }

      // Animate X ‚Üí hamburger
      menuToggle?.classList.remove("menu-toggle-open");

      document.body.classList.remove("menu-open");

      // AFTER links have faded out, slide the panel back up
      setTimeout(() => {
        if (!isMenuOpen && mobileMenu) {
          mobileMenu.classList.add("-translate-y-full", "pointer-events-none");
          mobileMenu.classList.remove("translate-y-0", "fade-out");
        }
      }, MOBILE_MENU_LINKS_FADE_DURATION);
    }

    menuToggle?.addEventListener("click", () => {
      if (isMenuOpen) closeMenu();
      else openMenu();
    });

    // Clicking links changes screen + closes menu
    menuLinks.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-menu-screen");
        if (!target) return;

        if (!isUnlocked && target !== "home") {
          const err = document.getElementById("unlock-error");
          if (err) {
            err.textContent =
              "Please unlock your stay first with the last 4 digits of your booking phone number.";
          }
          showScreen("home");
        } else {
          showScreen(target);
        }

        closeMenu();
      });
    });

    function scrollChatToBottom() {
      // Only scroll when the chat screen is actually visible
      if (!isChatVisible()) return;

      requestAnimationFrame(() => {
        const docEl = document.documentElement;
        const body = document.body;

        const fullHeight = Math.max(
          docEl.scrollHeight,
          body.scrollHeight,
          docEl.offsetHeight,
          body.offsetHeight
        );

        window.scrollTo({
          top: fullHeight,
          behavior: "auto",
        });
      });
    }

    // Legacy bottom nav (safe if empty)
    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-screen");
        if (!target) return;

        if (!isUnlocked && target !== "home") {
          const err = document.getElementById("unlock-error");
          if (err) {
            err.textContent =
              "Please unlock your stay first with the last 4 digits of your booking phone number.";
          }
          showScreen("home");
          return;
        }
        showScreen(target);
      });
    });

    updateHomeState();
    showScreen("home");

    // Language
    const langSelect = document.getElementById("language-select");
    function getSelectedLanguage() {
      if (!langSelect) return "auto";
      return langSelect.value || "auto";
    }
    if (langSelect) {
      const saved = window.localStorage.getItem("guest_language");
      if (saved) {
        langSelect.value = saved;
      }
      langSelect.addEventListener("change", () => {
        window.localStorage.setItem("guest_language", langSelect.value);
      });
    }

    // Unlock flow
    const unlockBtn = document.getElementById("unlock-button");
    const unlockCodeInput = document.getElementById("unlock-code");
    const unlockError = document.getElementById("unlock-error");
    const unlockSpinner = document.getElementById("unlock-spinner");

    if (unlockCodeInput) {
      unlockCodeInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          attemptUnlock();
        }
      });
    }

    if (unlockBtn) {
      unlockBtn.addEventListener("click", attemptUnlock);
    }

    async function attemptUnlock() {
      const code = (unlockCodeInput?.value || "").trim();
      if (unlockError) unlockError.textContent = "";

      if (!/^\d{4}$/.test(code)) {
        if (unlockError) unlockError.textContent = "Please enter exactly 4 digits.";
        return;
      }

      if (unlockBtn) unlockBtn.disabled = true;
      unlockSpinner?.classList.remove("hidden");

      try {
        const res = await fetch(`/guest/${window.PROPERTY_ID}/verify-json`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          if (unlockError) {
            unlockError.textContent =
              data.error ||
              "We couldn‚Äôt verify that code. Please double-check or contact your host.";
          }
          return;
        }

        isUnlocked = true;
        lastUnlockCode = code;
        if (unlockError) unlockError.textContent = "";
        if (unlockCodeInput) unlockCodeInput.value = "";

        try {
          if (data.guest_name) {
            guestName = data.guest_name;
            updateGuestNameInUI(guestName);
          }
          if (data.arrival_date) {
            arrivalDate = data.arrival_date;
            const arrEl = document.getElementById("arrival-date-span");
            if (arrEl) arrEl.textContent = arrivalDate;
          }
          if (data.departure_date) {
            departureDate = data.departure_date;
            const depEl = document.getElementById("departure-date-span");
            if (depEl) depEl.textContent = departureDate;
          }
        } catch (e) {
          console.warn("Error applying PMS guest info to UI:", e);
        }

        saveGuestState();
        updateHomeState();
        showScreen("home");
      } catch (err) {
        console.error(err);
        if (unlockError) {
          unlockError.textContent =
            "Something went wrong while verifying. Please try again.";
        }
      } finally {
        if (unlockBtn) unlockBtn.disabled = false;
        unlockSpinner?.classList.add("hidden");
      }
    }

    // Check-in modal
    const checkinButton = document.getElementById("checkin-button");
    const upgradesButton = document.getElementById("upgrades-button");
    const checkinModal = document.getElementById("checkin-modal");
    const checkinClose = document.getElementById("checkin-close");
    const checkinCodeEl = document.getElementById("checkin-code");

    function openCheckinModal() {
      if (!checkinModal) return;
      const code = lastUnlockCode || "----";
      if (checkinCodeEl) checkinCodeEl.textContent = code;
      checkinModal.classList.remove("hidden");
      checkinModal.classList.add("flex");
    }

    function closeCheckinModal() {
      if (!checkinModal) return;
      checkinModal.classList.add("hidden");
      checkinModal.classList.remove("flex");
    }

    if (checkinButton) {
      checkinButton.addEventListener("click", openCheckinModal);
    }
    if (checkinClose) {
      checkinClose.addEventListener("click", closeCheckinModal);
    }
    if (checkinModal) {
      checkinModal.addEventListener("click", (e) => {
        if (e.target === checkinModal) closeCheckinModal();
      });
    }

    // Upgrades screen shortcut (legacy button)
    if (upgradesButton) {
      upgradesButton.addEventListener("click", () => {
        if (!isUnlocked) return;
        showScreen("upgrades");
      });
    }

    // Chat logic
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const chatPlus = document.querySelector(".chat-plus");

    // Elements that sit on top of the chat (fixed at bottom)
    const chatInputBar = document.querySelector(".chat-input-bar");
    const bottomNav = document.querySelector('nav[role="navigation"]');

    if (window.SANDY_LIVE === "false") {
      if (chatBox) {
        renderMessage(
          "Sandy is currently offline for this property üåô\n\n" +
          "For urgent questions, please contact your host directly via your booking app or email.",
          "bot"
        );
      }
      if (chatInput) {
        chatInput.disabled = true;
        chatInput.placeholder = "Sandy is offline for this property.";
      }
      if (chatSend) chatSend.disabled = true;
      if (chatPlus) chatPlus.disabled = true;
    }

    function formatTime(date) {
      let hours = date.getHours();
      const minutes = date.getMinutes().toString().padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      if (hours === 0) hours = 12;
      return `${hours.toString().padStart(2, "0")}:${minutes} ${ampm}`;
    }

    function formatMessage(text) {
      let escaped = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      escaped = escaped.replace(
        /(https:\/\/www\.google\.com\/maps[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer" class="gmap-link">üìç View on Google Maps</a>'
      );
      escaped = escaped.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );

      return escaped.replace(/\n/g, "<br>");
    }

    function renderMessage(text, sender) {
      if (!chatBox) return;

      const isUser = sender === "user";
      const ts = formatTime(new Date());

      const row = document.createElement("div");
      row.className = "msg " + (isUser ? "user" : "bot");

      // Avatar (Sandy only)
      let avatar = null;
      if (!isUser) {
        avatar = document.createElement("div");
        avatar.className = "avatar avatar-sandy";
      }

      const column = document.createElement("div");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<div class="message-text">${formatMessage(text)}</div>`;

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = ts;

      column.appendChild(time);
      column.appendChild(bubble);

      if (isUser) {
        // user: bubble only
        row.appendChild(column);
      } else {
        // bot: avatar + bubble
        row.appendChild(avatar);
        row.appendChild(column);
      }

      chatBox.appendChild(row);

      // only scroll if the chat screen is actually visible
      scrollChatToBottom();
    }

    function addTyping() {
      if (!chatBox || document.getElementById("typing-indicator")) return;

      const row = document.createElement("div");
      row.id = "typing-indicator";
      row.className = "msg bot";

      const avatar = document.createElement("div");
      avatar.className = "avatar avatar-sandy";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `
        <span class="typing-dots">
          <span> </span><span> </span><span> </span>
        </span>
      `;

      const column = document.createElement("div");
      column.appendChild(bubble);

      row.appendChild(avatar);
      row.appendChild(column);

      chatBox.appendChild(row);
      scrollChatToBottom();
    }

    function removeTyping() {
      const el = document.getElementById("typing-indicator");
      if (el) el.remove();
    }

    async function sendChat() {
      const text = (chatInput?.value || "").trim();
      if (!text) return;

      if (window.SANDY_LIVE === "false") {
        renderMessage(
          "Sandy is currently offline for this property. Please contact your host directly. üôè",
          "bot"
        );
        return;
      }

      renderMessage(text, "user");
      if (chatInput) chatInput.value = "";
      addTyping();

      try {
        const body = {
          message: text,
          session_id: currentSessionId,
          language: getSelectedLanguage(),
        };

        const res = await fetch(`/properties/${window.PROPERTY_ID}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        removeTyping();

        if (data.session_id) {
          currentSessionId = data.session_id;
          saveGuestState();
        }

        if (data.error) {
          renderMessage(data.error, "bot");
        } else {
          renderMessage(
            data.response || "Hmm, I didn‚Äôt catch that ‚Äî could you try again? üå¥",
            "bot"
          );
        }
      } catch (err) {
        console.error(err);
        removeTyping();
        renderMessage(
          "Oops! Something went wrong. Please try again in a moment. üêö",
          "bot"
        );
      }
    }

    if (chatSend && chatInput) {
      chatSend.addEventListener("click", sendChat);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });
    }

    // Logout modal wiring
    const logoutButton = document.getElementById("logout-button");
    const logoutModal = document.getElementById("logout-modal");
    const logoutClose = document.getElementById("logout-close");
    const logoutCancel = document.getElementById("logout-cancel");
    const logoutConfirm = document.getElementById("logout-confirm");

    function openLogoutModal() {
      if (logoutModal) {
        logoutModal.classList.remove("hidden");
        logoutModal.classList.add("flex");
      }
    }

    function closeLogoutModal() {
      if (logoutModal) {
        logoutModal.classList.add("hidden");
        logoutModal.classList.remove("flex");
      }
    }

    if (logoutButton) {
      logoutButton.addEventListener("click", (e) => {
        e.preventDefault();
        openLogoutModal();
      });
    }

    if (logoutClose) {
      logoutClose.addEventListener("click", (e) => {
        e.preventDefault();
        closeLogoutModal();
      });
    }

    if (logoutCancel) {
      logoutCancel.addEventListener("click", (e) => {
        e.preventDefault();
        closeLogoutModal();
      });
    }

    if (logoutConfirm) {
      logoutConfirm.addEventListener("click", (e) => {
        e.preventDefault();
        try {
          window.localStorage.removeItem(GUEST_STATE_KEY);
        } catch (err) {
          console.warn("Unable to clear guest state:", err);
        }
        window.location.href = "/auth/logout";
      });
    }

    if (logoutModal) {
      logoutModal.addEventListener("click", (e) => {
        if (e.target === logoutModal) {
          closeLogoutModal();
        }
      });
    }
  });
</script>


</body>

</html>
