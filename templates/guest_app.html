<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>{{ property_name }} ‚Äì Guest Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / icons -->
  <link rel="manifest" href="/manifest/{{ property_id }}.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="theme-color" content="#020617" />
  <link rel="apple-touch-icon" href="/static/icons/app-icon-192.png" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,
    body {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 0.95rem;
      overflow-x: hidden;
      /* only block horizontal scroll */
    }


    * {
      box-sizing: border-box;
    }

    body.menu-open {
      overflow: hidden;
    }


    /* === Hamburger / X toggle for #menu-toggle === */
    #menu-toggle {
      position: relative;
    }

    /* Top + bottom bars */
    #menu-toggle::before,
    #menu-toggle::after {
      content: "";
      position: absolute;
      left: 50%;
      width: 24px;
      height: 2px;
      border-radius: 999px;
      background: #FFFFFF;
      /* closed: white bars on blue */
      transform: translateX(-50%);
      transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
    }

    /* Top bar (hamburger) */
    #menu-toggle::before {
      transform: translate(-50%, -6px);
    }

    /* Bottom bar (hamburger) */
    #menu-toggle::after {
      transform: translate(-50%, 6px);
    }

    /* Middle bar */
    #menu-toggle .menu-toggle-middle {
      width: 24px;
      height: 2px;
      border-radius: 999px;
      background: #FFFFFF !important; /* black */
      transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
    }

    /* === OPEN STATE transforms hamburger into "X" === */
    #menu-toggle.menu-toggle-open::before {
      transform: translate(-50%, 0) rotate(45deg);
    }

    #menu-toggle.menu-toggle-open::after {
      transform: translate(-50%, 0) rotate(-45deg);
    }

    #menu-toggle.menu-toggle-open .menu-toggle-middle {
      opacity: 0;
      transform: scaleX(0.5);
    }

 /* When menu is open ‚Üí switch to white (on black menu) */
#menu-toggle.menu-toggle-open::before,
#menu-toggle.menu-toggle-open::after,
#menu-toggle.menu-toggle-open .menu-toggle-middle {
  background: #FFFFFF !important; /* white */
}




    .menu-toggle {
      position: relative;
    }

    /* Top + bottom bars */
    .menu-toggle::before,
    .menu-toggle::after {
      content: "";
      position: absolute;
      left: 50%;
      width: 24px;
      height: 2px;
      background: #ffffff;
      border-radius: 999px;
      transform: translateX(-50%);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* Top bar (default) */
    .menu-toggle::before {
      transform: translate(-50%, -6px);
    }

    /* Bottom bar (default) */
    .menu-toggle::after {
      transform: translate(-50%, 6px);
    }

    /* Middle bar */
    .menu-toggle-middle {
      width: 24px;
      height: 2px;
      background: #ffffff;
      border-radius: 999px;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    /* === OPEN STATE === */
    .menu-toggle.menu-toggle-open::before {
      transform: translate(-50%, 0) rotate(45deg);
    }

    .menu-toggle.menu-toggle-open::after {
      transform: translate(-50%, 0) rotate(-45deg);
    }

    .menu-toggle.menu-toggle-open .menu-toggle-middle {
      opacity: 0;
      transform: scaleX(0.5);
    }

    /* Smooth fade on logo when we swap pngs */
#logo-img {
  transition: opacity 180ms ease;
}

    /* Keep Tailwind layout; only tweak visuals
nav[role="navigation"] {
  height: 120px !important; 
}
 */
    /* Make the nav buttons visually clean but DO NOT touch layout */
    nav .nav-item {
      background: none !important;
      border: none !important;
      padding: 0;
      margin: 0;
      box-shadow: none !important;
    }

    /* Icon images */
    .nav-icon-img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      opacity: 0.65;
      transition: opacity 0.25s ease;
    }

    /* Hover + active: just change opacity, nothing else */
    nav .nav-item:hover .nav-icon-img,
    nav .nav-item[aria-current="page"] .nav-icon-img {
      opacity: 1;
    }



    /* REMOVE any unwanted Tailwind classes JS might apply */
    nav .nav-icon {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      transform: none !important;
      /* stops scale-110 */
    }


    /* OPTIONAL ‚Äî dim inactive icons (if JS toggles text-slate-400/50) */
    .nav-item.text-slate-400 .nav-icon-img {
      opacity: 0.6;
    }

    .nav-item.text-slate-50 .nav-icon-img {
      opacity: 1;
    }



    /* header labels (Arrival, Check-in, WiFi Network, etc.) */
    .detail-label {
      font-size: 0.65rem !important;
      font-weight: 700 !important;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgb(148 163 184);
      /* slate-400 */
    }

    .detail-label-results {
      font-size: 1rem !important;
      font-weight: 600 !important;
      text-transform: uppercase;
      /* letter-spacing: 0.05em;*/
      color: rgb(255 255 255);
      /* slate-400 */
    }

    /* Sandy avatar photo */
    .avatar-sandy {
      background-image: url("/static/img/sandy.png");
      background-size: cover;
      background-position: center;
      background-color: transparent;
    }


    #chat-box {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }


    .msg {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0.75rem;
      animation: fadeInUp 0.35s ease-out;
      animation-fill-mode: both;
      scroll-margin-bottom: 7rem;
    }


    .msg.user {
      justify-content: flex-end;
    }

    /* Column that wraps bubble + timestamp for user messages */
    .msg.user>div {
      max-width: 70%;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-end;
      /* bubble & timestamp align to right together */

    }

    /* Column that wraps bubble + timestamp for bot messages */
    .msg.bot>div:last-child {
      max-width: 70%;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
    }


    .msg.bot {
      justify-content: flex-start;
    }



    .bubble {
      display: inline-block;
      /* hug contents */
      padding: 0.6rem 1rem;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      max-width: 100%;
      /* let parent control width */
      font-size: 0.95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }


    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 999px; /* full circle */
      overflow: hidden;     /* prevents distortion */
      /* rounded square
      margin: 0 0.5rem;
      background-size: cover;
      background-position: center;
      flex-shrink: 0; */
    }


    .msg.bot .avatar {
      /*background-color: #22c55e;*/
      color: #022c22;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 1.25rem; /* adjust to taste */
      margin-right: 0.50rem; /* 12px */
    }

    /* Timestamp above bubble */
    .timestamp {
      font-size: 0.65rem;
      color: #64748b;
      margin-bottom: 0.25rem;  /* spacing below timestamp */
      margin-top: 0;           /* remove old spacing */
    }


    /* Bot timestamps align left under the bubble */
    .msg.bot .timestamp {
      text-align: left;
      align-self: flex-start;
      padding-left: 4px;
    }

    /* User timestamps align right, directly under user bubble */
    .msg.user .timestamp {
      text-align: right;
      align-self: flex-end;
      padding-right: 4px;
    }


    .message-text p {
      margin: 0.5rem 0;
    }

    .message-text ul {
      margin: 0.5rem 0;
      padding-left: 1.2rem;
    }

    .message-text li {
      margin-bottom: 0.3rem;
    }

    .message-text a {
      color: #22c55e;
      text-decoration: none;
      word-break: break-word;
    }

    .message-text a:hover {
      text-decoration: underline;
    }

    .message-text strong {
      font-weight: 600;
    }

    .message-text em {
      font-style: italic;
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      transform: translateY(-2px);
      /* raise it */
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      margin: 0 3px;
      background-color: #022c22;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 1s infinite ease-in-out;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.3;
        transform: scale(0.7);
      }

      50% {
        opacity: 1;
        transform: scale(1);
      }
    }



    .dots-anim {
      display: inline-block;
    }

    .dots-anim span {
      font-size: 1.25rem;
      animation: blink 1.4s infinite both;
      opacity: 0.3;
    }

    .dots-anim span:nth-child(1) {
      animation-delay: 0s;
    }

    .dots-anim span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .dots-anim span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0% {
        opacity: 0.3;
      }

      20% {
        opacity: 1;
      }

      100% {
        opacity: 0.3;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }


    
/* TOP layer: chrome (logo + hamburger / X) */
#top-bar-chrome {
  z-index: 100; /* higher than everything else */
}

/* Menu: full-screen overlay, but under the chrome */
#mobile-menu {
  z-index: 200 !important; /* above modals (z-[80]) but below top-bar-chrome */
}

/* no special z-index needed on menu buttons */
#mobile-menu button {
  z-index: 250 !important;
}


    .chat-input-bar {
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0rem;
      /* above nav */
      z-index: 30;
    }

    /* Default hidden state */
    #mobile-menu .mobile-menu-content {
      opacity: 0;
      transform: translateY(-12px);
      transition:
        opacity .3s cubic-bezier(0.16, 1, 0.3, 1),
        transform .35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Opening animation */
    #mobile-menu.show-links {
      opacity: 1;
    }

    #mobile-menu.show-links .mobile-menu-content {
      opacity: 1;
      transform: translateY(0);
    }

    /* Closing fade-out ONLY */
    #mobile-menu.fade-out .mobile-menu-content {
      opacity: 0;
      transform: translateY(0);
      /* no slide on close */
      transition: opacity .25s ease;
    }

    /* When on chat screen: top bar becomes light grey */
body.chat-screen #top-bar {
  color: #020617 !important;
  /* if you want text on avatar label darker (you already do) */
}

body.chat-screen #top-bar::before {
  content: "";
  position: absolute;
  inset: 0;
  background: #f8fafc;      /* grey strip behind everything */
  z-index: 0;               /* under avatar */
}

    
#top-bar {
  z-index: 20;              /* below menu, below chrome */
}
    
    /* keep your existing color-swap rules for the hamburger */
body.chat-screen #menu-toggle::before,
body.chat-screen #menu-toggle::after,
body.chat-screen #menu-toggle .menu-toggle-middle {
  background: #FFFFFF !important;
}

/* avatar on top of grey bar but under menu */
#chat-header-sandy {
  z-index: 1;
}
    
    /* Switch logos appropriately */
    body.chat-screen #logo-light {
      display: none !important;
    }

    body.chat-screen #logo-dark {
      display: block !important;
    }

    /* Show Sandy header only on chat screen */
    body.chat-screen #chat-header-sandy {
      display: flex;
    }

   

    .chat-input-inner {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      padding: 0.6rem 0.75rem;
    }

    .chat-input-bar input[type="text"] {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      outline: none;
      color: #1f2937;
    }

    .chat-plus {
      background: #0b1120;
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #e5e7eb;
    }

    .send-button {
      background: #22c55e;
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #022c22;
    }

    /* Light mode chat screen */
    #screen-chat {
      color: #1f2937;
      /* DO NOT set display or height here so .hidden can control it */
    }

    #screen-chat>.flex-1 {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }


    .msg.user .bubble {
      background: #e5e7eb;
      color: #111827;
    }

    .msg.bot .bubble {
      background: #22c55e;
      color: #022c22;
    }

  

    .timestamp {
      color: #64748b;
    }

    /* Push chat content below the fixed top bar (h-20 = 5rem) */
body.chat-screen #screen-chat {
  padding-top: 5rem; /* match header height (h-20) */
}

 /* NEW STYLES */

/* Light surfaces for main screens (Home / Guides / Upgrades) */
#screen-home,
#screen-experiences,
#screen-upgrades {
  background: #f5f5f5;
  color: #020617;
}

/* Home card heading + small label */
.home-property-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: #94a3b8;
}

/* Big hero heading on Home / Guides / Upgrades */
.hero-heading {
  font-size: 2rem;
  line-height: 1.2;
  font-weight: 600;
}

/* White ‚Äúpolaroid‚Äù card with image (Home + Upgrades cards) */
.surface-card {
  border-radius: 2rem;
  background: #ffffff;
  box-shadow:
    0 20px 45px rgba(15, 23, 42, 0.16),
    0 0 0 1px rgba(15, 23, 42, 0.04);
}

/* Pill CTA buttons (Door / WiFi / purchase) */
.pill-button {
  border-radius: 999px;
  border-width: 1px;
  padding: 0.9rem 1rem;
  font-size: 0.95rem;
  font-weight: 600;
}

/* Black full-screen menu */
#mobile-menu {
  background: #000000;
  color: #f9fafb;
}

#mobile-menu .mobile-menu-content {
  justify-content: flex-start;
}

#mobile-menu ul li button {
  font-size: 2rem;       /* big menu items */
  font-weight: 600;
}

#mobile-menu .menu-label {
  font-size: 0.7rem;
  letter-spacing: 0.24em;
  text-transform: uppercase;
  color: #9ca3af;
}

#mobile-menu .menu-footer {
  font-size: 0.75rem;
  color: #9ca3af;
}

/* Guide detail full-page layout */
#guide-modal section {
  border-radius: 0;
  max-height: none;
  max-width: 100%;
}

/* Make the guide/upgrades detail screens feel like full pages */
#screen-guide-detail,
#screen-upgrade-detail {
  background: #f5f5f5;
  color: #020617;
}

/* === Beats-style upgrades carousel === */

.upgrades-carousel {
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
    overflow-x: auto;
  overflow-y: hidden;
}
.upgrades-carousel::-webkit-scrollbar {
  display: none;
}

.upgrades-track {
  padding-left: 80px;
  padding-right: 80px;
}

/* PARENT: do NOT clip shadow, give base z-index */
/* PARENT: do NOT clip shadow */
.upgrade-slide {
  position: relative;
  flex: 0 0 auto;
  margin-right: -120px;  /* overlap */
  transform-origin: center center;
  will-change: transform;
  cursor: pointer;
  overflow: visible;      /* don't clip the shadow */
  /* no z-index here; JS will control it */
  transition:
    transform 300ms cubic-bezier(0.22, 0.61, 0.36, 1),
    opacity 250ms ease;
}

/* Active slide is always in front */
.upgrade-slide.is-active { }
.upgrade-slide.is-inactive { }

/* INNER CARD: rounded, clipped, thick border, gets shadow */
.upgrade-card-inner {
  width: 280px;
  height: 360px;
  background: #ffffff;
  border-radius: 32px;
  overflow: hidden;           /* clip image to rounded corners */
  border: 4px solid #ffffff;  /* thick polaroid border */
  transform-origin: center center;
  transition:
    box-shadow 300ms ease,
    transform 300ms cubic-bezier(0.22, 0.61, 0.36, 1),
    opacity 250ms ease;
}


/* Make sure the image itself is clipped nicely */
.upgrade-slide img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Active centered card pops */
.upgrade-slide.is-active .upgrade-card-inner {
  box-shadow: 0 10px 20px rgba(0,0,0,0.35);
  transform: scale(1);
}

/* Inactive cards sit back */
.upgrade-slide.is-inactive .upgrade-card-inner {
  box-shadow: none;
  transform: scale(0.7) translateY(4px);
}

/* Add a white circle behind the X when menu is open */
#menu-toggle.menu-toggle-open {
  background: white !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

#menu-toggle.menu-toggle-open::before,
#menu-toggle.menu-toggle-open::after {
  background: black !important; /* black X on white circle */
}

#menu-toggle.menu-toggle-open .menu-toggle-middle {
  background: black !important;
}

.mobile-menu-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.mobile-menu-content ul {
  margin-top: auto;
  margin-bottom: auto; /* centers vertically */
}

    #upgrades-carousel {
  overflow-y: hidden;
}
  </style>

  <script>
    window.PROPERTY_ID = {{ property_id | tojson }};
    window.PROPERTY_NAME = {{ property_name | tojson }};
    window.SANDY_LIVE = {{ ("true" if is_live else "false") | tojson }};
    window.INITIAL_VERIFIED = {{ ("true" if is_verified else "false") | tojson }};
  </script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 flex flex-col overflow-x-hidden">

  <!-- App shell with shared background image + gradient -->
  <div id="app-shell" class="relative min-h-screen w-full max-w-full flex flex-col overflow-x-hidden"
    style="background-image: url('{{ hero_image_url or default_image_url }}'); background-size: cover; background-position: top;">
    <!-- Gradient overlay -->
    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent pointer-events-none"></div>


    <!-- Foreground content -->
    <div class="relative z-10 flex flex-col min-h-screen">

      <!-- Top header / nav -->
      <header id="app-header" class="relative w-full">

  <!-- BOTTOM LAYER: grey bar + Sandy avatar -->
  <div id="top-bar"
       class="fixed top-0 inset-x-0 h-20 bg-transparent text-white
              transition-colors duration-300">
    <!-- Sandy avatar, centered in the bar -->
    <div id="chat-header-sandy"
         class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2
                hidden flex flex-col items-center pointer-events-none">
      <div class="avatar avatar-sandy shadow"></div>
      <span class="text-xs text-slate-900 mt-1">Sandy</span>
    </div>
  </div>

  <!-- TOP LAYER: logo + hamburger, always above menu + bar -->
  <div id="top-bar-chrome"
       class="fixed top-0 inset-x-0 h-20 z-[70]">
    <div id="top-bar-inner"
         class="max-w-3xl mx-auto flex items-center justify-between h-full px-5">
      <!-- Logo -->
      <a href="#" class="flex items-center gap-2">
        <!-- default: white logo -->
        <img id="logo-img"
             src="/static/img/neat-sleeps-white.png"
             alt="{{ property_name }}"
             class="h-7" />
      </a>

      <!-- Hamburger -->
      <button id="menu-toggle" type="button"
              class="relative w-12 h-12 flex items-center justify-center rounded-full bg-black
       transition-transform duration-300 ease-in-out
       hover:scale-115 active:scale-90"
              aria-label="Toggle navigation menu">
        <span class="menu-toggle-middle"></span>
      </button>
    </div>
  </div>

</header>


      <!-- Full-screen slide-down mobile menu -->
<nav
  id="mobile-menu"
  class="fixed inset-0 z-[80]
         transform -translate-y-full pointer-events-none
         transition-transform duration-700 ease-out"
  aria-label="Main navigation"
>
  <div
    class="mobile-menu-content pt-24 pb-10 max-w-3xl mx-auto px-6 flex flex-col h-full justify-center items-center"
  >
   

    <!-- Main links -->
    <ul class="space-y-8">
      <li>
        <button
          type="button"
          data-menu-screen="home"
          class="w-full hover:text-[#CCCCCC] transition-colors"
        >
          Your Stay
        </button>
      </li>
      <li>
        <button
          type="button"
          data-menu-screen="chat"
          class="w-full  hover:text-[#CCCCCC] transition-colors"
        >
          Chat with Sandy
        </button>
      </li>
      <li>
        <button
          type="button"
          data-menu-screen="experiences"
          class="w-full hover:text-[#CCCCCC] transition-colors"
        >
          Guides
        </button>
      </li>
      <li>
        <button
          type="button"
          data-menu-screen="upgrades"
          class="w-full hover:text-[#CCCCCC] transition-colors"
        >
          Upgrades
        </button>
      </li>
    </ul>


    <!-- Footer -->
    <div class="mt-auto pt-8 menu-footer">
      <a href="https://www.hostscout.ai/"
   target="_blank"
   rel="noopener noreferrer"
   class="text-[12px] text-[#9ca3af] hover:text-white transition">Powered by HostScout.AI</a>
    </div>
  </div>
</nav>






      <!-- Main content area that swaps screens  overflow-hidden-->
      <main id="screen-container" class="flex-1 flex flex-col" role="main">
        
        
        
        <!-- HOME -->
<!-- HOME -->
<section
  id="screen-home"
  class="flex flex-col flex-1 bg-[#f4f4f4] text-[0.95rem] px-4 pt-20"
  aria-label="Home"
>
  <!-- LOGIN STATE (unchanged) -->
  <div id="home-login" class="space-y-4">
    <div class="space-y-2">
      <h2 class="font-semibold text-slate-900">Unlock your stay</h2>
      <p class="text-slate-500">
        Enter the
        <span class="font-semibold">last 4 digits of the phone number</span>
        on your booking to unlock your trip details, chat with Sandy, and
        browse guides.
      </p>
    </div>

    <div class="bg-white rounded-3xl p-4 space-y-3 shadow-sm">
      <label
        for="unlock-code"
        class="block font-medium text-slate-700 mb-1"
      >
        Last 4 digits
      </label>
      <input
        id="unlock-code"
        type="text"
        inputmode="numeric"
        maxlength="4"
        autocomplete="off"
        placeholder="1234"
        pattern="[0-9]*"
        class="w-full rounded-2xl bg-slate-50 border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"
      />
      <button
        id="unlock-button"
        type="button"
        data-property-id="{{ property_id }}"
        class="w-full mt-1 inline-flex justify-center items-center gap-2 rounded-2xl bg-slate-900 hover:bg-slate-800 font-semibold text-slate-50 py-3 transition"
      >
        <span>Unlock experience</span>
        <span
          id="unlock-spinner"
          class="hidden w-4 h-4 border-2 border-slate-50 border-t-transparent rounded-full animate-spin"
        ></span>
      </button>
      <p
        id="unlock-error"
        class="text-rose-500 min-h-[1.125rem]"
        aria-live="polite"
      ></p>
      <p class="text-slate-500 text-xs">
        Not sure which number is on the booking? Check your confirmation email
        or message your host.
      </p>
    </div>

    <div class="mt-2 text-slate-500 flex items-center gap-2 text-xs">
      {% if is_live %}
      <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
      <span>Sandy is live for this property üåä</span>
      {% else %}
      <span class="h-2 w-2 rounded-full bg-rose-500"></span>
      <span>
        Sandy is currently offline ‚Äì you can still view trip details.
      </span>
      {% endif %}
    </div>
  </div>

  <!-- UNLOCKED HOME (matches mock) -->
  <div class="flex-1 flex flex-col justify-start">
    <div
      id="home-stay"
      class="hidden pt-0"
    >
      <!-- Top labels / heading -->
      <div class="text-center pb-3">
        <p class="text-[11px] font-semibold text-[#666666]">
          Casa {{ property_name or "Your stay" }}
        </p>
        <h1 class="mt-2 text-[32px] font-semibold text-[#000000] leading-tight">
          <span id="guest-name-span">{{ reservation_name or "Guest" }}</span>, breathe.<br />
          You‚Äôve made it.
        </h1>
      </div>

      <!-- Image card max-w-[407px] -->
      <div class="w-full flex justify-center mt-2 pl-6 pr-6">
        <div
          class="bg-white rounded-[32px] shadow-[0_10px_20px_rgba(0,0,0,0.35)] overflow-hidden w-full border-[4px] border-[#FFFFFF]"
        >
          <div class="h-[430px] w-full overflow-hidden">
            <img
              src="{{ hero_image_url or default_image_url }}"
              alt="{{ property_name }}"
              class="w-full h-full object-cover"
            />
          </div>
        </div>
      </div>

      <!-- Details + buttons -->
      <div class="mt-8 space-y-8">
        {% if arrival_date or departure_date %}
        <!-- Arrival / Departure row -->
        <div
          class="max-w-[360px] mx-auto flex items-start justify-between text-center text-sm"
        >
          <div class="flex-1 pr-2">
            <p class="text-[11px] font-semibold text-[#666666] text-right">Arrival</p>
            <p id="arrival-date-span" class="mt-1 text-[20px] font-semibold text-[#000000] text-right">{{ arrival_date or "-" }}</p>
            <p class="mt-1 text-[20px] font-semibold text-[#000000] text-right pt-1">{{ checkin_time if checkin_time is defined and checkin_time else "4:00 PM" }}</p>
          </div>
          <div class="flex-1 pl-2">
            <p class="text-[11px] font-semibold text-[#666666] text-left">Departure</p>
            <p id="departure-date-span" class="mt-1 text-[20px] font-semibold text-[#000000] text-left">{{ departure_date or "-" }}</p>
            <p class="mt-1 text-[20px] font-semibold text-[#000000] text-left pt-1">{{ checkout_time if checkout_time is defined and checkout_time else "11:00 AM" }}</p>
          </div>
        </div>
        {% endif %}

        <!-- Door / WiFi buttons -->
        <div class="max-w-[360px] mx-auto grid grid-cols-2 gap-5">
          <button
            id="checkin-button"
            type="button"
            class="w-full border border-slate-900 rounded-[999px] py-4 text-[15px] font-semibold 
         bg-white text-slate-900 hover:bg-black hover:text-white 
         transition-colors duration-200"
          >
            Door
          </button>

          <button
            id="wifi-button"
            type="button"
            class="w-full border border-slate-900 rounded-[999px] py-4 text-[15px] font-semibold
       bg-white text-slate-900 hover:bg-black hover:text-white
       transition-colors duration-200"
            >
            WiFi
          </button>
        </div>
      </div>
    </div>
  </div>
</section>



        <!-- CHAT -->
        <section id="screen-chat" class="hidden bg-white min-h-screen" aria-label="Chat">

          <!-- NEW: Spacer for top navigation (same height as header h-16) 
  <div class="h-24"></div>-->

          <div id="chat-box" class="px-4 pt-4 pb-40 space-y-2 bg-white text-slate-800"></div>


          <div class="chat-input-bar">
            <div class="chat-input-inner">
              <button type="button" class="chat-plus" aria-label="Insert a suggested question">+</button>
              <input id="chat-input" type="text" placeholder="Type a message here..." aria-label="Chat message" />
              <button id="chat-send" type="button" class="send-button" aria-label="Send message">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                    d="M12 19V5M6.5 10.5L12 5l5.5 5.5" />
                </svg>
              </button>
            </div>
          </div>
        </section>

        <!-- GUIDES -->
<!-- GUIDES -->
<section
  id="screen-experiences"
  class="hidden bg-[#f5f5f5] px-4 pt-24 pb-24 space-y-6"
  aria-label="Guides and local tips"
>
  <!-- Hero -->
  <div class="text-center pb-3">
    <p class="text-[11px] font-semibold text-[#666666]">Casa 
      {{ property_name or "Your stay" }}
    </p>
     
    <h1 class="mt-2 text-[32px] font-semibold text-[#000000] leading-tight">
      Your stay just got<br>easier,
      <span>{{ reservation_name or "Guest" }}</span>.
    </h1>
      </div>
    
  <!-- Filters row -->
  <div class="flex items-center gap-2 overflow-x-auto pb-1 pt-1 text-[11px] justify-center">
    <!-- sort button -->
    <button
      type="button"
      class="guide-filter whitespace-nowrap px-3 py-1.5 rounded-full border border-slate-300 bg-white text-slate-900 inline-flex items-center gap-1"
      data-filter="all"
    >
      <span>Sort by</span>
      <span class="text-xs">‚ñº</span>
    </button>

    <!-- dynamic filters injected here -->
    <div
      id="guides-filters"
      class="flex gap-2 overflow-x-auto pb-1 pt-1 text-[11px]"
    ></div>
  </div>

  <!-- Guides grid: injected by JS -->
  <div
    id="guides-grid"
    class="grid grid-cols-2 gap-3 items-start auto-rows-min"
  ></div>

  <!-- Fallback / empty state -->
  <p
    id="guides-empty-state"
    class="hidden text-xs text-slate-500 mt-4"
  >
    We don‚Äôt have any guides yet for this stay. Check back soon or ask Sandy
    for local tips.
  </p>
</section>




<!-- UPGRADES -->
<section
  id="screen-upgrades"
  class="hidden bg-[#f5f5f5] flex flex-col flex-1 text-[0.95rem] px-4 pt-24 pb-24"
  aria-label="Upgrades"
>
  <!-- Heading -->
  <div class="text-center pb-3">
        <p class="text-[11px] font-semibold text-[#666666]">Casa 
      {{ property_name or "Your stay" }}
    </p>
        <h1 class="mt-2 text-[32px] font-semibold text-[#000000] leading-tight">
      Upgrades you‚Äôll love,<br>
      <span>{{ reservation_name or "Guest" }}</span>.
    </h1>
      </div>


  

  <!-- Beats-style carousel shell -->
  <div
    id="upgrades-carousel"
    class="upgrades-carousel relative w-full max-w-[420px] mx-auto overflow-x-auto"
  >
    <div class="upgrades-track flex items-center h-[420px] pt-6 pb-4">
      {% if upgrades and upgrades|length > 0 %}
        {% for up in upgrades %}
          {% set slug = up.slug or "" %}
          {% set title_lower = (up.title or "")|lower %}
          {% set is_time_flex =
                slug in ["early-check-in", "late-checkout", "late-check-out"]
                or "early check" in title_lower
                or "late check" in title_lower
          %}
          {% if same_day_turnover and is_time_flex %}
            {# skip time-flex on same-day turnover #}
          {% else %}
            <!-- each slide is still a button so your existing JS can use it -->
            <button
  type="button"
  class="upgrade-slide upgrade-card relative shrink-0 text-left focus:outline-none"
  data-upgrade-id="{{ up.id }}"
  data-upgrade-title="{{ up.title }}"
  data-upgrade-price="{{ up.price_display or '' }}"
>
  <div
    class="upgrade-card-inner w-[280px] h-[360px] bg-white"
  >
    {% if up.image_url %}
      <img
        src="{{ up.image_url }}"
        alt="{{ up.title }}"
        class="w-full h-full object-cover"
      />
    {% else %}
      <img
        src="{{ hero_image_url or default_image_url }}"
        alt="{{ up.title }}"
        class="w-full h-full object-cover"
      />
    {% endif %}
  </div>

  <!-- hidden long copy so JS can read it -->
  <p class="hidden upgrade-long">
    {{ up.long_description or up.short_description }}
  </p>
</button>


          {% endif %}
        {% endfor %}
      {% else %}
        <p class="text-xs text-slate-500">
          Upgrades aren‚Äôt available for this stay yet.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- COPY + BUTTON for the ACTIVE card only 
  <div id="upgrade-active-info" class="mt-6 text-center space-y-3 hidden">-->
  <div id="upgrade-active-info" class="text-center hidden">
    <h3
      id="upgrade-active-title"
      class="text-[20px] font-semibold text-[#000000]"
    >
      <!-- filled by JS -->
    </h3>
    <p
      id="upgrade-active-description"
      class="text-[14px] leading-relaxed text-[#000000] max-w-xs mx-auto pt-2"
    >
      <!-- filled by JS -->
    </p>
  </div>

  <div id="upgrade-active-cta" class="mt-6 flex justify-center hidden">
    <button
      id="upgrade-active-button"
      type="button"
      class="inline-flex items-center justify-center rounded-[999px]
             border border-[#020617] px-10 py-4 text-[15px] font-semibold
             bg-white text-[#020617] hover:bg-black hover:text-white
             transition-colors duration-200"
    >
      <span id="upgrade-active-button-label">$0.00 ‚Äì Purchase</span>
    </button>
  </div>
</section>





<!-- UPGRADE DETAIL (full page with purchase bar) -->
<div
  id="upgrade-modal"
  class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[80]"
>
  <section
    id="screen-upgrade-detail"
    class="bg-[#f5f5f5] text-slate-900 flex flex-col min-h-screen w-full"
    aria-label="Upgrade details"
  >
    <!-- Hero image with close -->
    <div class="relative h-64 w-full overflow-hidden">
      <img
        id="upgrade-detail-image"
        src="{{ hero_image_url or default_image_url }}"
        alt=""
        class="w-full h-full object-cover"
      />
      <button
        id="upgrade-modal-close"
        type="button"
        class="absolute top-6 right-5 w-9 h-9 rounded-full bg-black/80 flex items-center justify-center text-slate-50 text-xl leading-none"
      >
        √ó
      </button>
    </div>

    <!-- Text content -->
    <div class="px-6 pt-6 pb-32 flex-1 overflow-y-auto">
      <h2
        id="upgrade-detail-title"
        class="text-2xl font-semibold leading-tight"
      >
        Upgrade title
      </h2>

      <p
        id="upgrade-detail-body"
        class="mt-4 text-sm text-slate-800 leading-relaxed whitespace-pre-line"
      >
        Full description goes here.
      </p>

      <div class="mt-8 border border-slate-200 rounded-2xl p-4">
        <p
          class="text-[11px] uppercase tracking-[0.2em] text-slate-500 mb-2"
        >
          Your upgrade
        </p>
        <div class="flex items-center justify-between text-sm">
          <span id="upgrade-detail-name" class="font-medium">
            Upgrade name
          </span>
          <span id="upgrade-detail-price" class="font-semibold">
            $0.00
          </span>
        </div>
      </div>
    </div>

    <!-- Bottom purchase bar -->
    <div
      class="fixed bottom-0 left-0 right-0 px-4 pb-6 pt-3 bg-[#f5f5f5]/95 backdrop-blur-sm shadow-[0_-12px_30px_rgba(15,23,42,0.18)]"
    >
      <button
        id="upgrade-detail-purchase"
        type="button"
        class="w-full rounded-full py-3 text-sm font-semibold bg-slate-900 text-slate-50"
      >
        <span id="upgrade-detail-price-bottom">
          $0.00 ‚Äì Purchase
        </span>
      </button>
    </div>
  </section>
</div>




        <!-- WiFi modal -->
<div
  id="wifi-modal"
  class="fixed inset-0 z-[80] bg-black hidden items-center justify-center px-6"
     role="dialog"
     aria-modal="true"
  aria-labelledby="wifi-title"
>
  <!-- Close button -->
  <div class="absolute top-4 right-4">
    <button
      id="wifi-close"
      type="button"
      class="w-12 h-12 rounded-full flex items-center justify-center text-[32px] text-white leading-none"
        aria-label="Close">
      √ó
    </button>
  </div>

  <!-- Content space-y-4  class="space-y-4" -->
  <div class="text-center max-w-xs mx-auto">
    <div>
      <div>
        <p id="checkin-title" class="text-[14px] text-[#CCCCCC] font-semibold uppercase">
          WiFi Network
        </p>
        <p
          id="wifi-ssid"
          class="mt-1 text-[40px] font-semibold text-white break-all"
        >
          {{ wifi_ssid if wifi_ssid is defined and wifi_ssid else "Blueshore-5G" }}
        </p>
      </div>

      <div>
        <p id="checkin-title" class="text-[14px] text-[#CCCCCC] font-semibold uppercase pt-3">
          Password
        </p>
        <p
          id="wifi-password"
          class="mt-1 text-[40px] font-semibold text-white break-all" 
        >
          {{ wifi_password if wifi_password is defined and wifi_password else "Shore6345" }}
        </p>
      </div>
    </div>

    <p id="checkin-title" class="text-[14px] text-[#CCCCCC] pt-3 font-semibold">
      Tap and hold to copy on most devices.
    </p>
  </div>
</div>

        

  <!-- Check-in modal -->
  <div id="checkin-modal"
     class="fixed inset-0 z-[80] bg-black hidden items-center justify-center px-6"
     role="dialog"
     aria-modal="true"
     aria-labelledby="checkin-title">
    <div class="absolute top-4 right-4">
      <button id="checkin-close"
        type="button"
      class="w-12 h-12 rounded-full flex items-center justify-center text-[32px] text-white leading-none"
        aria-label="Close">
      √ó
      </button>
    </div>
    <div class="text-center space-y-4">
      <p id="checkin-title" class="text-[14px] text-[#CCCCCC] font-semibold uppercase">
        Your door code
      </p>
      <p id="checkin-code" class="text-[80px] text-white font-semibold">
        ----
      </p>
      <p class="text-[14px] text-[#CCCCCC] font-semibold max-w-xs mx-auto">
        This code matches the last 4 digits of the phone number on your reservation.
        Enter it slowly on the keypad. If the lock gives you trouble, contact your host.
      </p>
    </div>
  </div>



 <!-- GUIDE DETAIL (full page) -->
<!-- GUIDE DETAIL (full page, ABOVE MENU) -->
<div
  id="guide-modal"
  class="fixed inset-0 hidden bg-[#f5f5f5] z-[100]"
>
  <section
    id="screen-guide-detail"
    class="relative flex flex-col min-h-screen w-full text-slate-900"
    aria-label="Guide details"
  >
    <!-- Close button (top-right, black circle, above everything) -->
    <button
      id="guide-modal-close"
      type="button"
      class="absolute top-6 right-6 z-[110]
             w-14 h-14 rounded-full bg-black text-white
             flex items-center justify-center text-[32px] leading-none"
      aria-label="Close"
    >
      √ó
    </button>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto pt-28 pb-16 px-10">
      <div class="max-w-[22rem] mx-auto">
        <h2
          id="guide-modal-title"
          class="text-[34px] font-semibold leading-tight tracking-tight"
        >
          Headline
        </h2>

        <p
          id="guide-modal-body"
          class="mt-8 text-[20px] font-semibold leading-[1.65]
                 text-slate-900 whitespace-pre-line"
        >
          Full description goes here.
        </p>
      </div>
    </div>
  </section>
</div>





  <!-- Logout modal -->
  <div id="logout-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
    role="dialog" aria-modal="true" aria-labelledby="logout-title">
    <div class="mx-4 w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 id="logout-title" class="text-base font-semibold text-slate-900">Leaving already?</h2>
          <p class="mt-1 text-sm text-slate-500">
            To regain access to {{ property_name }}, you‚Äôll need to enter the last 4 digits of your booking phone
            number.
          </p>
        </div>
        <button id="logout-close" type="button"
          class="rounded-full p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-700">
          <span class="sr-only">Close</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"
            aria-hidden="true">
            <path fill-rule="evenodd"
              d="M10 8.586l4.95-4.95a1 1 0 111.414 1.414L11.414 10l4.95 4.95a1 1 0 01-1.414 1.414L10 11.414l-4.95 4.95a1 1 0 01-1.414-1.414L8.586 10l-4.95-4.95A1 1 0 115.05 3.636L10 8.586z"
              clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <div class="mt-5 flex items-center justify-end gap-3">
        <button id="logout-cancel" type="button"
          class="rounded-full border border-slate-200 px-4 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-50">
          Cancel
        </button>
        <button id="logout-confirm" type="button"
          class="rounded-full bg-slate-900 px-4 py-1.5 text-sm font-semibold text-white hover:bg-slate-800">
          Log out
        </button>
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Screens + core elements ---
    const screens = {
      home: document.getElementById("screen-home"),
      chat: document.getElementById("screen-chat"),
      experiences: document.getElementById("screen-experiences"),
      upgrades: document.getElementById("screen-upgrades"),
      //upgradeDetail: document.getElementById("screen-upgrade-detail"),
    };

    const LOGO_WHITE = "/static/img/neat-sleeps-white.png";
    const LOGO_BLACK = "/static/img/neat-sleeps-black.png";

    // helper: are we currently on the chat screen?
    function isChatVisible() {
      const chatScreen = screens.chat;
      return chatScreen && !chatScreen.classList.contains("hidden");
    }

    const navButtons = document.querySelectorAll("nav .nav-item");
    const homeLogin = document.getElementById("home-login");
    const homeStay = document.getElementById("home-stay");
    const headerEl = document.getElementById("app-header");
    /*const upgradeModal = document.getElementById("upgrade-modal");
    const upgradeModalClose = document.getElementById("upgrade-modal-close");*/

        // --- Guides / experiences (local tips) ---
        // --- Guides / experiences (local tips) ---

    const guidesGrid = document.getElementById("guides-grid");
    const guidesEmptyState = document.getElementById("guides-empty-state");
    const guidesFiltersContainer = document.getElementById("guides-filters");

    const guideModal = document.getElementById("guide-modal");
    const guideModalClose = document.getElementById("guide-modal-close");
    const guideModalTitle = document.getElementById("guide-modal-title");
    const guideModalBody = document.getElementById("guide-modal-body");

    const guidesState = {
      loaded: false,
      loading: false,
      guides: [],
      activeFilter: "all",
    };

    // Build one card per guide (2-col grid, ‚Äúblocks‚Äù like your mock)
    function createGuideCard(guide, index) {
      const isTall = index % 3 === 0; // every 3rd card taller for variety

      const card = document.createElement("button");
      card.type = "button";
      card.className =
        "group relative overflow-hidden rounded-[24px] bg-slate-200 shadow-sm " +
        "focus:outline-none focus:ring-2 focus:ring-slate-900 transition-transform active:scale-95";
      card.style.aspectRatio = isTall ? "3 / 4" : "4 / 3";

      const imageUrl =
        guide.image_url ||
        "{{ experiences_hero_url or hero_image_url or default_image_url }}";

      const img = document.createElement("img");
      img.src = imageUrl;
      img.alt = guide.title || "Guide";
      img.className =
        "h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]";
      card.appendChild(img);

      const overlay = document.createElement("div");
      overlay.className =
        "absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent";
      card.appendChild(overlay);

      const textWrap = document.createElement("div");
      textWrap.className =
        "absolute inset-x-3 bottom-3 text-left text-white space-y-1";

      const titleEl = document.createElement("h2");
      titleEl.className = "text-[13px] font-semibold leading-tight line-clamp-2";
      titleEl.textContent = guide.title || "Guide";
      textWrap.appendChild(titleEl);

      if (guide.category) {
        const catEl = document.createElement("p");
        catEl.className = "text-[10px] opacity-80";
        catEl.textContent = guide.category;
        textWrap.appendChild(catEl);
      }

      card.addEventListener("click", () => openGuideModalFromGuide(guide));
      return card;
    }

    function openGuideModalFromGuide(guide) {
      if (!guideModal) return;

      if (guideModalTitle) {
        guideModalTitle.textContent = guide.title || "Guide";
      }

      // Prefer HTML body if available
      if (guide.body_html) {
        guideModalBody.innerHTML = guide.body_html;
        guideModalBody.classList.remove("whitespace-pre-line");
      } else if (guide.long_description) {
        guideModalBody.textContent = guide.long_description;
        guideModalBody.classList.add("whitespace-pre-line");
      } else if (guide.short_description) {
        guideModalBody.textContent = guide.short_description;
        guideModalBody.classList.add("whitespace-pre-line");
      } else {
        guideModalBody.textContent = "";
        guideModalBody.classList.add("whitespace-pre-line");
      }

      guideModal.classList.remove("hidden");
      guideModal.classList.add("flex");
      document.body.classList.add("overflow-hidden");
    }

    function closeGuideModal() {
      if (!guideModal) return;
      guideModal.classList.add("hidden");
      guideModal.classList.remove("flex");
      document.body.classList.remove("overflow-hidden");
    }

    if (guideModalClose) {
      guideModalClose.addEventListener("click", (e) => {
        e.stopPropagation();
        closeGuideModal();
      });
    }

    if (guideModal) {
      guideModal.addEventListener("click", (e) => {
        if (e.target === guideModal) closeGuideModal();
      });
    }

    // Build filter chips from guide categories
    function buildGuideFiltersFromGuides(guides) {
      if (!guidesFiltersContainer) return;

      const categories = [
        ...new Set(
          guides
            .map((g) => g.category)
            .filter((c) => typeof c === "string" && c.trim() !== "")
        ),
      ];

      guidesFiltersContainer.innerHTML = "";

      // Make one button per category
      categories.forEach((category) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.filter = category;
        btn.textContent = category;
        btn.className =
          "guide-filter whitespace-nowrap px-3 py-1.5 rounded-full border " +
          "border-slate-300 bg-white text-slate-900 text-[11px]";
        btn.addEventListener("click", () => {
          guidesState.activeFilter = category;
          updateGuideFilterStates();
          renderGuidesGrid();
        });
        guidesFiltersContainer.appendChild(btn);
      });

      // Hook up the fixed ‚ÄúSort by‚Äù button to reset filter to all
      const sortButton = document.querySelector(
        'button.guide-filter[data-filter="all"]'
      );
      if (sortButton) {
        sortButton.addEventListener("click", () => {
          guidesState.activeFilter = "all";
          updateGuideFilterStates();
          renderGuidesGrid();
        });
      }

      updateGuideFilterStates();
    }

    function updateGuideFilterStates() {
      const buttons = document.querySelectorAll(".guide-filter");
      const active = guidesState.activeFilter;

      buttons.forEach((btn) => {
        const filter = btn.dataset.filter;
        const isActive =
          active === "all" ? filter === "all" : filter === active;

        if (isActive) {
          btn.classList.add("bg-slate-900", "text-white", "border-slate-900");
          btn.classList.remove("bg-white", "text-slate-900", "border-slate-300");
        } else if (filter !== "all") {
          btn.classList.add("bg-white", "text-slate-900", "border-slate-300");
          btn.classList.remove("bg-slate-900", "text-white", "border-slate-900");
        }
      });
    }

    function renderGuidesGrid() {
      if (!guidesGrid) return;

      guidesGrid.innerHTML = "";

      const filter = guidesState.activeFilter;
      const visible =
        filter === "all"
          ? guidesState.guides
          : guidesState.guides.filter((g) => g.category === filter);

      if (!visible.length) {
        guidesEmptyState?.classList.remove("hidden");
        return;
      }
      guidesEmptyState?.classList.add("hidden");

      visible.forEach((guide, index) => {
        const card = createGuideCard(guide, index);
        guidesGrid.appendChild(card);
      });
    }

    async function loadGuidesIfNeeded() {
      if (guidesState.loaded || guidesState.loading) return;
      guidesState.loading = true;

      try {
        const res = await fetch(`/properties/${window.PROPERTY_ID}/guides`);
        if (!res.ok) throw new Error("Failed to load guides");

        const data = await res.json();
        const guides = Array.isArray(data.guides) ? data.guides : [];

        // Normalize tags/fields if needed in the future
        guidesState.guides = guides;
        guidesState.loaded = true;

        if (!guides.length) {
          guidesEmptyState?.classList.remove("hidden");
          return;
        }

        buildGuideFiltersFromGuides(guides);
        renderGuidesGrid();
      } catch (err) {
        console.error("Error loading guides:", err);
        if (guidesEmptyState) {
          guidesEmptyState.textContent =
            "We couldn‚Äôt load guides right now. Please try again in a moment or ask Sandy for local tips.";
          guidesEmptyState.classList.remove("hidden");
        }
      } finally {
        guidesState.loading = false;
      }
    }


   


   

    // --- Global state ---
    let isUnlocked = window.INITIAL_VERIFIED === "true";

    // TEMP: force unlocked during UI testing //REMOVE when live
    //isUnlocked = true;

    let lastUnlockCode = null;
    let currentSessionId = null;
    let guestName = null;
    let arrivalDate = null;
    let departureDate = null;

    // üîπ helper: keep guest name in sync across all places we show it
    function updateGuestNameInUI(name) {
      const nameEls = document.querySelectorAll("#guest-name-span, #guest-name-span-guides");
      nameEls.forEach((el) => {
        el.textContent = name;
      });
    }

    const GUEST_STATE_KEY = `guest_state_${window.PROPERTY_ID}`;

    function saveGuestState() {
      try {
        const state = {
          isUnlocked,
          lastUnlockCode,
          sessionId: currentSessionId,
          guestName,
          arrivalDate,
          departureDate,
        };
        window.localStorage.setItem(GUEST_STATE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("Unable to save guest state:", e);
      }
    }

    function loadGuestState() {
      try {
        const raw = window.localStorage.getItem(GUEST_STATE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Unable to load guest state:", e);
        return null;
      }
    }

    const storedState = loadGuestState();
    if (storedState) {
      if (!isUnlocked && storedState.isUnlocked) {
        isUnlocked = true;
      }
      if (storedState.lastUnlockCode) {
        lastUnlockCode = storedState.lastUnlockCode;
      }
      if (storedState.sessionId) {
        currentSessionId = storedState.sessionId;
      }

      if (storedState.guestName) {
        guestName = storedState.guestName;
        updateGuestNameInUI(guestName);
      }
      if (storedState.arrivalDate) {
        arrivalDate = storedState.arrivalDate;
        const arrEl = document.getElementById("arrival-date-span");
        if (arrEl) arrEl.textContent = arrivalDate;
      }
      if (storedState.departureDate) {
        departureDate = storedState.departureDate;
        const depEl = document.getElementById("departure-date-span");
        if (depEl) depEl.textContent = departureDate;
      }
    }

    function updateHomeState() {
      if (isUnlocked) {
        if (homeLogin) homeLogin.classList.add("hidden");
        if (homeStay) homeStay.classList.remove("hidden");
      } else {
        if (homeLogin) homeLogin.classList.remove("hidden");
        if (homeStay) homeStay.classList.add("hidden");
      }
    }

    let chatHasWelcome = false;

    function showScreen(name) {
      // Show / hide screens
      Object.entries(screens).forEach(([key, el]) => {
        if (!el) return;
        if (key === name) el.classList.remove("hidden");
        else el.classList.add("hidden");
      });

      // Toggle body class for chat-specific styling (top nav, hamburger, etc.)
      if (name === "chat") {
        document.body.classList.add("chat-screen");
      } else {
        document.body.classList.remove("chat-screen");
      }

      if (name === "experiences") {
        loadGuidesIfNeeded();
      }

      // After switching screens, update logo accordingly
      if (name === "chat") {
        swapLogoWithFade(LOGO_BLACK);      // chat = black logo
      } else if (!isMenuOpen) {
        // Only switch back if the menu is not covering it
        swapLogoWithFade(LOGO_WHITE);      // home/experiences = white logo
      }

      // Chat-specific behavior
      if (name === "chat") {
        if (
          window.SANDY_LIVE === "true" &&
          chatBox &&
          !chatHasWelcome &&
          chatBox.children.length === 0
        ) {
          const intro = guestName
            ? `Hi ${guestName}! I‚Äôm Sandy, your stay assistant for ${window.PROPERTY_NAME}. You can ask about check-in, WiFi, parking, or local tips.`
            : `Hi there! I‚Äôm Sandy, your stay assistant for ${window.PROPERTY_NAME}. Ask me anything about check-in, WiFi, parking, or local recommendations.`;

          renderMessage(intro, "bot");
          chatHasWelcome = true;
        }

        scrollChatToBottom();
      }

    }

    // --- Upgrade cards ‚Üí detail screen + purchase ---
    const upgradeDetailTitle = document.getElementById("upgrade-detail-title");
    const upgradeDetailBody = document.getElementById("upgrade-detail-body");
    const upgradeDetailName = document.getElementById("upgrade-detail-name");
    const upgradeDetailPrice = document.getElementById("upgrade-detail-price");
    const upgradeDetailPriceBottom = document.getElementById("upgrade-detail-price-bottom");
    const upgradeDetailPurchase = document.getElementById("upgrade-detail-purchase");


    let currentUpgradeId = null;

    if (upgradeDetailPurchase) {
      upgradeDetailPurchase.addEventListener("click", async () => {
        if (!currentUpgradeId) return;
        try {
          await purchaseUpgrade(currentUpgradeId, null);
        } catch (e) {
          console.error(e);
          alert("Something went wrong starting checkout.");
        }
      });
    }

    // --- Stripe checkout for upgrades ---
    async function purchaseUpgrade(upgradeId, guestEmail) {
      const res = await fetch(
        `/properties/${window.PROPERTY_ID}/upgrades/${upgradeId}/checkout`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ guest_email: guestEmail || null }),
        }
      );

      const data = await res.json();
      if (data.checkout_url) {
        window.location.href = data.checkout_url;
      } else {
        alert(data.detail || "Unable to start checkout, please try again.");
      }
    }


// === Beats-style upgrades carousel behaviour ===
const upgradesCarousel = document.getElementById("upgrades-carousel");
const upgradeSlides   = Array.from(document.querySelectorAll(".upgrade-slide"));
const upgradesTrack   = document.querySelector(".upgrades-track");

const activeTitleEl     = document.getElementById("upgrade-active-title");
const activeDescEl      = document.getElementById("upgrade-active-description");
const activeButtonWrap  = document.getElementById("upgrade-active-cta");
const activeInfoWrap    = document.getElementById("upgrade-active-info");
const activeButton      = document.getElementById("upgrade-active-button");
const activeButtonLabel = document.getElementById("upgrade-active-button-label");

let activeUpgradeIndex = 0;
let activeUpgradeId    = null;

// keep track of the last ‚Äúbest‚Äù slide & a debounce timer
let lastComputedActiveIndex = 0;
let scrollSnapTimeout       = null;

// Scroll so the slide's CENTER lines up with the container CENTER
function snapToSlide(index) {
  if (!upgradesCarousel) return;
  const slide = upgradeSlides[index];
  if (!slide) return;

  const slideCenterX =
    slide.offsetLeft + slide.offsetWidth / 2;
  const targetScroll =
    slideCenterX - upgradesCarousel.clientWidth / 2;

  const maxScroll =
    upgradesCarousel.scrollWidth - upgradesCarousel.clientWidth;
  const safeTarget = Math.min(Math.max(targetScroll, 0), maxScroll);

  upgradesCarousel.scrollTo({
    left: safeTarget,
    behavior: "smooth",
  });
}

function updateActiveUpgradeInfo(index) {
  if (
    !upgradeSlides.length ||
    !activeTitleEl ||
    !activeDescEl ||
    !activeButton ||
    !activeButtonLabel
  ) return;

  const slide = upgradeSlides[index];
  if (!slide) return;

  activeUpgradeIndex = index;
  activeUpgradeId    = slide.getAttribute("data-upgrade-id") || null;

  const title  = slide.getAttribute("data-upgrade-title")  || "";
  const price  = slide.getAttribute("data-upgrade-price")  || "";
  const longEl = slide.querySelector(".upgrade-long");
  const body   = longEl ? longEl.textContent.trim() : "";

  activeTitleEl.textContent     = title;
  activeDescEl.textContent      = body || "";
  activeButtonLabel.textContent = price ? `${price} ‚Äì Purchase` : "Purchase";

  activeInfoWrap?.classList.remove("hidden");
  activeButtonWrap?.classList.remove("hidden");
}

function updateUpgradeSlides() {
  if (!upgradesCarousel || !upgradeSlides.length) return;

  const containerRect = upgradesCarousel.getBoundingClientRect();
  const centerX       = containerRect.left + containerRect.width / 2;

  let bestIndex        = 0;
  let smallestDistance = Infinity;

  // 1) find the index of the center slide
  upgradeSlides.forEach((slide, index) => {
    const rect        = slide.getBoundingClientRect();
    const slideCenter = rect.left + rect.width / 2;
    const distance    = slideCenter - centerX;
    const absDist     = Math.abs(distance);

    if (absDist < smallestDistance) {
      smallestDistance = absDist;
      bestIndex        = index;
    }
  });

  // 2) apply transforms + scale
  upgradeSlides.forEach((slide, index) => {
    const rect        = slide.getBoundingClientRect();
    const slideCenter = rect.left + rect.width / 2;
    const distance    = slideCenter - centerX;
    const normalized  = distance / rect.width;

    const maxShift   = 80;
    const translateX = -normalized * maxShift;

    const maxTilt = 14;
    const rotateY = -normalized * maxTilt;

    const cardInner = slide.querySelector(".upgrade-card-inner");
    if (cardInner) {
      const scaleBase = 0.7; // how small the back cards are
      let scale;

      if (index === bestIndex) {
        // center card ‚Üí full size
        scale = 1;
      } else {
        // neighbors stay smaller (tweak factor 0.3 if you want)
        const t = Math.min(Math.abs(normalized), 1); // 0 near center, 1 far
        scale   = scaleBase + (1 - scaleBase) * (0.3 * (1 - t));
        // if you want them all the SAME small size: scale = scaleBase;
      }

      cardInner.style.transform =
        `translateX(${translateX}px) scale(${scale}) rotateY(${rotateY}deg)`;
    }

    const isActive = index === bestIndex;
    slide.classList.toggle("is-active", isActive);
    slide.classList.toggle("is-inactive", !isActive);

    const indexDistance = Math.abs(index - bestIndex);
    slide.style.zIndex  = String(100 - indexDistance);
  });

  updateActiveUpgradeInfo(bestIndex);
  lastComputedActiveIndex = bestIndex;
}

// üîπ NEW: one place that sets padding for the last slide AND
// perfectly centers the first slide once everything has loaded
function centerFirstSlide() {
  if (!upgradesCarousel || !upgradeSlides.length) return;

  const firstSlide     = upgradeSlides[0];
  const containerWidth = upgradesCarousel.clientWidth;
  const slideWidth     = firstSlide.offsetWidth;

  // Ensure last slide can also center ‚Üí add right padding
  const lastSlide = upgradeSlides[upgradeSlides.length - 1];
  if (upgradesTrack && lastSlide) {
    const lastWidth          = lastSlide.offsetWidth;
    const neededPaddingRight = (containerWidth - lastWidth) / 2;
    const currentPaddingRight =
      parseFloat(getComputedStyle(upgradesTrack).paddingRight) || 0;

    upgradesTrack.style.paddingRight =
      `${currentPaddingRight + neededPaddingRight}px`;
  }

  // Center the very first slide
  const targetScroll =
    firstSlide.offsetLeft - (containerWidth - slideWidth) / 2;

  const maxScroll =
    upgradesCarousel.scrollWidth - upgradesCarousel.clientWidth;
  const safeTarget = Math.min(Math.max(targetScroll, 0), maxScroll);

  upgradesCarousel.scrollLeft = safeTarget;

  // Once scroll is applied, compute transforms based on final positions
  requestAnimationFrame(() => {
    updateUpgradeSlides();
  });
}

if (upgradesCarousel && upgradeSlides.length) {
  // make sure vertical scroll doesn't appear
  upgradesCarousel.style.overflowY = "hidden";

  // Scroll handler: update transforms + schedule a snap
  upgradesCarousel.addEventListener("scroll", () => {
    updateUpgradeSlides();

    if (scrollSnapTimeout) clearTimeout(scrollSnapTimeout);

    scrollSnapTimeout = setTimeout(() => {
      if (!upgradesCarousel) return;

      const maxScroll =
        upgradesCarousel.scrollWidth - upgradesCarousel.clientWidth;
      const current       = upgradesCarousel.scrollLeft;
      const edgeThreshold = 40; // px

      let indexToSnap = lastComputedActiveIndex;

      // If we‚Äôre near the right edge ‚Üí force last card to center
      if (maxScroll - current <= edgeThreshold) {
        indexToSnap = upgradeSlides.length - 1;
      }
      // near left edge ‚Üí force first card to center
      else if (current <= edgeThreshold) {
        indexToSnap = 0;
      }

      snapToSlide(indexToSnap);
    }, 120); // wait for user to stop scrolling
  });

  // Recalculate transforms on resize
  window.addEventListener("resize", updateUpgradeSlides);

  // Click a card ‚Üí snap it into center
  upgradeSlides.forEach((slide, index) => {
    slide.addEventListener("click", () => {
      snapToSlide(index);
    });
  });

  // üîπ Perfect initial centering once the whole page (images/fonts) is ready
  window.addEventListener("load", () => {
    setTimeout(centerFirstSlide, 50);
  });
}



      // CTA button: purchase the currently active upgrade directly
      if (activeButton) {
        activeButton.addEventListener("click", async () => {
          if (!activeUpgradeId) return;
      
          try {
            await purchaseUpgrade(activeUpgradeId, null);
          } catch (e) {
            console.error(e);
            alert("Something went wrong starting checkout.");
          }
        });
      }




    // --- Top bar sliding menu nav ---
    const topBar = document.getElementById("top-bar");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuToggle = document.getElementById("menu-toggle");
    const logoImg = document.getElementById("logo-img");   // üëà new single logo
    const menuLinks = document.querySelectorAll("[data-menu-screen]");
    let isMenuOpen = false;

    // match Tailwind duration-400 on the panel
    const MOBILE_MENU_SLIDE_DURATION = 400;  // ms
    const MOBILE_MENU_LINKS_FADE_DURATION = 250; // ms

    // Fade-out ‚Üí swap image ‚Üí fade-in
    function swapLogoWithFade(newSrc) {
      if (!logoImg) return;

      const currentSrc = logoImg.getAttribute("src");
      // If we're already on this logo (e.g. black ‚Üí black), do nothing
      if (currentSrc === newSrc) return;

      // fade out
      logoImg.style.opacity = "0";

      // after fade-out, swap src, then fade back in
      setTimeout(() => {
        logoImg.src = newSrc;
        logoImg.style.opacity = "1";
      }, 120); // slightly less than CSS transition (180ms)
    }

    function openMenu() {
      if (!mobileMenu) return;
      isMenuOpen = true;

      // Reset any closing state
      mobileMenu.classList.remove("fade-out");

      // Slide panel down from top
      mobileMenu.classList.remove("-translate-y-full", "pointer-events-none");
      mobileMenu.classList.add("translate-y-0");

      // Change top bar to light theme
      topBar?.classList.remove("bg-transparent", "text-white");
      topBar?.classList.add("bg-slate-50", "text-slate-900");

      // fade to dark logo
      swapLogoWithFade(LOGO_BLACK);

      // Animate hamburger ‚Üí X
      menuToggle?.classList.add("menu-toggle-open");

      document.body.classList.add("menu-open");

      // After panel finishes sliding, fade/slide in the links
      setTimeout(() => {
        if (isMenuOpen && mobileMenu) {
          mobileMenu.classList.add("show-links");
        }
      }, MOBILE_MENU_SLIDE_DURATION);
    }

    function closeMenu() {
      if (!mobileMenu) return;
      isMenuOpen = false;

      // Start fade-out on menu links ONLY (no slide)
      mobileMenu.classList.add("fade-out");
      mobileMenu.classList.remove("show-links");

      // Change top bar back to dark while content is fading
      topBar?.classList.add("bg-transparent", "text-white");
      topBar?.classList.remove("bg-slate-50", "text-slate-900");

      // fade back based on current screen
      if (document.body.classList.contains("chat-screen")) {
        swapLogoWithFade(LOGO_BLACK);   // stay black on chat
      } else {
        swapLogoWithFade(LOGO_WHITE);   // white elsewhere
      }

      // Animate X ‚Üí hamburger
      menuToggle?.classList.remove("menu-toggle-open");

      document.body.classList.remove("menu-open");

      // AFTER links have faded out, slide the panel back up
      setTimeout(() => {
        if (!isMenuOpen && mobileMenu) {
          mobileMenu.classList.add("-translate-y-full", "pointer-events-none");
          mobileMenu.classList.remove("translate-y-0", "fade-out");
        }
      }, MOBILE_MENU_LINKS_FADE_DURATION);
    }

    menuToggle?.addEventListener("click", () => {
      if (isMenuOpen) closeMenu();
      else openMenu();
    });

    // Clicking links changes screen + closes menu
    menuLinks.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-menu-screen");
        if (!target) return;

        if (!isUnlocked && target !== "home") {
          const err = document.getElementById("unlock-error");
          if (err) {
            err.textContent =
              "Please unlock your stay first with the last 4 digits of your booking phone number.";
          }
          showScreen("home");
        } else {
          showScreen(target);
        }

        closeMenu();
      });
    });

    function scrollChatToBottom() {
      // Only scroll when the chat screen is actually visible
      if (!isChatVisible()) return;

      requestAnimationFrame(() => {
        const docEl = document.documentElement;
        const body = document.body;

        const fullHeight = Math.max(
          docEl.scrollHeight,
          body.scrollHeight,
          docEl.offsetHeight,
          body.offsetHeight
        );

        window.scrollTo({
          top: fullHeight,
          behavior: "auto",
        });
      });
    }

    // Legacy bottom nav (safe if empty)
    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-screen");
        if (!target) return;

        if (!isUnlocked && target !== "home") {
          const err = document.getElementById("unlock-error");
          if (err) {
            err.textContent =
              "Please unlock your stay first with the last 4 digits of your booking phone number.";
          }
          showScreen("home");
          return;
        }
        showScreen(target);
      });
    });

    updateHomeState();
    showScreen("home");

    // Language
    const langSelect = document.getElementById("language-select");
    function getSelectedLanguage() {
      if (!langSelect) return "auto";
      return langSelect.value || "auto";
    }
    if (langSelect) {
      const saved = window.localStorage.getItem("guest_language");
      if (saved) {
        langSelect.value = saved;
      }
      langSelect.addEventListener("change", () => {
        window.localStorage.setItem("guest_language", langSelect.value);
      });
    }

    // Unlock flow
    const unlockBtn = document.getElementById("unlock-button");
    const unlockCodeInput = document.getElementById("unlock-code");
    const unlockError = document.getElementById("unlock-error");
    const unlockSpinner = document.getElementById("unlock-spinner");

    if (unlockCodeInput) {
      unlockCodeInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          attemptUnlock();
        }
      });
    }

    if (unlockBtn) {
      unlockBtn.addEventListener("click", attemptUnlock);
    }

    async function attemptUnlock() {
      const code = (unlockCodeInput?.value || "").trim();
      if (unlockError) unlockError.textContent = "";

      if (!/^\d{4}$/.test(code)) {
        if (unlockError) unlockError.textContent = "Please enter exactly 4 digits.";
        return;
      }

      if (unlockBtn) unlockBtn.disabled = true;
      unlockSpinner?.classList.remove("hidden");

      try {
        const res = await fetch(`/guest/${window.PROPERTY_ID}/verify-json`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          if (unlockError) {
            unlockError.textContent =
              data.error ||
              "We couldn‚Äôt verify that code. Please double-check or contact your host.";
          }
          return;
        }

        isUnlocked = true;
        lastUnlockCode = code;
        if (unlockError) unlockError.textContent = "";
        if (unlockCodeInput) unlockCodeInput.value = "";

        try {
          if (data.guest_name) {
            guestName = data.guest_name;
            updateGuestNameInUI(guestName);
          }
          if (data.arrival_date) {
            arrivalDate = data.arrival_date;
            const arrEl = document.getElementById("arrival-date-span");
            if (arrEl) arrEl.textContent = arrivalDate;
          }
          if (data.departure_date) {
            departureDate = data.departure_date;
            const depEl = document.getElementById("departure-date-span");
            if (depEl) depEl.textContent = departureDate;
          }
        } catch (e) {
          console.warn("Error applying PMS guest info to UI:", e);
        }

        saveGuestState();
        updateHomeState();
        showScreen("home");
      } catch (err) {
        console.error(err);
        if (unlockError) {
          unlockError.textContent =
            "Something went wrong while verifying. Please try again.";
        }
      } finally {
        if (unlockBtn) unlockBtn.disabled = false;
        unlockSpinner?.classList.add("hidden");
      }
    }

    // Check-in modal
    const checkinButton = document.getElementById("checkin-button");
    const upgradesButton = document.getElementById("upgrades-button");
    const checkinModal = document.getElementById("checkin-modal");
    const checkinClose = document.getElementById("checkin-close");
    const checkinCodeEl = document.getElementById("checkin-code");
        // WiFi modal
    const wifiButton = document.getElementById("wifi-button");
    const wifiModal = document.getElementById("wifi-modal");
    const wifiClose = document.getElementById("wifi-close");

    function openWifiModal() {
      if (!wifiModal) return;
      wifiModal.classList.remove("hidden");
      wifiModal.classList.add("flex");
    }

    function closeWifiModal() {
      if (!wifiModal) return;
      wifiModal.classList.add("hidden");
      wifiModal.classList.remove("flex");
    }

    if (wifiButton) {
      wifiButton.addEventListener("click", openWifiModal);
    }
    if (wifiClose) {
      wifiClose.addEventListener("click", closeWifiModal);
    }
    if (wifiModal) {
      wifiModal.addEventListener("click", (e) => {
        if (e.target === wifiModal) closeWifiModal();
      });
    }


    function openCheckinModal() {
      if (!checkinModal) return;
      const code = lastUnlockCode || "----";
      if (checkinCodeEl) checkinCodeEl.textContent = code;
      checkinModal.classList.remove("hidden");
      checkinModal.classList.add("flex");
    }

    function closeCheckinModal() {
      if (!checkinModal) return;
      checkinModal.classList.add("hidden");
      checkinModal.classList.remove("flex");
    }

    if (checkinButton) {
      checkinButton.addEventListener("click", openCheckinModal);
    }
    if (checkinClose) {
      checkinClose.addEventListener("click", closeCheckinModal);
    }
    if (checkinModal) {
      checkinModal.addEventListener("click", (e) => {
        if (e.target === checkinModal) closeCheckinModal();
      });
    }

    // Upgrades screen shortcut (legacy button)
    if (upgradesButton) {
      upgradesButton.addEventListener("click", () => {
        if (!isUnlocked) return;
        showScreen("upgrades");
      });
    }

    // Chat logic
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const chatPlus = document.querySelector(".chat-plus");

    // Elements that sit on top of the chat (fixed at bottom)
    const chatInputBar = document.querySelector(".chat-input-bar");
    const bottomNav = document.querySelector('nav[role="navigation"]');

    if (window.SANDY_LIVE === "false") {
      if (chatBox) {
        renderMessage(
          "Sandy is currently offline for this property üåô\n\n" +
          "For urgent questions, please contact your host directly via your booking app or email.",
          "bot"
        );
      }
      if (chatInput) {
        chatInput.disabled = true;
        chatInput.placeholder = "Sandy is offline for this property.";
      }
      if (chatSend) chatSend.disabled = true;
      if (chatPlus) chatPlus.disabled = true;
    }

    function formatTime(date) {
      let hours = date.getHours();
      const minutes = date.getMinutes().toString().padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      if (hours === 0) hours = 12;
      return `${hours.toString().padStart(2, "0")}:${minutes} ${ampm}`;
    }

    function formatMessage(text) {
      let escaped = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      escaped = escaped.replace(
        /(https:\/\/www\.google\.com\/maps[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer" class="gmap-link">üìç View on Google Maps</a>'
      );
      escaped = escaped.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );

      return escaped.replace(/\n/g, "<br>");
    }

    function renderMessage(text, sender) {
      if (!chatBox) return;

      const isUser = sender === "user";
      const ts = formatTime(new Date());

      const row = document.createElement("div");
      row.className = "msg " + (isUser ? "user" : "bot");

      // Avatar (Sandy only)
      let avatar = null;
      if (!isUser) {
        avatar = document.createElement("div");
        avatar.className = "avatar avatar-sandy";
      }

      const column = document.createElement("div");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<div class="message-text">${formatMessage(text)}</div>`;

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = ts;

      column.appendChild(time);
      column.appendChild(bubble);

      if (isUser) {
        // user: bubble only
        row.appendChild(column);
      } else {
        // bot: avatar + bubble
        row.appendChild(avatar);
        row.appendChild(column);
      }

      chatBox.appendChild(row);

      // only scroll if the chat screen is actually visible
      scrollChatToBottom();
    }

    function addTyping() {
      if (!chatBox || document.getElementById("typing-indicator")) return;

      const row = document.createElement("div");
      row.id = "typing-indicator";
      row.className = "msg bot";

      const avatar = document.createElement("div");
      avatar.className = "avatar avatar-sandy";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `
        <span class="typing-dots">
          <span> </span><span> </span><span> </span>
        </span>
      `;

      const column = document.createElement("div");
      column.appendChild(bubble);

      row.appendChild(avatar);
      row.appendChild(column);

      chatBox.appendChild(row);
      scrollChatToBottom();
    }

    function removeTyping() {
      const el = document.getElementById("typing-indicator");
      if (el) el.remove();
    }

    async function sendChat() {
      const text = (chatInput?.value || "").trim();
      if (!text) return;

      if (window.SANDY_LIVE === "false") {
        renderMessage(
          "Sandy is currently offline for this property. Please contact your host directly. üôè",
          "bot"
        );
        return;
      }

      renderMessage(text, "user");
      if (chatInput) chatInput.value = "";
      addTyping();

      try {
        const body = {
          message: text,
          session_id: currentSessionId,
          language: getSelectedLanguage(),
        };

        const res = await fetch(`/properties/${window.PROPERTY_ID}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        removeTyping();

        if (data.session_id) {
          currentSessionId = data.session_id;
          saveGuestState();
        }

        if (data.error) {
          renderMessage(data.error, "bot");
        } else {
          renderMessage(
            data.response || "Hmm, I didn‚Äôt catch that ‚Äî could you try again? üå¥",
            "bot"
          );
        }
      } catch (err) {
        console.error(err);
        removeTyping();
        renderMessage(
          "Oops! Something went wrong. Please try again in a moment. üêö",
          "bot"
        );
      }
    }

    if (chatSend && chatInput) {
      chatSend.addEventListener("click", sendChat);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });
    }

    // Logout modal wiring
    const logoutButton = document.getElementById("logout-button");
    const logoutModal = document.getElementById("logout-modal");
    const logoutClose = document.getElementById("logout-close");
    const logoutCancel = document.getElementById("logout-cancel");
    const logoutConfirm = document.getElementById("logout-confirm");

    function openLogoutModal() {
      if (logoutModal) {
        logoutModal.classList.remove("hidden");
        logoutModal.classList.add("flex");
      }
    }

    function closeLogoutModal() {
      if (logoutModal) {
        logoutModal.classList.add("hidden");
        logoutModal.classList.remove("flex");
      }
    }

    if (logoutButton) {
      logoutButton.addEventListener("click", (e) => {
        e.preventDefault();
        openLogoutModal();
      });
    }

    if (logoutClose) {
      logoutClose.addEventListener("click", (e) => {
        e.preventDefault();
        closeLogoutModal();
      });
    }

    if (logoutCancel) {
      logoutCancel.addEventListener("click", (e) => {
        e.preventDefault();
        closeLogoutModal();
      });
    }

    if (logoutConfirm) {
      logoutConfirm.addEventListener("click", (e) => {
        e.preventDefault();
        try {
          window.localStorage.removeItem(GUEST_STATE_KEY);
        } catch (err) {
          console.warn("Unable to clear guest state:", err);
        }
        window.location.href = "/auth/logout";
      });
    }

    if (logoutModal) {
      logoutModal.addEventListener("click", (e) => {
        if (e.target === logoutModal) {
          closeLogoutModal();
        }
      });
    }
  });
</script>


</body>

</html>
