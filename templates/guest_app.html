<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ property_name }} â€“ Guest Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / icons -->
  <link rel="manifest" href="/manifest/{{ property_id }}.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="theme-color" content="#020617" />
  <link rel="apple-touch-icon" href="/static/icons/app-icon-192.png" />

  <!-- Tailwind CDN + DOMPurify -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    html,
    body {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 0.95rem;
      overflow-x: hidden; /* only block horizontal scroll */
    }

    * { box-sizing: border-box; }

    body.menu-open { overflow: hidden; }

    /* Smooth fade on logo when we swap pngs */
    #logo-img { transition: opacity 180ms ease; }

    /* === Hamburger / X toggle for #menu-toggle === */
    #menu-toggle { position: relative; }

    /* Top + bottom bars (hamburger) */
    #menu-toggle::before,
    #menu-toggle::after {
      content: "";
      position: absolute;
      left: 50%;
      width: 24px;
      height: 2px;
      border-radius: 999px;
      background: #ffffff; /* closed: white bars */
      transform: translateX(-50%);
      transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
    }
    #menu-toggle::before { transform: translate(-50%, -6px); }
    #menu-toggle::after  { transform: translate(-50%,  6px); }

    /* Middle bar */
    #menu-toggle .menu-toggle-middle {
      width: 24px;
      height: 2px;
      border-radius: 999px;
      background: #ffffff;
      transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
    }

    /* OPEN STATE â†’ X */
    #menu-toggle.menu-toggle-open::before { transform: translate(-50%, 0) rotate(45deg); }
    #menu-toggle.menu-toggle-open::after  { transform: translate(-50%, 0) rotate(-45deg); }
    #menu-toggle.menu-toggle-open .menu-toggle-middle {
      opacity: 0;
      transform: scaleX(0.5);
    }

    /* Chat screen: hamburger (closed) stays white (and visible on grey bar) */
    body.chat-screen #menu-toggle:not(.menu-toggle-open)::before,
    body.chat-screen #menu-toggle:not(.menu-toggle-open)::after,
    body.chat-screen #menu-toggle:not(.menu-toggle-open) .menu-toggle-middle {
      background: #ffffff !important;
    }

    /* Add a white circle behind the X when menu is open */
    #menu-toggle.menu-toggle-open {
      background: #ffffff !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    /* open menu: black X on white circle */
    #menu-toggle.menu-toggle-open::before,
    #menu-toggle.menu-toggle-open::after,
    #menu-toggle.menu-toggle-open .menu-toggle-middle {
      background: #000000 !important;
    }

    /* Hide hamburger while guide/modal is open */
    body.guide-open #menu-toggle,
    body.modal-open #menu-toggle {
      display: none !important;
    }

    /* === Top bar layering === */
    /* TOP layer: chrome (logo + hamburger / X) */
    #top-bar-chrome { z-index: 300; }

    /* Menu: full-screen overlay, but under chrome */
    #mobile-menu { z-index: 200 !important; }

    /* no special z-index needed on menu buttons, but safe */
    #mobile-menu button { z-index: 250 !important; }

    /* When on chat screen: top bar becomes light grey strip */
    body.chat-screen #top-bar {
      color: #020617 !important;
    }
    body.chat-screen #top-bar::before {
      content: "";
      position: absolute;
      inset: 0;
      background: #f8fafc;
      z-index: 0;
    }

    /* avatar on top of grey bar but under menu */
    #chat-header-sandy { z-index: 1; }

    /* base top-bar layer below chrome/menu */
    #top-bar { z-index: 20; }

    /* Push chat content below the fixed top bar (h-20 = 5rem) */
    body.chat-screen #screen-chat { padding-top: 5rem; }

    /* Default hidden state for menu content */
    #mobile-menu .mobile-menu-content {
      opacity: 0;
      transform: translateY(-12px);
      transition:
        opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1),
        transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Opening animation */
    #mobile-menu.show-links { opacity: 1; }
    #mobile-menu.show-links .mobile-menu-content {
      opacity: 1;
      transform: translateY(0);
    }

    /* Closing fade-out ONLY */
    #mobile-menu.fade-out .mobile-menu-content {
      opacity: 0;
      transform: translateY(0);
      transition: opacity 0.25s ease;
    }

    /* Black full-screen menu */
    #mobile-menu {
      background: #000000;
      color: #f9fafb;
    }

    #mobile-menu .mobile-menu-content { justify-content: flex-start; }
    #mobile-menu ul li button { font-size: 2rem; font-weight: 600; }
    #mobile-menu .menu-footer { font-size: 0.75rem; color: #9ca3af; }

    .mobile-menu-content {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .mobile-menu-content ul {
      margin-top: auto;
      margin-bottom: auto; /* centers vertically */
    }

    /* Light surfaces for main screens (Home / Guides / Upgrades) */
    #screen-home,
    #screen-experiences,
    #screen-upgrades {
      background: #f5f5f5;
      color: #020617;
    }

    /* ===== Chat UI ===== */
    #chat-box {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .msg {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0.75rem;
      animation: fadeInUp 0.35s ease-out both;
      scroll-margin-bottom: 7rem;
    }
    .msg.user { justify-content: flex-end; }
    .msg.bot  { justify-content: flex-start; }

    .msg.user > div {
      max-width: 70%;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .msg.bot > div:last-child {
      max-width: 70%;
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .bubble {
      display: inline-block;
      padding: 0.6rem 1rem;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      max-width: 100%;
      font-size: 0.95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .msg.user .bubble { background: #e5e7eb; color: #111827; }
    .msg.bot  .bubble { background: #22c55e; color: #022c22; }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      overflow: hidden;
    }
    .avatar-sandy {
      background-image: url("/static/img/sandy.png");
      background-size: cover;
      background-position: center;
      background-color: transparent;
    }
    .msg.bot .avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 1.25rem;
      margin-right: 0.5rem;
    }

    .timestamp {
      font-size: 0.65rem;
      color: #64748b;
      margin-bottom: 0.25rem;
      margin-top: 0;
    }
    .msg.bot  .timestamp { text-align: left;  align-self: flex-start; padding-left: 4px; }
    .msg.user .timestamp { text-align: right; align-self: flex-end;  padding-right: 4px; }

    .message-text p { margin: 0.5rem 0; }
    .message-text ul { margin: 0.5rem 0; padding-left: 1.2rem; }
    .message-text li { margin-bottom: 0.3rem; }
    .message-text a { color: #22c55e; text-decoration: none; word-break: break-word; }
    .message-text a:hover { text-decoration: underline; }
    .message-text strong { font-weight: 600; }
    .message-text em { font-style: italic; }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      transform: translateY(-2px);
    }
    .typing-dots span {
      width: 6px;
      height: 6px;
      margin: 0 3px;
      background-color: #022c22;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 1s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes pulse {
      0%, 100% { opacity: 0.3; transform: scale(0.7); }
      50%      { opacity: 1;   transform: scale(1); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .chat-input-bar {
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
    }
    .chat-input-inner {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      padding: 0.6rem 0.75rem;
    }
    .chat-input-bar input[type="text"] {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      outline: none;
      color: #1f2937;
    }
    .chat-plus {
      background: #0b1120;
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #e5e7eb;
    }
    .send-button {
      background: #22c55e;
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #022c22;
    }

    #screen-chat {
      color: #1f2937;
      /* do NOT set display/height; .hidden controls it */
    }
    #screen-chat > .flex-1 {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* ===== Upgrades / masonry bits ===== */
    .upgrades-carousel {
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      overflow-x: auto;
      overflow-y: hidden;
    }
    .upgrades-carousel::-webkit-scrollbar { display: none; }

    .upgrades-track { padding-left: 80px; padding-right: 80px; }

    .upgrade-slide {
      position: relative;
      flex: 0 0 auto;
      margin-right: -120px;
      transform-origin: center center;
      will-change: transform;
      cursor: pointer;
      overflow: visible;
      transition: transform 300ms cubic-bezier(0.22, 0.61, 0.36, 1), opacity 250ms ease;
    }
    .upgrade-card-inner {
      width: 280px;
      height: 360px;
      background: #ffffff;
      border-radius: 32px;
      overflow: hidden;
      border: 4px solid #ffffff;
      transform-origin: center center;
      transition: box-shadow 300ms ease, transform 300ms cubic-bezier(0.22, 0.61, 0.36, 1), opacity 250ms ease;
    }
    .upgrade-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .upgrade-slide.is-active .upgrade-card-inner {
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
      transform: scale(1);
    }
    .upgrade-slide.is-inactive .upgrade-card-inner {
      box-shadow: none;
      transform: scale(0.7) translateY(4px);
    }

    /* JS masonry columns */
    .masonry-columns {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    .masonry-col {
      flex: 1;
      min-width: 160px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .masonry-item { width: 100%; }

    /* Modal/menu safety */
    body.guide-open #top-bar-chrome,
    body.guide-open #top-bar { display: none !important; }

    body.menu-open #top-bar-chrome { display: block !important; }

    body.modal-open #mobile-menu { display: none !important; }

    body.modal-open #top-bar-chrome,
    body.modal-open #top-bar { display: none !important; }

    body.modal-open #top-bar-chrome,
    body.modal-open #mobile-menu { pointer-events: none !important; }

    .message-text pre {
      background: #0b1120;
      color: #e5e7eb;
      padding: 0.75rem;
      border-radius: 0.75rem;
      overflow-x: auto;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    .message-text code {
      background: rgba(15, 23, 42, 0.08);
      padding: 0.15rem 0.35rem;
      border-radius: 0.4rem;
    }

  </style>

  <!-- Server-injected runtime config -->
  <script>
    window.PROPERTY_ID = {{ property_id | tojson }};
    window.PROPERTY_NAME = {{ property_name | tojson }};
    window.SANDY_LIVE = {{ is_live | tojson }};
    window.SANDY_ENABLED = {{ sandy_enabled | tojson }};
    window.INITIAL_VERIFIED = {{ is_verified | tojson }};
    window.ASSISTANT_CONFIG = {{ assistant_config | tojson }};
  </script>
</head>

<body class="min-h-screen bg-[#f5f5f5] text-slate-50 flex flex-col overflow-x-hidden">
  <!-- App shell -->
  <div
    id="app-shell"
    class="relative min-h-screen w-full max-w-full flex flex-col overflow-x-hidden bg-[#f5f5f5]"
  >
    <div class="absolute inset-0 pointer-events-none"></div>

    <div class="relative z-10 flex flex-col min-h-screen">
      <!-- Top header / nav -->
      <header id="app-header" class="relative w-full">
        <!-- BOTTOM LAYER: grey bar + Sandy avatar -->
        <div
          id="top-bar"
          class="fixed top-0 inset-x-0 h-20 bg-transparent text-white transition-colors duration-300"
        >
          <div
            id="chat-header-sandy"
            class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 hidden flex flex-col items-center pointer-events-none"
          >
            <div class="avatar avatar-sandy shadow"></div>
            <span class="text-xs text-slate-900 mt-1">Sandy</span>
          </div>
        </div>

        <!-- TOP LAYER: logo + hamburger -->
        <div id="top-bar-chrome" class="fixed top-0 inset-x-0 h-20">
          <div
            id="top-bar-inner"
            class="max-w-3xl mx-auto flex items-center justify-between h-full px-5"
          >
            <a href="#" class="flex items-center gap-2" aria-label="Home">
              <img
                id="logo-img"
                src="/static/img/neat-sleeps-white.png"
                alt="{{ property_name }}"
                class="h-7"
              />
            </a>

            <button
              id="menu-toggle"
              type="button"
              class="relative w-12 h-12 flex items-center justify-center rounded-full bg-black transition-transform duration-300 ease-in-out hover:scale-125 active:scale-90"
              aria-label="Toggle navigation menu"
              aria-controls="mobile-menu"
              aria-expanded="false"
            >
              <span class="menu-toggle-middle"></span>
            </button>
          </div>
        </div>
      </header>

      <!-- Full-screen slide-down mobile menu -->
      <nav
        id="mobile-menu"
        class="fixed inset-0 transform -translate-y-full pointer-events-none transition-transform duration-700 ease-out"
        aria-label="Main navigation"
      >
        <div
          class="mobile-menu-content pt-24 pb-10 max-w-3xl mx-auto px-6 flex flex-col h-full justify-center items-center"
        >
          <ul class="space-y-8">
            <li>
              <button
                type="button"
                data-menu-screen="home"
                class="w-full hover:text-[#CCCCCC] transition-colors"
              >
                Your Stay
              </button>
            </li>
            <li>
              <button
                type="button"
                data-menu-screen="chat"
                class="w-full hover:text-[#CCCCCC] transition-colors"
              >
                Chat with Sandy
              </button>
            </li>
            <li>
              <button
                type="button"
                data-menu-screen="experiences"
                class="w-full hover:text-[#CCCCCC] transition-colors"
              >
                Guides
              </button>
            </li>
            <li>
              <button
                type="button"
                data-menu-screen="upgrades"
                class="w-full hover:text-[#CCCCCC] transition-colors"
              >
                Upgrades
              </button>
            </li>
          </ul>

          <div class="mt-auto pt-8 menu-footer">
            <a
              href="https://www.hostscout.ai/"
              target="_blank"
              rel="noopener noreferrer"
              class="text-[12px] text-[#9ca3af] hover:text-white transition"
            >
              Powered by HostScout.AI
            </a>
          </div>
        </div>
      </nav>

      <!-- Main content area -->
      <main id="screen-container" class="flex-1 flex flex-col" role="main">
        <!-- HOME -->
        <section
          id="screen-home"
          class="flex flex-col flex-1 bg-[#f4f4f4] text-[0.95rem] px-4 pt-20"
          aria-label="Home"
        >
          <!-- LOGIN STATE -->
          <div id="home-login" class="space-y-4">
            <div class="space-y-2">
              <h2 class="font-semibold text-slate-900">Unlock your stay</h2>
              <p class="text-slate-500">
                Enter the
                <span class="font-semibold">last 4 digits of the phone number</span>
                on your booking to unlock your trip details, chat with Sandy, and
                browse guides.
              </p>
            </div>

            <div class="bg-white rounded-3xl p-4 space-y-3 shadow-sm">
              <label for="unlock-code" class="block font-medium text-slate-700 mb-1">
                Last 4 digits
              </label>

              <input
                id="unlock-code"
                type="text"
                inputmode="numeric"
                maxlength="4"
                autocomplete="off"
                placeholder="1234"
                pattern="[0-9]*"
                class="w-full rounded-2xl bg-slate-50 border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"
              />

              <button
                id="unlock-button"
                type="button"
                data-property-id="{{ property_id }}"
                class="w-full mt-1 inline-flex justify-center items-center gap-2 rounded-2xl bg-slate-900 hover:bg-slate-800 font-semibold text-slate-50 py-3 transition"
              >
                <span>Unlock experience</span>
                <span
                  id="unlock-spinner"
                  class="hidden w-4 h-4 border-2 border-slate-50 border-t-transparent rounded-full animate-spin"
                ></span>
              </button>

              <p id="unlock-error" class="text-rose-500 min-h-[1.125rem]" aria-live="polite"></p>

              <p class="text-slate-500 text-xs">
                Not sure which number is on the booking? Check your confirmation email
                or message your host.
              </p>
            </div>

            <div class="mt-2 text-slate-500 flex items-center gap-2 text-xs">
              {% if is_live %}
                <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                <span>Sandy is live for this property ðŸŒŠ</span>
              {% else %}
                <span class="h-2 w-2 rounded-full bg-rose-500"></span>
                <span>Sandy is currently offline â€“ you can still view trip details.</span>
              {% endif %}
            </div>
          </div>

          <!-- UNLOCKED HOME -->
          <div class="flex-1 flex flex-col justify-start">
            <div id="home-stay" class="hidden pt-0">
              <!-- Top labels / heading -->
              <div class="text-center pb-3">
                <p class="text-[11px] font-semibold text-[#666666]">
                  Casa {{ property_name or "Your stay" }}
                </p>
                <h1 class="mt-2 text-[32px] font-semibold text-[#000000] leading-tight">
                  <span class="guest-name">{{ reservation_name or "Guest" }}</span>, breathe.<br />
                  Youâ€™ve made it.
                </h1>
              </div>

              <!-- Image card -->
              <div class="w-full flex justify-center mt-2 px-6">
                <div
                  class="bg-white rounded-[32px] shadow-[0_10px_20px_rgba(0,0,0,0.35)] overflow-hidden w-full border-[4px] border-[#FFFFFF]"
                >
                  <div class="h-[430px] w-full overflow-hidden">
                    <img
                      src="{{ hero_image_url or default_image_url }}"
                      alt="{{ property_name }}"
                      class="w-full h-full object-cover"
                    />
                  </div>
                </div>
              </div>

              <!-- Details + buttons -->
              <div class="mt-8 space-y-8">
                <!-- Arrival / Departure -->
                <div class="max-w-[360px] mx-auto flex items-start justify-between text-center text-sm">
                  <div class="flex-1 pr-2">
                    <p class="text-[11px] font-semibold text-[#666666] text-right">Arrival</p>
                    <p id="arrival-date-span" class="mt-1 text-[20px] font-semibold text-[#000000] text-right">
                      {{ arrival_date or "-" }}
                    </p>
                    <p id="checkin-time-span" class="mt-1 text-[20px] font-semibold text-[#000000] text-right pt-1">
                      {{ checkin_time or "4:00 PM" }}
                    </p>
                  </div>

                  <div class="flex-1 pl-2">
                    <p class="text-[11px] font-semibold text-[#666666] text-left">Departure</p>
                    <p id="departure-date-span" class="mt-1 text-[20px] font-semibold text-[#000000] text-left">
                      {{ departure_date or "-" }}
                    </p>
                    <p id="checkout-time-span" class="mt-1 text-[20px] font-semibold text-[#000000] text-left pt-1">
                      {{ checkout_time or "10:00 AM" }}
                    </p>
                  </div>
                </div>

                <!-- Door / WiFi buttons -->
                <div class="max-w-[360px] mx-auto grid grid-cols-2 gap-5">
                  <button
                    id="checkin-button"
                    type="button"
                    class="w-full border border-slate-900 rounded-[999px] py-4 text-[15px] font-semibold bg-white text-slate-900 hover:bg-black hover:text-white transition-colors duration-200"
                  >
                    Door
                  </button>

                  <button
                    id="wifi-button"
                    type="button"
                    class="w-full border border-slate-900 rounded-[999px] py-4 text-[15px] font-semibold bg-white text-slate-900 hover:bg-black hover:text-white transition-colors duration-200"
                  >
                    WiFi
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- CHAT -->
        <section id="screen-chat" class="hidden bg-white min-h-screen" aria-label="Chat">
          <div id="chat-box" class="px-4 pt-4 pb-40 space-y-2 bg-white text-slate-800"></div>

          <div
            id="quick-replies-bar"
            class="hidden fixed left-0 right-0 bottom-[4.6rem] z-[29] px-4 py-3 bg-slate-50/95 backdrop-blur border-t border-slate-200"
          >
            <div id="quick-replies-track" class="flex gap-2 overflow-x-auto"></div>
          </div>

          <div id="suggestions-drawer" class="hidden fixed inset-0 z-[400] bg-black/40">
            <div
              class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl p-4 max-h-[60vh] overflow-y-auto"
            >
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-900">Suggestions</h3>
                <button id="suggestions-close" class="text-slate-900 text-2xl leading-none">Ã—</button>
              </div>
              <div id="suggestions-list" class="space-y-2"></div>
            </div>
          </div>

          <div class="chat-input-bar">
            <div class="chat-input-inner">
              <button type="button" class="chat-plus" aria-label="Insert a suggested question">+</button>
              <input id="chat-input" type="text" placeholder="Type a message here..." aria-label="Chat message" />
              <button id="chat-send" type="button" class="send-button" aria-label="Send message">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.6"
                    d="M12 19V5M6.5 10.5L12 5l5.5 5.5"
                  />
                </svg>
              </button>
            </div>
          </div>
        </section>

        <!-- GUIDES -->
        <section
          id="screen-experiences"
          class="hidden bg-[#f5f5f5] px-4 pt-24 pb-24 space-y-6"
          aria-label="Guides and local tips"
        >
          <div class="text-center pb-3">
            <p class="text-[11px] font-semibold text-[#666666]">
              Casa {{ property_name or "Your stay" }}
            </p>

            <h1 class="mt-2 text-[32px] font-semibold text-[#000000] leading-tight">
              Your stay just got<br />easier,
              <span class="guest-name">{{ reservation_name or "Guest" }}</span>.
            </h1>
          </div>

          <!-- Filters row -->
          <div class="flex items-center gap-2 overflow-x-auto pb-1 pt-1 text-[11px] justify-center">
            <button
              type="button"
              class="guide-filter whitespace-nowrap px-3 py-1.5 rounded-full border border-slate-300 bg-white text-slate-900 inline-flex items-center gap-1"
              data-filter="all"
            >
              <span>All</span>
            </button>

            <div id="guides-filters" class="flex gap-2 overflow-x-auto pb-1 pt-1 text-[11px]"></div>
          </div>

          <!-- Guides grid: injected by JS -->
          <div id="guides-grid" class="masonry-columns"></div>

          <p id="guides-empty-state" class="hidden text-xs text-slate-500 mt-4">
            We donâ€™t have any guides yet for this stay. Check back soon or ask Sandy for local tips.
          </p>
        </section>

        <!-- UPGRADES -->
        <section
          id="screen-upgrades"
          class="hidden bg-[#f5f5f5] flex flex-col flex-1 text-[0.95rem] px-4 pt-24"
          aria-label="Upgrades"
        >
          <div class="text-center pb-3">
            <p class="text-[11px] font-semibold text-[#666666]">
              Casa {{ property_name or "Your stay" }}
            </p>
            <h1 class="mt-2 text-[32px] font-semibold text-[#000000] leading-tight">
              Upgrades youâ€™ll love,<br />
              <span class="guest-name">{{ reservation_name or "Guest" }}</span>.
            </h1>
          </div>

          <!-- Beats-style carousel shell -->
          <div id="upgrades-carousel" class="upgrades-carousel relative w-full max-w-[420px] mx-auto overflow-x-auto">
            <div class="upgrades-track flex items-center h-[420px] pt-6 pb-4">
              {% if upgrades and upgrades|length > 0 %}
                {% for up in upgrades %}
                  {% set slug = up.slug or "" %}
                  {% set title_lower = (up.title or "")|lower %}
                  {% set is_time_flex =
                        slug in ["early-check-in", "late-checkout", "late-check-out"]
                        or "early check" in title_lower
                        or "late check" in title_lower
                  %}
                  {% if same_day_turnover and is_time_flex %}
                    {# skip time-flex on same-day turnover #}
                  {% else %}
                   <button
        type="button"
        class="upgrade-slide upgrade-card relative shrink-0 text-left focus:outline-none"
        data-upgrade-id="{{ up.id }}"
        data-upgrade-title="{{ up.title }}"
        data-upgrade-price="{{ up.price_display or '' }}"
      >
        <div
          class="upgrade-card-inner w-[280px] h-[360px] bg-white"
        >
          {% if up.image_url %}
            <img
              src="{{ up.image_url }}"
              alt="{{ up.title }}"
              class="w-full h-full object-cover"
            />
          {% else %}
            <img
              src="{{ hero_image_url or default_image_url }}"
              alt="{{ up.title }}"
              class="w-full h-full object-cover"
            />
          {% endif %}
        </div>
      
        <!-- hidden long copy so JS can read it -->
        <p class="hidden upgrade-long">
          {{ up.long_description or up.short_description }}
        </p>
      </button>

                  {% endif %}
                {% endfor %}
              {% else %}
                <p class="text-xs text-slate-500">Upgrades arenâ€™t available for this stay yet.</p>
              {% endif %}
            </div>
          </div>

          <div id="upgrade-active-info" class="text-center hidden">
            <h3 id="upgrade-active-title" class="text-[20px] font-semibold text-[#000000]"></h3>
            <p
              id="upgrade-active-description"
              class="text-[14px] leading-relaxed text-[#000000] max-w-xs mx-auto pt-2"
            ></p>
          </div>

          <div id="upgrade-active-cta" class="mt-6 flex justify-center hidden">
            <button
              id="upgrade-active-button"
              type="button"
              class="inline-flex items-center justify-center rounded-[999px] border border-[#020617] px-10 py-4 text-[15px] font-semibold bg-white text-[#020617] hover:bg-black hover:text-white transition-colors duration-200"
            >
              <span id="upgrade-active-button-label">$0.00 â€“ Purchase</span>
            </button>
          </div>
        </section>

        <!-- UPGRADE DETAIL -->
        <div id="upgrade-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[500]">
          <section
            id="screen-upgrade-detail"
            class="bg-[#f5f5f5] text-slate-900 flex flex-col min-h-screen w-full"
            aria-label="Upgrade details"
          >
            <div class="relative h-64 w-full overflow-hidden">
              <img
                id="upgrade-detail-image"
                src="{{ hero_image_url or default_image_url }}"
                alt=""
                class="w-full h-full object-cover"
              />
              <button
                id="upgrade-modal-close"
                type="button"
                class="absolute top-6 right-5 w-9 h-9 rounded-full bg-black/80 flex items-center justify-center text-slate-50 text-xl leading-none z-[510]"
              >
                Ã—
              </button>
            </div>

            <div class="px-6 pt-6 pb-32 flex-1 overflow-y-auto">
              <h2 id="upgrade-detail-title" class="text-2xl font-semibold leading-tight">Upgrade title</h2>

              <p
                id="upgrade-detail-body"
                class="mt-4 text-sm text-slate-800 leading-relaxed whitespace-pre-line"
              >
                Full description goes here.
              </p>

              <div class="mt-8 border border-slate-200 rounded-2xl p-4">
                <p class="text-[11px] uppercase tracking-[0.2em] text-slate-500 mb-2">Your upgrade</p>
                <div class="flex items-center justify-between text-sm">
                  <span id="upgrade-detail-name" class="font-medium">Upgrade name</span>
                  <span id="upgrade-detail-price" class="font-semibold">$0.00</span>
                </div>
              </div>
            </div>

            <div
              class="fixed bottom-0 left-0 right-0 px-4 pb-6 pt-3 bg-[#f5f5f5]/95 backdrop-blur-sm shadow-[0_-12px_30px_rgba(15,23,42,0.18)]"
            >
              <button
                id="upgrade-detail-purchase"
                type="button"
                class="w-full rounded-full py-3 text-sm font-semibold bg-slate-900 text-slate-50"
              >
                <span id="upgrade-detail-price-bottom">$0.00 â€“ Purchase</span>
              </button>
            </div>
          </section>
        </div>

        <!-- WiFi modal -->
        <div
          id="wifi-modal"
          class="fixed inset-0 z-[500] bg-black hidden items-center justify-center px-6"
          role="dialog"
          aria-modal="true"
          aria-labelledby="wifi-ssid"
        >
          <div class="absolute top-4 right-4">
            <button
              id="wifi-close"
              type="button"
              class="absolute top-1 right-1 w-12 h-12 rounded-full bg-white text-black flex items-center justify-center text-[32px] leading-none z-[510]"
              aria-label="Close"
            >
              <span class="relative -top-[2px]">Ã—</span>
            </button>
          </div>

          <div class="text-center max-w-xs mx-auto">
            <div>
              <p id="wifi-network-title" class="text-[14px] text-[#CCCCCC] font-semibold uppercase">
                WiFi Network
              </p>
              <p id="wifi-ssid" class="mt-1 text-[40px] font-semibold text-white break-all">
                {{ wifi_ssid if wifi_ssid is defined and wifi_ssid else "Blueshore-5G" }}
              </p>

              <p id="wifi-password-title" class="text-[14px] text-[#CCCCCC] font-semibold uppercase pt-3">
                Password
              </p>
              <p id="wifi-password" class="mt-1 text-[40px] font-semibold text-white break-all">
                {{ wifi_password if wifi_password is defined and wifi_password else "Shore6345" }}
              </p>
            </div>

            <p id="copy-title" class="text-[14px] text-[#CCCCCC] pt-3 font-semibold">
              Tap and hold to copy on most devices.
            </p>
          </div>
        </div>

        <!-- Check-in modal -->
        <div
          id="checkin-modal"
          class="fixed inset-0 z-[500] bg-black hidden items-center justify-center px-6"
          role="dialog"
          aria-modal="true"
          aria-labelledby="checkin-title"
        >
          <div class="absolute top-4 right-4">
            <button
              id="checkin-close"
              type="button"
              class="absolute top-1 right-1 w-12 h-12 rounded-full bg-white text-black flex items-center justify-center text-[32px] leading-none z-[510]"
              aria-label="Close"
            >
              <span class="relative -top-[2px]">Ã—</span>
            </button>
          </div>

          <div class="text-center space-y-4">
            <p id="checkin-title" class="text-[14px] text-[#CCCCCC] font-semibold uppercase">Your door code</p>
            <p id="checkin-code" class="text-[80px] text-white font-semibold">----</p>
            <p class="text-[14px] text-[#CCCCCC] font-semibold max-w-xs mx-auto">
              This code matches the last 4 digits of the phone number on your reservation.
              Enter it slowly on the keypad. If the lock gives you trouble, contact your host.
            </p>
          </div>
        </div>

        <!-- GUIDE DETAIL -->
        <div id="guide-modal" class="fixed inset-0 hidden bg-[#f5f5f5] z-[500] overflow-hidden">
          <section
            id="screen-guide-detail"
            class="relative flex flex-col h-full w-full text-slate-900 overflow-hidden"
            aria-label="Guide details"
          >
            <button
              id="guide-modal-close"
              type="button"
              class="absolute top-4 right-5 w-12 h-12 rounded-full bg-black text-white flex items-center justify-center text-[32px] leading-none z-[510]"
              aria-label="Close"
            >
              <span class="relative -top-[2px]">Ã—</span>
            </button>

            <div class="flex-1 overflow-y-auto pt-28 pb-16 px-8">
              <div class="max-w-[24rem] mx-auto">
                <h2 id="guide-modal-title" class="text-[30px] font-semibold leading-tight tracking-tight">Headline</h2>
                <p
                  id="guide-modal-body"
                  class="mt-8 text-[16px] font-semibold leading-[1.40] text-black whitespace-pre-line"
                >
                  Full description goes here.
                </p>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

      
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Normalize Sandy live flag (boolean-safe)
    const sandyLive = window.SANDY_LIVE === true || window.SANDY_LIVE === "true";

    // --- Screens + core elements ---
    const screens = {
      home: document.getElementById("screen-home"),
      chat: document.getElementById("screen-chat"),
      experiences: document.getElementById("screen-experiences"),
      upgrades: document.getElementById("screen-upgrades"),
    };

    const sandyEnabled = window.SANDY_ENABLED === true || window.SANDY_ENABLED === "true";
    if (!sandyEnabled) {
      document.body.innerHTML = `
        <div class="min-h-screen bg-[#f5f5f5] flex items-center justify-center p-6">
          <div class="max-w-md w-full bg-white rounded-3xl p-6 shadow-sm text-center">
            <h1 class="text-2xl font-semibold text-slate-900">Guest experience unavailable</h1>
            <p class="mt-3 text-slate-600">This property hasnâ€™t enabled Sandy yet. Please contact your host.</p>
          </div>
        </div>`;
      return;
    }

    const LOGO_WHITE = "/static/img/neat-sleeps-white.png";
    const LOGO_BLACK = "/static/img/neat-sleeps-black.png";

    // helper: are we currently on the chat screen?
    function isChatVisible() {
      const chatScreen = screens.chat;
      return chatScreen && !chatScreen.classList.contains("hidden");
    }

    // --- Core UI refs ---
    const homeLogin = document.getElementById("home-login");
    const homeStay = document.getElementById("home-stay");

    // Chat logic refs (MUST be defined before quick replies wiring)
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const chatPlus = document.querySelector(".chat-plus");

    // âœ… Assistant config from config.json (injected by server)
    const assistantCfg = window.ASSISTANT_CONFIG || {};
    const assistantName = assistantCfg.name || "Sandy";
    const voiceCfg = assistantCfg.voice || {};
    const quickReplies = Array.isArray(assistantCfg.quick_replies) ? assistantCfg.quick_replies : [];

    // --- Guides / experiences (local tips) ---
    const guidesGrid = document.getElementById("guides-grid");
    const guidesEmptyState = document.getElementById("guides-empty-state");
    const guidesFiltersContainer = document.getElementById("guides-filters");

    const guideModal = document.getElementById("guide-modal");
    const guideModalClose = document.getElementById("guide-modal-close");
    const guideModalTitle = document.getElementById("guide-modal-title");
    const guideModalBody = document.getElementById("guide-modal-body");

    const guidesState = {
      loaded: false,
      loading: false,
      guides: [],
      activeFilter: "all",
    };

    // --- Global state ---
    let isUnlocked = !!window.INITIAL_VERIFIED;
    let lastUnlockCode = null;
    let currentSessionId = null;
    let guestName = null;
    let arrivalDate = null;
    let departureDate = null;
    let checkinTime = null;
    let checkoutTime = null;

    let chatHasWelcome = false;
    let guidesAbortController = null;

    // Keep guest name in sync across UI
    function updateGuestNameInUI(name) {
      document.querySelectorAll(".guest-name").forEach((el) => {
        el.textContent = name || "Guest";
      });
    }

    // --- Guest state persistence ---
    const GUEST_STATE_KEY = `guest_state_${window.PROPERTY_ID}`;

    function saveGuestState() {
      try {
        const state = {
          isUnlocked,
          lastUnlockCode,
          sessionId: currentSessionId,
          guestName,
          arrivalDate,
          departureDate,
          checkinTime,
          checkoutTime,
        };
        window.localStorage.setItem(GUEST_STATE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("Unable to save guest state:", e);
      }
    }

    function formatDateLong(dateStr) {
      if (!dateStr) return "-";
      const date = new Date(dateStr + "T00:00:00");
      return date.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      });
    }

    function loadGuestState() {
      try {
        const raw = window.localStorage.getItem(GUEST_STATE_KEY);
        if (!raw) return null;

        const state = JSON.parse(raw);
        if (!state || typeof state !== "object") return null;

        const today = new Date().toISOString().slice(0, 10);
        if (state.departureDate && typeof state.departureDate === "string" && state.departureDate < today) {
          window.localStorage.removeItem(GUEST_STATE_KEY);
          return null;
        }

        if (state.isUnlocked === true) isUnlocked = true;
        if (state.lastUnlockCode) lastUnlockCode = state.lastUnlockCode;
        if (state.sessionId) currentSessionId = state.sessionId;

        if (state.guestName) {
          guestName = state.guestName;
          updateGuestNameInUI(guestName);
        }

        if (state.arrivalDate) {
          arrivalDate = state.arrivalDate;
          const el = document.getElementById("arrival-date-span");
          if (el) el.textContent = formatDateLong(arrivalDate);
        }

        if (state.departureDate) {
          departureDate = state.departureDate;
          const el = document.getElementById("departure-date-span");
          if (el) el.textContent = formatDateLong(departureDate);
        }

        if (state.checkinTime) {
          checkinTime = state.checkinTime;
          const el = document.getElementById("checkin-time-span");
          if (el) el.textContent = checkinTime;
        }

        if (state.checkoutTime) {
          checkoutTime = state.checkoutTime;
          const el = document.getElementById("checkout-time-span");
          if (el) el.textContent = checkoutTime;
        }

        return state;
      } catch (err) {
        console.warn("Failed to load guest state:", err);
        return null;
      }
    }

    loadGuestState();

    function updateHomeState() {
      if (isUnlocked) {
        homeLogin?.classList.add("hidden");
        homeStay?.classList.remove("hidden");
      } else {
        homeLogin?.classList.remove("hidden");
        homeStay?.classList.add("hidden");
      }
    }

    // --- Top bar sliding menu nav ---
    const topBar = document.getElementById("top-bar");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuToggle = document.getElementById("menu-toggle");
    const logoImg = document.getElementById("logo-img");
    const menuLinks = document.querySelectorAll("[data-menu-screen]");
    let isMenuOpen = false;

    const MOBILE_MENU_SLIDE_DURATION = 700;

    function swapLogoWithFade(newSrc) {
      if (!logoImg) return;
      const currentSrc = logoImg.getAttribute("src");
      if (currentSrc === newSrc) return;

      logoImg.style.opacity = "0";
      setTimeout(() => {
        logoImg.src = newSrc;
        logoImg.style.opacity = "1";
      }, 120);
    }

    function openMenu() {
      if (!mobileMenu) return;
      isMenuOpen = true;

      mobileMenu.classList.remove("fade-out");
      mobileMenu.classList.remove("-translate-y-full", "pointer-events-none");
      mobileMenu.classList.add("translate-y-0");

      topBar?.classList.remove("bg-transparent", "text-white");
      topBar?.classList.add("bg-slate-50", "text-slate-900");

      swapLogoWithFade(LOGO_BLACK);
      menuToggle?.classList.add("menu-toggle-open");
      document.body.classList.add("menu-open");
      menuToggle?.setAttribute("aria-expanded", "true");

      setTimeout(() => {
        if (isMenuOpen && mobileMenu) mobileMenu.classList.add("show-links");
      }, MOBILE_MENU_SLIDE_DURATION);
    }

    function closeMenu() {
      if (!mobileMenu) return;
      isMenuOpen = false;

      mobileMenu.classList.add("fade-out");
      mobileMenu.classList.remove("show-links");

      topBar?.classList.add("bg-transparent", "text-white");
      topBar?.classList.remove("bg-slate-50", "text-slate-900");

      if (document.body.classList.contains("chat-screen")) swapLogoWithFade(LOGO_BLACK);
      else swapLogoWithFade(LOGO_WHITE);

      menuToggle?.classList.remove("menu-toggle-open");
      document.body.classList.remove("menu-open");
      menuToggle?.setAttribute("aria-expanded", "false");

      setTimeout(() => {
        if (!isMenuOpen && mobileMenu) {
          mobileMenu.classList.add("-translate-y-full", "pointer-events-none");
          mobileMenu.classList.remove("translate-y-0", "fade-out");
        }
      }, MOBILE_MENU_SLIDE_DURATION);
    }

    menuToggle?.addEventListener("click", () => {
      if (isMenuOpen) closeMenu();
      else openMenu();
    });

    // --- Chat rendering helpers ---
    function scrollChatToBottom() {
      if (!isChatVisible()) return;

      requestAnimationFrame(() => {
        const docEl = document.documentElement;
        const body = document.body;

        const fullHeight = Math.max(
          docEl.scrollHeight,
          body.scrollHeight,
          docEl.offsetHeight,
          body.offsetHeight
        );

        window.scrollTo({ top: fullHeight, behavior: "auto" });
      });
    }

    function formatTime(date) {
      let hours = date.getHours();
      const minutes = date.getMinutes().toString().padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      if (hours === 0) hours = 12;
      return `${hours.toString().padStart(2, "0")}:${minutes} ${ampm}`;
    }

    function formatMessage(text) {
      const raw = String(text || "");
    
      // 1) Pre-process: replace Google Maps URLs with a friendly link label
      const withMapLinks = raw.replace(
        /(https:\/\/www\.google\.com\/maps[^\s]+)/g,
        `[ðŸ“ View on Google Maps]($1)`
      );
    
      // 2) Markdown -> HTML (ChatGPT-like formatting)
      const html = marked.parse(withMapLinks, {
        breaks: true,   // convert single newlines to <br>
        gfm: true
      });
    
      // 3) Sanitize the HTML for safety
      const clean = DOMPurify.sanitize(html, {
        USE_PROFILES: { html: true },
        FORBID_TAGS: ["script", "iframe", "object", "embed"],
        FORBID_ATTR: ["onerror", "onclick", "onload"],
      });
    
      // 4) Ensure links open in new tab safely (marked doesn't always add these)
      const withSafeTargets = clean.replace(
        /<a\s+([^>]*href="[^"]+"[^>]*)>/g,
        (match, attrs) => {
          const hasTarget = /target=/.test(attrs);
          const hasRel = /rel=/.test(attrs);
          let out = `<a ${attrs}`;
          if (!hasTarget) out += ` target="_blank"`;
          if (!hasRel) out += ` rel="noopener noreferrer"`;
          out += `>`;
          return out;
        }
      );
    
      return withSafeTargets;
    }


    function renderMessage(text, sender) {
      if (!chatBox) return;

      const isUser = sender === "user";
      const ts = formatTime(new Date());

      const row = document.createElement("div");
      row.className = "msg " + (isUser ? "user" : "bot");

      let avatar = null;
      if (!isUser) {
        avatar = document.createElement("div");
        avatar.className = "avatar avatar-sandy";
      }

      const column = document.createElement("div");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<div class="message-text">${formatMessage(text)}</div>`;

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = ts;

      column.appendChild(time);
      column.appendChild(bubble);

      if (isUser) row.appendChild(column);
      else {
        row.appendChild(avatar);
        row.appendChild(column);
      }

      chatBox.appendChild(row);
      scrollChatToBottom();
    }

    //console.log("assistantName=", assistantName);
    //console.log("template=", template);
   //console.log("intro(before trim)=", intro);


    function addTyping() {
      if (!chatBox || document.getElementById("typing-indicator")) return;

      const row = document.createElement("div");
      row.id = "typing-indicator";
      row.className = "msg bot";

      const avatar = document.createElement("div");
      avatar.className = "avatar avatar-sandy";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `
        <span class="typing-dots">
          <span> </span><span> </span><span> </span>
        </span>
      `;

      const column = document.createElement("div");
      column.appendChild(bubble);

      row.appendChild(avatar);
      row.appendChild(column);

      chatBox.appendChild(row);
      scrollChatToBottom();
    }

    function removeTyping() {
      document.getElementById("typing-indicator")?.remove();
    }

    function getSelectedLanguage() {
      return "auto";
    }

    async function sendChat() {
      const text = (chatInput?.value || "").trim();
      if (!text) return;

      if (!sandyLive) {
        renderMessage(
          "Sandy is currently offline for this property. Please contact your host directly. ðŸ™",
          "bot"
        );
        return;
      }

      renderMessage(text, "user");
      if (chatInput) chatInput.value = "";
      addTyping();

      try {
        const body = {
          message: text,
          session_id: currentSessionId,
          language: getSelectedLanguage(),
        };

        const res = await fetch(`/properties/${window.PROPERTY_ID}/chat?stream=1`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(body),
        });

        const data = await res.json();
        removeTyping();

        if (data.session_id) {
          currentSessionId = data.session_id;
          saveGuestState();
        }

        if (data.error) renderMessage(data.error, "bot");
        else
          renderMessage(
            data.response || voiceCfg.fallback_message || "Could you try that again?",
            "bot"
          );
      } catch (err) {
        console.error(err);
        removeTyping();
        renderMessage(voiceCfg.error_message || "Something went wrong. Please try again.", "bot");
      }
    }

    if (chatSend && chatInput) {
      chatSend.addEventListener("click", sendChat);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });
    }

    // --- Quick replies + suggestions drawer ---
    const quickBar = document.getElementById("quick-replies-bar");
    const quickTrack = document.getElementById("quick-replies-track");
    const drawer = document.getElementById("suggestions-drawer");
    const drawerList = document.getElementById("suggestions-list");
    const drawerClose = document.getElementById("suggestions-close");

    function renderQuickReplies() {
      if (!quickTrack) return;
      quickTrack.innerHTML = "";

      quickReplies.slice(0, 10).forEach((label) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "px-3 py-2 rounded-full bg-white border border-slate-200 text-slate-900 text-sm font-semibold whitespace-nowrap";
        btn.textContent = label;
        btn.addEventListener("click", () => {
          if (!chatInput) return;
          chatInput.value = label;
          sendChat();
        });
        quickTrack.appendChild(btn);
      });
    }

    function showQuickReplies(show) {
      if (!quickBar) return;

      if (!show || !quickReplies.length) {
        quickBar.classList.add("hidden");
        return;
      }

      renderQuickReplies();
      quickBar.classList.remove("hidden");
    }

    function openSuggestions() {
      if (!drawer || !drawerList) return;

      drawerList.innerHTML = "";
      quickReplies.forEach((label) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "w-full text-left px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200 font-semibold text-slate-900";
        btn.textContent = label;
        btn.addEventListener("click", () => {
          closeSuggestions();
          if (!chatInput) return;
          chatInput.value = label;
          sendChat();
        });
        drawerList.appendChild(btn);
      });

      drawer.classList.remove("hidden");
    }

    function closeSuggestions() {
      drawer?.classList.add("hidden");
    }

    drawer?.addEventListener("click", (e) => {
      if (e.target === drawer) closeSuggestions();
    });
    drawerClose?.addEventListener("click", closeSuggestions);
    chatPlus?.addEventListener("click", openSuggestions);

    // --- Guides (same logic as you had) ---
    function createGuideCard(guide, index) {
      let minHeight;
      if (index % 4 === 0) minHeight = "320px";
      else if (index % 2 === 0) minHeight = "240px";
      else minHeight = "180px";

      const card = document.createElement("button");
      card.type = "button";
      card.className =
        "masonry-item group relative overflow-hidden rounded-[24px] bg-slate-200 shadow-sm " +
        "focus:outline-none focus:ring-2 focus:ring-slate-900 transition-transform active:scale-95 text-left w-full";
      card.style.minHeight = minHeight;

      const imageUrl =
        guide.image_url || "{{ experiences_hero_url or hero_image_url or default_image_url }}";

      const img = document.createElement("img");
      img.src = imageUrl;
      img.alt = guide.title || "Guide";
      img.className =
        "absolute inset-0 h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]";
      card.appendChild(img);

      const overlay = document.createElement("div");
      overlay.className =
        "absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent";
      card.appendChild(overlay);

      const textWrap = document.createElement("div");
      textWrap.className = "absolute inset-x-3 bottom-3 text-left text-white space-y-1";
      card.appendChild(textWrap);

      const titleEl = document.createElement("h2");
      titleEl.className = "text-[13px] font-semibold leading-tight line-clamp-2";
      titleEl.textContent = guide.title || "Guide";
      textWrap.appendChild(titleEl);

      if (guide.category) {
        const catEl = document.createElement("p");
        catEl.className = "text-[10px] opacity-80";
        catEl.textContent = guide.category;
        textWrap.appendChild(catEl);
      }

      card.addEventListener("click", () => openGuideModalFromGuide(guide));
      return card;
    }

    function openGuideModalFromGuide(guide) {
      if (!guideModal) return;
      closeMenu();

      if (guideModalTitle) guideModalTitle.textContent = guide.title || "Guide";

      if (guideModalBody) {
        if (guide.body_html) {
          guideModalBody.innerHTML = DOMPurify.sanitize(guide.body_html, {
            USE_PROFILES: { html: true },
            FORBID_TAGS: ["script", "iframe", "object", "embed"],
            FORBID_ATTR: ["onerror", "onclick", "onload"],
          });
          guideModalBody.classList.remove("whitespace-pre-line");
        } else if (guide.long_description) {
          guideModalBody.textContent = guide.long_description;
          guideModalBody.classList.add("whitespace-pre-line");
        } else if (guide.short_description) {
          guideModalBody.textContent = guide.short_description;
          guideModalBody.classList.add("whitespace-pre-line");
        } else {
          guideModalBody.textContent = "";
          guideModalBody.classList.add("whitespace-pre-line");
        }
      }

      guideModal.classList.remove("hidden");
      guideModal.classList.add("flex");
      document.body.classList.add("overflow-hidden", "guide-open");
      document.documentElement.classList.add("overflow-hidden");

      const scroller = guideModal.querySelector(".overflow-y-auto");
      if (scroller) scroller.scrollTop = 0;
    }

    function closeGuideModal() {
      if (!guideModal) return;
      guideModal.classList.add("hidden");
      guideModal.classList.remove("flex");
      document.body.classList.remove("overflow-hidden", "guide-open");
      document.documentElement.classList.remove("overflow-hidden");
    }

    guideModalClose?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeGuideModal();
    });

    guideModal?.addEventListener("click", (e) => {
      if (e.target === guideModal) closeGuideModal();
    });

    function buildGuideFiltersFromGuides(guides) {
      if (!guidesFiltersContainer) return;

      const categories = [
        ...new Set(
          guides
            .map((g) => g.category)
            .filter((c) => typeof c === "string" && c.trim() !== "")
        ),
      ];

      guidesFiltersContainer.innerHTML = "";

      categories.forEach((category) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.filter = category;
        btn.textContent = category;
        btn.className =
          "guide-filter whitespace-nowrap px-3 py-1.5 rounded-full border border-slate-300 bg-white text-slate-900 text-[11px]";
        btn.addEventListener("click", () => {
          guidesState.activeFilter = category;
          updateGuideFilterStates();
          renderGuidesGrid();
        });
        guidesFiltersContainer.appendChild(btn);
      });

      const allBtn = document.querySelector('button.guide-filter[data-filter="all"]');
      allBtn?.addEventListener("click", () => {
        guidesState.activeFilter = "all";
        updateGuideFilterStates();
        renderGuidesGrid();
      });

      updateGuideFilterStates();
    }

    function updateGuideFilterStates() {
      const buttons = document.querySelectorAll(".guide-filter");
      const active = guidesState.activeFilter;

      buttons.forEach((btn) => {
        const filter = btn.dataset.filter;
        const isActive = active === "all" ? filter === "all" : filter === active;

        if (isActive) {
          btn.classList.add("bg-slate-900", "text-white", "border-slate-900");
          btn.classList.remove("bg-white", "text-slate-900", "border-slate-300");
        } else if (filter !== "all") {
          btn.classList.add("bg-white", "text-slate-900", "border-slate-300");
          btn.classList.remove("bg-slate-900", "text-white", "border-slate-900");
        }
      });
    }

    function getMasonryColumnCount() {
      return window.matchMedia("(min-width: 768px)").matches ? 3 : 2;
    }

    function renderGuidesGrid() {
      if (!guidesGrid) return;

      guidesGrid.innerHTML = "";

      const filter = guidesState.activeFilter;
      const visible =
        filter === "all"
          ? guidesState.guides
          : guidesState.guides.filter((g) => g.category === filter);

      if (!visible.length) {
        guidesEmptyState?.classList.remove("hidden");
        return;
      }
      guidesEmptyState?.classList.add("hidden");

      const colCount = getMasonryColumnCount();
      const cols = [];

      for (let i = 0; i < colCount; i++) {
        const col = document.createElement("div");
        col.className = "masonry-col";
        guidesGrid.appendChild(col);
        cols.push(col);
      }

      visible.forEach((guide, index) => {
        const card = createGuideCard(guide, index);
        cols[index % cols.length].appendChild(card);
      });
    }

    window.addEventListener("resize", () => {
      if (screens?.experiences && !screens.experiences.classList.contains("hidden")) {
        renderGuidesGrid();
      }
    });

    async function loadGuidesIfNeeded() {
      if (guidesState.loaded || guidesState.loading) return;

      guidesState.loading = true;

      if (guidesAbortController) guidesAbortController.abort();
      guidesAbortController = new AbortController();

      try {
        guidesEmptyState?.classList.add("hidden");
        if (guidesEmptyState) {
          guidesEmptyState.textContent =
            "We donâ€™t have any guides yet for this stay. Check back soon or ask Sandy for local tips.";
        }

        const res = await fetch(`/properties/${window.PROPERTY_ID}/guides`, {
          signal: guidesAbortController.signal,
          headers: { Accept: "application/json" },
          cache: "no-store",
          credentials: "include",
        });

        if (!res.ok) throw new Error(`Failed to load guides (${res.status})`);

        const data = await res.json();
        const guides = Array.isArray(data?.guides) ? data.guides : [];

        guidesState.guides = guides;
        guidesState.loaded = true;

        if (!guides.length) {
          if (guidesGrid) guidesGrid.innerHTML = "";
          guidesEmptyState?.classList.remove("hidden");
          return;
        }

        buildGuideFiltersFromGuides(guides);
        renderGuidesGrid();
      } catch (err) {
        if (err?.name === "AbortError") return;
        console.error("Error loading guides:", err);

        if (guidesGrid) guidesGrid.innerHTML = "";
        if (guidesEmptyState) {
          guidesEmptyState.textContent = "We couldnâ€™t load guides right now. Please try again in a moment.";
          guidesEmptyState.classList.remove("hidden");
        }

        guidesState.loaded = false;
      } finally {
        guidesState.loading = false;
      }
    }

 function safeReplaceAll(str, needle, replacement) {
  str = String(str ?? "");
  needle = String(needle ?? "");
  replacement = String(replacement ?? "");
  if (!needle) return str; // âœ… critical: prevents replaceAll("")
  return str.split(needle).join(replacement);
}



    // --- Screen router ---
   function showScreen(name) {
  const sandyHeader = document.getElementById("chat-header-sandy");
  if (sandyHeader) sandyHeader.classList.toggle("hidden", name !== "chat");

  Object.entries(screens).forEach(([key, el]) => {
    if (!el) return;
    el.classList.toggle("hidden", key !== name);
  });

  document.body.classList.toggle("chat-screen", name === "chat");

  if (name === "experiences") loadGuidesIfNeeded();

     if (name === "upgrades") {
  initUpgradesCarousel();
  requestAnimationFrame(updateActiveFromScroll);
}


  if (name === "chat") swapLogoWithFade(LOGO_BLACK);
  else if (!isMenuOpen) swapLogoWithFade(LOGO_WHITE);

  showQuickReplies(name === "chat");

  if (name === "chat") {
    // âœ… hard guard: once per page load (and per property)
    const welcomeKey = `welcome_shown_${window.PROPERTY_ID}`;

    if (!chatHasWelcome && !sessionStorage.getItem(welcomeKey)) {
      if (sandyLive && chatBox && chatBox.children.length === 0) {
        const template = guestName
          ? (voiceCfg.welcome_template || "")
          : (voiceCfg.welcome_template_no_name || "");

        let intro = String(template || "");

        intro = safeReplaceAll(intro, "{{guest_name}}", guestName || "");
        intro = safeReplaceAll(intro, "{{assistant_name}}", assistantName || "Sandy");
        intro = safeReplaceAll(intro, "{{property_name}}", window.PROPERTY_NAME || "");

        const fallback = `Hi! Iâ€™m ${assistantName || "Sandy"}, your stay assistant for ${window.PROPERTY_NAME || "your stay"}. How can I help?`;

        renderMessage((intro.trim() || fallback), "bot");

        chatHasWelcome = true;
        sessionStorage.setItem(welcomeKey, "1");
      }
    }

    scrollChatToBottom();
  }
}

    // --- Menu screen links ---
    menuLinks.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-menu-screen");
        if (!target) return;

        if (!isUnlocked && target !== "home") {
          const err = document.getElementById("unlock-error");
          if (err)
            err.textContent =
              "Please unlock your stay first with the last 4 digits of your booking phone number.";
          showScreen("home");
        } else {
          showScreen(target);
        }

        closeMenu();
      });
    });

    // --- Initial render ---
    updateHomeState();
    showScreen("home");

    // --- Unlock flow ---
    const unlockBtn = document.getElementById("unlock-button");
    const unlockCodeInput = document.getElementById("unlock-code");
    const unlockError = document.getElementById("unlock-error");
    const unlockSpinner = document.getElementById("unlock-spinner");

    // --- Unlock / Verify (clean + hardened) ---

let unlockInFlight = false;

async function attemptUnlock() {
  if (unlockInFlight) return; // prevent double-submit
  unlockInFlight = true;

  const code = String(unlockCodeInput?.value || "").trim();

  if (unlockError) unlockError.textContent = "";

  // Validate property id early (prevents /guest/undefined/verify-json)
  const propertyId = window.PROPERTY_ID;
  if (!propertyId && propertyId !== 0) {
    if (unlockError) unlockError.textContent = "Missing property id. Please refresh the page.";
    unlockInFlight = false;
    return;
  }

  // Validate 4 digits
  if (!/^\d{4}$/.test(code)) {
    if (unlockError) unlockError.textContent = "Please enter exactly 4 digits.";
    unlockInFlight = false;
    return;
  }

  if (unlockBtn) unlockBtn.disabled = true;
  unlockSpinner?.classList.remove("hidden");

  try {
    const res = await fetch(`/guest/${propertyId}/verify-json`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ code }),
    });

    // Be robust if backend returns non-JSON on error
    let data = {};
    try {
      data = await res.json();
    } catch {
      data = {};
    }

    // Handle failure (HTTP or logical)
    if (!res.ok || !data.success) {
      const fallback =
        res.status === 401
          ? "Please refresh and try again."
          : res.status === 403
          ? "That code didnâ€™t match the reservation phone number."
          : "We couldnâ€™t verify that code. Please double-check or contact your host.";

      if (unlockError) unlockError.textContent = data.error || fallback;
      return;
    }

    // Success
    isUnlocked = true;
    lastUnlockCode = code;

    if (unlockError) unlockError.textContent = "";
    if (unlockCodeInput) unlockCodeInput.value = "";

    // Apply PMS / guest info safely
    try {
      if (data.guest_name) {
        guestName = data.guest_name;
        updateGuestNameInUI(guestName);
      }

      if (data.arrival_date) {
        arrivalDate = data.arrival_date;
        const el = document.getElementById("arrival-date-span");
        if (el) el.textContent = formatDateLong(arrivalDate);
      }

      if (data.departure_date) {
        departureDate = data.departure_date;
        const el = document.getElementById("departure-date-span");
        if (el) el.textContent = formatDateLong(departureDate);
      }

      if (data.checkin_time) {
        checkinTime = data.checkin_time;
        const el = document.getElementById("checkin-time-span");
        if (el) el.textContent = checkinTime;
      }

      if (data.checkout_time) {
        checkoutTime = data.checkout_time;
        const el = document.getElementById("checkout-time-span");
        if (el) el.textContent = checkoutTime;
      }
        } catch (e) {
          console.warn("Error applying guest info to UI:", e);
        }
    
        saveGuestState();
        updateHomeState();
        showScreen("home");
      } catch (err) {
        console.error("Verify error:", err);
        if (unlockError) unlockError.textContent = "Something went wrong while verifying. Please try again.";
      } finally {
        if (unlockBtn) unlockBtn.disabled = false;
        unlockSpinner?.classList.add("hidden");
        unlockInFlight = false;
      }
    }
    
    // Click to unlock
    unlockBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      attemptUnlock();
    });
    
    // Enter key to unlock
    unlockCodeInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        attemptUnlock();
      }
    });


    // --- Modals: Door + WiFi ---
    const checkinButton = document.getElementById("checkin-button");
    const checkinModal = document.getElementById("checkin-modal");
    const checkinClose = document.getElementById("checkin-close");
    const checkinCodeEl = document.getElementById("checkin-code");

    const wifiButton = document.getElementById("wifi-button");
    const wifiModal = document.getElementById("wifi-modal");
    const wifiClose = document.getElementById("wifi-close");

    function openWifiModal() {
      if (!wifiModal) return;
      closeMenu();

      wifiModal.classList.remove("hidden");
      wifiModal.classList.add("flex");

      document.body.classList.add("overflow-hidden", "modal-open");
      document.documentElement.classList.add("overflow-hidden");
    }

    function closeWifiModal() {
      if (!wifiModal) return;

      wifiModal.classList.add("hidden");
      wifiModal.classList.remove("flex");

      document.body.classList.remove("overflow-hidden", "modal-open");
      document.documentElement.classList.remove("overflow-hidden");
    }

    wifiButton?.addEventListener("click", (e) => {
      e.preventDefault();
      openWifiModal();
    });

    wifiClose?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeWifiModal();
    });

    wifiModal?.addEventListener("click", (e) => {
      if (e.target === wifiModal) closeWifiModal();
    });

    function openCheckinModal() {
      if (!checkinModal) return;
      closeMenu();

      const code = lastUnlockCode || "----";
      if (checkinCodeEl) checkinCodeEl.textContent = code;

      checkinModal.classList.remove("hidden");
      checkinModal.classList.add("flex");

      document.body.classList.add("overflow-hidden", "modal-open");
      document.documentElement.classList.add("overflow-hidden");
    }

    function closeCheckinModal() {
      if (!checkinModal) return;

      checkinModal.classList.add("hidden");
      checkinModal.classList.remove("flex");

      document.body.classList.remove("overflow-hidden", "modal-open");
      document.documentElement.classList.remove("overflow-hidden");
    }

    checkinButton?.addEventListener("click", (e) => {
      e.preventDefault();
      openCheckinModal();
    });

    checkinClose?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeCheckinModal();
    });

    checkinModal?.addEventListener("click", (e) => {
      if (e.target === checkinModal) closeCheckinModal();
    });

    // --- Escape closes modals ---
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;

      if (wifiModal && !wifiModal.classList.contains("hidden")) closeWifiModal();
      if (checkinModal && !checkinModal.classList.contains("hidden")) closeCheckinModal();
      if (guideModal && !guideModal.classList.contains("hidden")) closeGuideModal();
      if (drawer && !drawer.classList.contains("hidden")) closeSuggestions();
      if (isMenuOpen) closeMenu();
    });

    // --- If offline, show message + disable chat UI ---
    if (!sandyLive) {
      if (chatBox) {
        renderMessage(
          voiceCfg.offline_message ||
            "Iâ€™m currently offline for this property ðŸŒ™\n\nFor urgent questions, please contact your host directly.",
          "bot"
        );
      }
      if (chatInput) {
        chatInput.disabled = true;
        chatInput.placeholder = `${assistantName} is offline for this property.`;
      }
      if (chatSend) chatSend.disabled = true;
      if (chatPlus) chatPlus.disabled = true;
    }

    // --- Upgrades carousel (Beats-style) ---
const upgradesCarousel = document.getElementById("upgrades-carousel");
const upgradeSlides = Array.from(document.querySelectorAll(".upgrade-slide"));

let upgradesBound = false;

function getCarouselCenterX() {
  if (!upgradesCarousel) return 0;
  const r = upgradesCarousel.getBoundingClientRect();
  return r.left + r.width / 2;
}

function setActiveSlideByIndex(idx) {
  const slide = upgradeSlides[idx];
  if (!slide) return;

  // your existing active/inactive class toggles here...
  upgradeSlides.forEach((s, i) => {
    s.classList.toggle("is-active", i === idx);
    s.classList.toggle("is-inactive", i !== idx);
  });

  // âœ… populate below-carousel text
  const infoWrap = document.getElementById("upgrade-active-info");
  const titleEl  = document.getElementById("upgrade-active-title");
  const descEl   = document.getElementById("upgrade-active-description");
  const ctaWrap  = document.getElementById("upgrade-active-cta");
  const ctaLabel = document.getElementById("upgrade-active-button-label");

  const title = slide.dataset.upgradeTitle || "Upgrade";
  const price = slide.dataset.upgradePrice || "";
  const long  = slide.querySelector(".upgrade-long")?.textContent?.trim() || "";

  if (titleEl) titleEl.textContent = title;
  if (descEl)  descEl.textContent  = long;
  if (ctaLabel) ctaLabel.textContent = price ? `${price} â€“ Purchase` : "Purchase";

  infoWrap?.classList.remove("hidden");
  ctaWrap?.classList.remove("hidden");
}


function findClosestSlideIndex() {
  if (!upgradesCarousel || !upgradeSlides.length) return 0;

  const centerX = getCarouselCenterX();
  let bestIdx = 0;
  let bestDist = Infinity;

  upgradeSlides.forEach((slide, idx) => {
    const r = slide.getBoundingClientRect();
    const slideCenter = r.left + r.width / 2;
    const dist = Math.abs(slideCenter - centerX);
    if (dist < bestDist) {
      bestDist = dist;
      bestIdx = idx;
    }
  });

  return bestIdx;
}

function centerSlide(idx, behavior = "smooth") {
  if (!upgradesCarousel || !upgradeSlides[idx]) return;

  const slide = upgradeSlides[idx];
  const cRect = upgradesCarousel.getBoundingClientRect();
  const sRect = slide.getBoundingClientRect();

  // current scrollLeft + delta from centers
  const current = upgradesCarousel.scrollLeft;
  const delta = (sRect.left + sRect.width / 2) - (cRect.left + cRect.width / 2);

  upgradesCarousel.scrollTo({ left: current + delta, behavior });
}

function updateActiveFromScroll() {
  const idx = findClosestSlideIndex();
  setActiveSlideByIndex(idx);
}

// Bind once
function initUpgradesCarousel() {
  if (upgradesBound) return;
  upgradesBound = true;

  if (!upgradesCarousel || !upgradeSlides.length) return;

  // default state
  setActiveSlideByIndex(0);

  // center first slide after layout settles
  requestAnimationFrame(() => centerSlide(0, "auto"));

  // update on scroll (throttled-ish)
  let t = null;
  upgradesCarousel.addEventListener("scroll", () => {
    if (t) cancelAnimationFrame(t);
    t = requestAnimationFrame(updateActiveFromScroll);
  }, { passive: true });

  // tap a card to center it + activate it
  upgradeSlides.forEach((slide, idx) => {
    slide.addEventListener("click", () => {
      setActiveSlideByIndex(idx);
      centerSlide(idx, "smooth");
      // (optional) open modal here if you want click to open details instead of center
    });
  });

  // keep correct on resize
  window.addEventListener("resize", () => {
    updateActiveFromScroll();
  });
}

  });
</script>






</body>

</html>
