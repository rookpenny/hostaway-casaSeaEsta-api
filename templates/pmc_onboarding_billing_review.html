# ----------------------------
# POST: Create Stripe Checkout (setup fee + monthly subscription)
# ----------------------------
@router.post("/pmc/onboarding/billing/checkout")
def onboarding_billing_checkout(request: Request, db: Session = Depends(get_db)):
    redirect = _require_login_or_redirect(request, "/pmc/onboarding/billing-review")
    if redirect:
        return redirect

    pmc = _require_pmc_for_session(db, request)

    enabled_count = (
        db.query(Property)
        .filter(Property.pmc_id == pmc.id, Property.sandy_enabled.is_(True))
        .count()
    )
    if enabled_count <= 0:
        return RedirectResponse("/pmc/onboarding/properties", status_code=303)

    stripe_secret = (os.getenv("STRIPE_SECRET_KEY") or "").strip()
    price_setup = (os.getenv("STRIPE_PRICE_SIGNUP_ONETIME") or "").strip()          # should be $499 one-time
    price_monthly = (os.getenv("STRIPE_PRICE_PROPERTY_MONTHLY") or "").strip()     # should be $9.99/mo
    app_base = (os.getenv("APP_BASE_URL") or "").rstrip("/")

    if not stripe_secret or not price_setup or not price_monthly or not app_base:
        raise HTTPException(status_code=500, detail="Missing Stripe env vars")

    stripe.api_key = stripe_secret

    # Prefer existing customer from prior checkout; if not present, create one now.
    customer_id = getattr(pmc, "stripe_customer_id", None)
    if not customer_id:
        cust = stripe.Customer.create(email=getattr(pmc, "email", None) or None, metadata={"pmc_id": str(pmc.id)})
        customer_id = cust["id"]
        _set_if_attr(pmc, "stripe_customer_id", customer_id)
        db.commit()

    try:
        checkout = stripe.checkout.Session.create(
            mode="subscription",
            customer=customer_id,
            line_items=[
                # One-time setup fee, charged NOW inside the subscription checkout
                {"price": price_setup, "quantity": 1},
                # Monthly recurring per-property
                {"price": price_monthly, "quantity": int(enabled_count)},
            ],
            success_url=f"{app_base}/pmc/onboarding/billing/success?session_id={{CHECKOUT_SESSION_ID}}",
            cancel_url=f"{app_base}/pmc/onboarding/billing-review",
            metadata={
                "pmc_id": str(pmc.id),
                "type": "pmc_setup_plus_property_subscription",
                "enabled_count": str(enabled_count),
            },
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Stripe checkout failed: {str(e)}")

    return RedirectResponse(checkout.url, status_code=303)


# ----------------------------
# GET: Stripe success (still not proof of payment; webhook is truth)
# ----------------------------
@router.get("/pmc/onboarding/billing/success", response_class=HTMLResponse)
def onboarding_billing_success(request: Request, session_id: str = Query(...), db: Session = Depends(get_db)):
    redirect = _require_login_or_redirect(request, "/pmc/onboarding/billing/success")
    if redirect:
        return redirect

    pmc = _require_pmc_for_session(db, request)

    stripe_secret = (os.getenv("STRIPE_SECRET_KEY") or "").strip()
    if not stripe_secret:
        raise HTTPException(status_code=500, detail="Missing STRIPE_SECRET_KEY")
    stripe.api_key = stripe_secret

    # Retrieve session to store subscription/customer ids deterministically
    try:
        cs = stripe.checkout.Session.retrieve(session_id)
    except Exception:
        # If retrieval fails, still send them to dashboard (webhook should handle state)
        return RedirectResponse("/admin/dashboard", status_code=303)

    # Basic integrity check: ensure session is for this PMC
    md = cs.get("metadata") or {}
    if (md.get("pmc_id") or "").strip() and str(pmc.id) != str(md.get("pmc_id")):
        raise HTTPException(status_code=403, detail="Checkout session does not match your account")

    sub_id = cs.get("subscription")
    cust_id = cs.get("customer")

    if sub_id:
        _set_if_attr(pmc, "stripe_subscription_id", sub_id)
    if cust_id and not getattr(pmc, "stripe_customer_id", None):
        _set_if_attr(pmc, "stripe_customer_id", cust_id)

    _set_if_attr(pmc, "last_stripe_checkout_session_id", cs.get("id"))

    # IMPORTANT: don't mark paid here. Webhook should set billing_status=active, etc.
    db.commit()

    return RedirectResponse("/admin/dashboard", status_code=303)
