{# chat_detail_panel.html (COPY/PASTE CLEAN) #}
{% set prop_name = (property.property_name if property else (property_name_by_id | default({})).get(session.property_id)) %}

<div class="space-y-4">

  <!-- Sticky Header -->
  <div class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b border-slate-200">
    <div class="p-4 space-y-3">

      <!-- 2-column header -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">

        <!-- LEFT: Chat meta -->
        <div class="min-w-0 space-y-1">
          <div class="text-[14px] font-semibold truncate">
            Chat #{{ session.id }}
            <br>{{ prop_name or "Unknown property" }} ‚Ä¢ Property ID: {{ session.property_id }}
          </div>

          <div>
            {% if session.reservation_status == "active" %}
              <span class="inline-flex items-center px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-semibold text-xs">üèñ Active</span>
            {% elif session.reservation_status == "pre_booking" %}
              <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold text-xs">üí¨ Pre-booking</span>
            {% elif session.reservation_status == "post_stay" %}
              <span class="inline-flex items-center px-2 py-1 rounded-full bg-slate-200 text-slate-700 font-semibold text-xs">üì¨ Post-stay</span>
            {% else %}
              <span class="inline-flex items-center px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-semibold text-xs">Unknown</span>
            {% endif %}

            <span
              id="resolved-pill"
              class="inline-flex items-center px-2 py-1 rounded-full text-[14px] font-semibold
                {% if session.is_resolved %}
                  bg-emerald-100 text-emerald-800
                {% else %}
                  bg-slate-200 text-slate-700
                {% endif %}
              "
            >
              {% if session.is_resolved %}‚úÖ Resolved{% else %}üïí Open{% endif %}
            </span>

            <span
              id="escalation-pill"
              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold
                {% if session.escalation_level == 'high' %}
                  bg-rose-100 text-rose-800
                {% elif session.escalation_level == 'medium' %}
                  bg-amber-100 text-amber-800
                {% elif session.escalation_level == 'low' %}
                  bg-blue-100 text-blue-800
                {% else %}
                  bg-slate-100 text-slate-500
                {% endif %}
              "
            >
              {% if session.escalation_level %}
                üö® Escalation: {{ session.escalation_level|capitalize }}
              {% else %}
                No escalation
              {% endif %}
            </span>
            <br>

            <span class="text-[14px] text-slate-500">
              Assigned:
              <span id="assigned-label" class="font-semibold text-slate-700">
                {{ session.assigned_to or "‚Äî" }}
              </span>
            </span>
          </div>
        </div>

        <!-- RIGHT: Status + actions -->
        <div class="flex flex-wrap items-center gap-2 justify-start md:justify-end">
          <div class="flex flex-wrap items-center gap-2">
            <select
              id="escalation-select"
              class="h-10 border border-slate-200 rounded-xl px-3 text-sm bg-white">
              <option value="" {% if not session.escalation_level %}selected{% endif %}>No escalation</option>
              <option value="low" {% if session.escalation_level=='low' %}selected{% endif %}>Low</option>
              <option value="medium" {% if session.escalation_level=='medium' %}selected{% endif %}>Medium</option>
              <option value="high" {% if session.escalation_level=='high' %}selected{% endif %}>High</option>
            </select>

            {% if session.is_resolved %}
              <button
                id="unresolve-btn"
                class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800"
                type="button"
              >
                Reopen
              </button>
            {% else %}
              <button
                id="resolve-btn"
                class="h-10 px-4 rounded-xl bg-emerald-700 text-white text-sm font-semibold hover:bg-emerald-800"
                type="button"
              >
                Mark Resolved
              </button>
            {% endif %}
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <input
              id="assigned-input"
              value="{{ session.assigned_to or '' }}"
              class="h-10 border border-slate-200 rounded-xl px-3 text-sm bg-white w-full sm:w-[320px]"
              placeholder="Assign to (name/email)"
            />

            <button
              id="assign-btn"
              class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800"
              type="button"
            >
              Assign
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="p-4 space-y-4">

    <!-- Internal note -->
    <div class="rounded-2xl border border-slate-200 p-3 bg-white">
      <div class="flex items-center justify-between gap-2">
        <div class="text-sm font-semibold text-slate-800">Internal note</div>

        <!-- Toggle (note) -->
        <button
          id="note-toggle"
          type="button"
          class="inline-flex items-center gap-1 text-slate-600 hover:text-slate-900"
          aria-expanded="false"
          title="Toggle notes (N)"
        >
          <span class="text-xs font-semibold">N</span>
          <svg id="note-chevron" class="w-5 h-5 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <!-- NOTE BODY (hidden by default) -->
      <div id="note-body" class="mt-3 hidden">
        <textarea
          id="note-input"
          class="w-full border border-slate-200 rounded-xl p-2 text-sm bg-white"
          rows="3"
          placeholder="Add an internal note (not visible to guests)"
        >{{ session.internal_note or "" }}</textarea>

        <div class="mt-2 flex items-center gap-2">
          <button
            id="save-note-btn"
            class="px-3 py-1 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800"
            type="button"
          >
            Save note
          </button>
          <span id="note-status" class="text-xs text-slate-500"></span>
        </div>
      </div>
    </div>

    <!-- AI Summary -->
    <div class="rounded-2xl border border-slate-200 p-3 bg-white">
      <div class="flex items-center justify-between gap-3">
        <div class="min-w-0">
          <div class="text-sm font-semibold">AI Summary</div>
          <div class="text-xs text-slate-500 truncate">
            {% if session.ai_summary_updated_at %}
              Updated: {{ session.ai_summary_updated_at }}
            {% else %}
              Not generated yet
            {% endif %}
          </div>
        </div>

        <div class="flex items-center gap-2">
          <!-- Toggle (summary) -->
          <button
            id="summary-toggle"
            type="button"
            class="inline-flex items-center gap-1 text-slate-600 hover:text-slate-900"
            aria-expanded="false"
            title="Toggle summary (S)"
          >
            <span class="text-xs font-semibold">S</span>
            <svg id="summary-chevron" class="w-5 h-5 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
            </svg>
          </button>

          <button
            id="summary-btn"
            class="bg-slate-900 text-white rounded-xl px-3 py-1 text-sm hover:bg-slate-800"
            type="button"
          >
            Generate / Refresh
          </button>
        </div>
      </div>

      <!-- SUMMARY BODY (hidden by default) -->
      <div id="summary-body" class="mt-3 hidden">
        <div id="summary-box" class="text-sm text-slate-800 whitespace-pre-wrap">
          {% if session.ai_summary %}
            {{ session.ai_summary }}
          {% else %}
            <span class="text-slate-500">No summary yet.</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Messages (speech bubbles, unchanged) -->
    <div class="rounded-2xl border border-slate-200 p-3 bg-white">
      <div class="text-sm font-semibold">Messages</div>

      <div class="mt-3 space-y-3">
        {% for msg in messages %}
          <div class="flex {{ 'justify-end' if msg.sender == 'assistant' else 'justify-start' }}">
            <div class="max-w-[85%] rounded-2xl px-3 py-2 text-sm border
              {% if msg.sender == 'assistant' %}
                bg-blue-50 border-blue-100
              {% elif msg.sender == 'guest' %}
                bg-slate-50 border-slate-200
              {% else %}
                bg-amber-50 border-amber-200
              {% endif %}
            ">
              <div class="text-xs font-semibold mb-1 text-slate-600">
                {{ msg.sender|capitalize }}
                <span class="text-slate-400">‚Ä¢ {{ msg.created_at }}</span>
              </div>

              <div class="whitespace-pre-wrap text-slate-800">{{ msg.content }}</div>

              {% if msg.sender == 'guest' %}
                <div class="mt-1 text-[11px] text-slate-500">
                  Category: {{ msg.category or '‚Äî' }} ‚Ä¢
                  Log: {{ msg.log_type or '‚Äî' }} ‚Ä¢
                  Sentiment: {{ msg.sentiment or '‚Äî' }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  </div>
</div>
