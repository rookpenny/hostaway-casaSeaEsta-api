{% set prop_name = (property.property_name if property else (property_name_by_id | default({})).get(session.property_id)) %}

<div class="space-y-4">

  <!-- Sticky Header -->
  <div class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b border-slate-200">
    <div class="p-4 space-y-3">

      <!-- 2-column header -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">

        <!-- LEFT: Chat meta -->
        <div class="min-w-0 space-y-1">
          <div class="text-[14px] font-semibold truncate">
            Chat #{{ session.id }}
            <br>{{ prop_name or "Unknown property" }} ‚Ä¢ Property ID: {{ session.property_id }}
          </div>

          <div class="space-y-2">
            <div class="flex flex-wrap items-center gap-2">
              {% if session.reservation_status == "active" %}
                <span class="inline-flex items-center px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-semibold text-xs">üèñ Active</span>
              {% elif session.reservation_status == "pre_booking" %}
                <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold text-xs">üí¨ Pre-booking</span>
              {% elif session.reservation_status == "post_stay" %}
                <span class="inline-flex items-center px-2 py-1 rounded-full bg-slate-200 text-slate-700 font-semibold text-xs">üì¨ Post-stay</span>
              {% else %}
                <span class="inline-flex items-center px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-semibold text-xs">Unknown</span>
              {% endif %}

              <span
                id="resolved-pill"
                class="inline-flex items-center px-2 py-1 rounded-full text-[13px] font-semibold
                  {% if session.is_resolved %}
                    bg-emerald-100 text-emerald-800
                  {% else %}
                    bg-slate-200 text-slate-700
                  {% endif %}
                "
              >
                {% if session.is_resolved %}‚úÖ Resolved{% else %}üïí Open{% endif %}
              </span>

              <span
                id="escalation-pill"
                class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold
                  {% if session.escalation_level == 'high' %}
                    bg-rose-100 text-rose-800
                  {% elif session.escalation_level == 'medium' %}
                    bg-amber-100 text-amber-800
                  {% elif session.escalation_level == 'low' %}
                    bg-blue-100 text-blue-800
                  {% else %}
                    bg-slate-100 text-slate-500
                  {% endif %}
                "
              >
                {% if session.escalation_level %}
                  üö® Escalation: {{ session.escalation_level|capitalize }}
                {% else %}
                  No escalation
                {% endif %}
              </span>
            </div>

            <span class="text-[14px] text-slate-500">
              Assigned:
              <span id="assigned-label" class="font-semibold text-slate-700">
                {{ session.assigned_to or "‚Äî" }}
              </span>
            </span>
          </div>
        </div>

        <!-- RIGHT: Status + actions -->
        <div class="flex flex-wrap items-center gap-2 justify-start md:justify-end">

          <!-- Row: pills -->
          <div class="flex flex-wrap items-center gap-2">
            <select
              id="escalation-select"
              class="h-10 border border-slate-200 rounded-xl px-3 text-sm bg-white"
            >
              <option value="" {% if not session.escalation_level %}selected{% endif %}>No escalation</option>
              <option value="low" {% if session.escalation_level=='low' %}selected{% endif %}>Low</option>
              <option value="medium" {% if session.escalation_level=='medium' %}selected{% endif %}>Medium</option>
              <option value="high" {% if session.escalation_level=='high' %}selected{% endif %}>High</option>
            </select>

            {% if session.is_resolved %}
              <button
                id="unresolve-btn"
                class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800"
                type="button"
              >
                Reopen
              </button>
            {% else %}
              <button
                id="resolve-btn"
                class="h-10 px-4 rounded-xl bg-emerald-700 text-white text-sm font-semibold hover:bg-emerald-800"
                type="button"
              >
                Mark Resolved
              </button>
            {% endif %}
          </div>

          <!-- Row: actions -->
          <div class="flex flex-wrap items-center gap-2">
            <input
              id="assigned-input"
              value="{{ session.assigned_to or '' }}"
              class="h-10 border border-slate-200 rounded-xl px-3 text-sm bg-white w-full sm:w-[320px]"
              placeholder="Assign to (name/email)"
            />

            <button
              id="assign-btn"
              class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800"
              type="button"
            >
              Assign
            </button>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Body -->
  <div class="p-4 space-y-4">

    <!-- Internal note -->
    <div class="rounded-2xl border border-slate-200 p-3 bg-white">
      <div class="flex items-center justify-between">
        <div class="text-xs font-semibold text-slate-600">Internal note</div>

        <button
          type="button"
          class="inline-flex items-center gap-1 text-slate-500 hover:text-slate-900"
          data-toggle-btn
          data-target="note-panel"
          data-storage="admin_chatpanel:{{ session.id }}:note_hidden"
          aria-label="Toggle internal note"
          title="Toggle (N)"
        >
          <span class="text-[11px] font-semibold">N</span>
          <span class="w-5 h-5 inline-flex items-center justify-center">
            <!-- chevron -->
            <svg data-chevron class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path>
            </svg>
          </span>
        </button>
      </div>

      <div id="note-panel" class="mt-2">
        <textarea
          id="note-input"
          class="w-full border border-slate-200 rounded-xl p-2 text-sm bg-white"
          rows="3"
          placeholder="Add an internal note (not visible to guests)"
        >{{ session.internal_note or "" }}</textarea>

        <div class="mt-2 flex items-center gap-2">
          <button
            id="save-note-btn"
            class="px-3 py-1 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800"
            type="button"
          >
            Save note
          </button>
          <span id="note-status" class="text-xs text-slate-500"></span>
        </div>
      </div>
    </div>

    <!-- AI Summary -->
    <div class="rounded-2xl border border-slate-200 p-3 bg-white">
      <div class="flex items-center justify-between gap-3">
        <div class="min-w-0">
          <div class="text-sm font-semibold">AI Summary</div>
          <div class="text-xs text-slate-500 truncate">
            {% if session.ai_summary_updated_at %}
              Updated: {{ session.ai_summary_updated_at }}
            {% else %}
              Not generated yet
            {% endif %}
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            type="button"
            class="inline-flex items-center gap-1 text-slate-500 hover:text-slate-900"
            data-toggle-btn
            data-target="summary-panel"
            data-storage="admin_chatpanel:{{ session.id }}:summary_hidden"
            aria-label="Toggle AI summary"
            title="Toggle (S)"
          >
            <span class="text-[11px] font-semibold">S</span>
            <span class="w-5 h-5 inline-flex items-center justify-center">
              <!-- chevron -->
              <svg data-chevron class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path>
              </svg>
            </span>
          </button>

          <button
            id="summary-btn"
            class="bg-slate-900 text-white rounded-xl px-3 py-1 text-sm hover:bg-slate-800"
            type="button"
          >
            Generate / Refresh
          </button>
        </div>
      </div>

      <div id="summary-panel" class="mt-3">
        <div id="summary-box" class="text-sm text-slate-800 whitespace-pre-wrap">
          {% if session.ai_summary %}
            {{ session.ai_summary }}
          {% else %}
            <span class="text-slate-500">No summary yet.</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Messages (speech bubbles back-and-forth) -->
    <div class="rounded-2xl border border-slate-200 p-3 bg-white">
      <div class="text-sm font-semibold">Messages</div>

      <div class="mt-3 space-y-3">
        {% for msg in messages %}
          <div class="flex {{ 'justify-end' if msg.sender == 'assistant' else 'justify-start' }}">
            <div class="max-w-[85%] rounded-2xl px-3 py-2 text-sm border
              {% if msg.sender == 'assistant' %}
                bg-blue-50 border-blue-100
              {% elif msg.sender == 'guest' %}
                bg-slate-50 border-slate-200
              {% else %}
                bg-amber-50 border-amber-200
              {% endif %}
            ">
              <div class="text-xs font-semibold mb-1 text-slate-600">
                {{ msg.sender|capitalize }}
                <span class="text-slate-400">‚Ä¢ {{ msg.created_at }}</span>
              </div>

              <div class="whitespace-pre-wrap text-slate-800">{{ msg.content }}</div>

              {% if msg.sender == 'guest' %}
                <div class="mt-1 text-[11px] text-slate-500">
                  Category: {{ msg.category or '‚Äî' }} ‚Ä¢
                  Log: {{ msg.log_type or '‚Äî' }} ‚Ä¢
                  Sentiment: {{ msg.sentiment or '‚Äî' }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  </div>
</div>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  const CHAT_ID = "{{ session.id }}";

  function isTypingContext() {
    const el = document.activeElement;
    if (!el) return false;
    const tag = (el.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || el.isContentEditable;
  }

  function setChevron(btn, isCollapsed) {
    const chev = btn?.querySelector("[data-chevron]");
    if (!chev) return;
    // collapsed => rotate to point right; expanded => point down
    // Our SVG points down by default
    chev.style.transform = isCollapsed ? "rotate(-90deg)" : "rotate(0deg)";
    chev.style.transition = "transform 150ms ease";
  }

  function setSectionHidden(targetId, hidden, storageKey, btn) {
    const el = document.getElementById(targetId);
    if (!el) return;
    el.classList.toggle("hidden", !!hidden);
    if (storageKey) {
      try { localStorage.setItem(storageKey, hidden ? "1" : "0"); } catch (e) {}
    }
    setChevron(btn, hidden);
  }

  function toggleSection(targetId, storageKey, btn) {
    const el = document.getElementById(targetId);
    if (!el) return;
    const hidden = !el.classList.contains("hidden") ? true : false;
    setSectionHidden(targetId, hidden, storageKey, btn);
  }

  async function postJSON(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: body ? JSON.stringify(body) : undefined,
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.ok === false) throw new Error(data.error || "Request failed");
    return data;
  }

  // -----------------------------
  // Restore hide/show state (localStorage)
  // -----------------------------
  document.querySelectorAll("[data-toggle-btn]")?.forEach((btn) => {
    const targetId = btn.getAttribute("data-target");
    const storageKey = btn.getAttribute("data-storage");
    if (!targetId || !storageKey) return;

    let hidden = false;
    try { hidden = localStorage.getItem(storageKey) === "1"; } catch (e) {}
    setSectionHidden(targetId, hidden, storageKey, btn);

    btn.addEventListener("click", () => toggleSection(targetId, storageKey, btn));
  });

  // -----------------------------
  // Keyboard shortcuts
  // N = notes, S = summary
  // -----------------------------
  document.addEventListener("keydown", (e) => {
    if (isTypingContext()) return;
    if (e.metaKey || e.ctrlKey || e.altKey) return;

    const key = (e.key || "").toLowerCase();
    if (key === "n") {
      const btn = document.querySelector('[data-target="note-panel"]');
      btn?.click();
    } else if (key === "s") {
      const btn = document.querySelector('[data-target="summary-panel"]');
      btn?.click();
    }
  });

  // -----------------------------
  // Action Panel
  // -----------------------------
  const resolveBtn = document.getElementById("resolve-btn");
  const unresolveBtn = document.getElementById("unresolve-btn");
  const escalationSelect = document.getElementById("escalation-select");
  const assignBtn = document.getElementById("assign-btn");
  const assignedInput = document.getElementById("assigned-input");

  const noteInput = document.getElementById("note-input");
  const saveNoteBtn = document.getElementById("save-note-btn");
  const noteStatus = document.getElementById("note-status");

  resolveBtn?.addEventListener("click", async () => {
    try {
      await postJSON(`/admin/chats/${CHAT_ID}/resolve`);
      location.reload();
    } catch (e) {
      alert(e.message);
    }
  });

  unresolveBtn?.addEventListener("click", async () => {
    try {
      await postJSON(`/admin/chats/${CHAT_ID}/unresolve`);
      location.reload();
    } catch (e) {
      alert(e.message);
    }
  });

  escalationSelect?.addEventListener("change", async () => {
    try {
      await postJSON(`/admin/chats/${CHAT_ID}/escalate`, { level: escalationSelect.value });
      location.reload();
    } catch (e) {
      alert(e.message);
    }
  });

  assignBtn?.addEventListener("click", async () => {
    try {
      await postJSON(`/admin/chats/${CHAT_ID}/assign`, { assigned_to: assignedInput.value });
      location.reload();
    } catch (e) {
      alert(e.message);
    }
  });

  saveNoteBtn?.addEventListener("click", async () => {
    try {
      noteStatus.textContent = "Saving‚Ä¶";
      await postJSON(`/admin/chats/${CHAT_ID}/note`, { note: noteInput.value });
      noteStatus.textContent = "Saved ‚úÖ";
      setTimeout(() => (noteStatus.textContent = ""), 1500);
    } catch (e) {
      noteStatus.textContent = "Error";
      alert(e.message);
    }
  });

  // -----------------------------
  // AI Summary
  // Auto-expand when it updates
  // -----------------------------
  const summaryBtn = document.getElementById("summary-btn");
  const summaryBox = document.getElementById("summary-box");

  summaryBtn?.addEventListener("click", async () => {
    summaryBtn.disabled = true;
    const originalLabel = summaryBtn.textContent;
    summaryBtn.textContent = "Generating‚Ä¶";
    summaryBox?.classList.remove("text-red-600");

    try {
      const res = await fetch(`/admin/chats/${CHAT_ID}/summarize`, { method: "POST" });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");

      // Update text (safe)
      if (summaryBox) summaryBox.textContent = data.summary || "";

      // Auto-expand summary panel after update
      const summaryToggleBtn = document.querySelector('[data-target="summary-panel"]');
      const storageKey = summaryToggleBtn?.getAttribute("data-storage");
      setSectionHidden("summary-panel", false, storageKey, summaryToggleBtn);

    } catch (e) {
      if (summaryBox) {
        summaryBox.classList.add("text-red-600");
        summaryBox.textContent = `Summary error: ${e.message}`;
      }
    } finally {
      summaryBtn.disabled = false;
      summaryBtn.textContent = originalLabel || "Generate / Refresh";
    }
  });
</script>
